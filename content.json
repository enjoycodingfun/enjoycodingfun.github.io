[{"title":"spring-aopå¸¸ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼","date":"2020-04-06T15:52:39.748Z","path":"posts/spring-aop-pointcut/","text":"AOPæ˜¯springçš„æœ€é‡è¦æ¨¡å—ä¹‹ä¸€ï¼Œå…³äºAOPçš„åŸç†ï¼Œä¸»è¦å°±æ˜¯åŸºäºåŠ¨æ€ä»£ç†ï¼Œå¯ä»¥æŸ¥çœ‹å®˜ç½‘Understanding AOP Proxiesï¼Œæœ¬èŠ‚å†…å®¹ä¸å»æ·±ç©¶AOPåŸç†ï¼Œä»…ä»…åˆ—å‡ºåœ¨springæ¡†æ¶ä¸­ç¼–å†™AOPä»£ç æ—¶ï¼Œå¸¸ç”¨çš„åˆ‡ç‚¹è¡¨è¾¾å¼å†™æ³•ï¼Œå®˜ç½‘ä¸Šå…³äºAOPè¿™ä¸€èŠ‚çš„è¯´æ˜ï¼Œä¹Ÿå¯ä»¥çœ‹ä¸‹ï¼Œä¸€å®šä¼šæœ‰æ”¶è·Aspect Oriented Programming with Springæœ¬æ–‡ä¹Ÿæ˜¯åŸºäºå®˜æ–¹æ–‡æ¡£å½¢æˆçš„ã€‚ éœ€è¦è¯´æ˜çš„æ˜¯åœ¨springæ¡†æ¶ä¸­å…±ç”¨äº†AspectJçš„ä¸€äº›æ³¨è§£ï¼Œä¸”ç›®å‰ä»…æ”¯æŒæ–¹æ³•çº§åˆ«çš„å¢å¼ºï¼ŒAspectJæ”¯æŒæ›´å¤šçš„åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œåœ¨æœ¬æ–‡ä¾‹å­ä¸­ä¹Ÿä¸å»è¯¦è¿°ï¼Œæƒ³è¦äº†è§£çš„å¯ä»¥å»çœ‹The AspectJTM Programming Guide ç”±äºæœ¬æ–‡çš„é‡ç‚¹åœ¨äºåˆ‡ç‚¹è¡¨è¾¾å¼çš„ä¾‹å­ï¼Œæ‰€ä»¥æœ¬æ–‡æ‰€é‡‡ç”¨çš„å¢å¼ºæ–¹å¼ä¸€èˆ¬ä»¥ç¯ç»•å¢å¼ºä¸ºä¸»ã€‚ 1. spring-aopæ”¯æŒçš„åˆ‡ç‚¹è¡¨è¾¾å¼å…³é”®å­—å®˜ç½‘å¾ˆæ˜ç¡®çš„è¯´æ˜äº†springæ”¯æŒå“ªäº›åˆ‡ç‚¹è¡¨è¾¾å¼å…³é”®å­—ï¼Œå¦‚ä¸‹: Spring AOP supports the following AspectJ pointcut designators (PCD) for use in pointcut expressions: execution: For matching method execution join points. This is the primary pointcut designator to use when working with Spring AOP. within: Limits matching to join points within certain types (the execution of a method declared within a matching type when using Spring AOP). this: Limits matching to join points (the execution of methods when using Spring AOP) where the bean reference (Spring AOP proxy) is an instance of the given type. target: Limits matching to join points (the execution of methods when using Spring AOP) where the target object (application object being proxied) is an instance of the given type. args: Limits matching to join points (the execution of methods when using Spring AOP) where the arguments are instances of the given types. @target: Limits matching to join points (the execution of methods when using Spring AOP) where the class of the executing object has an annotation of the given type. @args: Limits matching to join points (the execution of methods when using Spring AOP) where the runtime type of the actual arguments passed have annotations of the given types. @within: Limits matching to join points within types that have the given annotation (the execution of methods declared in types with the given annotation when using Spring AOP). @annotation: Limits matching to join points where the subject of the join point (the method being executed in Spring AOP) has the given annotation. è‡³äºå®˜æ–¹æš‚æ—¶ä¸æ”¯æŒçš„åˆ‡ç‚¹è¡¨è¾¾å¼å…³é”®å­—ï¼Œä¹Ÿåˆ—ä¸¾å‡ºæ¥äº†ï¼Œè¿˜è¡¨ç¤ºå°†æ¥çš„ç‰ˆæœ¬å¯èƒ½ä¼šæ”¯æŒæ›´å¤šçš„å…³é”®å­—ï¼š Other pointcut types The full AspectJ pointcut language supports additional pointcut designators that are not supported in Spring: call, get, set, preinitialization, staticinitialization, initialization, handler, adviceexecution, withincode, cflow, cflowbelow, if, @this, and @withincode. Use of these pointcut designators in pointcut expressions interpreted by Spring AOP results in an IllegalArgumentException being thrown. The set of pointcut designators supported by Spring AOP may be extended in future releases to support more of the AspectJ pointcut designators. åˆ‡ç‚¹è¡¨è¾¾å¼ä¹‹é—´æ”¯æŒ&amp;&amp;, || ! è¿æ¥ï¼Œè¿æ¥æ—¶å€™å¯ä»¥é‡‡ç”¨å…·ä½“çš„è¡¨è¾¾å¼ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨pointcutæ³¨è§£å¯¹åº”çš„æ–¹æ³•ç­¾åï¼šæ¯”å¦‚åœ¨springä¸­è‡ªå®šä¹‰æ³¨è§£ä¸­ç”¨åˆ°çš„myAnnoCut()&amp;&amp;myPointCut() 2. å¸¸ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼é‡‡ç”¨executionå…³é”®å­—å®šä¹‰çš„åˆ‡ç‚¹è¡¨è¾¾å¼æ ¼å¼å¦‚ä¸‹ï¼š 12execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern) throws-pattern?) è¡¨è¾¾å¼ä¸­é™¤äº†è¿”å›å€¼ç±»å‹åŒ¹é…è§„åˆ™ret-type-pattern (é€šå¸¸æ˜¯ *æ¥åŒ¹é…æ‰€æœ‰è¿”å›å€¼ç±»å‹)ä¹‹å¤–çš„å…¶ä»–ç±»å‹åŒ¹é…è§„åˆ™éƒ½æ˜¯å¯é€‰çš„ name-patternæ–¹æ³•åï¼Œå¯ä»¥æ˜¯å…·ä½“çš„æ–¹æ³•åï¼Œä¹Ÿå¯ä»¥ç”¨*åœˆå®šæ‰€æœ‰æ–¹æ³• param-patternæ–¹æ³•å…¥å‚ï¼šï¼ˆï¼‰åŒ¹é…æ— å‚æ–¹æ³•ï¼Œ(..)åŒ¹é…å¤šå‚æ•°æ–¹æ³•ï¼Œï¼ˆ*ï¼‰åŒ¹é…å•å‚æ•°ä»»æ„å…¥å‚ç±»å‹çš„æ–¹æ³•ï¼Œ(*,String)åŒ¹é…æœ‰ä¸¤ä¸ªå…¥å‚çš„æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œç¬¬äºŒä¸ªå¿…é¡»æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚ ä»¥ä¸‹æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°çš„ä¸€äº›è¡¨è¾¾å¼ï¼š 12345678910111213141516execution(public * *(..)) //åŒ¹é…æ‰€æœ‰publicæ–¹æ³•execution(* set*(..))//åŒ¹é…æ‰€æœ‰æ–¹æ³•åå¼€å¤´ä¸ºsetçš„æ–¹æ³•execution(* com.xyz.service.AccountService.*(..))//åŒ¹é…AccountServiceä¸‹çš„æ‰€æœ‰æ–¹æ³•execution(* com.xyz.service.*.*(..))//åŒ¹é…serviceåŒ…ä¸‹çš„æ‰€æœ‰æ–¹æ³•execution(* com.xyz.service..*.*(..))//åŒ¹é…serviceåŒ…æˆ–å…¶å­åŒ…ä¸‹çš„æ‰€æœ‰æ–¹æ³•within(com.xyz.service.*)//åŒ¹é…serviceåŒ…ä¸‹çš„æ‰€æœ‰æ–¹æ³•within(com.xyz.service..*)//åŒ¹é…serviceåŒ…æˆ–å…¶å­åŒ…ä¸‹çš„æ‰€æœ‰æ–¹æ³•this(com.xyz.service.AccountService)//åŒ¹é…æ‰€æœ‰å®ç°äº†AccountServiceæ¥å£çš„ç±»çš„ä»£ç†ç±»çš„æ–¹æ³•ï¼ˆæ³¨æ„æ˜¯ä»£ç†ç±»ï¼‰target(com.xyz.service.AccountService)//åŒ¹é…æ‰€æœ‰å®ç°äº†AccountServiceæ¥å£çš„ç±»çš„æ–¹æ³•ï¼ˆæ³¨æ„æ˜¯æœ¬ç±»ï¼‰args(java.io.Serializable)//åŒ¹é…åªæœ‰ä¸€ä¸ªå…¥å‚ï¼Œä¸”å…¥å‚å®ç°äº†Serializableæ¥å£çš„æ–¹æ³•@target(org.springframework.transaction.annotation.Transactional)//åŒ¹é…ç±»ä¸Šæ ‡æ³¨äº†@Transactionalæ³¨è§£çš„ç±»ä¸­æ–¹æ³•@within(org.springframework.transaction.annotation.Transactional)//åŒ¹é…è¿è¡Œæ—¶å­ç±»ä¸Šæ ‡æ³¨äº†@Transactionalæ³¨è§£çš„ç±»ä¸­æ–¹æ³•@annotation(org.springframework.transaction.annotation.Transactional)//åŒ¹é…æ‰€æœ‰æ‰“äº†@Transactionalæ³¨è§£çš„æ–¹æ³•@args(com.xyz.security.Classified)//åŒ¹é…åªæœ‰ä¸€ä¸ªå…¥å‚ï¼Œä¸”è¿è¡Œæ—¶å…¥å‚æœ‰@Classifiedæ³¨è§£çš„æ–¹æ³•bean(tradeService)//åŒ¹é…å‘½åä¸ºtradeServiceçš„ç±»çš„æ–¹æ³•bean(*Service)//åŒ¹é…å‘½ååç¼€ä¸ºServiceçš„ç±»çš„æ–¹æ³• â€˜thisâ€™ is more commonly used in a binding form. See the section on Declaring Advice for how to make the proxy object available in the advice body. å…³äºä¸Šé¢@targetå’Œ@withinåŒºåˆ«è¯·çœ‹åšå®¢ 3. è¿ç®—ç¬¦ç»„åˆåˆ‡ç‚¹è¡¨è¾¾å¼è¿™ä¸€éƒ¨åˆ†ç›´æ¥åˆ—ä¸¾å‡ ä¸ªï¼ŒåŸºç¡€è¡¨è¾¾å¼ä¼šå†™ä¹‹åï¼Œç»„åˆæŒ‰ç…§è‡ªå·±æƒ³åœˆå®šçš„èŒƒå›´è¿›è¡Œç»„åˆè¿ç®—åŒ¹é…å³å¯ï¼š 12345678910111213//æˆ–ï¼ˆ||ï¼‰è¿ç®—ç¬¦@Pointcut(\"execution(* com.xxx.yyy.service.*.*.*(..))||\" + \"execution(* com.xxx.yyy.api.*.*.*(..))\")public void myElseCut()&#123;&#125;;//ä¸ï¼ˆ&amp;&amp;ï¼‰è¿ç®—ç¬¦@Pointcut(\"execution(* com.xxx.yyy.controller..*.*(..))\" + \"&amp;&amp; @within(org.springframework.web.bind.annotation.RestController)\")public void myAndCut()&#123;&#125;;//éï¼ˆï¼ï¼‰è¿ç®—ç¬¦@Pointcut(\"@within(org.springframework.validation.annotation.Validated)\" + \"&amp;&amp; !@within(org.springframework.web.bind.annotation.RestController)\" + \"&amp;&amp; !@within(org.springframework.stereotype.Controller)\")public void myNotCut()&#123;&#125;; ç»„åˆåˆ‡ç‚¹è¡¨è¾¾å¼å‡å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªåˆ‡ç‚¹å£°æ˜ï¼Œç„¶åå†ä½¿ç”¨è¿ç®—ç¬¦è¿æ¥ï¼Œè¿™æ ·å¯è¯»æ€§å¥½äº›ï¼Œä¾‹å¦‚ï¼š 12345678910111213141516171819202122232425@Aspect@Componentpublic class MyselfAnnotionAspect &#123; //é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼å®šä¹‰åˆ‡ç‚¹ /**@Pointcut(\"execution(* com.enjoyican.demo.selfannotion.service.impl..*(..))\") public void myPointCut()&#123;&#125;; @Pointcut(\"@annotation(MyselfAnnotion)\") public void myAnnoCut()&#123;&#125;; @Pointcut(\"within(com.enjoyican.demo.selfannotion.service..*)\") public void myWithinCut()&#123;&#125;; @Pointcut(\"target(com.enjoyican.demo.selfannotion.service.MyAnnotionTestService)\") public void myTargetCut()&#123;&#125;;*/ @Pointcut(\"@target(MyselfAnnotion)\") public void myAtTargetCut()&#123;&#125;; @Pointcut(\"bean(myAnnotionTestServiceImpl)\") public void myBeanCut()&#123;&#125;; //å®šä¹‰æ–¹æ³•å¢å¼ºç±»å‹ï¼ˆæœ¬ä¾‹å­é‡‡ç”¨ç¯ç»•å¢å¼ºï¼‰ @Around(\"myBeanCut()&amp;&amp;myAtTargetCut()\") public Object around(ProceedingJoinPoint point) throws Throwable &#123; System.out.println(\"AOPåˆ‡é¢åœ¨æ‰§è¡Œserviceæ–¹æ³•ä¹‹å‰å¢å¼º\"); point.proceed(); System.out.println(\"AOPåˆ‡é¢åœ¨æ‰§è¡Œserviceæ–¹æ³•ä¹‹åå¢å¼º\"); return null; &#125;&#125; æ€»ç»“å¯¹äºåˆ‡ç‚¹è¡¨è¾¾å¼çš„ç†Ÿæ‚‰å¯ä»¥ä½¿æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æ›´å¥½çš„å†™å‡ºåŒ¹é…åˆ°æ›´çµæ´»è§„åˆ™çš„ç±»çš„è¡¨è¾¾å¼ï¼Œå¼ºçƒˆå»ºè®®çœ‹ä¸‹å®˜ç½‘ä¸­Aspect Oriented Programming with Springè¿™ä¸€èŠ‚çš„å†…å®¹ï¼Œå¾ˆå¤šæˆ‘ä»¬å¹³æ—¶ç”¨çš„å…¶å®å®˜æ–¹æ–‡æ¡£ä¸Šéƒ½è¯´æ˜äº†ï¼Œè€Œä¸”è¿™é‡Œçš„è‹±æ–‡ç›¸å¯¹ç®€å•ï¼Œé™¤äº†ä¸€äº›ä¸“ä¸šè¯æ±‡å¤–éƒ½æ˜¯å¾ˆé€šä¿—æ˜“æ‡‚çš„è¯­å¥ã€‚","categories":[{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.enjoyican.com/categories/%E6%A1%86%E6%9E%B6/"}],"tags":[{"name":"aop","slug":"aop","permalink":"https://www.enjoyican.com/tags/aop/"},{"name":"aspectj","slug":"aspectj","permalink":"https://www.enjoyican.com/tags/aspectj/"},{"name":"pointcut","slug":"pointcut","permalink":"https://www.enjoyican.com/tags/pointcut/"}]},{"title":"springä¸­è‡ªå®šä¹‰æ³¨è§£","date":"2020-04-06T07:33:57.500Z","path":"posts/custom-annotation/","text":"è‡ªå®šä¹‰æ³¨è§£åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨ï¼Œå½“æ¡†æ¶æä¾›çš„æ³¨è§£æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘éœ€æ±‚æ—¶ä¼šéœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰æ³¨è§£ï¼Œäº†è§£è‡ªå®šä¹‰æ³¨è§£ä¹‹å‰éœ€è¦å…ˆäº†è§£å…ƒæ³¨è§£ï¼Œå³æ‰€è°“æ³¨è§£çš„æ³¨è§£ï¼Œæœ¬æ–‡ä¸è¯¦èŠå…ƒæ³¨è§£çš„æ¦‚å¿µï¼Œç®€å•ç²—æš´ä¸Šç¤ºä¾‹ä»£ç æ¼”ç¤ºå‡ ç§å¸¸è§çš„è‡ªå®šä¹‰æ³¨è§£æ–¹å¼ï¼Œæƒ³äº†è§£å…ƒæ³¨è§£çš„å¯ä»¥æŸ¥çœ‹JAVAç¼–ç¨‹æ€æƒ³ç¬¬å››ç‰ˆç¬¬äºŒåç« æ³¨è§£ä¸€ç« ï¼Œæˆ–è€…ç›´æ¥ç½‘ä¸Šæ‰¾åšå®¢å†…å®¹ä¼šæœ‰å¾ˆå¤šï¼Œä¸‹é¢å¼€å§‹æ­£æ–‡ã€‚ Controllerå±‚æ³¨è§£-ç»“åˆspringæ‹¦æˆªå™¨è‡ªå®šä¹‰æ³¨è§£é’ˆå¯¹controllerå±‚çš„æ³¨è§£ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰æ³¨è§£ç»“åˆspringæ‹¦æˆªå™¨çš„æ–¹å¼ï¼š 1. è‡ªå®šä¹‰æ³¨è§£é¦–å…ˆä½ éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ï¼Œæ³¨è§£çš„å®šä¹‰é‡‡ç”¨å…³é”®å­—@interfaceæ¥å®šä¹‰ï¼Œå¦‚ä¸‹ 1234567891011//å…³äºå…ƒæ³¨è§£çš„çŸ¥è¯†å¯ä»¥ç½‘ä¸ŠæŸ¥çœ‹èµ„æ–™@Retention(RetentionPolicy.RUNTIME)//è¯¥æ³¨è§£åªç”¨åœ¨æ–¹æ³•ä¸Šï¼Œç”¨åœ¨å…¶ä»–åœ°æ–¹çš„å¯ä»¥æŸ¥çœ‹å…ƒæ³¨è§£çš„å…¶ä»–æšä¸¾å€¼ï¼Œä¸èµ˜è¿°@Target(ElementType.METHOD)public @interface MyselfAnnotion &#123; //æ³¨è§£çš„å˜é‡æ”¯æŒåŸºæœ¬æ•°æ®ç±»å‹ï¼Œå­—ç¬¦ä¸²ï¼Œæšä¸¾ï¼Œä»¥åŠå¯¹åº”çš„æ•°ç»„ç±»å‹ String name() default \"guanyu\"; int age() default 18; boolean isHero() default true; String[] bros() default &#123;&#125;;&#125; 2. è‡ªå®šä¹‰æ‹¦æˆªå™¨å¤„ç†æ³¨è§£å½“ä½ å®šä¹‰å¥½äº†æ³¨è§£åï¼Œä½ éœ€è¦è‡ªå®šä¹‰å¤„ç†è¯¥æ³¨è§£çš„æ‹¦æˆªå™¨ï¼Œåœ¨æ‹¦æˆªå™¨ä¸­è¿›è¡Œä¸šåŠ¡çš„å¤„ç†ï¼Œè‡ªå®šä¹‰æ‹¦æˆªå™¨å®ç°springæä¾›çš„æ¥å£HandlerInterceptorå³å¯ï¼Œå¦‚ä¸‹ springæä¾›çš„æ‹¦æˆªå™¨æ¥å£å¦‚ä¸‹ï¼š 123456789101112131415161718public interface HandlerInterceptor &#123; //è¯·æ±‚å‘é€åˆ°Controllerä¹‹å‰è°ƒç”¨ default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; return true; &#125; //è¯·æ±‚å‘é€åˆ°Controllerä¹‹åè°ƒç”¨ default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception &#123; &#125; //å®Œæˆè¯·æ±‚çš„å¤„ç†çš„å›è°ƒæ–¹æ³• default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception &#123; &#125;&#125; å¯ä»¥çœ‹åˆ°springæä¾›çš„æ‹¦æˆªå™¨æ¥å£ä¸»è¦æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ç”¨æ¥å¤„ç†ä¸åŒé˜¶æ®µçš„è¯·æ±‚ï¼ŒæŒ‰ç…§è‡ªå·±é¡¹ç›®çš„éœ€è¦é‡å†™å…¶ä¸­çš„æ–¹æ³•å³å¯ï¼Œæ¯”å¦‚æœ‰æ—¶å€™åœ¨controllerä½ éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£æ¥æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œç™»å½•ä¹‹åå°†ç”¨æˆ·ä¿¡æ¯å­˜åœ¨threadLocalä¸­ä¾›åç»­è°ƒç”¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨preHandleæ–¹æ³•ä¸­å®ç°ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ï¼Œå½“ä¸€æ¬¡è¯·æ±‚å®Œæˆä¹‹åï¼Œä½ åˆéœ€è¦å°†threadlocalä¸­çš„ä¿¡æ¯removeæ‰ï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨afterCompletionæ–¹æ³•ä¸­è¿›è¡Œé‡Šæ”¾ï¼Œæœ¬ä¾‹å­ä¸­å±•ç¤ºç®€å•çš„åœ¨è¯·æ±‚å‘é€åˆ°controllerä¹‹å‰çš„å¤„ç†ï¼Œå› æ­¤åªé‡å†™preHandleæ–¹æ³•,å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637@Component@Slf4jpublic class MyAnnotionInterceptor implements HandlerInterceptor &#123; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; if (handler instanceof HandlerMethod)&#123; HandlerMethod method = (HandlerMethod) handler; //1è·å–æ–¹æ³•ä¸Šçš„æ³¨è§£ MyselfAnnotion methodAnnotation = method.getMethodAnnotation(MyselfAnnotion.class); //2è·å–ç±»ä¸Šçš„æ³¨è§£ //MyselfAnnotion annotation = method.getBeanType().getAnnotation(MyselfAnnotion.class); //3è·å–ç±»ä¸­å±æ€§çš„æ³¨è§£ /*Field[] declaredFields = method.getBeanType().getDeclaredFields(); for (Field field:declaredFields)&#123; field.setAccessible(true); MyselfAnnotion annotation = field.getAnnotation(MyselfAnnotion.class); &#125;*/ if (null == methodAnnotation)&#123; return true; &#125; if (MyAnnotionEnum.GUANYU.getName().equals(methodAnnotation.name()))&#123; System.out.println(\"æ‹¦æˆªå™¨æ£€æµ‹åˆ°æ˜¯äº”è™ä¸Šå°†\" + methodAnnotation.name()); &#125;else &#123; System.out.println(\"æ‹¦æˆªå™¨æ£€æµ‹åˆ°ä¸æ˜¯å…³ç¾½ï¼Œæ˜¯\"+ methodAnnotation.name() +\"ä¸èƒ½é€šå…³\"); return false; &#125; if (MyAnnotionEnum.GUANYU.getAge().equals(methodAnnotation.age()))&#123; System.out.println(\"æ‹¦æˆªå™¨æ£€æµ‹åˆ°è¿™æ˜¯18å²çš„å…³ç¾½ï¼Œå¨çŒ›ï¼Œè¿‡å…³\"); return true; &#125;else &#123; System.out.println(\"æ‹¦æˆªå™¨æ£€æµ‹åˆ°è¿™ä¸ªå…³ç¾½è€äº†ï¼Œä¸èƒ½é€šå…³\"); return false; &#125; &#125; return false; &#125;&#125; 1234567891011//æ‹¦æˆªå™¨ä¸­ç”¨åˆ°çš„æšä¸¾ç±»@Getter@AllArgsConstructorpublic enum MyAnnotionEnum &#123; LIUBEI(\"liubei\",48), ZHANGFEI(\"zhangfei\",24), GUANYU(\"guanyu\",18); private String name; private Integer age;&#125; ä¸Šé¢è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ä¸­ï¼Œåœ¨preHandleæ–¹æ³•ä¸­æœ‰å¦‚ä¸‹çš„é€»è¾‘ï¼Œé¦–å…ˆè·å–åˆ¤å®šè¯¥handleræ˜¯å¦æ˜¯handlermethodå®ä¾‹,å…³äºhandlermethodå¯ä»¥ç†è§£ä¸ºå­˜å‚¨ç€controllerä¸­æ¯ä¸ª@RequestMappingæ³¨è§£æ–¹æ³•çš„å¯¹è±¡ï¼Œå¯ä»¥ä¸Šå®˜ç½‘äº†è§£ä¸‹ï¼šspringmvcï¼Œè¿™é‡Œç®€å•è¯´ä¸‹ç†è§£ï¼š Spring MVCåº”ç”¨å¯åŠ¨æ—¶ä¼šæœé›†å¹¶åˆ†ææ¯ä¸ªWebæ§åˆ¶å™¨æ–¹æ³•ï¼Œä»ä¸­æå–å¯¹åº”çš„&quot;&lt;è¯·æ±‚åŒ¹é…æ¡ä»¶,æ§åˆ¶å™¨æ–¹æ³•&gt;&quot;æ˜ å°„å…³ç³»ï¼Œå½¢æˆä¸€ä¸ªæ˜ å°„å…³ç³»è¡¨ä¿å­˜åœ¨ä¸€ä¸ªRequestMappingHandlerMapping beanä¸­ã€‚ç„¶ååœ¨å®¢æˆ·è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå†ä½¿ç”¨RequestMappingHandlerMappingä¸­çš„è¯¥æ˜ å°„å…³ç³»è¡¨æ‰¾åˆ°ç›¸åº”çš„æ§åˆ¶å™¨æ–¹æ³•å»å¤„ç†è¯¥è¯·æ±‚ã€‚åœ¨RequestMappingHandlerMappingä¸­ä¿å­˜çš„æ¯ä¸ªâ€&lt;è¯·æ±‚åŒ¹é…æ¡ä»¶,æ§åˆ¶å™¨æ–¹æ³•&gt;&quot;æ˜ å°„å…³ç³»å¯¹å„¿ä¸­,â€è¯·æ±‚åŒ¹é…æ¡ä»¶â€é€šè¿‡RequestMappingInfoåŒ…è£…å’Œè¡¨ç¤ºï¼Œè€Œâ€æ§åˆ¶å™¨æ–¹æ³•â€åˆ™é€šè¿‡HandlerMethodæ¥åŒ…è£…å’Œè¡¨ç¤ºã€‚(æƒ³äº†è§£è¿™éƒ¨åˆ†å†…å®¹çš„å¯ä»¥æŸ¥çœ‹springæŠ€æœ¯å†…å¹•-è®¡æ–‡æŸ¯ç¬¬äºŒç‰ˆä¸­p166ï¼Œç¬¬4.4.4å°èŠ‚ Mvcå¤„ç†HTTPåˆ†å‘è¯·æ±‚è¿™ä¸€å°èŠ‚ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹springæºç æ·±åº¦è§£æ-éƒä½³ä¸€ä¹¦ä¸­p291ï¼Œç¬¬11ç«  springmvc) ä¸€ä¸ªHandlerMethodå¯¹è±¡ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å¯¹å¦‚ä¸‹ä¿¡æ¯çš„ä¸€ä¸ªåŒ…è£… :Object bean Webæ§åˆ¶å™¨æ–¹æ³•æ‰€åœ¨çš„Webæ§åˆ¶å™¨beanã€‚å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨beançš„åç§°;ä¹Ÿå¯ä»¥æ˜¯beanå®ä¾‹å¯¹è±¡æœ¬èº«ã€‚Class beanType Webæ§åˆ¶å™¨æ–¹æ³•æ‰€åœ¨çš„Webæ§åˆ¶å™¨beançš„ç±»å‹,å¦‚æœè¯¥beanè¢«ä»£ç†ï¼Œè¿™é‡Œè®°å½•çš„æ˜¯è¢«ä»£ç†çš„ç”¨æˆ·ç±»ä¿¡æ¯Method method Webæ§åˆ¶å™¨æ–¹æ³•Method bridgedMethod è¢«æ¡¥æ¥çš„Webæ§åˆ¶å™¨æ–¹æ³•MethodParameter[] parameters Webæ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°ä¿¡æ¯:æ‰€åœ¨ç±»æ‰€åœ¨æ–¹æ³•,å‚æ•°,ç´¢å¼•,å‚æ•°ç±»å‹HttpStatus responseStatus æ³¨è§£@ResponseStatusçš„codeå±æ€§String responseStatusReason æ³¨è§£@ResponseStatusçš„reasonå±æ€§ å¦‚æœè¯¥handleræ˜¯handlermethodå®ä¾‹ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æœ‰è‡ªå®šä¹‰æ³¨è§£MyselfAnnotionåœ¨æ–¹æ³•ä¸Šï¼Œå¦‚æœæ²¡æœ‰ç›´æ¥è¿”å›trueæ”¾è¡Œï¼Œå¦‚æœæœ‰ç»§ç»­åˆ¤æ–­æ³¨è§£ä¸­nameæ˜¯å¦å…³ç¾½ï¼Œæ˜¯å¦å¹´é¾„18ï¼Œä¸¤è€…éƒ½æ»¡è¶³å°±æ”¾è¡Œï¼Œä¸æ»¡è¶³åˆ™ä¸æ”¾è¡Œã€‚ 3. å°†è‡ªå®šä¹‰æ‹¦æˆªå™¨æ³¨å†Œè¿›webMvcæ‹¦æˆªå™¨é“¾å¹¶å®šä¹‰æ‹¦æˆªè·¯ç”±123456789101112131415/** * æ³¨å†Œæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªç‰¹å®šè¯·æ±‚ */@Configurationpublic class MyAnnotionInterceptorConfig extends WebMvcConfigurationSupport &#123; //æ³¨å…¥è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ @Autowired private MyAnnotionInterceptor myAnnotionInterceptor; //æ³¨å†Œæ‹¦æˆªå™¨å¹¶å®šä¹‰æ‹¦æˆªè·¯ç”± @Override public void addInterceptors(InterceptorRegistry registry) &#123; registry.addInterceptor(myAnnotionInterceptor).addPathPatterns(\"/testMyselfAnno/**\"); super.addInterceptors(registry); &#125;&#125; è‡³æ­¤ï¼Œç»“åˆæ‹¦æˆªå™¨è‡ªå®šä¹‰çš„æ³¨è§£å·²ç»å®Œæˆï¼Œå¯ä»¥ç¼–å†™æµ‹è¯•ç±»controlleræµ‹è¯•ä¸‹ï¼Œå¦‚ä¸‹ï¼š 4. ç¼–å†™æµ‹è¯•Controllerç±»1234567891011121314151617181920212223@RequestMapping(\"/testMyselfAnno/no\") @MyselfAnnotion(name = \"guanyu\", age = 50) public void testMyAnnotion1()&#123; System.out.println(\"è™½ç„¶æ˜¯å…³ç¾½ï¼Œä½†æ˜¯å¹´é¾„å¤§äº†ï¼Œæ²¡é€šè¿‡æ ¡éªŒ\"); &#125; @RequestMapping(\"/yes\") @MyselfAnnotion(name = \"guanyu\", age = 50) public void testMyAnnotion2()&#123; System.out.println(\"è™½ç„¶æœ‰æ³¨è§£ï¼Œä½†æ˜¯è·¯å¾„ä¸å±äºæ‹¦æˆªèŒƒå›´ï¼Œé€šè¿‡æ ¡éªŒ,è¿›å…¥æ–¹æ³•ä½“\"); &#125; @RequestMapping(\"/testMyselfAnno/liubei/no\") @MyselfAnnotion(name = \"liubei\", age = 48) public void testMyAnnotion3()&#123; System.out.println(\"ä¸æ˜¯å…³ç¾½ï¼Œæ— æ³•é€šè¿‡æ ¡éªŒ\"); &#125; @RequestMapping(\"/testMyselfAnno/defaultyes\") @MyselfAnnotion public void testMyAnnotion4()&#123; System.out.println(\"æ³¨è§£é»˜è®¤å€¼æ˜¯å…³ç¾½ï¼Œè€Œä¸”å¾ˆå¹´è½»ï¼Œé€šè¿‡æ ¡éªŒï¼Œè¿›å…¥æ–¹æ³•ä½“\"); &#125; æˆ‘ä»¬ä¾æ¬¡åœ¨postmanä¸Šè®¿é—®å¯¹åº”çš„æ¥å£ï¼ˆæˆ–è€…é€šè¿‡spring-teståŒ…çš„mockmvcå»mockï¼‰æŸ¥çœ‹å¯¹åº”ç»“æœï¼š 1ï¼‰è®¿é—®æ–¹æ³•testMyAnnotion1ä¸Šçš„è·¯ç”± /testMyselfAnno/no é¦–å…ˆè¯¥è·¯å¾„èƒ½å¤ŸåŒ¹é…ä¸Šæˆ‘ä»¬åœ¨é…ç½®ä¸­é…çš„è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œä¸”è¯¥æ–¹æ³•ä¸Šå«æœ‰@MyselfAnnotionè‡ªå®šä¹‰æ³¨è§£ï¼Œå…¶ä¸­nameçš„ç¡®æ˜¯å…³ç¾½ï¼Œæ‰€ä»¥åœ¨æ‹¦æˆªå™¨å¤„ç†æ—¶ä¼šæ‰“å°å‡º&quot;æ‹¦æˆªå™¨æ£€æµ‹åˆ°æ˜¯äº”è™ä¸Šå°†guanyu&quot;,ä¹‹ååˆ¤å®šå¹´é¾„ï¼Œç”±äºæ³¨è§£ä¸­å¹´é¾„ä¸º50ï¼Œæ‹¦æˆªå™¨å¤„ç†æ—¶ä¼šæ‰“å°å‡º&quot;æ‹¦æˆªå™¨æ£€æµ‹åˆ°è¿™ä¸ªå…³ç¾½è€äº†ï¼Œä¸èƒ½é€šå…³&quot;,ä¹‹åè¿”å›falseï¼Œä¸ä¼šèµ°è¿›æ–¹æ³•ä¸­çš„å…·ä½“æ‰“å°ã€‚ è®¿é—®æ¥å£1 å…¶ä»–ä¾‹å­ä¹Ÿå¯è‡ªè¡Œåˆ†æåè‡ªæµ‹ä½“éªŒä¸‹ã€‚ Serviceå±‚æ³¨è§£-ç»“åˆSpringAOPè‡ªå®šä¹‰æ³¨è§£1. è‡ªå®šä¹‰æ³¨è§£æ³¨è§£è¿˜æ˜¯é‡‡ç”¨ä¸Šæ–‡ä¸­çš„æ³¨è§£@MyselfAnnotion 2.è‡ªå®šä¹‰åˆ‡é¢å¤„ç†æ³¨è§£åœ¨è‡ªå®šä¹‰åˆ‡é¢ä¹‹å‰ï¼Œå…ˆåœ¨ä¹‹å‰çš„Controllerå±‚æ–°å¢åŠ ä¸€ä¸ªæ¥å£å¦‚ä¸‹ï¼š 1234567891011121314@RestControllerpublic class MyAnnotionTestController&#123; @Autowired private MyAnnotionTestService myAnnotionTestService; @RequestMapping(\"/test/aop\") @MyselfAnnotion public void testMyAnnotion5()&#123; System.out.println(\"æˆ‘æ¥è‡ªControllerå±‚ï¼Œæˆ‘ç”¨æ¥æµ‹è¯•è‡ªå®šä¹‰æ³¨è§£\"); myAnnotionTestService.testAopAnnotion(); &#125;&#125; ä¹‹åå®šä¹‰serviceå±‚æ¥å£åŠå®ç°ç±»å¦‚ä¸‹ï¼š 12345678910111213//æ¥å£public interface MyAnnotionTestService &#123; void testAopAnnotion();&#125;//å®ç°ç±»@Servicepublic class MyAnnotionTestServiceImpl implements MyAnnotionTestService &#123; @Override @MyselfAnnotion public void testAopAnnotion() &#123; System.out.println(\"æˆ‘æ¥è‡ªserviceå±‚ï¼Œæˆ‘ç”¨æ¥æµ‹è¯•è‡ªå®šä¹‰æ³¨è§£\"); &#125;&#125; ç”±äºæœ¬æ¡ˆä¾‹å±•ç¤ºserviceå±‚çš„æ³¨è§£ä¸AOPåˆ‡é¢çš„ç»“åˆï¼Œæ‰€ä»¥æš‚æ—¶åœ¨ç¤ºä¾‹æ—¶æŒ‡å®šåˆ‡ç‚¹è¡¨è¾¾å¼å…·ä½“åˆ°serviceå±‚ï¼Œä¸‹é¢å®šä¹‰åˆ‡é¢ï¼Œå¦‚ä¸‹ 123456789101112131415161718@Aspect@Componentpublic class MyselfAnnotionAspect &#123; //é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼å®šä¹‰åˆ‡ç‚¹ @Pointcut(\"execution(* com.enjoyican.demo.selfannotion.service.impl..*(..))\") public void myPointCut()&#123;&#125;; @Pointcut(\"@annotation(MyselfAnnotion)\") public void myAnnoCut()&#123;&#125;; //å®šä¹‰æ–¹æ³•å¢å¼ºç±»å‹ï¼ˆæœ¬ä¾‹å­é‡‡ç”¨ç¯ç»•å¢å¼ºï¼‰ @Around(\"myAnnoCut()&amp;&amp;myPointCut()\") public Object around(ProceedingJoinPoint point) throws Throwable &#123; System.out.println(\"AOPåˆ‡é¢åœ¨æ‰§è¡Œserviceæ–¹æ³•ä¹‹å‰å¢å¼º\"); point.proceed(); System.out.println(\"AOPåˆ‡é¢åœ¨æ‰§è¡Œserviceæ–¹æ³•ä¹‹åå¢å¼º\"); return null; &#125;&#125; é¦–å…ˆä¸Šé¢çš„åˆ‡é¢å®šä¹‰äº†ä¸¤ä¸ªåˆ‡ç‚¹ï¼Œä¸€ä¸ªæ˜¯å®šä¹‰åˆ°service.implåŒ…ä¸‹,å¦ä¸€ä¸ªå®šä¹‰æˆå¸¦æœ‰æ³¨è§£MyselfAnnotionçš„ç±»ï¼Œç„¶åå®šä¹‰ä¸€ä¸ªç¯ç»•å¢å¼ºï¼Œåˆ‡ç‚¹è¡¨è¾¾å¼é‡‡ç”¨ä¸¤è€…ç»“åˆå³å¯å®šä½åˆ°å¯¹åº”çš„serviceå±‚ä¸‹é¢æ‰“äº†@MyselfAnnotionæ³¨è§£çš„ç±»ä¸­ï¼ˆæœ¬ä¾‹å­ä¹‹æ‰€ä»¥è¿™ä¹ˆå®šä¹‰æ˜¯ä¸ºäº†ç¨åæ¼”ç¤ºæ–¹ä¾¿ï¼Œåˆ‡ç‚¹è¡¨è¾¾å¼ä¹Ÿå¯ä»¥åˆæˆä¸€ä¸ªï¼Œåé¢æˆ‘ä¼šä¸“é—¨è¯´ä¸‹springä¸­åˆ‡ç‚¹è¡¨è¾¾å¼çš„æ¡ˆä¾‹çš„ï¼‰ ç°åœ¨çš„IDEAæ™ºèƒ½æç¤ºéå¸¸æ–¹ä¾¿ï¼Œå½“ä½ çš„åˆ‡é¢å®šä¹‰å¥½åï¼Œåœ¨å¢å¼ºæ–¹æ³•å¯¹åº”åœ°æ–¹å…‰æ ‡ä¼šæ˜¾ç¤ºå¢å¼ºäº†å“ªäº›æ–¹æ³•ï¼Œæ¯”å¦‚æŒ‰ç…§æˆ‘ä¸Šé¢çš„å†™æ³•ï¼Œä¼šå‡ºç°å¦‚ä¸‹æç¤ºï¼š IDEAæç¤º IDEAæç¤º 3. æµ‹è¯•æ³¨è§£å¦‚ä¸Šé¢åˆ‡é¢å®šä¹‰å¥½äº†ï¼Œåœ¨åˆ‡é¢ä¸­æˆ‘ä»¬åšäº†ä¸€ä»¶äº‹å°±æ˜¯åœ¨æ‰§è¡Œserviceæ–¹æ³•çš„å‰åæ‰“å°äº†ä¸¤å¥è¯ï¼ˆåœ¨å®é™…ä¸šåŠ¡ä¸­å¯ä»¥æ˜¯åœ¨æ‰§è¡Œserviceæ–¹æ³•å‰åè¿›è¡Œä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚æ‰“å°å…¥å‚ï¼Œè¿”å›å€¼æˆ–å…¶ä»–åŠŸèƒ½ï¼‰ï¼Œæ¥ä¸‹æ¥é€šè¿‡postmanè·‘ä¸‹å¯¹åº”çš„æ¥å£ï¼Œå¾—åˆ°å¦‚ä¸‹å“åº”ï¼š æ³¨è§£å“åº” å¯ä»¥çœ‹åˆ°è™½ç„¶æˆ‘ä»¬åœ¨controllerå±‚å’Œserviceå±‚éƒ½åŠ äº†@MyselfAnnotionæ³¨è§£ï¼Œä½†æ˜¯æˆ‘ä»¬åˆ‡é¢åªå¤„ç†serviceå±‚çš„ï¼Œæ‰€ä»¥åœ¨æ‰“å°controllerå±‚çš„â€œæˆ‘æ¥è‡ªControllerå±‚ï¼Œæˆ‘ç”¨æ¥æµ‹è¯•è‡ªå®šä¹‰æ³¨è§£â€è¿™å¥è¯çš„å‰åå¹¶æ²¡æœ‰è¿›è¡Œå¢å¼ºï¼Œè€ŒserviceæŒ‰ç…§æˆ‘ä»¬æƒ³çš„è¿›è¡Œäº†æ–¹æ³•å¢å¼ºã€‚ ä¸Šé¢ä¸¾çš„ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œå®é™…ä¸šåŠ¡ä¸­å°†æ³¨è§£ç”¨åˆ°serviceå±‚æŸäº›æ–¹æ³•ä¹‹ä¸Šæ¥å®ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘çš„æƒ…å†µå¾ˆå¸¸è§ï¼Œç›¸æ¯”ä»…ä»…ç”¨åˆ‡é¢å»æ§åˆ¶ï¼Œé€šè¿‡ä¸€ä¸ªæ³¨è§£æ§åˆ¶çš„åŠ›åº¦æ›´ç»†æ›´çµæ´»ä¸€äº›ï¼Œä¹Ÿæ›´æ–¹ä¾¿æ“ä½œã€‚ å¦å¤–æœ¬ä¾‹ä¸­è™½ç„¶ä»¥åœ¨serviceå±‚é€šè¿‡æ³¨è§£åŠ AOPçš„å½¢å¼æ¥è‡ªå®šä¹‰æ³¨è§£å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®é™…ä¸Šcontrollerå±‚çš„æœ‰äº›åœºæ™¯ä¹Ÿå¯ä»¥ç”¨aopæ¥æ§åˆ¶ï¼Œå¹¶ä¸æ˜¯å¿…é¡»è¦é‡‡ç”¨æ‹¦æˆªå™¨ï¼Œè¿™ä¸ªè¦çœ‹ä½ å…·ä½“æƒ³è·å–çš„æ˜¯å“ªäº›ä¿¡æ¯ä»¥åŠéœ€è¦åœ¨å“ªä¸ªé˜¶æ®µå¢å¼ºæœ‰å…³ï¼Œå¦‚æœç”¨aopæ§åˆ¶çš„è¯ä¹Ÿå°±æ˜¯åˆ‡ç‚¹è¡¨è¾¾å¼æ€ä¹ˆå†™çš„é—®é¢˜ã€‚ æ¯”å¦‚ï¼Œåœ¨ä¸Šé¢ä¾‹å­ä¸­ï¼ŒåŠ å…¥å°†ç¯ç»•å¢å¼ºå˜æˆå¦‚ä¸‹å½¢å¼ï¼š 123456789//å®šä¹‰æ–¹æ³•å¢å¼ºç±»å‹ï¼ˆæœ¬ä¾‹å­é‡‡ç”¨ç¯ç»•å¢å¼ºï¼‰ @Around(\"myAnnoCut()\") public Object around(ProceedingJoinPoint point) throws Throwable &#123; System.out.println(\"AOPåˆ‡é¢åœ¨æ‰§è¡Œserviceæ–¹æ³•ä¹‹å‰å¢å¼º\"); point.proceed(); System.out.println(\"AOPåˆ‡é¢åœ¨æ‰§è¡Œserviceæ–¹æ³•ä¹‹åå¢å¼º\"); return null; &#125; æ­¤æ—¶æˆ‘ä»¬çš„å¢å¼ºå¯¹è±¡æ˜¯æ‰€æœ‰æ‰“äº†@MyselfAnnotionæ³¨è§£çš„æ–¹æ³•ï¼Œå› æ­¤è¿™ä¸ªæƒ…å†µä¸‹controllerå±‚çš„æ–¹æ³•ä¹Ÿä¼šè¢«å¢å¼ºï¼Œæ­¤æ—¶IDEAçš„æç¤ºä¹Ÿä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œå¦‚ä¸‹å›¾ï¼š IDEAæç¤º å› ä¸ºæ­¤æ—¶è¢«å¢å¼ºçš„æ–¹æ³•å¤šäº†ï¼Œæ‰€ä»¥ç‚¹å‡»æ—¶å€™ä¼šæ˜¾ç¤ºéƒ½æœ‰å“ªäº›è¢«å¢å¼ºã€‚æ­¤æ—¶æˆ‘ä»¬å†è®¿é—®åˆšæ‰çš„æ¥å£ï¼Œå¾—åˆ°çš„å“åº”å¦‚ä¸‹ï¼š æ³¨è§£å“åº” å¯çœ‹åˆ°åœ¨controllerå’Œserviceå±‚æ–¹æ³•æ‰§è¡Œå‰åï¼Œéƒ½è¢«å¢å¼ºäº†ï¼ˆå¿½ç•¥ä¸Šé¢AOPæç¤ºä¸­éƒ½æ˜¯æ˜¾ç¤ºserviceå¢å¼ºï¼‰ å‚æ•°æ ¡éªŒå‹è‡ªå®šä¹‰æ³¨è§£åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€ç±»æ³¨è§£ä¸å¾—ä¸æï¼Œå°±æ˜¯é€šå¸¸ç”¨æ¥å¯¹æ–¹æ³•å…¥å‚è¿›è¡Œæ ¡éªŒçš„æ³¨è§£ã€‚å¯¹æ–¹æ³•å…¥å‚è¿›è¡Œæ ¡éªŒï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡aopæ¥å¤„ç†ï¼Œé€šè¿‡è·å–å±æ€§ä¸Šçš„æ³¨è§£ï¼Œè¿›è¡Œåˆ¤å®šã€‚åœ¨springmvcä¸­ï¼Œæˆ‘ä»¬å€ŸåŠ©å¸¸ç”¨çš„hibernate-validatorå³å¯å®ç°å¤§éƒ¨åˆ†å…¥å‚çš„æ ¡éªŒï¼Œå…³äºä½¿ç”¨hibernate-validatorè¿›è¡Œæ ¡éªŒçš„çŸ¥è¯†ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£æˆ–è€…ä»ç½‘ä¸Šæœç´¢ç›¸å…³èµ„æºå³å¯ï¼Œæœ¬å°ç»“ä¸å¯¹æ­¤åšç‰¹åˆ«è¯´æ˜ï¼Œä¹Ÿå¯ä»¥çœ‹ä¸‹å¦‚ä¸‹åšå®¢åŸºäºæ³¨è§£æ ¡éªŒå…¥å‚ï¼Œspringç»„ä»¶å‚æ•°æ ¡éªŒ æœ‰æ—¶å€™æˆ‘ä»¬çš„éœ€æ±‚åœ¨ç°æœ‰çš„æ³¨è§£ä¸­å¯èƒ½æ²¡æ‰¾åˆ°åˆé€‚çš„ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰æ³¨è§£ ï¼Œæœ¬ä¾‹å­ä¸­è¯´æ˜ä¸€ä¸ªè‡ªå®šä¹‰æ ¡éªŒå…¥å‚ä¸­æšä¸¾å€¼æ˜¯å¦ç¬¦åˆç°æœ‰æšä¸¾å€¼çš„è‡ªå®šä¹‰æ³¨è§£ï¼Œå‰ç½®çŸ¥è¯†å¯ä»¥çœ‹ä¸‹è¿™ç¯‡åšå®¢ 1.è‡ªå®šä¹‰æ³¨è§£12345678910111213141516@Documented//æ³¨æ„è¿™ä¸ªæ³¨è§£@Constraint(validatedBy = &#123;ValidEnumValueValidator.class&#125;)@Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER&#125;)@Retention(RUNTIME)public @interface ValidEnumValue &#123; String message() default \"ä¸æ˜¯æœ‰æ•ˆçš„æšä¸¾å€¼\"; Class&lt;?&gt;[] groups() default &#123;&#125;; Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;; //è¿™é‡Œçš„ValidityInterpretableæ¥å£åœ¨åé¢å®šä¹‰ Class&lt;? extends ValidityInterpretable&gt; enumType();&#125; 2.å®šä¹‰@Constraintä¸­ç”¨åˆ°çš„æ ¡éªŒè§„åˆ™ç±»åœ¨æœ¬ä¾‹ä¸­å³ä¸ºValidEnumValueValidatorï¼Œæ³¨æ„éœ€è¦å®ç°ConstraintValidator&lt;ValidEnumValue, Integer&gt;æ¥å£ï¼Œæ³›å‹æ¥å£ä¸­çš„ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯è‡ªå®šä¹‰çš„æ³¨è§£ValidEnumValueï¼Œå¦å¤–ä¸€ä¸ªä¸ºè‡ªå®šä¹‰çš„æ ¡éªŒæ³¨è§£ä¸­æ ¡éªŒå€¼çš„ç±»å‹ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡éœ€è¦ç¡®å®š å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829public class ValidEnumValueValidator implements ConstraintValidator&lt;ValidEnumValue, Integer&gt; &#123; private ValidityInterpretable validityInterpretable; private boolean isEmpty; @Override public void initialize(ValidEnumValue constraintAnnotation) &#123; //åˆå§‹åŒ–åŠ è½½æ‰€æœ‰æšä¸¾ç±» ValidityInterpretable[] enumConstants = constraintAnnotation.enumType().getEnumConstants(); if (enumConstants.length == 0) &#123; isEmpty = true; &#125; validityInterpretable = enumConstants[0]; &#125; @Override public boolean isValid(Integer value, ConstraintValidatorContext context) &#123; //åˆ¤æ–­æœ‰æ•ˆæ€§çš„å…·ä½“é€»è¾‘ç”±å­ç±»é‡å†™ if (value == null) &#123; return true; &#125; if (isEmpty) &#123; return false; &#125; return validityInterpretable.isValid(value); &#125;&#125; 3.å®šä¹‰å¯¹åº”çš„å­ç±»é‡å†™çˆ¶ç±»ä¸­çš„æ–¹æ³•,å³ç›¸å…³çš„æ ¡éªŒé€»è¾‘é¦–å…ˆå®šä¹‰æ³¨è§£ä¸­ç”¨åˆ°çš„ValidityInterpretableæ¥å£ 1234567public interface ValidityInterpretable &#123; /** * åˆ¤æ–­valueå¯¹è¯¥enumè€Œè¨€æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æšä¸¾å€¼ */ boolean isValid(Integer value);&#125; å…¶æ¬¡å®šä¹‰ä¸€ä¸ªå­ç±»å®ç°è¯¥æ¥å£ï¼Œé‡å†™æ ¡éªŒçš„æ–¹æ³•ï¼Œè¯¥å­ç±»ä¸ºæˆ‘ä»¬æšä¸¾å€¼å®šä¹‰çš„ç±»ï¼š 1234567891011121314151617181920212223242526@AllArgsConstructor@Getterpublic enum IdolOrderEnum implements ValidityInterpretable &#123; /** * è”¡å¾å¤ */ CAI_XU_KUN(1), /** * é™ˆç«‹å†œ */ CHEN_LI_NONG(2), /** * èŒƒä¸ä¸ */ FAN_CHEN_CHEN(3); private Integer value; @Override public boolean isValid(Integer value) &#123; return Arrays.stream(values()).anyMatch(one -&gt; one.getValue().equals(value)); &#125;&#125; åœ¨ä¸Šé¢çš„æšä¸¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¶åƒæ’åçš„æšä¸¾ç±»ï¼ˆæ­¤å¤„å¼•ç”¨å¶åƒç»ƒä¹ ç”Ÿninepercentå‡ºé“æ’åï¼Œæ²¡åˆ«çš„åŸå› ï¼Œä»…ä»…æ˜¯ä»Šå¤©å¾®åšçƒ­æœä¸Šçœ‹åˆ°çš„ï¼‰ï¼Œå…¶ä¸­æä¾›äº†ä¸€ä¸ªisValidæ–¹æ³•ç”¨æ¥æ ¡éªŒæ‰€æœ‰çš„æšä¸¾å€¼valueä¸­æœ‰æ²¡æœ‰ä¸æˆ‘ä¼ å…¥çš„valueç›¸åŒçš„ï¼Œæœ‰è¯´æ˜è¯¥å…¥å‚ç¬¦åˆè§„èŒƒï¼Œæ²¡æœ‰è¯´æ˜å…¥å‚ä¸ç¬¦åˆè§„çŸ©ï¼Œä¸‹é¢ç¼–å†™ä¸€ä¸ªæµ‹è¯•ç±»æ¥è¯´æ˜ 4.æ³¨è§£çš„ä½¿ç”¨æ³¨è§£çš„ä½¿ç”¨ï¼Œåœ¨å…¥å‚dtoä¸­éœ€è¦æ ¡éªŒå­—æ®µæœ‰æ•ˆæ€§çš„åœ°æ–¹ï¼Œæ‰“ä¸Šè‡ªå®šä¹‰çš„æ³¨è§£ï¼Œæ¥åˆ¤æ–­å‰ç«¯æˆ–è€…apiè°ƒç”¨ä¸­å¯¹æ–¹ä¼ æ¥çš„å‚æ•°æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼š é¦–å…ˆå®šä¹‰ä¸€ä¸ªå…¥å‚DTOå¯¹è±¡ï¼š 12345678910@Data@ToStringpublic class MyRequest &#123; @NotNull //æ­¤å¤„æ‰“ä¸Šå¯¹åº”çš„æ³¨è§£ï¼Œæ³¨æ˜æ ¡éªŒçš„æšä¸¾ç±» @ValidEnumValue(enumType = IdolOrderEnum.class) private Integer order; private String name;&#125; ä¹‹åä¾ç„¶é‡‡ç”¨ä¹‹å‰çš„MyAnnotionTestControlleråœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š 1234567891011@RequestMapping(\"/test/validator\") public void testMyAnnotion6(@RequestBody @Valid MyRequest request, BindingResult result)&#123; if (result.hasErrors())&#123; List&lt;FieldError&gt; fieldErrors = result.getFieldErrors(); for (FieldError error : fieldErrors) &#123; //å¯ä»¥è¿”å›å…·ä½“çš„é”™è¯¯å¼‚å¸¸ System.out.println(error.getField()+error.getDefaultMessage()); &#125; &#125; System.out.println(\"æµ‹è¯•å…¥å‚æ ¡éªŒè‡ªå®šä¹‰æ³¨è§£,å…¥å‚ï¼š\"+request.toString()); &#125; ä¹‹åç”¨postmanè®¿é—®ï¼ŒåŠ å…¥æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæšä¸¾ä¸­æ²¡æœ‰çš„å€¼ï¼Œorder=4ï¼Œå°±ä¼šæ— æ³•é€šè¿‡æ ¡éªŒï¼Œå¦‚ä¸‹ï¼š æ³¨è§£å“åº” å¦‚æœæˆ‘ä»¬ä¼ å…¥æ­£ç¡®çš„å€¼ï¼Œå°±ä¼šé€šè¿‡æ ¡éªŒï¼Œæ‰§è¡Œæ–¹æ³•åé¢çš„ä»£ç ï¼š æ³¨è§£å“åº” æ€»ç»“ä»¥ä¸Šæ€»ç»“äº†ç»“åˆæ‹¦æˆªå™¨ï¼Œaopï¼Œä»¥åŠ@Constraintæ³¨è§£æ¥å¤„ç†è‡ªå®šä¹‰æ³¨è§£çš„æ¡ˆä¾‹ï¼Œåœ¨å®é™…å¼€å‘ä¸­è‡ªå®šä¹‰æ³¨è§£æ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬å¼€å‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ªå®šä¹‰æ³¨è§£çš„ä½¿ç”¨å¹¶ä¸æ˜¯ä¸€å®šè¦ç»“åˆä¸Šé¢ä¸‰ç§æƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“æ³¨è§£é€šè¿‡åå°„å¯ä»¥æ‹¿åˆ°ï¼Œé‚£ä¹ˆæœ‰æ—¶å€™æˆ‘ä»¬åœ¨ç±»å±æ€§å­—æ®µä¸Šçš„æ³¨è§£åªéœ€è¦é€šè¿‡åå°„è·å–ä¹‹åï¼Œè¿›è¡Œå¯¹åº”çš„åˆ¤å®šå’Œä¸šåŠ¡é€»è¾‘å¤„ç†å³å¯ã€‚","categories":[{"name":"spring","slug":"spring","permalink":"https://www.enjoyican.com/categories/spring/"}],"tags":[{"name":"aop","slug":"aop","permalink":"https://www.enjoyican.com/tags/aop/"},{"name":"annotion","slug":"annotion","permalink":"https://www.enjoyican.com/tags/annotion/"}]},{"title":"è½¬è½½-è®¾è®¡æ¨¡å¼ä¹Ÿå¯ä»¥è¿™ä¹ˆç®€å•","date":"2020-03-23T15:22:15.000Z","path":"posts/design-pattern/","text":"éƒ‘é‡å£°æ˜ : æœ¬æ–‡è½¬è½½è‡ªæˆ‘å…³æ³¨çš„ä¸€ä½å¤§ä½¬çš„åšå®¢,åŸæ–‡é“¾æ¥ å¦‚æœ‰ä¾µæƒè¿˜è¯·è”ç³»æœ¬äººåˆ é™¤,ä»…åšçŸ¥è¯†ä¼ æ’­ä¸è®°å½•,æ— å‰½çªƒå†’çŠ¯ä¹‹æ„. å¯åœ¨blog-design-pattern æˆ–CSDNç•™è¨€ ä¸€ç›´æƒ³å†™ä¸€ç¯‡ä»‹ç»è®¾è®¡æ¨¡å¼çš„æ–‡ç« ï¼Œè®©è¯»è€…å¯ä»¥å¾ˆå¿«çœ‹å®Œï¼Œè€Œä¸”ä¸€çœ‹å°±æ‡‚ï¼Œçœ‹æ‡‚å°±ä¼šç”¨ï¼ŒåŒæ—¶ä¸ä¼šå°†å„ä¸ªæ¨¡å¼ææ··ã€‚è‡ªè®¤ä¸ºæœ¬æ–‡è¿˜æ˜¯å†™å¾—ä¸é”™çš„ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼ŒèŠ±äº†ä¸å°‘å¿ƒæ€æ¥å†™è¿™æ–‡ç« å’Œåšå›¾ï¼ŒåŠ›æ±‚è®©è¯»è€…çœŸçš„èƒ½çœ‹ç€ç®€å•åŒæ—¶æœ‰æ‰€æ”¶è·ã€‚ è®¾è®¡æ¨¡å¼æ˜¯å¯¹å¤§å®¶å®é™…å·¥ä½œä¸­å†™çš„å„ç§ä»£ç è¿›è¡Œé«˜å±‚æ¬¡æŠ½è±¡çš„æ€»ç»“ï¼Œå…¶ä¸­æœ€å‡ºåçš„å½“å± Gang of Four (GoF) çš„åˆ†ç±»äº†ï¼Œä»–ä»¬å°†è®¾è®¡æ¨¡å¼åˆ†ç±»ä¸º 23 ç§ç»å…¸çš„æ¨¡å¼ï¼Œæ ¹æ®ç”¨é€”æˆ‘ä»¬åˆå¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼Œåˆ†åˆ«ä¸ºåˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„å‹æ¨¡å¼å’Œè¡Œä¸ºå‹æ¨¡å¼ã€‚ æœ‰ä¸€äº›é‡è¦çš„è®¾è®¡åŸåˆ™åœ¨å¼€ç¯‡å’Œå¤§å®¶åˆ†äº«ä¸‹ï¼Œè¿™äº›åŸåˆ™å°†è´¯é€šå…¨æ–‡ï¼š é¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é¢å‘å®ç°ã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œä¹Ÿæ˜¯ä¼˜é›…çš„ã€å¯æ‰©å±•çš„ä»£ç çš„ç¬¬ä¸€æ­¥ï¼Œè¿™å°±ä¸éœ€è¦å¤šè¯´äº†å§ã€‚ èŒè´£å•ä¸€åŸåˆ™ã€‚æ¯ä¸ªç±»éƒ½åº”è¯¥åªæœ‰ä¸€ä¸ªå•ä¸€çš„åŠŸèƒ½ï¼Œå¹¶ä¸”è¯¥åŠŸèƒ½åº”è¯¥ç”±è¿™ä¸ªç±»å®Œå…¨å°è£…èµ·æ¥ã€‚ å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ã€‚å¯¹ä¿®æ”¹å…³é—­æ˜¯è¯´ï¼Œæˆ‘ä»¬è¾›è¾›è‹¦è‹¦åŠ ç­å†™å‡ºæ¥çš„ä»£ç ï¼Œè¯¥å®ç°çš„åŠŸèƒ½å’Œè¯¥ä¿®å¤çš„ bug éƒ½å®Œæˆäº†ï¼Œåˆ«äººå¯ä¸èƒ½è¯´æ”¹å°±æ”¹ï¼›å¯¹æ‰©å±•å¼€æ”¾å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æˆ‘ä»¬å†™å¥½çš„ä»£ç åŸºç¡€ä¸Šï¼Œå¾ˆå®¹æ˜“å®ç°æ‰©å±•ã€‚ åˆ›å»ºå‹æ¨¡å¼æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä¼šæ¯”è¾ƒæ²¡æœ‰æ„æ€ï¼Œç»“æ„å‹å’Œè¡Œä¸ºå‹æ¯”è¾ƒæœ‰æ„æ€ã€‚ åˆ›å»ºå‹æ¨¡å¼åˆ›å»ºå‹æ¨¡å¼çš„ä½œç”¨å°±æ˜¯åˆ›å»ºå¯¹è±¡ï¼Œè¯´åˆ°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œæœ€ç†Ÿæ‚‰çš„å°±æ˜¯ new ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶å set ç›¸å…³å±æ€§ã€‚ä½†æ˜¯ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç»™å®¢æˆ·ç«¯æä¾›æ›´åŠ å‹å¥½çš„åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯é‚£ç§æˆ‘ä»¬å®šä¹‰äº†ç±»ï¼Œä½†æ˜¯éœ€è¦æä¾›ç»™å…¶ä»–å¼€å‘è€…ç”¨çš„æ—¶å€™ã€‚ ç®€å•å·¥å‚æ¨¡å¼å’Œåå­—ä¸€æ ·ç®€å•ï¼Œéå¸¸ç®€å•ï¼Œç›´æ¥ä¸Šä»£ç å§ï¼š 12345678910111213141516public class FoodFactory &#123; public static Food makeFood(String name) &#123; if (name.equals(\"noodle\")) &#123; Food noodle = new LanZhouNoodle(); noodle.addSpicy(\"more\"); return noodle; &#125; else if (name.equals(\"chicken\")) &#123; Food chicken = new HuangMenChicken(); chicken.addCondiment(\"potato\"); return chicken; &#125; else &#123; return null; &#125; &#125;&#125; å…¶ä¸­ï¼ŒLanZhouNoodle å’Œ HuangMenChicken éƒ½ç»§æ‰¿è‡ª Foodã€‚ ç®€å•åœ°è¯´ï¼Œç®€å•å·¥å‚æ¨¡å¼é€šå¸¸å°±æ˜¯è¿™æ ·ï¼Œä¸€ä¸ªå·¥å‚ç±» XxxFactoryï¼Œé‡Œé¢æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œæ ¹æ®æˆ‘ä»¬ä¸åŒçš„å‚æ•°ï¼Œè¿”å›ä¸åŒçš„æ´¾ç”Ÿè‡ªåŒä¸€ä¸ªçˆ¶ç±»ï¼ˆæˆ–å®ç°åŒä¸€æ¥å£ï¼‰çš„å®ä¾‹å¯¹è±¡ã€‚ æˆ‘ä»¬å¼ºè°ƒèŒè´£å•ä¸€åŸåˆ™ï¼Œä¸€ä¸ªç±»åªæä¾›ä¸€ç§åŠŸèƒ½ï¼ŒFoodFactory çš„åŠŸèƒ½å°±æ˜¯åªè¦è´Ÿè´£ç”Ÿäº§å„ç§ Foodã€‚ å·¥å‚æ¨¡å¼ç®€å•å·¥å‚æ¨¡å¼å¾ˆç®€å•ï¼Œå¦‚æœå®ƒèƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼Œæˆ‘è§‰å¾—å°±ä¸è¦æŠ˜è…¾äº†ã€‚ä¹‹æ‰€ä»¥éœ€è¦å¼•å…¥å·¥å‚æ¨¡å¼ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¾€å¾€éœ€è¦ä½¿ç”¨ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å·¥å‚ã€‚ 1234567891011121314151617181920212223242526272829public interface FoodFactory &#123; Food makeFood(String name);&#125;public class ChineseFoodFactory implements FoodFactory &#123; @Override public Food makeFood(String name) &#123; if (name.equals(\"A\")) &#123; return new ChineseFoodA(); &#125; else if (name.equals(\"B\")) &#123; return new ChineseFoodB(); &#125; else &#123; return null; &#125; &#125;&#125;public class AmericanFoodFactory implements FoodFactory &#123; @Override public Food makeFood(String name) &#123; if (name.equals(\"A\")) &#123; return new AmericanFoodA(); &#125; else if (name.equals(\"B\")) &#123; return new AmericanFoodB(); &#125; else &#123; return null; &#125; &#125;&#125; å…¶ä¸­ï¼ŒChineseFoodAã€ChineseFoodBã€AmericanFoodAã€AmericanFoodB éƒ½æ´¾ç”Ÿè‡ª Foodã€‚ å®¢æˆ·ç«¯è°ƒç”¨ï¼š 12345678public class APP &#123; public static void main(String[] args) &#123; // å…ˆé€‰æ‹©ä¸€ä¸ªå…·ä½“çš„å·¥å‚ FoodFactory factory = new ChineseFoodFactory(); // ç”±ç¬¬ä¸€æ­¥çš„å·¥å‚äº§ç”Ÿå…·ä½“çš„å¯¹è±¡ï¼Œä¸åŒçš„å·¥å‚é€ å‡ºä¸ä¸€æ ·çš„å¯¹è±¡ Food food = factory.makeFood(\"A\"); &#125;&#125; è™½ç„¶éƒ½æ˜¯è°ƒç”¨ makeFood(â€œAâ€) åˆ¶ä½œ A ç±»é£Ÿç‰©ï¼Œä½†æ˜¯ï¼Œä¸åŒçš„å·¥å‚ç”Ÿäº§å‡ºæ¥çš„å®Œå…¨ä¸ä¸€æ ·ã€‚ ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦é€‰å–åˆé€‚çš„å·¥å‚ï¼Œç„¶åç¬¬äºŒæ­¥åŸºæœ¬ä¸Šå’Œç®€å•å·¥å‚ä¸€æ ·ã€‚ æ ¸å¿ƒåœ¨äºï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¬¬ä¸€æ­¥é€‰å¥½æˆ‘ä»¬éœ€è¦çš„å·¥å‚ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ LogFactory æ¥å£ï¼Œå®ç°ç±»æœ‰ FileLogFactory å’Œ KafkaLogFactoryï¼Œåˆ†åˆ«å¯¹åº”å°†æ—¥å¿—å†™å…¥æ–‡ä»¶å’Œå†™å…¥ Kafka ä¸­ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬å®¢æˆ·ç«¯ç¬¬ä¸€æ­¥å°±éœ€è¦å†³å®šåˆ°åº•è¦å®ä¾‹åŒ– FileLogFactory è¿˜æ˜¯ KafkaLogFactoryï¼Œè¿™å°†å†³å®šä¹‹åçš„æ‰€æœ‰çš„æ“ä½œã€‚ è™½ç„¶ç®€å•ï¼Œä¸è¿‡æˆ‘ä¹ŸæŠŠæ‰€æœ‰çš„æ„ä»¶éƒ½ç”»åˆ°ä¸€å¼ å›¾ä¸Šï¼Œè¿™æ ·è¯»è€…çœ‹ç€æ¯”è¾ƒæ¸…æ™°ï¼š å·¥å‚æ¨¡å¼ç±»å›¾ æŠ½è±¡å·¥å‚æ¨¡å¼å½“æ¶‰åŠåˆ°äº§å“æ—çš„æ—¶å€™ï¼Œå°±éœ€è¦å¼•å…¥æŠ½è±¡å·¥å‚æ¨¡å¼äº†ã€‚ ä¸€ä¸ªç»å…¸çš„ä¾‹å­æ˜¯é€ ä¸€å°ç”µè„‘ã€‚æˆ‘ä»¬å…ˆä¸å¼•å…¥æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œçœ‹çœ‹æ€ä¹ˆå®ç°ã€‚ å› ä¸ºç”µè„‘æ˜¯ç”±è®¸å¤šçš„æ„ä»¶ç»„æˆçš„ï¼Œæˆ‘ä»¬å°† CPU å’Œä¸»æ¿è¿›è¡ŒæŠ½è±¡ï¼Œç„¶å CPU ç”± CPUFactory ç”Ÿäº§ï¼Œä¸»æ¿ç”± MainBoardFactory ç”Ÿäº§ï¼Œç„¶åï¼Œæˆ‘ä»¬å†å°† CPU å’Œä¸»æ¿æ­é…èµ·æ¥ç»„åˆåœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹å›¾ï¼š æŠ½è±¡å·¥å‚æ¨¡å¼ç±»å›¾ è¿™ä¸ªæ—¶å€™çš„å®¢æˆ·ç«¯è°ƒç”¨æ˜¯è¿™æ ·çš„ï¼š 12345678910// å¾—åˆ° Intel çš„ CPUCPUFactory intelCPUFactory = new IntelCPUFactory();CPU cpu = intelCPUFactory.makeCPU();// å¾—åˆ° AMD çš„ä¸»æ¿MainBoardFactory mainBoardFactory = new AmdMainBoardFactory();MainBoard mainBoard = mainBoardFactory.make();// ç»„è£… CPU å’Œä¸»æ¿Computer computer = new Computer(cpu, mainBoard); å•ç‹¬çœ‹ CPU å·¥å‚å’Œä¸»æ¿å·¥å‚ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯å‰é¢æˆ‘ä»¬è¯´çš„å·¥å‚æ¨¡å¼ã€‚è¿™ç§æ–¹å¼ä¹Ÿå®¹æ˜“æ‰©å±•ï¼Œå› ä¸ºè¦ç»™ç”µè„‘åŠ ç¡¬ç›˜çš„è¯ï¼Œåªéœ€è¦åŠ ä¸€ä¸ª HardDiskFactory å’Œç›¸åº”çš„å®ç°å³å¯ï¼Œä¸éœ€è¦ä¿®æ”¹ç°æœ‰çš„å·¥å‚ã€‚ ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœ Intel å®¶äº§çš„ CPU å’Œ AMD äº§çš„ä¸»æ¿ä¸èƒ½å…¼å®¹ä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä»£ç å°±å®¹æ˜“å‡ºé”™ï¼Œå› ä¸ºå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“å®ƒä»¬ä¸å…¼å®¹ï¼Œä¹Ÿå°±ä¼šé”™è¯¯åœ°å‡ºç°éšæ„ç»„åˆã€‚ ä¸‹é¢å°±æ˜¯æˆ‘ä»¬è¦è¯´çš„äº§å“æ—çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨äº†ç»„æˆæŸä¸ªäº§å“çš„ä¸€ç³»åˆ—é™„ä»¶çš„é›†åˆï¼š äº§å“æ—ç¤ºæ„å›¾ å½“æ¶‰åŠåˆ°è¿™ç§äº§å“æ—çš„é—®é¢˜çš„æ—¶å€™ï¼Œå°±éœ€è¦æŠ½è±¡å·¥å‚æ¨¡å¼æ¥æ”¯æŒäº†ã€‚æˆ‘ä»¬ä¸å†å®šä¹‰ CPU å·¥å‚ã€ä¸»æ¿å·¥å‚ã€ç¡¬ç›˜å·¥å‚ã€æ˜¾ç¤ºå±å·¥å‚ç­‰ç­‰ï¼Œæˆ‘ä»¬ç›´æ¥å®šä¹‰ç”µè„‘å·¥å‚ï¼Œæ¯ä¸ªç”µè„‘å·¥å‚è´Ÿè´£ç”Ÿäº§æ‰€æœ‰çš„è®¾å¤‡ï¼Œè¿™æ ·èƒ½ä¿è¯è‚¯å®šä¸å­˜åœ¨å…¼å®¹é—®é¢˜ã€‚ æŠ½è±¡å·¥å‚æ¨¡å¼ç¤ºä¾‹ è¿™ä¸ªæ—¶å€™ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œä¸å†éœ€è¦å•ç‹¬æŒ‘é€‰ CPUå‚å•†ã€ä¸»æ¿å‚å•†ã€ç¡¬ç›˜å‚å•†ç­‰ï¼Œç›´æ¥é€‰æ‹©ä¸€å®¶å“ç‰Œå·¥å‚ï¼Œå“ç‰Œå·¥å‚ä¼šè´Ÿè´£ç”Ÿäº§æ‰€æœ‰çš„ä¸œè¥¿ï¼Œè€Œä¸”èƒ½ä¿è¯è‚¯å®šæ˜¯å…¼å®¹å¯ç”¨çš„ã€‚ 12345678910111213public static void main(String[] args) &#123; // ç¬¬ä¸€æ­¥å°±è¦é€‰å®šä¸€ä¸ªâ€œå¤§å‚â€ ComputerFactory cf = new AmdFactory(); // ä»è¿™ä¸ªå¤§å‚é€  CPU CPU cpu = cf.makeCPU(); // ä»è¿™ä¸ªå¤§å‚é€ ä¸»æ¿ MainBoard board = cf.makeMainBoard(); // ä»è¿™ä¸ªå¤§å‚é€ ç¡¬ç›˜ HardDisk hardDisk = cf.makeHardDisk(); // å°†åŒä¸€ä¸ªå‚å­å‡ºæ¥çš„ CPUã€ä¸»æ¿ã€ç¡¬ç›˜ç»„è£…åœ¨ä¸€èµ· Computer result = new Computer(cpu, board, hardDisk);&#125; å½“ç„¶ï¼ŒæŠ½è±¡å·¥å‚çš„é—®é¢˜ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åŠ ä¸ªæ˜¾ç¤ºå™¨ï¼Œå°±éœ€è¦ä¿®æ”¹æ‰€æœ‰çš„å·¥å‚ï¼Œç»™æ‰€æœ‰çš„å·¥å‚éƒ½åŠ ä¸Šåˆ¶é€ æ˜¾ç¤ºå™¨çš„æ–¹æ³•ã€‚è¿™æœ‰ç‚¹è¿åäº†å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾è¿™ä¸ªè®¾è®¡åŸåˆ™ã€‚ å•ä¾‹æ¨¡å¼å•ä¾‹æ¨¡å¼ç”¨å¾—æœ€å¤šï¼Œé”™å¾—æœ€å¤šã€‚ é¥¿æ±‰æ¨¡å¼æœ€ç®€å•ï¼š 12345678910111213public class Singleton &#123; // é¦–å…ˆï¼Œå°† new Singleton() å µæ­» private Singleton() &#123;&#125;; // åˆ›å»ºç§æœ‰é™æ€å®ä¾‹ï¼Œæ„å‘³ç€è¿™ä¸ªç±»ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™å°±ä¼šè¿›è¡Œåˆ›å»º private static Singleton instance = new Singleton(); public static Singleton getInstance() &#123; return instance; &#125; // çå†™ä¸€ä¸ªé™æ€æ–¹æ³•ã€‚è¿™é‡Œæƒ³è¯´çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯è¦è°ƒç”¨ Singleton.getDate(...)ï¼Œ // æœ¬æ¥æ˜¯ä¸æƒ³è¦ç”Ÿæˆ Singleton å®ä¾‹çš„ï¼Œä¸è¿‡æ²¡åŠæ³•ï¼Œå·²ç»ç”Ÿæˆäº† public static Date getDate(String mode) &#123;return new Date();&#125;&#125; å¾ˆå¤šäººéƒ½èƒ½è¯´å‡ºé¥¿æ±‰æ¨¡å¼çš„ç¼ºç‚¹ï¼Œå¯æ˜¯æˆ‘è§‰å¾—ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œå¾ˆå°‘ç¢°åˆ°è¿™ç§æƒ…å†µï¼šä½ å®šä¹‰äº†ä¸€ä¸ªå•ä¾‹çš„ç±»ï¼Œä¸éœ€è¦å…¶å®ä¾‹ï¼Œå¯æ˜¯ä½ å´æŠŠä¸€ä¸ªæˆ–å‡ ä¸ªä½ ä¼šç”¨åˆ°çš„é™æ€æ–¹æ³•å¡åˆ°è¿™ä¸ªç±»ä¸­ã€‚ é¥±æ±‰æ¨¡å¼æœ€å®¹æ˜“å‡ºé”™ï¼š 12345678910111213141516171819public class Singleton &#123; // é¦–å…ˆï¼Œä¹Ÿæ˜¯å…ˆå µæ­» new Singleton() è¿™æ¡è·¯ private Singleton() &#123;&#125; // å’Œé¥¿æ±‰æ¨¡å¼ç›¸æ¯”ï¼Œè¿™è¾¹ä¸éœ€è¦å…ˆå®ä¾‹åŒ–å‡ºæ¥ï¼Œæ³¨æ„è¿™é‡Œçš„ volatileï¼Œå®ƒæ˜¯å¿…é¡»çš„ private static volatile Singleton instance = null; public static Singleton getInstance() &#123; if (instance == null) &#123; // åŠ é” synchronized (Singleton.class) &#123; // è¿™ä¸€æ¬¡åˆ¤æ–­ä¹Ÿæ˜¯å¿…é¡»çš„ï¼Œä¸ç„¶ä¼šæœ‰å¹¶å‘é—®é¢˜ if (instance == null) &#123; instance = new Singleton(); &#125; &#125; &#125; return instance; &#125;&#125; åŒé‡æ£€æŸ¥ï¼ŒæŒ‡çš„æ˜¯ä¸¤æ¬¡æ£€æŸ¥ instance æ˜¯å¦ä¸º nullã€‚ volatile åœ¨è¿™é‡Œæ˜¯éœ€è¦çš„ï¼Œå¸Œæœ›èƒ½å¼•èµ·è¯»è€…çš„å…³æ³¨ã€‚ å¾ˆå¤šäººä¸çŸ¥é“æ€ä¹ˆå†™ï¼Œç›´æ¥å°±åœ¨ getInstance() æ–¹æ³•ç­¾åä¸ŠåŠ ä¸Š synchronizedï¼Œè¿™å°±ä¸å¤šè¯´äº†ï¼Œæ€§èƒ½å¤ªå·®ã€‚ åµŒå¥—ç±»æœ€ç»å…¸ï¼Œä»¥åå¤§å®¶å°±ç”¨å®ƒå§ï¼š 1234567891011public class Singleton3 &#123; private Singleton3() &#123;&#125; // ä¸»è¦æ˜¯ä½¿ç”¨äº† åµŒå¥—ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„é™æ€å±æ€§å’Œé™æ€æ–¹æ³• çš„ç‰¹æ€§ private static class Holder &#123; private static Singleton3 instance = new Singleton3(); &#125; public static Singleton3 getInstance() &#123; return Holder.instance; &#125;&#125; æ³¨æ„ï¼Œå¾ˆå¤šäººéƒ½ä¼šæŠŠè¿™ä¸ªåµŒå¥—ç±»è¯´æˆæ˜¯é™æ€å†…éƒ¨ç±»ï¼Œä¸¥æ ¼åœ°è¯´ï¼Œå†…éƒ¨ç±»å’ŒåµŒå¥—ç±»æ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä»¬èƒ½è®¿é—®çš„å¤–éƒ¨ç±»æƒé™ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚ æœ€åï¼Œæˆ‘ä»¬è¯´ä¸€ä¸‹æšä¸¾ï¼Œæšä¸¾å¾ˆç‰¹æ®Šï¼Œå®ƒåœ¨ç±»åŠ è½½çš„æ—¶å€™ä¼šåˆå§‹åŒ–é‡Œé¢çš„æ‰€æœ‰çš„å®ä¾‹ï¼Œè€Œä¸” JVM ä¿è¯äº†å®ƒä»¬ä¸ä¼šå†è¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥å®ƒå¤©ç”Ÿå°±æ˜¯å•ä¾‹çš„ã€‚ è™½ç„¶æˆ‘ä»¬å¹³æ—¶å¾ˆå°‘çœ‹åˆ°ç”¨æšä¸¾æ¥å®ç°å•ä¾‹ï¼Œä½†æ˜¯åœ¨ RxJava çš„æºç ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½ç”¨äº†æšä¸¾æ¥å®ç°å•ä¾‹ã€‚ å»ºé€ è€…æ¨¡å¼ç»å¸¸ç¢°è§çš„ XxxBuilder çš„ç±»ï¼Œé€šå¸¸éƒ½æ˜¯å»ºé€ è€…æ¨¡å¼çš„äº§ç‰©ã€‚å»ºé€ è€…æ¨¡å¼å…¶å®æœ‰å¾ˆå¤šçš„å˜ç§ï¼Œä½†æ˜¯å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä½¿ç”¨é€šå¸¸éƒ½æ˜¯ä¸€ä¸ªæ¨¡å¼çš„ï¼š 12Food food = new FoodBuilder().a().b().c().build();Food food = Food.builder().a().b().c().build(); å¥—è·¯å°±æ˜¯å…ˆ new ä¸€ä¸ª Builderï¼Œç„¶åå¯ä»¥é“¾å¼åœ°è°ƒç”¨ä¸€å †æ–¹æ³•ï¼Œæœ€åå†è°ƒç”¨ä¸€æ¬¡ build() æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡å°±æœ‰äº†ã€‚ æ¥ä¸€ä¸ªä¸­è§„ä¸­çŸ©çš„å»ºé€ è€…æ¨¡å¼ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768class User &#123; // ä¸‹é¢æ˜¯â€œä¸€å †â€çš„å±æ€§ private String name; private String password; private String nickName; private int age; // æ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼Œä¸ç„¶å®¢æˆ·ç«¯å°±ä¼šç›´æ¥è°ƒç”¨æ„é€ æ–¹æ³•äº† private User(String name, String password, String nickName, int age) &#123; this.name = name; this.password = password; this.nickName = nickName; this.age = age; &#125; // é™æ€æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ª Builderï¼Œè¿™ä¸ªä¸ä¸€å®šè¦æœ‰ï¼Œä¸è¿‡å†™è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¹ æƒ¯ï¼Œ // æœ‰äº›ä»£ç è¦æ±‚åˆ«äººå†™ new User.UserBuilder().a()...build() çœ‹ä¸Šå»å°±æ²¡é‚£ä¹ˆå¥½ public static UserBuilder builder() &#123; return new UserBuilder(); &#125; public static class UserBuilder &#123; // ä¸‹é¢æ˜¯å’Œ User ä¸€æ¨¡ä¸€æ ·çš„ä¸€å †å±æ€§ private String name; private String password; private String nickName; private int age; private UserBuilder() &#123; &#125; // é“¾å¼è°ƒç”¨è®¾ç½®å„ä¸ªå±æ€§å€¼ï¼Œè¿”å› thisï¼Œå³ UserBuilder public UserBuilder name(String name) &#123; this.name = name; return this; &#125; public UserBuilder password(String password) &#123; this.password = password; return this; &#125; public UserBuilder nickName(String nickName) &#123; this.nickName = nickName; return this; &#125; public UserBuilder age(int age) &#123; this.age = age; return this; &#125; // build() æ–¹æ³•è´Ÿè´£å°† UserBuilder ä¸­è®¾ç½®å¥½çš„å±æ€§â€œå¤åˆ¶â€åˆ° User ä¸­ã€‚ // å½“ç„¶ï¼Œå¯ä»¥åœ¨ â€œå¤åˆ¶â€ ä¹‹å‰åšç‚¹æ£€éªŒ public User build() &#123; if (name == null || password == null) &#123; throw new RuntimeException(\"ç”¨æˆ·åå’Œå¯†ç å¿…å¡«\"); &#125; if (age &lt;= 0 || age &gt;= 150) &#123; throw new RuntimeException(\"å¹´é¾„ä¸åˆæ³•\"); &#125; // è¿˜å¯ä»¥åšèµ‹äºˆâ€é»˜è®¤å€¼â€œçš„åŠŸèƒ½ if (nickName == null) &#123; nickName = name; &#125; return new User(name, password, nickName, age); &#125; &#125;&#125; æ ¸å¿ƒæ˜¯ï¼šå…ˆæŠŠæ‰€æœ‰çš„å±æ€§éƒ½è®¾ç½®ç»™ Builderï¼Œç„¶å build() æ–¹æ³•çš„æ—¶å€™ï¼Œå°†è¿™äº›å±æ€§å¤åˆ¶ç»™å®é™…äº§ç”Ÿçš„å¯¹è±¡ã€‚ çœ‹çœ‹å®¢æˆ·ç«¯çš„è°ƒç”¨ï¼š 123456789public class APP &#123; public static void main(String[] args) &#123; User d = User.builder() .name(\"foo\") .password(\"pAss12345\") .age(25) .build(); &#125;&#125; è¯´å®è¯ï¼Œå»ºé€ è€…æ¨¡å¼çš„é“¾å¼å†™æ³•å¾ˆå¸å¼•äººï¼Œä½†æ˜¯ï¼Œå¤šå†™äº†å¾ˆå¤šâ€œæ— ç”¨â€çš„ builder çš„ä»£ç ï¼Œæ„Ÿè§‰è¿™ä¸ªæ¨¡å¼æ²¡ä»€ä¹ˆç”¨ã€‚ä¸è¿‡ï¼Œå½“å±æ€§å¾ˆå¤šï¼Œè€Œä¸”æœ‰äº›å¿…å¡«ï¼Œæœ‰äº›é€‰å¡«çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¨¡å¼ä¼šä½¿ä»£ç æ¸…æ™°å¾ˆå¤šã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Builder çš„æ„é€ æ–¹æ³•ä¸­å¼ºåˆ¶è®©è°ƒç”¨è€…æä¾›å¿…å¡«å­—æ®µï¼Œè¿˜æœ‰ï¼Œåœ¨ build() æ–¹æ³•ä¸­æ ¡éªŒå„ä¸ªå‚æ•°æ¯”åœ¨ User çš„æ„é€ æ–¹æ³•ä¸­æ ¡éªŒï¼Œä»£ç è¦ä¼˜é›…ä¸€äº›ã€‚ é¢˜å¤–è¯ï¼Œå¼ºçƒˆå»ºè®®è¯»è€…ä½¿ç”¨ lombokï¼Œç”¨äº† lombok ä»¥åï¼Œä¸Šé¢çš„ä¸€å¤§å †ä»£ç ä¼šå˜æˆå¦‚ä¸‹è¿™æ ·: 1234567@Builderclass User &#123; private String name; private String password; private String nickName; private int age;&#125; æ€ä¹ˆæ ·ï¼Œçœä¸‹æ¥çš„æ—¶é—´æ˜¯ä¸æ˜¯åˆå¯ä»¥å¹²ç‚¹åˆ«çš„äº†ã€‚ å½“ç„¶ï¼Œå¦‚æœä½ åªæ˜¯æƒ³è¦é“¾å¼å†™æ³•ï¼Œä¸æƒ³è¦å»ºé€ è€…æ¨¡å¼ï¼Œæœ‰ä¸ªå¾ˆç®€å•çš„åŠæ³•ï¼ŒUser çš„ getter æ–¹æ³•ä¸å˜ï¼Œæ‰€æœ‰çš„ setter æ–¹æ³•éƒ½è®©å…¶ return this å°±å¯ä»¥äº†ï¼Œç„¶åå°±å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨ï¼š 1User user = new User().setName(\"\").setPassword(\"\").setAge(20); å¾ˆå¤šäººæ˜¯è¿™ä¹ˆç”¨çš„ï¼Œä½†æ˜¯ç¬”è€…è§‰å¾—å…¶å®è¿™ç§å†™æ³•éå¸¸åœ°ä¸ä¼˜é›…ï¼Œä¸æ˜¯å¾ˆæ¨èä½¿ç”¨ã€‚ åŸå‹æ¨¡å¼è¿™æ˜¯æˆ‘è¦è¯´çš„åˆ›å»ºå‹æ¨¡å¼çš„æœ€åä¸€ä¸ªè®¾è®¡æ¨¡å¼äº†ã€‚ åŸå‹æ¨¡å¼å¾ˆç®€å•ï¼šæœ‰ä¸€ä¸ªåŸå‹å®ä¾‹ï¼ŒåŸºäºè¿™ä¸ªåŸå‹å®ä¾‹äº§ç”Ÿæ–°çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯â€œå…‹éš†â€äº†ã€‚ Object ç±»ä¸­æœ‰ä¸€ä¸ª clone() æ–¹æ³•ï¼Œå®ƒç”¨äºç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œjava è¦æ±‚æˆ‘ä»¬çš„ç±»å¿…é¡»å…ˆå®ç° Cloneable æ¥å£ï¼Œæ­¤æ¥å£æ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ï¼Œä½†æ˜¯ä¸è¿™ä¹ˆåšçš„è¯ï¼Œåœ¨ clone() çš„æ—¶å€™ï¼Œä¼šæŠ›å‡º CloneNotSupportedException å¼‚å¸¸ã€‚ 1protected native Object clone() throws CloneNotSupportedException; java çš„å…‹éš†æ˜¯æµ…å…‹éš†ï¼Œç¢°åˆ°å¯¹è±¡å¼•ç”¨çš„æ—¶å€™ï¼Œå…‹éš†å‡ºæ¥çš„å¯¹è±¡å’ŒåŸå¯¹è±¡ä¸­çš„å¼•ç”¨å°†æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚é€šå¸¸å®ç°æ·±å…‹éš†çš„æ–¹æ³•æ˜¯å°†å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åå†è¿›è¡Œååºåˆ—åŒ–ã€‚ åŸå‹æ¨¡å¼äº†è§£åˆ°è¿™é‡Œæˆ‘è§‰å¾—å°±å¤Ÿäº†ï¼Œå„ç§å˜ç€æ³•å­è¯´è¿™ç§ä»£ç æˆ–é‚£ç§ä»£ç æ˜¯åŸå‹æ¨¡å¼ï¼Œæ²¡ä»€ä¹ˆæ„ä¹‰ã€‚ åˆ›å»ºå‹æ¨¡å¼æ€»ç»“åˆ›å»ºå‹æ¨¡å¼æ€»ä½“ä¸Šæ¯”è¾ƒç®€å•ï¼Œå®ƒä»¬çš„ä½œç”¨å°±æ˜¯ä¸ºäº†äº§ç”Ÿå®ä¾‹å¯¹è±¡ï¼Œç®—æ˜¯å„ç§å·¥ä½œçš„ç¬¬ä¸€æ­¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬å†™çš„æ˜¯é¢å‘å¯¹è±¡çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡äº†ã€‚ ç®€å•å·¥å‚æ¨¡å¼æœ€ç®€å•ï¼›å·¥å‚æ¨¡å¼åœ¨ç®€å•å·¥å‚æ¨¡å¼çš„åŸºç¡€ä¸Šå¢åŠ äº†é€‰æ‹©å·¥å‚çš„ç»´åº¦ï¼Œéœ€è¦ç¬¬ä¸€æ­¥é€‰æ‹©åˆé€‚çš„å·¥å‚ï¼›æŠ½è±¡å·¥å‚æ¨¡å¼æœ‰äº§å“æ—çš„æ¦‚å¿µï¼Œå¦‚æœå„ä¸ªäº§å“æ˜¯å­˜åœ¨å…¼å®¹æ€§é—®é¢˜çš„ï¼Œå°±è¦ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚å•ä¾‹æ¨¡å¼å°±ä¸è¯´äº†ï¼Œä¸ºäº†ä¿è¯å…¨å±€ä½¿ç”¨çš„æ˜¯åŒä¸€å¯¹è±¡ï¼Œä¸€æ–¹é¢æ˜¯å®‰å…¨æ€§è€ƒè™‘ï¼Œä¸€æ–¹é¢æ˜¯ä¸ºäº†èŠ‚çœèµ„æºï¼›å»ºé€ è€…æ¨¡å¼ä¸“é—¨å¯¹ä»˜å±æ€§å¾ˆå¤šçš„é‚£ç§ç±»ï¼Œä¸ºäº†è®©ä»£ç æ›´ä¼˜ç¾ï¼›åŸå‹æ¨¡å¼ç”¨å¾—æœ€å°‘ï¼Œäº†è§£å’Œ Object ç±»ä¸­çš„ clone() æ–¹æ³•ç›¸å…³çš„çŸ¥è¯†å³å¯ã€‚ ç»“æ„å‹æ¨¡å¼å‰é¢åˆ›å»ºå‹æ¨¡å¼ä»‹ç»äº†åˆ›å»ºå¯¹è±¡çš„ä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œè¿™èŠ‚ä»‹ç»çš„ç»“æ„å‹æ¨¡å¼æ—¨åœ¨é€šè¿‡æ”¹å˜ä»£ç ç»“æ„æ¥è¾¾åˆ°è§£è€¦çš„ç›®çš„ï¼Œä½¿å¾—æˆ‘ä»¬çš„ä»£ç å®¹æ˜“ç»´æŠ¤å’Œæ‰©å±•ã€‚ ä»£ç†æ¨¡å¼ç¬¬ä¸€ä¸ªè¦ä»‹ç»çš„ä»£ç†æ¨¡å¼æ˜¯æœ€å¸¸ä½¿ç”¨çš„æ¨¡å¼ä¹‹ä¸€äº†ï¼Œç”¨ä¸€ä¸ªä»£ç†æ¥éšè—å…·ä½“å®ç°ç±»çš„å®ç°ç»†èŠ‚ï¼Œé€šå¸¸è¿˜ç”¨äºåœ¨çœŸå®çš„å®ç°çš„å‰åæ·»åŠ ä¸€éƒ¨åˆ†é€»è¾‘ã€‚ æ—¢ç„¶è¯´æ˜¯ä»£ç†ï¼Œé‚£å°±è¦å¯¹å®¢æˆ·ç«¯éšè—çœŸå®å®ç°ï¼Œç”±ä»£ç†æ¥è´Ÿè´£å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚ã€‚å½“ç„¶ï¼Œä»£ç†åªæ˜¯ä¸ªä»£ç†ï¼Œå®ƒä¸ä¼šå®Œæˆå®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯ä¸€å±‚çš®è€Œå·²ï¼Œä½†æ˜¯å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒå¿…é¡»è¡¨ç°å¾—å°±æ˜¯å®¢æˆ·ç«¯éœ€è¦çš„çœŸå®å®ç°ã€‚ ç†è§£ä»£ç†è¿™ä¸ªè¯ï¼Œè¿™ä¸ªæ¨¡å¼å…¶å®å°±ç®€å•äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public interface FoodService &#123; Food makeChicken(); Food makeNoodle();&#125;public class FoodServiceImpl implements FoodService &#123; public Food makeChicken() &#123; Food f = new Chicken() f.setChicken(\"1kg\"); f.setSpicy(\"1g\"); f.setSalt(\"3g\"); return f; &#125; public Food makeNoodle() &#123; Food f = new Noodle(); f.setNoodle(\"500g\"); f.setSalt(\"5g\"); return f; &#125;&#125;// ä»£ç†è¦è¡¨ç°å¾—â€œå°±åƒæ˜¯â€çœŸå®å®ç°ç±»ï¼Œæ‰€ä»¥éœ€è¦å®ç° FoodServicepublic class FoodServiceProxy implements FoodService &#123; // å†…éƒ¨ä¸€å®šè¦æœ‰ä¸€ä¸ªçœŸå®çš„å®ç°ç±»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥ private FoodService foodService = new FoodServiceImpl(); public Food makeChicken() &#123; System.out.println(\"æˆ‘ä»¬é©¬ä¸Šè¦å¼€å§‹åˆ¶ä½œé¸¡è‚‰äº†\"); // å¦‚æœæˆ‘ä»¬å®šä¹‰è¿™å¥ä¸ºæ ¸å¿ƒä»£ç çš„è¯ï¼Œé‚£ä¹ˆï¼Œæ ¸å¿ƒä»£ç æ˜¯çœŸå®å®ç°ç±»åšçš„ï¼Œ // ä»£ç†åªæ˜¯åœ¨æ ¸å¿ƒä»£ç å‰ååšäº›â€œæ— è¶³è½»é‡â€çš„äº‹æƒ… Food food = foodService.makeChicken(); System.out.println(\"é¸¡è‚‰åˆ¶ä½œå®Œæˆå•¦ï¼ŒåŠ ç‚¹èƒ¡æ¤’ç²‰\"); // å¢å¼º food.addCondiment(\"pepper\"); return food; &#125; public Food makeNoodle() &#123; System.out.println(\"å‡†å¤‡åˆ¶ä½œæ‹‰é¢~\"); Food food = foodService.makeNoodle(); System.out.println(\"åˆ¶ä½œå®Œæˆå•¦\") return food; &#125;&#125; å®¢æˆ·ç«¯è°ƒç”¨ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬è¦ç”¨ä»£ç†æ¥å®ä¾‹åŒ–æ¥å£ï¼š 123// è¿™é‡Œç”¨ä»£ç†ç±»æ¥å®ä¾‹åŒ–FoodService foodService = new FoodServiceProxy();foodService.makeChicken(); ä»£ç†æ¨¡å¼ç±»å›¾ æˆ‘ä»¬å‘ç°æ²¡æœ‰ï¼Œä»£ç†æ¨¡å¼è¯´ç™½äº†å°±æ˜¯åš â€œæ–¹æ³•åŒ…è£…â€ æˆ–åš â€œæ–¹æ³•å¢å¼ºâ€ã€‚åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹ä¸­ï¼Œå…¶å®å°±æ˜¯åŠ¨æ€ä»£ç†çš„è¿‡ç¨‹ã€‚æ¯”å¦‚ Spring ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±ä¸å®šä¹‰ä»£ç†ç±»ï¼Œä½†æ˜¯ Spring ä¼šå¸®æˆ‘ä»¬åŠ¨æ€æ¥å®šä¹‰ä»£ç†ï¼Œç„¶åæŠŠæˆ‘ä»¬å®šä¹‰åœ¨ @Beforeã€@Afterã€@Around ä¸­çš„ä»£ç é€»è¾‘åŠ¨æ€æ·»åŠ åˆ°ä»£ç†ä¸­ã€‚ è¯´åˆ°åŠ¨æ€ä»£ç†ï¼Œåˆå¯ä»¥å±•å¼€è¯´ï¼ŒSpring ä¸­å®ç°åŠ¨æ€ä»£ç†æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¦‚æœæˆ‘ä»¬çš„ç±»å®šä¹‰äº†æ¥å£ï¼Œå¦‚ UserService æ¥å£å’Œ UserServiceImpl å®ç°ï¼Œé‚£ä¹ˆé‡‡ç”¨ JDK çš„åŠ¨æ€ä»£ç†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»çœ‹çœ‹ java.lang.reflect.Proxy ç±»çš„æºç ï¼›å¦ä¸€ç§æ˜¯æˆ‘ä»¬è‡ªå·±æ²¡æœ‰å®šä¹‰æ¥å£çš„ï¼ŒSpring ä¼šé‡‡ç”¨ CGLIB è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå®ƒæ˜¯ä¸€ä¸ª jar åŒ…ï¼Œæ€§èƒ½è¿˜ä¸é”™ã€‚ é€‚é…å™¨æ¨¡å¼è¯´å®Œä»£ç†æ¨¡å¼ï¼Œè¯´é€‚é…å™¨æ¨¡å¼ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œå¯ä»¥åšä¸ªæ¯”è¾ƒã€‚ é€‚é…å™¨æ¨¡å¼åšçš„å°±æ˜¯ï¼Œæœ‰ä¸€ä¸ªæ¥å£éœ€è¦å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬ç°æˆçš„å¯¹è±¡éƒ½ä¸æ»¡è¶³ï¼Œéœ€è¦åŠ ä¸€å±‚é€‚é…å™¨æ¥è¿›è¡Œé€‚é…ã€‚ é€‚é…å™¨æ¨¡å¼æ€»ä½“æ¥è¯´åˆ†ä¸‰ç§ï¼šé»˜è®¤é€‚é…å™¨æ¨¡å¼ã€å¯¹è±¡é€‚é…å™¨æ¨¡å¼ã€ç±»é€‚é…å™¨æ¨¡å¼ã€‚å…ˆä¸æ€¥ç€åˆ†æ¸…æ¥šè¿™å‡ ä¸ªï¼Œå…ˆçœ‹çœ‹ä¾‹å­å†è¯´ã€‚ é»˜è®¤é€‚é…å™¨æ¨¡å¼é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹æœ€ç®€å•çš„é€‚é…å™¨æ¨¡å¼é»˜è®¤é€‚é…å™¨æ¨¡å¼(Default Adapter)æ˜¯æ€ä¹ˆæ ·çš„ã€‚ æˆ‘ä»¬ç”¨ Appache commons-io åŒ…ä¸­çš„ FileAlterationListener åšä¾‹å­ï¼Œæ­¤æ¥å£å®šä¹‰äº†å¾ˆå¤šçš„æ–¹æ³•ï¼Œç”¨äºå¯¹æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è¿›è¡Œç›‘æ§ï¼Œä¸€æ—¦å‘ç”Ÿäº†å¯¹åº”çš„æ“ä½œï¼Œå°±ä¼šè§¦å‘ç›¸åº”çš„æ–¹æ³•ã€‚ 12345678910public interface FileAlterationListener &#123; void onStart(final FileAlterationObserver observer); void onDirectoryCreate(final File directory); void onDirectoryChange(final File directory); void onDirectoryDelete(final File directory); void onFileCreate(final File file); void onFileChange(final File file); void onFileDelete(final File file); void onStop(final FileAlterationObserver observer);&#125; æ­¤æ¥å£çš„ä¸€å¤§é—®é¢˜æ˜¯æŠ½è±¡æ–¹æ³•å¤ªå¤šäº†ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨è¿™ä¸ªæ¥å£ï¼Œæ„å‘³ç€æˆ‘ä»¬è¦å®ç°æ¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯æƒ³è¦ç›‘æ§æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ›å»ºå’Œæ–‡ä»¶åˆ é™¤äº‹ä»¶ï¼Œå¯æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¸å¾—ä¸å®ç°æ‰€æœ‰çš„æ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹é¢çš„ä¸€ä¸ªé€‚é…å™¨ï¼Œå®ƒç”¨äºå®ç°ä¸Šé¢çš„æ¥å£ï¼Œä½†æ˜¯æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç©ºæ–¹æ³•ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½¬è€Œå®šä¹‰è‡ªå·±çš„ç±»æ¥ç»§æ‰¿ä¸‹é¢è¿™ä¸ªç±»å³å¯ã€‚ 1234567891011121314151617181920212223242526public class FileAlterationListenerAdaptor implements FileAlterationListener &#123; public void onStart(final FileAlterationObserver observer) &#123; &#125; public void onDirectoryCreate(final File directory) &#123; &#125; public void onDirectoryChange(final File directory) &#123; &#125; public void onDirectoryDelete(final File directory) &#123; &#125; public void onFileCreate(final File file) &#123; &#125; public void onFileChange(final File file) &#123; &#125; public void onFileDelete(final File file) &#123; &#125; public void onStop(final FileAlterationObserver observer) &#123; &#125;&#125; æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹ç±»ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦å®ç°æˆ‘ä»¬æƒ³å®ç°çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼š 1234567891011public class FileMonitor extends FileAlterationListenerAdaptor &#123; public void onFileCreate(final File file) &#123; // æ–‡ä»¶åˆ›å»º doSomething(); &#125; public void onFileDelete(final File file) &#123; // æ–‡ä»¶åˆ é™¤ doSomething(); &#125;&#125; å½“ç„¶ï¼Œä¸Šé¢è¯´çš„åªæ˜¯é€‚é…å™¨æ¨¡å¼çš„å…¶ä¸­ä¸€ç§ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„ä¸€ç§ï¼Œæ— éœ€å¤šè¨€ã€‚ä¸‹é¢ï¼Œå†ä»‹ç»â€œæ­£ç»Ÿçš„â€é€‚é…å™¨æ¨¡å¼ã€‚ å¯¹è±¡é€‚é…å™¨æ¨¡å¼æ¥çœ‹ä¸€ä¸ªã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼Œçœ‹çœ‹æ€ä¹ˆå°†é¸¡é€‚é…æˆé¸­ï¼Œè¿™æ ·é¸¡ä¹Ÿèƒ½å½“é¸­æ¥ç”¨ã€‚å› ä¸ºï¼Œç°åœ¨é¸­è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ²¡æœ‰åˆé€‚çš„å®ç°ç±»å¯ä»¥ç”¨ï¼Œæ‰€ä»¥éœ€è¦é€‚é…å™¨ã€‚ 123456789101112131415161718public interface Duck &#123; public void quack(); // é¸­çš„å‘±å‘±å« public void fly(); // é£&#125;public interface Cock &#123; public void gobble(); // é¸¡çš„å’•å’•å« public void fly(); // é£&#125;public class WildCock implements Cock &#123; public void gobble() &#123; System.out.println(\"å’•å’•å«\"); &#125; public void fly() &#123; System.out.println(\"é¸¡ä¹Ÿä¼šé£å“¦\"); &#125;&#125; é¸­æ¥å£æœ‰ fly() å’Œ quare() ä¸¤ä¸ªæ–¹æ³•ï¼Œé¸¡ Cock å¦‚æœè¦å†’å……é¸­ï¼Œfly() æ–¹æ³•æ˜¯ç°æˆçš„ï¼Œä½†æ˜¯é¸¡ä¸ä¼šé¸­çš„å‘±å‘±å«ï¼Œæ²¡æœ‰ quack() æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦é€‚é…äº†ï¼š 123456789101112131415161718192021// æ¯«æ— ç–‘é—®ï¼Œé¦–å…ˆï¼Œè¿™ä¸ªé€‚é…å™¨è‚¯å®šéœ€è¦ implements Duckï¼Œè¿™æ ·æ‰èƒ½å½“åšé¸­æ¥ç”¨public class CockAdapter implements Duck &#123; Cock cock; // æ„é€ æ–¹æ³•ä¸­éœ€è¦ä¸€ä¸ªé¸¡çš„å®ä¾‹ï¼Œæ­¤ç±»å°±æ˜¯å°†è¿™åªé¸¡é€‚é…æˆé¸­æ¥ç”¨ public CockAdapter(Cock cock) &#123; this.cock = cock; &#125; // å®ç°é¸­çš„å‘±å‘±å«æ–¹æ³• @Override public void quack() &#123; // å†…éƒ¨å…¶å®æ˜¯ä¸€åªé¸¡çš„å’•å’•å« cock.gobble(); &#125; @Override public void fly() &#123; cock.fly(); &#125;&#125; å®¢æˆ·ç«¯è°ƒç”¨å¾ˆç®€å•äº†ï¼š 1234567public static void main(String[] args) &#123; // æœ‰ä¸€åªé‡é¸¡ Cock wildCock = new WildCock(); // æˆåŠŸå°†é‡é¸¡é€‚é…æˆé¸­ Duck duck = new CockAdapter(wildCock); ...&#125; åˆ°è¿™é‡Œï¼Œå¤§å®¶ä¹Ÿå°±çŸ¥é“äº†é€‚é…å™¨æ¨¡å¼æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚æ— éæ˜¯æˆ‘ä»¬éœ€è¦ä¸€åªé¸­ï¼Œä½†æ˜¯æˆ‘ä»¬åªæœ‰ä¸€åªé¸¡ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å®šä¹‰ä¸€ä¸ªé€‚é…å™¨ï¼Œç”±è¿™ä¸ªé€‚é…å™¨æ¥å……å½“é¸­ï¼Œä½†æ˜¯é€‚é…å™¨é‡Œé¢çš„æ–¹æ³•è¿˜æ˜¯ç”±é¸¡æ¥å®ç°çš„ã€‚ æˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾æ¥ç®€å•è¯´æ˜ä¸‹ï¼š å¯¹è±¡é€‚é…å™¨ç±»å›¾ ä¸Šå›¾åº”è¯¥è¿˜æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œæˆ‘å°±ä¸åšæ›´å¤šçš„è§£é‡Šäº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹ç±»é€‚é…æ¨¡å¼æ€ä¹ˆæ ·çš„ã€‚ ç±»é€‚é…å™¨æ¨¡å¼åºŸè¯å°‘è¯´ï¼Œç›´æ¥ä¸Šå›¾ï¼š ç±»é€‚é…å™¨æ¨¡å¼ç±»å›¾ çœ‹åˆ°è¿™ä¸ªå›¾ï¼Œå¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“ç†è§£çš„å§ï¼Œé€šè¿‡ç»§æ‰¿çš„æ–¹æ³•ï¼Œé€‚é…å™¨è‡ªåŠ¨è·å¾—äº†æ‰€éœ€è¦çš„å¤§éƒ¨åˆ†æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨æ›´åŠ ç®€å•ï¼Œç›´æ¥ Target t = new SomeAdapter(); å°±å¯ä»¥äº†ã€‚ é€‚é…å™¨æ¨¡å¼æ€»ç»“ ç±»é€‚é…å’Œå¯¹è±¡é€‚é…çš„å¼‚åŒ ä¸€ä¸ªé‡‡ç”¨ç»§æ‰¿ï¼Œä¸€ä¸ªé‡‡ç”¨ç»„åˆï¼› ç±»é€‚é…å±äºé™æ€å®ç°ï¼Œå¯¹è±¡é€‚é…å±äºç»„åˆçš„åŠ¨æ€å®ç°ï¼Œå¯¹è±¡é€‚é…éœ€è¦å¤šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚ æ€»ä½“æ¥è¯´ï¼Œå¯¹è±¡é€‚é…ç”¨å¾—æ¯”è¾ƒå¤šã€‚ é€‚é…å™¨æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„å¼‚åŒ æ¯”è¾ƒè¿™ä¸¤ç§æ¨¡å¼ï¼Œå…¶å®æ˜¯æ¯”è¾ƒå¯¹è±¡é€‚é…å™¨æ¨¡å¼å’Œä»£ç†æ¨¡å¼ï¼Œåœ¨ä»£ç ç»“æ„ä¸Šï¼Œå®ƒä»¬å¾ˆç›¸ä¼¼ï¼Œéƒ½éœ€è¦ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»çš„å®ä¾‹ã€‚ä½†æ˜¯å®ƒä»¬çš„ç›®çš„ä¸ä¸€æ ·ï¼Œä»£ç†æ¨¡å¼åšçš„æ˜¯å¢å¼ºåŸæ–¹æ³•çš„æ´»ï¼›é€‚é…å™¨åšçš„æ˜¯é€‚é…çš„æ´»ï¼Œä¸ºçš„æ˜¯æä¾›â€œæŠŠé¸¡åŒ…è£…æˆé¸­ï¼Œç„¶åå½“åšé¸­æ¥ä½¿ç”¨â€ï¼Œè€Œé¸¡å’Œé¸­å®ƒä»¬ä¹‹é—´åŸæœ¬æ²¡æœ‰ç»§æ‰¿å…³ç³»ã€‚ æ¡¥æ¢æ¨¡å¼ç†è§£æ¡¥æ¢æ¨¡å¼ï¼Œå…¶å®å°±æ˜¯ç†è§£ä»£ç æŠ½è±¡å’Œè§£è€¦ã€‚ æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªæ¡¥æ¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰æä¾›çš„æ¥å£æ–¹æ³•ã€‚ 123public interface DrawAPI &#123; public void draw(int radius, int x, int y);&#125; ç„¶åæ˜¯ä¸€ç³»åˆ—å®ç°ç±»ï¼š 123456789101112131415161718public class RedPen implements DrawAPI &#123; @Override public void draw(int radius, int x, int y) &#123; System.out.println(\"ç”¨çº¢è‰²ç¬”ç”»å›¾ï¼Œradius:\" + radius + \", x:\" + x + \", y:\" + y); &#125;&#125;public class GreenPen implements DrawAPI &#123; @Override public void draw(int radius, int x, int y) &#123; System.out.println(\"ç”¨ç»¿è‰²ç¬”ç”»å›¾ï¼Œradius:\" + radius + \", x:\" + x + \", y:\" + y); &#125;&#125;public class BluePen implements DrawAPI &#123; @Override public void draw(int radius, int x, int y) &#123; System.out.println(\"ç”¨è“è‰²ç¬”ç”»å›¾ï¼Œradius:\" + radius + \", x:\" + x + \", y:\" + y); &#125;&#125; å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ­¤ç±»çš„å®ç°ç±»éƒ½éœ€è¦ä½¿ç”¨ DrawAPIï¼š 1234567public abstract class Shape &#123; protected DrawAPI drawAPI; protected Shape(DrawAPI drawAPI) &#123; this.drawAPI = drawAPI; &#125; public abstract void draw();&#125; å®šä¹‰æŠ½è±¡ç±»çš„å­ç±»ï¼š 123456789101112131415161718192021222324// åœ†å½¢public class Circle extends Shape &#123; private int radius; public Circle(int radius, DrawAPI drawAPI) &#123; super(drawAPI); this.radius = radius; &#125; public void draw() &#123; drawAPI.draw(radius, 0, 0); &#125;&#125;// é•¿æ–¹å½¢public class Rectangle extends Shape &#123; private int x; private int y; public Rectangle(int x, int y, DrawAPI drawAPI) &#123; super(drawAPI); this.x = x; this.y = y; &#125; public void draw() &#123; drawAPI.draw(0, x, y); &#125;&#125; æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹å®¢æˆ·ç«¯æ¼”ç¤ºï¼š 123456public static void main(String[] args) &#123; Shape greenCircle = new Circle(10, new GreenPen()); Shape redRectangle = new Rectangle(4, 8, new RedPen()); greenCircle.draw(); redRectangle.draw();&#125; å¯èƒ½å¤§å®¶çœ‹ä¸Šé¢ä¸€æ­¥æ­¥è¿˜ä¸æ˜¯ç‰¹åˆ«æ¸…æ™°ï¼Œæˆ‘æŠŠæ‰€æœ‰çš„ä¸œè¥¿æ•´åˆåˆ°ä¸€å¼ å›¾ä¸Šï¼š æ¡¥æ¢æ¨¡å¼ç±»å›¾ç¤ºä¾‹ è¿™å›å¤§å®¶åº”è¯¥å°±çŸ¥é“æŠ½è±¡åœ¨å“ªé‡Œï¼Œæ€ä¹ˆè§£è€¦äº†å§ã€‚æ¡¥æ¢æ¨¡å¼çš„ä¼˜ç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå°±æ˜¯éå¸¸å®¹æ˜“è¿›è¡Œæ‰©å±•ã€‚ æœ¬èŠ‚å¼•ç”¨äº†è¿™é‡Œçš„ä¾‹å­ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¿®æ”¹ã€‚ è£…é¥°æ¨¡å¼è¦æŠŠè£…é¥°æ¨¡å¼è¯´æ¸…æ¥šæ˜ç™½ï¼Œä¸æ˜¯ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚ä¹Ÿè®¸è¯»è€…çŸ¥é“ Java IO ä¸­çš„å‡ ä¸ªç±»æ˜¯å…¸å‹çš„è£…é¥°æ¨¡å¼çš„åº”ç”¨ï¼Œä½†æ˜¯è¯»è€…ä¸ä¸€å®šæ¸…æ¥šå…¶ä¸­çš„å…³ç³»ï¼Œä¹Ÿè®¸çœ‹å®Œå°±å¿˜äº†ï¼Œå¸Œæœ›çœ‹å®Œè¿™èŠ‚åï¼Œè¯»è€…å¯ä»¥å¯¹å…¶æœ‰æ›´æ·±çš„æ„Ÿæ‚Ÿã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„å›¾ï¼Œçœ‹è¿™ä¸ªå›¾çš„æ—¶å€™ï¼Œäº†è§£ä¸‹å±‚æ¬¡ç»“æ„å°±å¯ä»¥äº†ï¼š è£…é¥°è€…æ¨¡å¼ç±»å›¾ç¤ºä¾‹ æˆ‘ä»¬æ¥è¯´è¯´è£…é¥°æ¨¡å¼çš„ä¼˜ç¼ºç‚¹ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¥å£ Component å…¶å®å·²ç»æœ‰äº† ConcreteComponentA å’Œ ConcreteComponentB ä¸¤ä¸ªå®ç°ç±»äº†ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦å¢å¼ºè¿™ä¸¤ä¸ªå®ç°ç±»çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è£…é¥°æ¨¡å¼ï¼Œç”¨å…·ä½“çš„è£…é¥°å™¨æ¥è£…é¥°å®ç°ç±»ï¼Œä»¥è¾¾åˆ°å¢å¼ºçš„ç›®çš„ã€‚ ä»åå­—æ¥ç®€å•è§£é‡Šä¸‹è£…é¥°å™¨ã€‚æ—¢ç„¶è¯´æ˜¯è£…é¥°ï¼Œé‚£ä¹ˆå¾€å¾€å°±æ˜¯æ·»åŠ å°åŠŸèƒ½è¿™ç§ï¼Œè€Œä¸”ï¼Œæˆ‘ä»¬è¦æ»¡è¶³å¯ä»¥æ·»åŠ å¤šä¸ªå°åŠŸèƒ½ã€‚æœ€ç®€å•çš„ï¼Œä»£ç†æ¨¡å¼å°±å¯ä»¥å®ç°åŠŸèƒ½çš„å¢å¼ºï¼Œä½†æ˜¯ä»£ç†ä¸å®¹æ˜“å®ç°å¤šä¸ªåŠŸèƒ½çš„å¢å¼ºï¼Œå½“ç„¶ä½ å¯ä»¥è¯´ç”¨ä»£ç†åŒ…è£…ä»£ç†çš„å¤šå±‚åŒ…è£…æ–¹å¼ï¼Œä½†æ˜¯é‚£æ ·çš„è¯ä»£ç å°±å¤æ‚äº†ã€‚ é¦–å…ˆæ˜ç™½ä¸€äº›ç®€å•çš„æ¦‚å¿µï¼Œä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œæ‰€æœ‰çš„å…·ä½“è£…é¥°è€…ä»¬ ConcreteDecorator éƒ½å¯ä»¥ä½œä¸º Component æ¥ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬éƒ½å®ç°äº† Component ä¸­çš„æ‰€æœ‰æ¥å£ã€‚å®ƒä»¬å’Œ Component å®ç°ç±» ConcreteComponent çš„åŒºåˆ«æ˜¯ï¼Œå®ƒä»¬åªæ˜¯è£…é¥°è€…ï¼Œèµ·è£…é¥°ä½œç”¨ï¼Œä¹Ÿå°±æ˜¯å³ä½¿å®ƒä»¬çœ‹ä¸Šå»ç‰›é€¼è½°è½°ï¼Œä½†æ˜¯å®ƒä»¬éƒ½åªæ˜¯åœ¨å…·ä½“çš„å®ç°ä¸­åŠ äº†å±‚çš®æ¥è£…é¥°è€Œå·²ã€‚ æ³¨æ„è¿™æ®µè¯ä¸­æ··æ‚åœ¨å„ä¸ªåè¯ä¸­çš„ Component å’Œ Decoratorï¼Œåˆ«ææ··äº†ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå…ˆæŠŠè£…é¥°æ¨¡å¼å¼„æ¸…æ¥šï¼Œç„¶åå†ä»‹ç»ä¸‹ java io ä¸­çš„è£…é¥°æ¨¡å¼çš„åº”ç”¨ã€‚ æœ€è¿‘å¤§è¡—ä¸Šæµè¡Œèµ·æ¥äº†â€œå¿«ä¹æŸ æª¬â€ï¼Œæˆ‘ä»¬æŠŠå¿«ä¹æŸ æª¬çš„é¥®æ–™åˆ†ä¸ºä¸‰ç±»ï¼šçº¢èŒ¶ã€ç»¿èŒ¶ã€å’–å•¡ï¼Œåœ¨è¿™ä¸‰å¤§ç±»çš„åŸºç¡€ä¸Šï¼Œåˆå¢åŠ äº†è®¸å¤šçš„å£å‘³ï¼Œä»€ä¹ˆé‡‘æ¡”æŸ æª¬çº¢èŒ¶ã€é‡‘æ¡”æŸ æª¬çç ç»¿èŒ¶ã€èŠ’æœçº¢èŒ¶ã€èŠ’æœç»¿èŒ¶ã€èŠ’æœçç çº¢èŒ¶ã€çƒ¤çç çº¢èŒ¶ã€çƒ¤çç èŠ’æœç»¿èŒ¶ã€æ¤°é¦™èƒšèŠ½å’–å•¡ã€ç„¦ç³–å¯å¯å’–å•¡ç­‰ç­‰ï¼Œæ¯å®¶åº—éƒ½æœ‰å¾ˆé•¿çš„èœå•ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸‹ï¼Œå…¶å®åŸæ–™ä¹Ÿæ²¡å‡ æ ·ï¼Œä½†æ˜¯å¯ä»¥æ­é…å‡ºå¾ˆå¤šç»„åˆï¼Œå¦‚æœé¡¾å®¢éœ€è¦ï¼Œå¾ˆå¤šæ²¡å‡ºç°åœ¨èœå•ä¸­çš„é¥®æ–™ä»–ä»¬ä¹Ÿæ˜¯å¯ä»¥åšçš„ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œçº¢èŒ¶ã€ç»¿èŒ¶ã€å’–å•¡æ˜¯æœ€åŸºç¡€çš„é¥®æ–™ï¼Œå…¶ä»–çš„åƒé‡‘æ¡”æŸ æª¬ã€èŠ’æœã€çç ã€æ¤°æœã€ç„¦ç³–ç­‰éƒ½å±äºè£…é¥°ç”¨çš„ã€‚å½“ç„¶ï¼Œåœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç¡®å®å¯ä»¥åƒé—¨åº—ä¸€æ ·ï¼Œå¼€å‘è¿™äº›ç±»ï¼šLemonBlackTeaã€LemonGreenTeaã€MangoBlackTeaã€MangoLemonGreenTeaâ€¦â€¦ä½†æ˜¯ï¼Œå¾ˆå¿«æˆ‘ä»¬å°±å‘ç°ï¼Œè¿™æ ·å­å¹²è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬éœ€è¦ç»„åˆå‡ºæ‰€æœ‰çš„å¯èƒ½ï¼Œè€Œä¸”å¦‚æœå®¢äººéœ€è¦åœ¨çº¢èŒ¶ä¸­åŠ åŒä»½æŸ æª¬æ€ä¹ˆåŠï¼Ÿä¸‰ä»½æŸ æª¬æ€ä¹ˆåŠï¼Ÿ ä¸è¯´åºŸè¯äº†ï¼Œä¸Šä»£ç ã€‚ é¦–å…ˆï¼Œå®šä¹‰é¥®æ–™æŠ½è±¡åŸºç±»ï¼š 123456public abstract class Beverage &#123; // è¿”å›æè¿° public abstract String getDescription(); // è¿”å›ä»·æ ¼ public abstract double cost();&#125; ç„¶åæ˜¯ä¸‰ä¸ªåŸºç¡€é¥®æ–™å®ç°ç±»ï¼Œçº¢èŒ¶ã€ç»¿èŒ¶å’Œå’–å•¡ï¼š 1234567891011121314151617public class BlackTea extends Beverage &#123; public String getDescription() &#123; return \"çº¢èŒ¶\"; &#125; public double cost() &#123; return 10; &#125;&#125;public class GreenTea extends Beverage &#123; public String getDescription() &#123; return \"ç»¿èŒ¶\"; &#125; public double cost() &#123; return 11; &#125;&#125;...// å’–å•¡çœç•¥ å®šä¹‰è°ƒæ–™ï¼Œä¹Ÿå°±æ˜¯è£…é¥°è€…çš„åŸºç±»ï¼Œæ­¤ç±»å¿…é¡»ç»§æ‰¿è‡ª Beverageï¼š 1234// è°ƒæ–™public abstract class Condiment extends Beverage &#123; &#125; ç„¶åæˆ‘ä»¬æ¥å®šä¹‰æŸ æª¬ã€èŠ’æœç­‰å…·ä½“çš„è°ƒæ–™ï¼Œå®ƒä»¬å±äºè£…é¥°è€…ï¼Œæ¯«æ— ç–‘é—®ï¼Œè¿™äº›è°ƒæ–™è‚¯å®šéƒ½éœ€è¦ç»§æ‰¿è°ƒæ–™ Condiment ç±»ï¼š 123456789101112131415161718192021222324252627282930public class Lemon extends Condiment &#123; private Beverage bevarage; // è¿™é‡Œå¾ˆå…³é”®ï¼Œéœ€è¦ä¼ å…¥å…·ä½“çš„é¥®æ–™ï¼Œå¦‚éœ€è¦ä¼ å…¥æ²¡æœ‰è¢«è£…é¥°çš„çº¢èŒ¶æˆ–ç»¿èŒ¶ï¼Œ // å½“ç„¶ä¹Ÿå¯ä»¥ä¼ å…¥å·²ç»è£…é¥°å¥½çš„èŠ’æœç»¿èŒ¶ï¼Œè¿™æ ·å¯ä»¥åšèŠ’æœæŸ æª¬ç»¿èŒ¶ public Lemon(Beverage bevarage) &#123; this.bevarage = bevarage; &#125; public String getDescription() &#123; // è£…é¥° return bevarage.getDescription() + \", åŠ æŸ æª¬\"; &#125; public double cost() &#123; // è£…é¥° return beverage.cost() + 2; // åŠ æŸ æª¬éœ€è¦ 2 å…ƒ &#125;&#125;public class Mango extends Condiment &#123; private Beverage bevarage; public Mango(Beverage bevarage) &#123; this.bevarage = bevarage; &#125; public String getDescription() &#123; return bevarage.getDescription() + \", åŠ èŠ’æœ\"; &#125; public double cost() &#123; return beverage.cost() + 3; // åŠ èŠ’æœéœ€è¦ 3 å…ƒ &#125;&#125;...// ç»™æ¯ä¸€ç§è°ƒæ–™éƒ½åŠ ä¸€ä¸ªç±» çœ‹å®¢æˆ·ç«¯è°ƒç”¨ï¼š 12345678910public static void main(String[] args) &#123; // é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸºç¡€é¥®æ–™ï¼Œçº¢èŒ¶ã€ç»¿èŒ¶æˆ–å’–å•¡ Beverage beverage = new GreenTea(); // å¼€å§‹è£…é¥° beverage = new Lemon(beverage); // å…ˆåŠ ä¸€ä»½æŸ æª¬ beverage = new Mongo(beverage); // å†åŠ ä¸€ä»½èŠ’æœ System.out.println(beverage.getDescription() + \" ä»·æ ¼ï¼šï¿¥\" + beverage.cost()); //\"ç»¿èŒ¶, åŠ æŸ æª¬, åŠ èŠ’æœ ä»·æ ¼ï¼šï¿¥16\"&#125; å¦‚æœæˆ‘ä»¬éœ€è¦ èŠ’æœ-çç -åŒä»½æŸ æª¬-çº¢èŒ¶ï¼š 1Beverage beverage = new Mongo(new Pearl(new Lemon(new Lemon(new BlackTea())))); æ˜¯ä¸æ˜¯å¾ˆå˜æ€ï¼Ÿ çœ‹çœ‹ä¸‹å›¾å¯èƒ½ä¼šæ¸…æ™°ä¸€äº›ï¼š è£…é¥°è€…æ¨¡å¼ç±»å›¾ç¤ºä¾‹äºŒ åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥å·²ç»æ¸…æ¥šè£…é¥°æ¨¡å¼äº†å§ã€‚ ä¸‹é¢ï¼Œæˆ‘ä»¬å†æ¥è¯´è¯´ java IO ä¸­çš„è£…é¥°æ¨¡å¼ã€‚çœ‹ä¸‹å›¾ InputStream æ´¾ç”Ÿå‡ºæ¥çš„éƒ¨åˆ†ç±»ï¼š IOæµä¸­çš„è£…é¥°è€…æ¨¡å¼ç¤ºä¾‹ æˆ‘ä»¬çŸ¥é“ InputStream ä»£è¡¨äº†è¾“å…¥æµï¼Œå…·ä½“çš„è¾“å…¥æ¥æºå¯ä»¥æ˜¯æ–‡ä»¶ï¼ˆFileInputStreamï¼‰ã€ç®¡é“ï¼ˆPipedInputStreamï¼‰ã€æ•°ç»„ï¼ˆByteArrayInputStreamï¼‰ç­‰ï¼Œè¿™äº›å°±åƒå‰é¢å¥¶èŒ¶çš„ä¾‹å­ä¸­çš„çº¢èŒ¶ã€ç»¿èŒ¶ï¼Œå±äºåŸºç¡€è¾“å…¥æµã€‚ FilterInputStream æ‰¿æ¥äº†è£…é¥°æ¨¡å¼çš„å…³é”®èŠ‚ç‚¹ï¼Œå®ƒçš„å®ç°ç±»æ˜¯ä¸€ç³»åˆ—è£…é¥°å™¨ï¼Œæ¯”å¦‚ BufferedInputStream ä»£è¡¨ç”¨ç¼“å†²æ¥è£…é¥°ï¼Œä¹Ÿå°±ä½¿å¾—è¾“å…¥æµå…·æœ‰äº†ç¼“å†²çš„åŠŸèƒ½ï¼ŒLineNumberInputStream ä»£è¡¨ç”¨è¡Œå·æ¥è£…é¥°ï¼Œåœ¨æ“ä½œçš„æ—¶å€™å°±å¯ä»¥å–å¾—è¡Œå·äº†ï¼ŒDataInputStream çš„è£…é¥°ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»è¾“å…¥æµè½¬æ¢ä¸º java ä¸­çš„åŸºæœ¬ç±»å‹å€¼ã€‚ å½“ç„¶ï¼Œåœ¨ java IO ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è£…é¥°å™¨çš„è¯ï¼Œå°±ä¸å¤ªé€‚åˆé¢å‘æ¥å£ç¼–ç¨‹äº†ï¼Œå¦‚ï¼š 1InputStream inputStream = new LineNumberInputStream(new BufferedInputStream(new FileInputStream(\"\"))); è¿™æ ·çš„ç»“æœæ˜¯ï¼ŒInputStream è¿˜æ˜¯ä¸å…·æœ‰è¯»å–è¡Œå·çš„åŠŸèƒ½ï¼Œå› ä¸ºè¯»å–è¡Œå·çš„æ–¹æ³•å®šä¹‰åœ¨ LineNumberInputStream ç±»ä¸­ã€‚ æˆ‘ä»¬åº”è¯¥åƒä¸‹é¢è¿™æ ·ä½¿ç”¨ï¼š 123DataInputStream is = new DataInputStream( new BufferedInputStream( new FileInputStream(\"\"))); æ‰€ä»¥è¯´å˜›ï¼Œè¦æ‰¾åˆ°çº¯çš„ä¸¥æ ¼ç¬¦åˆè®¾è®¡æ¨¡å¼çš„ä»£ç è¿˜æ˜¯æ¯”è¾ƒéš¾çš„ã€‚ é—¨é¢æ¨¡å¼é—¨é¢æ¨¡å¼ï¼ˆä¹Ÿå«å¤–è§‚æ¨¡å¼ï¼ŒFacade Patternï¼‰åœ¨è®¸å¤šæºç ä¸­æœ‰ä½¿ç”¨ï¼Œæ¯”å¦‚ slf4j å°±å¯ä»¥ç†è§£ä¸ºæ˜¯é—¨é¢æ¨¡å¼çš„åº”ç”¨ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬ç›´æ¥ä¸Šä»£ç å†è¯´å§ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¥å£ï¼š 123public interface Shape &#123; void draw();&#125; å®šä¹‰å‡ ä¸ªå®ç°ç±»ï¼š 12345678910111213public class Circle implements Shape &#123; @Override public void draw() &#123; System.out.println(\"Circle::draw()\"); &#125;&#125;public class Rectangle implements Shape &#123; @Override public void draw() &#123; System.out.println(\"Rectangle::draw()\"); &#125;&#125; å®¢æˆ·ç«¯è°ƒç”¨ï¼š 123456789public static void main(String[] args) &#123; // ç”»ä¸€ä¸ªåœ†å½¢ Shape circle = new Circle(); circle.draw(); // ç”»ä¸€ä¸ªé•¿æ–¹å½¢ Shape rectangle = new Rectangle(); rectangle.draw();&#125; ä»¥ä¸Šæ˜¯æˆ‘ä»¬å¸¸å†™çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦ç”»åœ†å°±è¦å…ˆå®ä¾‹åŒ–åœ†ï¼Œç”»é•¿æ–¹å½¢å°±éœ€è¦å…ˆå®ä¾‹åŒ–ä¸€ä¸ªé•¿æ–¹å½¢ï¼Œç„¶åå†è°ƒç”¨ç›¸åº”çš„ draw() æ–¹æ³•ã€‚ ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆç”¨é—¨é¢æ¨¡å¼æ¥è®©å®¢æˆ·ç«¯è°ƒç”¨æ›´åŠ å‹å¥½ä¸€äº›ã€‚ æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªé—¨é¢ï¼š 12345678910111213141516171819202122232425public class ShapeMaker &#123; private Shape circle; private Shape rectangle; private Shape square; public ShapeMaker() &#123; circle = new Circle(); rectangle = new Rectangle(); square = new Square(); &#125; /** * ä¸‹é¢å®šä¹‰ä¸€å †æ–¹æ³•ï¼Œå…·ä½“åº”è¯¥è°ƒç”¨ä»€ä¹ˆæ–¹æ³•ï¼Œç”±è¿™ä¸ªé—¨é¢æ¥å†³å®š */ public void drawCircle()&#123; circle.draw(); &#125; public void drawRectangle()&#123; rectangle.draw(); &#125; public void drawSquare()&#123; square.draw(); &#125;&#125; çœ‹çœ‹ç°åœ¨å®¢æˆ·ç«¯æ€ä¹ˆè°ƒç”¨ï¼š 12345678public static void main(String[] args) &#123; ShapeMaker shapeMaker = new ShapeMaker(); // å®¢æˆ·ç«¯è°ƒç”¨ç°åœ¨æ›´åŠ æ¸…æ™°äº† shapeMaker.drawCircle(); shapeMaker.drawRectangle(); shapeMaker.drawSquare(); &#125; é—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹æ˜¾è€Œæ˜“è§ï¼Œå®¢æˆ·ç«¯ä¸å†éœ€è¦å…³æ³¨å®ä¾‹åŒ–æ—¶åº”è¯¥ä½¿ç”¨å“ªä¸ªå®ç°ç±»ï¼Œç›´æ¥è°ƒç”¨é—¨é¢æä¾›çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼Œå› ä¸ºé—¨é¢ç±»æä¾›çš„æ–¹æ³•çš„æ–¹æ³•åå¯¹äºå®¢æˆ·ç«¯æ¥è¯´å·²ç»å¾ˆå‹å¥½äº†ã€‚ ç»„åˆæ¨¡å¼ç»„åˆæ¨¡å¼ç”¨äºè¡¨ç¤ºå…·æœ‰å±‚æ¬¡ç»“æ„çš„æ•°æ®ï¼Œä½¿å¾—æˆ‘ä»¬å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„è®¿é—®å…·æœ‰ä¸€è‡´æ€§ã€‚ ç›´æ¥çœ‹ä¸€ä¸ªä¾‹å­å§ï¼Œæ¯ä¸ªå‘˜å·¥éƒ½æœ‰å§“åã€éƒ¨é—¨ã€è–ªæ°´è¿™äº›å±æ€§ï¼ŒåŒæ—¶è¿˜æœ‰ä¸‹å±å‘˜å·¥é›†åˆï¼ˆè™½ç„¶å¯èƒ½é›†åˆä¸ºç©ºï¼‰ï¼Œè€Œä¸‹å±å‘˜å·¥å’Œè‡ªå·±çš„ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæœ‰å§“åã€éƒ¨é—¨è¿™äº›å±æ€§ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä»–ä»¬çš„ä¸‹å±å‘˜å·¥é›†åˆã€‚ 1234567891011121314151617181920212223242526272829public class Employee &#123; private String name; private String dept; private int salary; private List&lt;Employee&gt; subordinates; // ä¸‹å± public Employee(String name,String dept, int sal) &#123; this.name = name; this.dept = dept; this.salary = sal; subordinates = new ArrayList&lt;Employee&gt;(); &#125; public void add(Employee e) &#123; subordinates.add(e); &#125; public void remove(Employee e) &#123; subordinates.remove(e); &#125; public List&lt;Employee&gt; getSubordinates()&#123; return subordinates; &#125; public String toString()&#123; return (\"Employee :[ Name : \" + name + \", dept : \" + dept + \", salary :\" + salary+\" ]\"); &#125; &#125; é€šå¸¸ï¼Œè¿™ç§ç±»éœ€è¦å®šä¹‰ add(node)ã€remove(node)ã€getChildren() è¿™äº›æ–¹æ³•ã€‚ è¿™è¯´çš„å…¶å®å°±æ˜¯ç»„åˆæ¨¡å¼ï¼Œè¿™ç§ç®€å•çš„æ¨¡å¼æˆ‘å°±ä¸åšè¿‡å¤šä»‹ç»äº†ï¼Œç›¸ä¿¡å„ä½è¯»è€…ä¹Ÿä¸å–œæ¬¢çœ‹æˆ‘å†™åºŸè¯ã€‚ äº«å…ƒæ¨¡å¼è‹±æ–‡æ˜¯ Flyweight Patternï¼Œä¸çŸ¥é“æ˜¯è°æœ€å…ˆç¿»è¯‘çš„è¿™ä¸ªè¯ï¼Œæ„Ÿè§‰è¿™ç¿»è¯‘çœŸçš„ä¸å¥½ç†è§£ï¼Œæˆ‘ä»¬è¯•ç€å¼ºè¡Œå…³è”èµ·æ¥å§ã€‚Flyweight æ˜¯è½»é‡çº§çš„æ„æ€ï¼Œäº«å…ƒåˆ†å¼€æ¥è¯´å°±æ˜¯ å…±äº« å…ƒå™¨ä»¶ï¼Œä¹Ÿå°±æ˜¯å¤ç”¨å·²ç»ç”Ÿæˆçš„å¯¹è±¡ï¼Œè¿™ç§åšæ³•å½“ç„¶ä¹Ÿå°±æ˜¯è½»é‡çº§çš„äº†ã€‚ å¤ç”¨å¯¹è±¡æœ€ç®€å•çš„æ–¹å¼æ˜¯ï¼Œç”¨ä¸€ä¸ª HashMap æ¥å­˜æ”¾æ¯æ¬¡æ–°ç”Ÿæˆçš„å¯¹è±¡ã€‚æ¯æ¬¡éœ€è¦ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå…ˆåˆ° HashMap ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†ç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œç„¶åå°†è¿™ä¸ªå¯¹è±¡æ”¾å…¥ HashMap ä¸­ã€‚ è¿™ç§ç®€å•çš„ä»£ç æˆ‘å°±ä¸æ¼”ç¤ºäº†ã€‚ ç»“æ„å‹æ¨¡å¼æ€»ç»“å‰é¢ï¼Œæˆ‘ä»¬è¯´äº†ä»£ç†æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼ã€æ¡¥æ¢æ¨¡å¼ã€è£…é¥°æ¨¡å¼ã€é—¨é¢æ¨¡å¼ã€ç»„åˆæ¨¡å¼å’Œäº«å…ƒæ¨¡å¼ã€‚è¯»è€…æ˜¯å¦å¯ä»¥åˆ†åˆ«æŠŠè¿™å‡ ä¸ªæ¨¡å¼è¯´æ¸…æ¥šäº†å‘¢ï¼Ÿåœ¨è¯´åˆ°è¿™äº›æ¨¡å¼çš„æ—¶å€™ï¼Œå¿ƒä¸­æ˜¯å¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„å›¾æˆ–å¤„ç†æµç¨‹åœ¨è„‘æµ·é‡Œå‘¢ï¼Ÿ ä»£ç†æ¨¡å¼æ˜¯åšæ–¹æ³•å¢å¼ºçš„ï¼Œé€‚é…å™¨æ¨¡å¼æ˜¯æŠŠé¸¡åŒ…è£…æˆé¸­è¿™ç§ç”¨æ¥é€‚é…æ¥å£çš„ï¼Œæ¡¥æ¢æ¨¡å¼åšåˆ°äº†å¾ˆå¥½çš„è§£è€¦ï¼Œè£…é¥°æ¨¡å¼ä»åå­—ä¸Šå°±çœ‹å¾—å‡ºæ¥ï¼Œé€‚åˆäºè£…é¥°ç±»æˆ–è€…è¯´æ˜¯å¢å¼ºç±»çš„åœºæ™¯ï¼Œé—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯å®¢æˆ·ç«¯ä¸éœ€è¦å…³å¿ƒå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œåªè¦è°ƒç”¨éœ€è¦çš„æ–¹æ³•å³å¯ï¼Œç»„åˆæ¨¡å¼ç”¨äºæè¿°å…·æœ‰å±‚æ¬¡ç»“æ„çš„æ•°æ®ï¼Œäº«å…ƒæ¨¡å¼æ˜¯ä¸ºäº†åœ¨ç‰¹å®šçš„åœºæ™¯ä¸­ç¼“å­˜å·²ç»åˆ›å»ºçš„å¯¹è±¡ï¼Œç”¨äºæé«˜æ€§èƒ½ã€‚ è¡Œä¸ºå‹æ¨¡å¼è¡Œä¸ºå‹æ¨¡å¼å…³æ³¨çš„æ˜¯å„ä¸ªç±»ä¹‹é—´çš„ç›¸äº’ä½œç”¨ï¼Œå°†èŒè´£åˆ’åˆ†æ¸…æ¥šï¼Œä½¿å¾—æˆ‘ä»¬çš„ä»£ç æ›´åŠ åœ°æ¸…æ™°ã€‚ ç­–ç•¥æ¨¡å¼ç­–ç•¥æ¨¡å¼å¤ªå¸¸ç”¨äº†ï¼Œæ‰€ä»¥æŠŠå®ƒæ”¾åˆ°æœ€å‰é¢è¿›è¡Œä»‹ç»ã€‚å®ƒæ¯”è¾ƒç®€å•ï¼Œæˆ‘å°±ä¸åºŸè¯ï¼Œç›´æ¥ç”¨ä»£ç è¯´äº‹å§ã€‚ ä¸‹é¢è®¾è®¡çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ç”»ä¸€ä¸ªå›¾å½¢ï¼Œå¯é€‰çš„ç­–ç•¥å°±æ˜¯ç”¨çº¢è‰²ç¬”æ¥ç”»ï¼Œè¿˜æ˜¯ç»¿è‰²ç¬”æ¥ç”»ï¼Œæˆ–è€…è“è‰²ç¬”æ¥ç”»ã€‚ é¦–å…ˆï¼Œå…ˆå®šä¹‰ä¸€ä¸ªç­–ç•¥æ¥å£ï¼š 123public interface Strategy &#123; public void draw(int radius, int x, int y);&#125; ç„¶åæˆ‘ä»¬å®šä¹‰å…·ä½“çš„å‡ ä¸ªç­–ç•¥ï¼š 123456789101112131415161718public class RedPen implements Strategy &#123; @Override public void draw(int radius, int x, int y) &#123; System.out.println(\"ç”¨çº¢è‰²ç¬”ç”»å›¾ï¼Œradius:\" + radius + \", x:\" + x + \", y:\" + y); &#125;&#125;public class GreenPen implements Strategy &#123; @Override public void draw(int radius, int x, int y) &#123; System.out.println(\"ç”¨ç»¿è‰²ç¬”ç”»å›¾ï¼Œradius:\" + radius + \", x:\" + x + \", y:\" + y); &#125;&#125;public class BluePen implements Strategy &#123; @Override public void draw(int radius, int x, int y) &#123; System.out.println(\"ç”¨è“è‰²ç¬”ç”»å›¾ï¼Œradius:\" + radius + \", x:\" + x + \", y:\" + y); &#125;&#125; ä½¿ç”¨ç­–ç•¥çš„ç±»ï¼š 1234567891011public class Context &#123; private Strategy strategy; public Context(Strategy strategy)&#123; this.strategy = strategy; &#125; public int executeDraw(int radius, int x, int y)&#123; return strategy.draw(radius, x, y); &#125;&#125; å®¢æˆ·ç«¯æ¼”ç¤ºï¼š 1234public static void main(String[] args) &#123; Context context = new Context(new BluePen()); // ä½¿ç”¨ç»¿è‰²ç¬”æ¥ç”» context.executeDraw(10, 0, 0);&#125; æ”¾åˆ°ä¸€å¼ å›¾ä¸Šï¼Œè®©å¤§å®¶çœ‹å¾—æ¸…æ™°äº›ï¼š ç­–ç•¥æ¨¡å¼ç±»å›¾ç¤ºä¾‹ è¿™ä¸ªæ—¶å€™ï¼Œå¤§å®¶æœ‰æ²¡æœ‰è”æƒ³åˆ°ç»“æ„å‹æ¨¡å¼ä¸­çš„æ¡¥æ¢æ¨¡å¼ï¼Œå®ƒä»¬å…¶å®éå¸¸ç›¸ä¼¼ï¼Œæˆ‘æŠŠæ¡¥æ¢æ¨¡å¼çš„å›¾æ‹¿è¿‡æ¥å¤§å®¶å¯¹æ¯”ä¸‹ï¼š bridge-1 è¦æˆ‘è¯´çš„è¯ï¼Œå®ƒä»¬éå¸¸ç›¸ä¼¼ï¼Œæ¡¥æ¢æ¨¡å¼åœ¨å·¦ä¾§åŠ äº†ä¸€å±‚æŠ½è±¡è€Œå·²ã€‚æ¡¥æ¢æ¨¡å¼çš„è€¦åˆæ›´ä½ï¼Œç»“æ„æ›´å¤æ‚ä¸€äº›ã€‚ è§‚å¯Ÿè€…æ¨¡å¼è§‚å¯Ÿè€…æ¨¡å¼å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼ŒçœŸæ˜¯å†ç®€å•ä¸è¿‡äº†ã€‚æ— å¤–ä¹ä¸¤ä¸ªæ“ä½œï¼Œè§‚å¯Ÿè€…è®¢é˜…è‡ªå·±å…³å¿ƒçš„ä¸»é¢˜å’Œä¸»é¢˜æœ‰æ•°æ®å˜åŒ–åé€šçŸ¥è§‚å¯Ÿè€…ä»¬ã€‚ é¦–å…ˆï¼Œéœ€è¦å®šä¹‰ä¸»é¢˜ï¼Œæ¯ä¸ªä¸»é¢˜éœ€è¦æŒæœ‰è§‚å¯Ÿè€…åˆ—è¡¨çš„å¼•ç”¨ï¼Œç”¨äºåœ¨æ•°æ®å˜æ›´çš„æ—¶å€™é€šçŸ¥å„ä¸ªè§‚å¯Ÿè€…ï¼š 12345678910111213141516171819202122public class Subject &#123; private List&lt;Observer&gt; observers = new ArrayList&lt;Observer&gt;(); private int state; public int getState() &#123; return state; &#125; public void setState(int state) &#123; this.state = state; // æ•°æ®å·²å˜æ›´ï¼Œé€šçŸ¥è§‚å¯Ÿè€…ä»¬ notifyAllObservers(); &#125; // æ³¨å†Œè§‚å¯Ÿè€… public void attach(Observer observer) &#123; observers.add(observer); &#125; // é€šçŸ¥è§‚å¯Ÿè€…ä»¬ public void notifyAllObservers() &#123; for (Observer observer : observers) &#123; observer.update(); &#125; &#125;&#125; å®šä¹‰è§‚å¯Ÿè€…æ¥å£ï¼š 1234public abstract class Observer &#123; protected Subject subject; public abstract void update();&#125; å…¶å®å¦‚æœåªæœ‰ä¸€ä¸ªè§‚å¯Ÿè€…ç±»çš„è¯ï¼Œæ¥å£éƒ½ä¸ç”¨å®šä¹‰äº†ï¼Œä¸è¿‡ï¼Œé€šå¸¸åœºæ™¯ä¸‹ï¼Œæ—¢ç„¶ç”¨åˆ°äº†è§‚å¯Ÿè€…æ¨¡å¼ï¼Œæˆ‘ä»¬å°±æ˜¯å¸Œæœ›ä¸€ä¸ªäº‹ä»¶å‡ºæ¥äº†ï¼Œä¼šæœ‰å¤šä¸ªä¸åŒçš„ç±»éœ€è¦å¤„ç†ç›¸åº”çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œè®¢å•ä¿®æ”¹æˆåŠŸäº‹ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›å‘çŸ­ä¿¡çš„ç±»å¾—åˆ°é€šçŸ¥ã€å‘é‚®ä»¶çš„ç±»å¾—åˆ°é€šçŸ¥ã€å¤„ç†ç‰©æµä¿¡æ¯çš„ç±»å¾—åˆ°é€šçŸ¥ç­‰ã€‚ æˆ‘ä»¬æ¥å®šä¹‰å…·ä½“çš„å‡ ä¸ªè§‚å¯Ÿè€…ç±»ï¼š 1234567891011121314151617181920212223242526public class BinaryObserver extends Observer &#123; // åœ¨æ„é€ æ–¹æ³•ä¸­è¿›è¡Œè®¢é˜…ä¸»é¢˜ public BinaryObserver(Subject subject) &#123; this.subject = subject; // é€šå¸¸åœ¨æ„é€ æ–¹æ³•ä¸­å°† this å‘å¸ƒå‡ºå»çš„æ“ä½œä¸€å®šè¦å°å¿ƒ this.subject.attach(this); &#125; // è¯¥æ–¹æ³•ç”±ä¸»é¢˜ç±»åœ¨æ•°æ®å˜æ›´çš„æ—¶å€™è¿›è¡Œè°ƒç”¨ @Override public void update() &#123; String result = Integer.toBinaryString(subject.getState()); System.out.println(\"è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºäºŒè¿›åˆ¶å€¼ä¸ºï¼š\" + result); &#125;&#125;public class HexaObserver extends Observer &#123; public HexaObserver(Subject subject) &#123; this.subject = subject; this.subject.attach(this); &#125; @Override public void update() &#123; String result = Integer.toHexString(subject.getState()).toUpperCase(); System.out.println(\"è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºåå…­è¿›åˆ¶å€¼ä¸ºï¼š\" + result); &#125;&#125; å®¢æˆ·ç«¯ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼š 12345678910public static void main(String[] args) &#123; // å…ˆå®šä¹‰ä¸€ä¸ªä¸»é¢˜ Subject subject1 = new Subject(); // å®šä¹‰è§‚å¯Ÿè€… new BinaryObserver(subject1); new HexaObserver(subject1); // æ¨¡æ‹Ÿæ•°æ®å˜æ›´ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè§‚å¯Ÿè€…ä»¬çš„ update æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ subject.setState(11);&#125; output: 12è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºäºŒè¿›åˆ¶å€¼ä¸ºï¼š1011è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºåå…­è¿›åˆ¶å€¼ä¸ºï¼šB å½“ç„¶ï¼Œjdk ä¹Ÿæä¾›äº†ç›¸ä¼¼çš„æ”¯æŒï¼Œå…·ä½“çš„å¤§å®¶å¯ä»¥å‚è€ƒ java.util.Observable å’Œ java.util.Observer è¿™ä¸¤ä¸ªç±»ã€‚ å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œè§‚å¯Ÿè€…æ¨¡å¼å¾€å¾€ç”¨æ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°ï¼Œå¦‚æœè¦å®ç°å•æœºè§‚å¯Ÿè€…æ¨¡å¼ï¼Œç¬”è€…å»ºè®®è¯»è€…ä½¿ç”¨ Guava ä¸­çš„ EventBusï¼Œå®ƒæœ‰åŒæ­¥å®ç°ä¹Ÿæœ‰å¼‚æ­¥å®ç°ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»è®¾è®¡æ¨¡å¼ï¼Œå°±ä¸å±•å¼€è¯´äº†ã€‚ è¿˜æœ‰ï¼Œå³ä½¿æ˜¯ä¸Šé¢çš„è¿™ä¸ªä»£ç ï¼Œä¹Ÿä¼šæœ‰å¾ˆå¤šå˜ç§ï¼Œå¤§å®¶åªè¦è®°ä½æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œé‚£å°±æ˜¯ä¸€å®šæœ‰ä¸€ä¸ªåœ°æ–¹å­˜æ”¾äº†æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œç„¶ååœ¨äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œéå†è§‚å¯Ÿè€…ï¼Œè°ƒç”¨å®ƒä»¬çš„å›è°ƒå‡½æ•°ã€‚ è´£ä»»é“¾æ¨¡å¼è´£ä»»é“¾é€šå¸¸éœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œç„¶åè°ƒç”¨æ–¹åªéœ€è¦è°ƒç”¨å¤´éƒ¨èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼Œåé¢ä¼šè‡ªåŠ¨æµè½¬ä¸‹å»ã€‚æ¯”å¦‚æµç¨‹å®¡æ‰¹å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œåªè¦ç»ˆç«¯ç”¨æˆ·æäº¤ç”³è¯·ï¼Œæ ¹æ®ç”³è¯·çš„å†…å®¹ä¿¡æ¯ï¼Œè‡ªåŠ¨å»ºç«‹ä¸€æ¡è´£ä»»é“¾ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹æµè½¬äº†ã€‚ æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·å‚åŠ ä¸€ä¸ªæ´»åŠ¨å¯ä»¥é¢†å–å¥–å“ï¼Œä½†æ˜¯æ´»åŠ¨éœ€è¦è¿›è¡Œå¾ˆå¤šçš„è§„åˆ™æ ¡éªŒç„¶åæ‰èƒ½æ”¾è¡Œï¼Œæ¯”å¦‚é¦–å…ˆéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ã€ä»Šæ—¥å‚ä¸äººæ•°æ˜¯å¦æœ‰é™é¢ã€å…¨åœºå‚ä¸äººæ•°æ˜¯å¦æœ‰é™é¢ç­‰ç­‰ã€‚è®¾å®šçš„è§„åˆ™éƒ½é€šè¿‡åï¼Œæ‰èƒ½è®©ç”¨æˆ·é¢†èµ°å¥–å“ã€‚ å¦‚æœäº§å“ç»™ä½ è¿™ä¸ªéœ€æ±‚çš„è¯ï¼Œæˆ‘æƒ³å¤§éƒ¨åˆ†äººä¸€å¼€å§‹è‚¯å®šæƒ³çš„å°±æ˜¯ï¼Œç”¨ä¸€ä¸ª List æ¥å­˜æ”¾æ‰€æœ‰çš„è§„åˆ™ï¼Œç„¶å foreach æ‰§è¡Œä¸€ä¸‹æ¯ä¸ªè§„åˆ™å°±å¥½äº†ã€‚ä¸è¿‡ï¼Œè¯»è€…ä¹Ÿå…ˆåˆ«æ€¥ï¼Œçœ‹çœ‹è´£ä»»é“¾æ¨¡å¼å’Œæˆ‘ä»¬è¯´çš„è¿™ä¸ªæœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰æµç¨‹ä¸ŠèŠ‚ç‚¹çš„åŸºç±»ï¼š 1234567891011121314public abstract class RuleHandler &#123; // åç»§èŠ‚ç‚¹ protected RuleHandler successor; public abstract void apply(Context context); public void setSuccessor(RuleHandler successor) &#123; this.successor = successor; &#125; public RuleHandler getSuccessor() &#123; return successor; &#125;&#125; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰å…·ä½“çš„æ¯ä¸ªèŠ‚ç‚¹äº†ã€‚ æ ¡éªŒç”¨æˆ·æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ï¼š 123456789101112public class NewUserRuleHandler extends RuleHandler &#123; public void apply(Context context) &#123; if (context.isNewUser()) &#123; // å¦‚æœæœ‰åç»§èŠ‚ç‚¹çš„è¯ï¼Œä¼ é€’ä¸‹å» if (this.getSuccessor() != null) &#123; this.getSuccessor().apply(context); &#125; &#125; else &#123; throw new RuntimeException(\"è¯¥æ´»åŠ¨ä»…é™æ–°ç”¨æˆ·å‚ä¸\"); &#125; &#125;&#125; æ ¡éªŒç”¨æˆ·æ‰€åœ¨åœ°åŒºæ˜¯å¦å¯ä»¥å‚ä¸ï¼š 123456789101112public class LocationRuleHandler extends RuleHandler &#123; public void apply(Context context) &#123; boolean allowed = activityService.isSupportedLocation(context.getLocation); if (allowed) &#123; if (this.getSuccessor() != null) &#123; this.getSuccessor().apply(context); &#125; &#125; else &#123; throw new RuntimeException(\"éå¸¸æŠ±æ­‰ï¼Œæ‚¨æ‰€åœ¨çš„åœ°åŒºæ— æ³•å‚ä¸æœ¬æ¬¡æ´»åŠ¨\"); &#125; &#125;&#125; æ ¡éªŒå¥–å“æ˜¯å¦å·²é¢†å®Œï¼š 123456789101112public class LimitRuleHandler extends RuleHandler &#123; public void apply(Context context) &#123; int remainedTimes = activityService.queryRemainedTimes(context); // æŸ¥è¯¢å‰©ä½™å¥–å“ if (remainedTimes &gt; 0) &#123; if (this.getSuccessor() != null) &#123; this.getSuccessor().apply(userInfo); &#125; &#125; else &#123; throw new RuntimeException(\"æ‚¨æ¥å¾—å¤ªæ™šäº†ï¼Œå¥–å“è¢«é¢†å®Œäº†\"); &#125; &#125;&#125; å®¢æˆ·ç«¯ï¼š 12345678910public static void main(String[] args) &#123; RuleHandler newUserHandler = new NewUserRuleHandler(); RuleHandler locationHandler = new LocationRuleHandler(); RuleHandler limitHandler = new LimitRuleHandler(); // å‡è®¾æœ¬æ¬¡æ´»åŠ¨ä»…æ ¡éªŒåœ°åŒºå’Œå¥–å“æ•°é‡ï¼Œä¸æ ¡éªŒæ–°è€ç”¨æˆ· locationHandler.setSuccessor(limitHandler); locationHandler.apply(context);&#125; ä»£ç å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯å…ˆå®šä¹‰å¥½ä¸€ä¸ªé“¾è¡¨ï¼Œç„¶ååœ¨é€šè¿‡ä»»æ„ä¸€èŠ‚ç‚¹åï¼Œå¦‚æœæ­¤èŠ‚ç‚¹æœ‰åç»§èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼ é€’ä¸‹å»ã€‚ è‡³äºå®ƒå’Œæˆ‘ä»¬å‰é¢è¯´çš„ç”¨ä¸€ä¸ª List å­˜æ”¾éœ€è¦æ‰§è¡Œçš„è§„åˆ™çš„åšæ³•æœ‰ä»€ä¹ˆå¼‚åŒï¼Œç•™ç»™è¯»è€…è‡ªå·±ç¢ç£¨å§ã€‚ æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨å«æœ‰ç»§æ‰¿ç»“æ„çš„ä»£ç ä¸­ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯éå¸¸å¸¸ç”¨çš„ã€‚ é€šå¸¸ä¼šæœ‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼š 123456789101112131415161718public abstract class AbstractTemplate &#123; // è¿™å°±æ˜¯æ¨¡æ¿æ–¹æ³• public void templateMethod() &#123; init(); apply(); // è¿™ä¸ªæ˜¯é‡ç‚¹ end(); // å¯ä»¥ä½œä¸ºé’©å­æ–¹æ³• &#125; protected void init() &#123; System.out.println(\"init æŠ½è±¡å±‚å·²ç»å®ç°ï¼Œå­ç±»ä¹Ÿå¯ä»¥é€‰æ‹©è¦†å†™\"); &#125; // ç•™ç»™å­ç±»å®ç° protected abstract void apply(); protected void end() &#123; &#125;&#125; æ¨¡æ¿æ–¹æ³•ä¸­è°ƒç”¨äº† 3 ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ apply() æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°å®ƒï¼Œå…¶å®æ¨¡æ¿æ–¹æ³•ä¸­æœ‰å‡ ä¸ªæŠ½è±¡æ–¹æ³•å®Œå…¨æ˜¯è‡ªç”±çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸‰ä¸ªæ–¹æ³•éƒ½è®¾ç½®ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œè®©å­ç±»æ¥å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¨¡æ¿æ–¹æ³•åªè´Ÿè´£å®šä¹‰ç¬¬ä¸€æ­¥åº”è¯¥è¦åšä»€ä¹ˆï¼Œç¬¬äºŒæ­¥åº”è¯¥åšä»€ä¹ˆï¼Œç¬¬ä¸‰æ­¥åº”è¯¥åšä»€ä¹ˆï¼Œè‡³äºæ€ä¹ˆåšï¼Œç”±å­ç±»æ¥å®ç°ã€‚ æˆ‘ä»¬å†™ä¸€ä¸ªå®ç°ç±»ï¼š 123456789public class ConcreteTemplate extends AbstractTemplate &#123; public void apply() &#123; System.out.println(\"å­ç±»å®ç°æŠ½è±¡æ–¹æ³• apply\"); &#125; public void end() &#123; System.out.println(\"æˆ‘ä»¬å¯ä»¥æŠŠ method3 å½“åšé’©å­æ–¹æ³•æ¥ä½¿ç”¨ï¼Œéœ€è¦çš„æ—¶å€™è¦†å†™å°±å¯ä»¥äº†\"); &#125;&#125; å®¢æˆ·ç«¯è°ƒç”¨æ¼”ç¤ºï¼š 12345public static void main(String[] args) &#123; AbstractTemplate t = new ConcreteTemplate(); // è°ƒç”¨æ¨¡æ¿æ–¹æ³• t.templateMethod();&#125; ä»£ç å…¶å®å¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸Šçœ‹åˆ°å°±æ‡‚äº†ï¼Œå…³é”®æ˜¯è¦å­¦ä¼šç”¨åˆ°è‡ªå·±çš„ä»£ç ä¸­ã€‚ çŠ¶æ€æ¨¡å¼update: 2017-10-19 åºŸè¯æˆ‘å°±ä¸è¯´äº†ï¼Œæˆ‘ä»¬è¯´ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å•†å“åº“å­˜ä¸­å¿ƒæœ‰ä¸ªæœ€åŸºæœ¬çš„éœ€æ±‚æ˜¯å‡åº“å­˜å’Œè¡¥åº“å­˜ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆç”¨çŠ¶æ€æ¨¡å¼æ¥å†™ã€‚ æ ¸å¿ƒåœ¨äºï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹ä¸å†æ˜¯ Context æ˜¯è¯¥è¿›è¡Œå“ªç§æ“ä½œï¼Œè€Œæ˜¯å…³æ³¨åœ¨è¿™ä¸ª Context ä¼šæœ‰å“ªäº›æ“ä½œã€‚ å®šä¹‰çŠ¶æ€æ¥å£ï¼š 123public interface State &#123; public void doAction(Context context);&#125; å®šä¹‰å‡åº“å­˜çš„çŠ¶æ€ï¼š 12345678910111213public class DeductState implements State &#123; public void doAction(Context context) &#123; System.out.println(\"å•†å“å–å‡ºï¼Œå‡†å¤‡å‡åº“å­˜\"); context.setState(this); //... æ‰§è¡Œå‡åº“å­˜çš„å…·ä½“æ“ä½œ &#125; public String toString() &#123; return \"Deduct State\"; &#125;&#125; å®šä¹‰è¡¥åº“å­˜çŠ¶æ€ï¼š 12345678910111213public class RevertState implements State &#123; public void doAction(Context context) &#123; System.out.println(\"ç»™æ­¤å•†å“è¡¥åº“å­˜\"); context.setState(this); //... æ‰§è¡ŒåŠ åº“å­˜çš„å…·ä½“æ“ä½œ &#125; public String toString() &#123; return \"Revert State\"; &#125;&#125; å‰é¢ç”¨åˆ°äº† context.setState(this)ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆå®šä¹‰ Context ç±»ï¼š 1234567891011121314public class Context &#123; private State state; private String name; public Context(String name) &#123; this.name = name; &#125; public void setState(State state) &#123; this.state = state; &#125; public void getState() &#123; return this.state; &#125;&#125; æˆ‘ä»¬æ¥çœ‹ä¸‹å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå¤§å®¶å°±ä¸€æ¸…äºŒæ¥šäº†ï¼š 123456789101112131415public static void main(String[] args) &#123; // æˆ‘ä»¬éœ€è¦æ“ä½œçš„æ˜¯ iPhone X Context context = new Context(\"iPhone X\"); // çœ‹çœ‹æ€ä¹ˆè¿›è¡Œè¡¥åº“å­˜æ“ä½œ State revertState = new RevertState(); revertState.doAction(context); // åŒæ ·çš„ï¼Œå‡åº“å­˜æ“ä½œä¹Ÿéå¸¸ç®€å• State deductState = new DeductState(); deductState.doAction(context); // å¦‚æœéœ€è¦æˆ‘ä»¬å¯ä»¥è·å–å½“å‰çš„çŠ¶æ€ // context.getState().toString();&#125; è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸å…³å¿ƒå½“å‰ context å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œé‚£ä¹ˆ Context å°±å¯ä»¥ä¸ç”¨ç»´æŠ¤ state å±æ€§äº†ï¼Œé‚£æ ·ä»£ç ä¼šç®€å•å¾ˆå¤šã€‚ ä¸è¿‡ï¼Œå•†å“åº“å­˜è¿™ä¸ªä¾‹å­æ¯•ç«Ÿåªæ˜¯ä¸ªä¾‹ï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šå®ä¾‹æ˜¯éœ€è¦çŸ¥é“å½“å‰ context å¤„äºä»€ä¹ˆçŠ¶æ€çš„ã€‚ è¡Œä¸ºå‹æ¨¡å¼æ€»ç»“è¡Œä¸ºå‹æ¨¡å¼éƒ¨åˆ†ä»‹ç»äº†ç­–ç•¥æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼ï¼Œå…¶å®ï¼Œç»å…¸çš„è¡Œä¸ºå‹æ¨¡å¼è¿˜åŒ…æ‹¬å¤‡å¿˜å½•æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ç­‰ï¼Œä½†æ˜¯å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯æ¯”è¾ƒæœ‰é™ï¼Œè€Œä¸”æœ¬æ–‡ç¯‡å¹…ä¹ŸæŒºå¤§äº†ï¼Œæˆ‘å°±ä¸è¿›è¡Œä»‹ç»äº†ã€‚ æ€»ç»“ å­¦ä¹ è®¾è®¡æ¨¡å¼çš„ç›®çš„æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ çš„ä¼˜é›…ã€æ˜“ç»´æŠ¤ã€æ˜“æ‰©å±•ã€‚è¿™æ¬¡æ•´ç†è¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘é‡æ–°å®¡è§†äº†ä¸€ä¸‹å„ä¸ªè®¾è®¡æ¨¡å¼ï¼Œå¯¹æˆ‘è‡ªå·±è€Œè¨€æ”¶è·è¿˜æ˜¯æŒºå¤§çš„ã€‚æˆ‘æƒ³ï¼Œæ–‡ç« çš„æœ€å¤§æ”¶ç›Šè€…ä¸€èˆ¬éƒ½æ˜¯ä½œè€…æœ¬äººï¼Œä¸ºäº†å†™ä¸€ç¯‡æ–‡ç« ï¼Œéœ€è¦å·©å›ºè‡ªå·±çš„çŸ¥è¯†ï¼Œéœ€è¦å¯»æ‰¾å„ç§èµ„æ–™ï¼Œè€Œä¸”ï¼Œè‡ªå·±å†™è¿‡çš„æ‰æœ€å®¹æ˜“è®°ä½ï¼Œä¹Ÿç®—æ˜¯æˆ‘ç»™è¯»è€…çš„å»ºè®®å§ã€‚ ï¼ˆå…¨æ–‡å®Œï¼‰ å¤§ä½¬çš„åšå®¢çœ‹è¿‡äº†,æ•´ç¯‡è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°ç®€æ´çš„,æˆ‘è‡ªå·±è¿˜çœ‹è¿‡è®¾è®¡æ¨¡å¼ä¹‹ç¦…è¿™æœ¬ä¹¦,æ€»ç»“èµ·æ¥è®¾è®¡æ¨¡å¼å¯¹äºæˆ‘ä»¬æŠ½è±¡ä»£ç ç»“æ„,å¤„ç†å¤æ‚æˆ–æ¨¡å¼é‡å¤çš„ç¼–ç å·¥ä½œæ—¶å¾ˆæœ‰ç”¨,å½“ä½ å‘ç°è‡ªå·±æ€»æ˜¯åœ¨é‡å¤æ‹“å±•å·²æœ‰ä»£ç ,æ€»æ˜¯åœ¨é‡æ„æˆ–è€…ä¸šåŠ¡å¤æ‚æ—¶,ä¸å¦¨è¯•è¯•è®¾è®¡æ¨¡å¼çš„åº”ç”¨,å½“ç„¶,éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯è®¾è®¡æ¨¡å¼ä¸å¯ä¸ºäº†åº”ç”¨è€Œåº”ç”¨,è¿‡åº¦è®¾è®¡é€ æˆåäººç»´æŠ¤ä»£ç ,ç†è§£ä»£ç æˆæœ¬å¤ªé«˜ä¹Ÿæ˜¯å¾—ä¸å¿å¤±çš„,æ”¹å¤©æœ‰ç©ºæˆ‘å†å°†è‡ªå·±çœ‹è®¾è®¡æ¨¡å¼ä¹‹ç¦…çš„è¯»ä¹¦ç¬”è®°æ€»ç»“ä¸‹å§,å¥½åœ¨æˆ‘è¯»ä¹¦å–œæ¬¢å‹¾å‹¾ç”»ç”»,ç¬”è®°æ•´ç†èµ·æ¥åº”è¯¥æ˜¯å¿«çš„,å°±æ˜¯æ¯”è¾ƒæ‡’ !:sweat_smile::sweat_smile::sweat_smile: éƒ‘é‡å£°æ˜ : æœ¬æ–‡è½¬è½½è‡ªæˆ‘å…³æ³¨çš„ä¸€ä½å¤§ä½¬çš„åšå®¢,åŸæ–‡é“¾æ¥ å¦‚æœ‰ä¾µæƒè¿˜è¯·è”ç³»æœ¬äººåˆ é™¤,ä»…åšçŸ¥è¯†ä¼ æ’­ä¸è®°å½•,æ— å‰½çªƒå†’çŠ¯ä¹‹æ„. å¯åœ¨blog-design-pattern æˆ–CSDNç•™è¨€","categories":[{"name":"design pattern","slug":"design-pattern","permalink":"https://www.enjoyican.com/categories/design-pattern/"}],"tags":[{"name":"design-pattern","slug":"design-pattern","permalink":"https://www.enjoyican.com/tags/design-pattern/"}]},{"title":"redisè®¾è®¡ä¸å®ç°è¯»ä¹¦ç¬”è®°-å¤šæœºæ•°æ®åº“çš„å®ç°","date":"2020-03-19T14:21:30.000Z","path":"posts/redis-three/","text":"å‰è¨€ç»è¿‡å‰ä¸¤ç¯‡è¯»ä¹¦ç¬”è®°çš„æ•´ç†å¯¹redisè®¾è®¡ä¸å®ç°è¿™æœ¬ä¹¦æ¢³ç†äº†ä¸‹,å½“ç„¶æˆ‘çš„æ¢³ç†ç¨æ˜¾ç²—ç³™,å› ä¸ºå¾ˆå¤šå†…å®¹åœ¨ä¹¦ä¸Šä»‹ç»çš„æ¯”è¾ƒæ¸…æ¥š,è€Œè¿™æœ¬ä¹¦å°±åœ¨æˆ‘æ‰‹å¤´ä¸Š,æˆ‘åœ¨ç¬”è®°ä¸­å°±ä¸å†èµ˜è¿°,æœ‰èµ„æºçš„æœ€å¥½è¯»åŸä¹¦,çœ‹ä¸€æœ¬å¥½ä¹¦çš„æ—¶å€™æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯è¿™æœ¬ä¹¦çœ‹çš„å¾ˆé¡ºç•…,æ´¥æ´¥æœ‰å‘³,å¯¹å¾ˆå¤šä¹‹å‰çš„ç–‘æƒ‘æœ‰è§£è°œçš„ä½œç”¨,è€Œä¸æ˜¯é€¼ç€è‡ªå·±ä»Šå¤©çœ‹å‡ é¡µ,æ˜å¤©çœ‹å‡ é¡µ,è€Œè¿™æœ¬ä¹¦å°±æ˜¯è®©æˆ‘æ„Ÿè§‰æ¯”è¾ƒèˆ’æœçš„ä¸€æœ¬,æ¥ä¸‹æ¥è¿™ç¯‡é‡ç‚¹ä»‹ç»redisçš„ä¸»ä»å¤åˆ¶,å“¨å…µæ¨¡å¼å’Œé›†ç¾¤,è¿™é‡Œä¹Ÿæ˜¯å¾ˆå¤šé¢è¯•çˆ±é—®çš„ç‚¹. å¤åˆ¶è¿™é‡Œçš„å¤åˆ¶,æŒ‡çš„å°±æ˜¯æˆ‘ä»¬éƒ½æ‡‚çš„ä¸»ä»å¤åˆ¶.ä¹¦ä¸­è®²è¿°äº†redis2.8ç‰ˆæœ¬ä¹‹å‰çš„å¤åˆ¶åŸç†å’Œ2.8ä¹‹åçš„å¤åˆ¶åŸç†,æ¥ä¸‹æ¥æè¿°ä¸­æ—§ç‰ˆæŒ‡çš„å°±æ˜¯2.8ç‰ˆæœ¬ä¹‹å‰çš„,æ–°ç‰ˆæŒ‡çš„å°±æ˜¯2.8ç‰ˆæœ¬ä¹‹åçš„. æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°Redisçš„å¤åˆ¶åŠŸèƒ½åˆ†ä¸ºåŒæ­¥(sync)å’Œå‘½ä»¤ä¼ æ’­(command propagate)ä¸¤ä¸ªæ“ä½œ: åŒæ­¥æ“ä½œå°†ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€ å‘½ä»¤ä¼ æ’­æ“ä½œç”¨äºå½“ä¸»æœåŠ¡å™¨æ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹,å¯¼è‡´ä¸»ä»ä¸ä¸€è‡´æ—¶,ä½¿ä¸»ä»æ•°æ®åº“é‡æ–°å›åˆ°ä¸€è‡´çŠ¶æ€ åŒæ­¥å½“å®¢æˆ·ç«¯å‘ä»æœåŠ¡å™¨å‘é€SLAVEOFå‘½ä»¤è¦æ±‚ä»æœåŠ¡å™¨å¤åˆ¶ä¸»æœåŠ¡å™¨çš„æ—¶å€™,ä»æœåŠ¡å™¨é¦–å…ˆæ‰§è¡Œçš„å°±æ˜¯åŒæ­¥æ“ä½œ. ä»æœåŠ¡å™¨ä¼šå‘ä¸»æœåŠ¡å™¨å‘é€SYNCå‘½ä»¤æ¥å®ŒæˆåŒæ­¥,å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹: ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€SYNCå‘½ä»¤ ä¸»æœåŠ¡å™¨æ”¶åˆ°å‘½ä»¤åæ‰§è¡ŒBGSAVEå‘½ä»¤,åœ¨åå°ç”ŸæˆRDBæ–‡ä»¶,å¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºæ¥è®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ å½“ä¸»æœåŠ¡å™¨æ‰§è¡Œå®ŒBGSAVEå‘½ä»¤ä¹‹å,ä¸»æœåŠ¡å™¨ä¼šå°†ç”Ÿæˆçš„RDBæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨,ä»æœåŠ¡æ¥å—å¹¶è½½å…¥æ–‡ä»¶,ä½¿è‡ªå·±æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨æ‰§è¡ŒBGSAVEå‘½ä»¤æ—¶çš„æ•°æ®åº“çŠ¶æ€ ä¸»æœåŠ¡å™¨å°†è®°å½•åœ¨ç¼“å†²åŒºé‡Œé¢çš„æ‰€æœ‰å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨,ä»æœåŠ¡å™¨æ”¶åˆ°åæ‰§è¡Œ,ä½¿è‡ªå·±æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ å‘½ä»¤ä¼ æ’­å½“åŒæ­¥ä¹‹å,ä¸»ä»æœåŠ¡å™¨å¤„äºä¸€è‡´çŠ¶æ€,ä½†æ˜¯å½“ä¸»æœåŠ¡å™¨æ‰§è¡Œæ–°çš„å†™å‘½ä»¤ä¹‹å,ä¸¤è€…åˆä¸ä¸€è‡´äº†,è¿™æ—¶å€™ä¸»æœåŠ¡å™¨ä¼šå°†åˆšæ‰æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨è®©å…¶æ‰§è¡Œ,ä»¥ä½¿ä¸¤è€…é‡æ–°ä¸€è‡´,è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å‘½ä»¤ä¼ æ’­ æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½ç¼ºé™·æ—§ç‰ˆå¤åˆ¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µ: åˆæ¬¡å¤åˆ¶: ä»æœåŠ¡å™¨ä¹‹å‰æ²¡æœ‰å¤åˆ¶è¿‡ç°åœ¨è¦å¤åˆ¶çš„è¿™å°ä¸»æœåŠ¡å™¨ æ–­çº¿åé‡å¤åˆ¶: å¤„äºå‘½ä»¤ä¼ æ’­é˜¶æ®µçš„ä¸»ä»æœåŠ¡å™¨å› ä¸ºç½‘ç»œåŸå› ä¸­æ–­å¤åˆ¶,ä¹‹åä»æœåŠ¡å™¨é€šè¿‡è‡ªåŠ¨é‡è¿é‡æ–°æ¥ä¸Šäº†ä¸»æœåŠ¡å™¨,å¹¶ç»§ç»­å¤åˆ¶ä¸»æœåŠ¡å™¨ ç¼ºé™·ä¹‹å¤„: å¯¹äºåˆæ¬¡å¤åˆ¶,æ—§ç‰ˆå¤åˆ¶æœ‰å¾ˆå¥½çš„æ”¯æŒ,é—®é¢˜å°±åœ¨äºæ–­çº¿åå¤åˆ¶,åœ¨æ–­çº¿åå¤åˆ¶çš„æ—¶å€™,ç†æƒ³çš„çŠ¶æ€æ˜¯å°†æ–­çº¿å‰ä»æœåŠ¡å™¨ç›®å‰å¤åˆ¶åˆ°çš„ä½ç½®ä¹‹åæ‰€æœ‰çš„å†…å®¹è¿›è¡Œå¤åˆ¶,ä½†æ˜¯æ—§ç‰ˆçš„æ–­çº¿å¤åˆ¶,å´æ˜¯é‡æ–°æ‰§è¡Œäº†æ‰€æœ‰çš„å¤åˆ¶æ“ä½œ,ä¾ç„¶æ˜¯ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€SYNCæŒ‡ä»¤,ä¹‹åä¸»æœåŠ¡å™¨åœ¨åå°ç”Ÿæˆå¯¹åº”çš„RDBæ–‡ä»¶â€¦â€¦,å°†ä¹‹å‰çš„è€è·¯é‡æ–°èµ°äº†ä¸€é,è¿™å…¶å®éå¸¸æ¶ˆè€—æ€§èƒ½ æ–°ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°ä¸ºäº†è§£å†³æ—§ç‰ˆæ–­çº¿é‡è¿åå¤åˆ¶çš„ä½æ•ˆé—®é¢˜,æ–°ç‰ˆé‡‡ç”¨äº†PSYNCå‘½ä»¤ä»£æ›¿SYNCå‘½ä»¤æ¥æ‰§è¡Œå¤åˆ¶æ—¶çš„åŒæ­¥æ“ä½œ. PSYNCæœ‰å®Œæ•´é‡åŒæ­¥å’Œéƒ¨åˆ†é‡åŒæ­¥ä¸¤ç§æ¨¡å¼: å®Œæ•´ä»åŒæ­¥ä¸åˆæ¬¡å¤åˆ¶çš„æ­¥éª¤ç±»ä¼¼ éƒ¨åˆ†é‡åŒæ­¥å°±æ˜¯ä¸»æœåŠ¡å™¨åªå°†ä¸»ä»æœåŠ¡å™¨æ–­å¼€è¿™æ®µæ—¶é—´æ‰§è¡Œçš„æŒ‡ä»¤å‘ç»™ä»æœåŠ¡å™¨æ‰§è¡Œ å¯ä»¥çœ‹åˆ°éƒ¨åˆ†é‡åŒæ­¥çš„å¼€é”€æ¯”ä¹‹å‰æ—§ç‰ˆçš„å°äº†å¾ˆå¤š,å®ç°éƒ¨åˆ†é‡åŒæ­¥çš„ä¸‰ä¸ªéƒ¨åˆ†å¦‚ä¸‹: ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡(replication offset)å’Œä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒº(replication backlog) æœåŠ¡å™¨çš„è¿è¡ŒID(run ID) å¤åˆ¶åç§»é‡ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨åœ¨æ‰§è¡Œå¤åˆ¶çš„è¿‡ç¨‹ä¸­ä¼šåˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡: ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨ä¼ æ’­Nä¸ªå­—èŠ‚æ—¶,ä¼šåœ¨è‡ªå·±çš„å¤åˆ¶åç§»é‡ä¸ŠåŠ N;è€Œä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä»ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„Nä¸ªå­—èŠ‚çš„æ•°æ®æ—¶,ä¹Ÿä¼šåœ¨è‡ªå·±çš„å¤åˆ¶åç§»é‡ä¸ŠåŠ N é€šè¿‡å¯¹ä¸»ä»å¤åˆ¶åç§»é‡çš„å¯¹æ¯”,å¯ä»¥åˆ¤æ–­ä¸»ä»æœåŠ¡å™¨æ˜¯å¦å¤„äºä¸€è‡´çŠ¶æ€:å¦‚æœå¤åˆ¶åç§»é‡ç›¸åŒ,è¯´æ˜å¤„äºä¸€è‡´çŠ¶æ€,å¦åˆ™ä¸ä¸€è‡´. å‡è®¾æ–­çº¿é‡è¿å,ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€PSYNCå‘½ä»¤,åŒæ—¶æ±‡æŠ¥è‡ªå·±çš„å¤åˆ¶åç§»é‡,é‚£ä¹ˆä¸»æœåŠ¡å™¨å¦‚ä½•åˆ¤æ–­æ˜¯è¯¥å¯¹ä»æœåŠ¡å™¨è¿›è¡Œå…¨éƒ¨é‡åŒæ­¥è¿˜æ˜¯éƒ¨åˆ†é‡åŒæ­¥,å¦‚æœæ˜¯éƒ¨åˆ†é‡åŒæ­¥,åˆå¦‚ä½•åˆ¤æ–­è¦ä¼ é€’çš„æ•°æ®æ˜¯å“ªäº›å‘¢,è¿™äº›éƒ½å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºæœ‰å…³ å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦(fixed-size)å…ˆè¿›å…ˆå‡º(FIFO)é˜Ÿåˆ—,é»˜è®¤å¤§å°ä¸º1MB å½“ä¸»æœåŠ¡å™¨å‘ä»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­æ—¶,å®ƒä¼šåŒæ—¶å°†å‘½ä»¤æ”¾å…¥å¤åˆ¶ç§¯å‹ç¼“å†²åŒº,å¦‚ä¸‹å›¾æ‰€ç¤º å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡,å¦‚ä¸‹è¡¨: åç§»é‡ 10087 10088 10089 10090 10091 10092 10093 10095 10096 10096 å­—èŠ‚å€¼ â€˜*â€™ 3 â€˜\\râ€™ â€˜\\nâ€™ â€˜$â€™ 3 â€¦ â€˜Sâ€™ â€˜Eâ€™ â€˜Tâ€™ å½“ä¸»ä»æ–­çº¿é‡è¿ä¹‹å,ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€PSUNCå‘½ä»¤åŒæ—¶æ±‡æŠ¥è‡ªå·±çš„å¤åˆ¶åç§»é‡offsetä¹‹å,ä¸»æœåŠ¡å™¨ä¼šæ‹¿ç€è¿™ä¸ªå¤åˆ¶åç§»é‡å»å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­æŸ¥çœ‹,å¦‚æœä»è¯¥offsetå¼€å§‹å¾€åçš„æ•°æ®ä»ç„¶å­˜åœ¨,å°±æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥,å¦‚æœå·²ç»ä¸å­˜åœ¨äº†,å°±æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ. å¤åˆ¶ç§¯å‹åŠ ç¼“å†²åŒºçš„å¤§å°å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®:repl-backlog-size æœåŠ¡å™¨è¿è¡ŒIDé™¤äº†å¤åˆ¶åç§»é‡å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¹‹å¤–,å®ç°éƒ¨åˆ†é‡åŒæ­¥è¿˜éœ€è¦ç”¨åˆ°æœåŠ¡å™¨è¿è¡ŒID æ¯ä¸ªredisæœåŠ¡å™¨,ä¸è®ºä¸»ä»éƒ½æœ‰è‡ªå·±çš„è¿è¡ŒID è¿è¡ŒIDåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆ,ç”±40ä¸ªéšæœºçš„16è¿›åˆ¶å­—ç¬¦ç»„æˆ,å¦‚:53b9b28dfâ€¦. å½“ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡å¤åˆ¶çš„æ—¶å€™,ä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±çš„è¿è¡ŒIDä¼ é€ç»™ä»æœåŠ¡å™¨,ä»æœåŠ¡å™¨ä¼šå°†è¿™ä¸ªè¿è¡ŒIDä¿å­˜èµ·æ¥,å½“æ–­çº¿é‡è¿å,ä»æœåŠ¡å™¨ä¼šå‘ä¸»æœåŠ¡å™¨å‘é€è¿™ä¸ªè¿è¡ŒID,å¦‚æœä¸å½“å‰ä¸»æœåŠ¡å™¨çš„è¿è¡ŒIDç›¸åŒ,åˆ™å¯ä»¥ç”±ä¸»æœåŠ¡å™¨æ ¹æ®æƒ…å†µåˆ¤æ–­æ˜¯å¦å¯ä»¥æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥,å¦‚æœè¿™ä¸ªIDå’Œå½“å‰ä¸»æœåŠ¡å™¨çš„IDä¸åŒ,é‚£ä¹ˆç›´æ¥æ‰§è¡Œå®Œæ•´é‡åŒæ­¥. PSYNCå‘½ä»¤çš„å®ç°PSYNCå‘½ä»¤çš„è°ƒç”¨æ–¹æ³•æœ‰ä¸¤ç§æƒ…å†µ: å¦‚æœä»æœåŠ¡å™¨ä¹‹å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨,æˆ–è€…ä¹‹å‰æ‰§è¡Œè¿‡SLAVEOF NO ONEå‘½ä»¤,é‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€PSYNC ? -1å‘½ä»¤,ä¸»åŠ¨è¯·æ±‚ä¸»æœåŠ¡å™¨è¿›è¡Œå®Œæ•´é‡åŒæ­¥ å¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨,é‚£ä¹ˆé‡è¿åä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€PSYNC runid offsetå‘½ä»¤,runidæ˜¯ä¸Šæ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨è¿è¡Œid,offsetæ˜¯ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡,ä¹‹åä¸»æœåŠ¡å™¨ä¼šæ ¹æ®æ”¶åˆ°çš„ä¿¡æ¯åˆ¤å®šæ˜¯è¿›è¡Œéƒ¨åˆ†é‡åŒæ­¥è¿˜æ˜¯å®Œæ•´é‡åŒæ­¥ å…³äºå¤åˆ¶è¿‡ç¨‹çš„æ•´ä½“å®ç°è¿‡ç¨‹,å¯ä»¥çœ‹åŸä¹¦15.6èŠ‚-å¤åˆ¶çš„å®ç° Sentinelå“¨å…µæ¨¡å¼å“¨å…µæ¨¡å¼æ˜¯redisä¸ºä¿è¯é«˜å¯ç”¨æ‰€æä¾›çš„è§£å†³æ–¹æ¡ˆ,ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå“¨å…µç»„æˆçš„å“¨å…µç³»ç»Ÿ,ç›‘æ§ç³»ç»Ÿä¸­ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨,å½“å‘ç”Ÿæ•…éšœçš„æ—¶å€™,æ¯”å¦‚ä¸»æœåŠ¡å™¨æŒ‚äº†,å“¨å…µå¯ä»¥é€šè¿‡é€‰ä¸¾æœºåˆ¶äº§ç”Ÿæ–°çš„ä¸»æœåŠ¡å™¨å¹¶è¿›è¡Œæ•…éšœè½¬ç§»,ä»è€Œä¿è¯å¯ç”¨æ€§ å¯åŠ¨å¹¶åˆå§‹åŒ–sentinelå¯åŠ¨ä¸€ä¸ªsentinelå¯ä»¥ä½¿ç”¨å‘½ä»¤: redis-sentinel /path/to/your/sentinel.confæˆ–è€…å‘½ä»¤redis-server /path/to/your/sentinel.conf --sentinel å½“ä¸€ä¸ªsentinelå¯åŠ¨æ—¶,éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤: åˆå§‹åŒ–æœåŠ¡å™¨ å°†æ™®é€šredisæœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆsentinelä¸“ç”¨ä»£ç  åˆå§‹åŒ–sentinelçŠ¶æ€ æ ¹æ®æŒ‡å®šçš„é…ç½®æ–‡ä»¶,åˆå§‹åŒ–sentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨åˆ—è¡¨ åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ åˆå§‹åŒ–æœåŠ¡å™¨sentinelæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„redisæœåŠ¡å™¨,å› ä¸ºsentinelå¹¶ä¸ä½¿ç”¨æ•°æ®åº“,æ‰€ä»¥åˆå§‹åŒ–sentinelçš„æ—¶å€™å°±ä¸ä¼šè½½å…¥RDBæ–‡ä»¶æˆ–è€…AOFæ–‡ä»¶ ä½¿ç”¨sentinelä¸“ç”¨ä»£ç è¯¥æ­¥éª¤ä¸­å°†ä¸€éƒ¨åˆ†æ™®é€šredisä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆsentinelä¸“ç”¨ä»£ç ,ç‰¹åˆ«æŒ‡å‡ºPING SENTINEL INFO SUBSCRIBE UNSUBSCRIBE PSUBSCRIBE å’Œ PUNSUBSCRIBEè¿™ä¸ƒä¸ªå‘½ä»¤æ˜¯å®¢æˆ·ç«¯å¯ä»¥å¯¹sentinelæ‰§è¡Œçš„å…¨éƒ¨å‘½ä»¤ åˆå§‹åŒ–sentinelçŠ¶æ€åœ¨åº”ç”¨äº†sentinelä¸“ç”¨ä»£ç ä¹‹å,æœåŠ¡å™¨ä¼šåˆå§‹åŒ–ä¸€ä¸ªsentinel.c/sentinelStateç»“æ„(sentinelçŠ¶æ€),è¿™ä¸ªç»“æ„ä¿å­˜äº†æœåŠ¡å™¨æ‰€æœ‰ä¸sentinelåŠŸèƒ½æœ‰å…³çš„çŠ¶æ€(æœåŠ¡å™¨çš„ä¸€èˆ¬çŠ¶æ€ä»ç„¶ç”±redis.h/redisServerç»“æ„ä¿å­˜): 1234567891011121314151617struct snetinelState&#123; //å½“å‰çºªå…ƒ,ç”¨äºå®ç°æ•…éšœè½¬ç§»(é€‰ä¸¾æœºåˆ¶ä¼šç”¨åˆ°) uint64_t current_epoch; //ä¿å­˜äº†æ‰€æœ‰è¢«è¿™ä¸ªsentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨ //å­—å…¸çš„é”®æ˜¯ä¸»æœåŠ¡å™¨çš„åå­—,å€¼æ˜¯ä¸€ä¸ªæŒ‡å‘sentinelRedisInstanceç»“æ„çš„æŒ‡é’ˆ dict *masters; //æ˜¯å¦è¿›å…¥äº†TILTæ¨¡å¼; int tilt; //ç›®å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬çš„æ•°é‡ int running_scripts; //è¿›å…¥TITLæ¨¡å¼çš„æ—¶é—´ mstime_t titl_start_time; //æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¤„ç†å™¨çš„æ—¶é—´ mstime_t previous_time; //ä¸€ä¸ªFIFOé˜Ÿåˆ—,åŒ…å«äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç”¨æˆ·è„šæœ¬ list *scripts_queue; &#125;sentinel åˆå§‹åŒ–sentinelçŠ¶æ€çš„masterså±æ€§æ¯ä¸ªsentinelRedisInstance(å®ä¾‹ç»“æ„)ç»“æ„ä»£è¡¨ä¸€ä¸ªè¢«sentinelç›‘è§†çš„redisæœåŠ¡å™¨å®ä¾‹,è¿™ä¸ªå®ä¾‹å¯ä»¥æ˜¯ä¸»æœåŠ¡å™¨,ä»æœåŠ¡å™¨æˆ–è€…å¦å¤–ä¸€ä¸ªsentinel.å®ä¾‹ç»“æ„åŒ…å«çš„å±æ€§è¾ƒå¤š,ä¸‹é¢ä»£ç å±•ç¤ºäº†ä½œä¸ºä¸»æœåŠ¡å™¨ä½¿ç”¨æ—¶ç”¨åˆ°çš„ä¸€éƒ¨åˆ†å±æ€§: 1234567891011121314151617181920212223242526typedef struct sentinelRedisInstance&#123; //æ ‡è¯†å€¼,è®°å½•äº†å®ä¾‹çš„ç±»å‹ä»¥åŠè¯¥å®ä¾‹çš„å½“å‰çŠ¶æ€ int flags; //å®ä¾‹çš„åå­—,ä¸»æœåŠ¡çš„åå­—ç”±ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®,ä»æœåŠ¡å™¨ä»¥åŠsentinelçš„åå­—ç”±sentinelè‡ªåŠ¨è®¾ç½® //æ ¼å¼ä¸ºip:port,æ¯”å¦‚\"127.0.0.1:26379\" char *name; //å®ä¾‹çš„è¿è¡Œid char *runid; //é…ç½®çºªå…ƒ,ç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t config_epoch; //å®ä¾‹çš„åœ°å€ sentinelAddr *addr; //SENTINEL down-after-millisecondsé€‰é¡¹è®¾å®šçš„å€¼ //å®ä¾‹æ— å“åº”å¤šå°‘æ¯«ç§’ä¹‹åæ‰ä¼šè¢«åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿(subjectively down) mstime_t down_after_period; //SENTINEL monitor &lt;master-name&gt; &lt;IP&gt; &lt;port&gt; &lt;quorum&gt;é€‰é¡¹ä¸­çš„quorumå‚æ•° //åˆ¤æ–­è¿™ä¸ªå®ä¾‹ä¸ºå®¢è§‚ä¸‹çº¿(objectively down)æ‰€éœ€çš„æ”¯æŒæŠ•ç¥¨æ•°é‡ int quorum; //SENTINEL parallel-syncs &lt;master-name&gt; &lt;number&gt;é€‰é¡¹çš„å€¼ //åœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ—¶,å¯ä»¥åŒæ—¶å¯¹æ–°çš„ä¸»æœåŠ¡å™¨æ‰§è¡ŒåŒæ­¥çš„ä»æœåŠ¡å™¨æ•°é‡ int parallel_syncs; //SENTINEL failover-timeout&lt;master-name&gt; &lt;ms&gt; é€‰é¡¹çš„å€¼ //åˆ·æ–°æ•…éšœè¿ç§»çŠ¶æ€çš„æœ€å¤§æ—¶é™ mstime_t failover_timeout; //...&#125;sentinelRedisInstance sentinelRedisInstance.addrå±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘sentinel.c/sentinelAddrç»“æ„çš„æŒ‡é’ˆ,è¿™ä¸ªç»“æ„ä¿å­˜ç€å®ä¾‹çš„IPåœ°å€å’Œç«¯å£å·: 1234typedef struct sentinelAddr&#123; char *ip; int port;&#125;sentinelAddr å¯¹sentinelçŠ¶æ€çš„åˆå§‹åŒ–å°†å¼•å‘å¯¹masterå­—å…¸çš„åˆå§‹åŒ–,masterså­—å…¸çš„åˆå§‹åŒ–æ—¶æ ¹æ®è¢«è½½å…¥çš„sentinelé…ç½®æ–‡ä»¶æ¥è¿›è¡Œçš„. åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥åˆå§‹åŒ–sentinelçš„æœ€åä¸€æ­¥æ˜¯åˆ›å»ºè¿å‘è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥,sentinelå°†æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯,å®ƒå¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤,å¹¶ä»å‘½ä»¤å›å¤ä¸­è·å–ç›¸å…³ä¿¡æ¯. å¯¹äºæ¯ä¸ªè¢«sentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨æ¥è¯´,sentinelä¼šåˆ›å»ºä¸¤ä¸ªè¿å‘ä¸»æœåŠ¡å™¨çš„å¼‚æ­¥ç½‘ç»œè¿æ¥: ä¸€ä¸ªæ˜¯å‘½ä»¤è¿æ¥,è¿™ä¸ªè¿æ¥ä¸“é—¨ç”¨äºå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤,å¹¶æ¥å—å‘½ä»¤å›å¤ å¦ä¸€ä¸ªæ˜¯è®¢é˜…è¿æ¥,è¿™ä¸ªè¿æ¥ä¸“é—¨ç”¨äºè®¢é˜…ä¸»æœåŠ¡å™¨çš„_sentinel_:helloé¢‘é“ è·å–ä¸»æœåŠ¡å™¨ä¿¡æ¯sentinelä¼šé»˜è®¤ä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡,é€šè¿‡å‘½ä»¤è¿æ¥å‘è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å‘é€INFOå‘½ä»¤,å¹¶é€šè¿‡åˆ†æå‘½ä»¤å›å¤æ¥è·å–ä¸»æœåŠ¡å™¨å½“å‰çš„ä¿¡æ¯,åŒ…æ‹¬: ä¸»æœåŠ¡å™¨æœ¬èº«çš„ä¿¡æ¯:runid,role(æœåŠ¡å™¨è§’è‰²) ä¸»æœåŠ¡å™¨ä¸‹æ‰€æœ‰ä»æœåŠ¡å™¨ä¿¡æ¯,sentinelæ— é¡»ç”¨æˆ·æä¾›ä»æœåŠ¡å™¨çš„åœ°å€,å¯ä»¥è‡ªåŠ¨æ ¹æ®ä¸»æœåŠ¡å™¨çš„å›å¤è·å– è·å–ä»æœåŠ¡å™¨ä¿¡æ¯åŒæ ·çš„,sentinelä¼šé»˜è®¤ä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡,é€šè¿‡å‘½ä»¤è¿æ¥å‘ä»æœåŠ¡å™¨å‘é€INFOå‘½ä»¤,å¹¶é€šè¿‡åˆ†æå‘½ä»¤å›å¤æ¥è·å–ä»æœåŠ¡å™¨å½“å‰çš„ä¿¡æ¯,åŒ…æ‹¬: ä»æœåŠ¡å™¨çš„è¿è¡ŒID run_id ä»æœåŠ¡å™¨çš„è§’è‰²role ä¸»æœåŠ¡å™¨çš„ipåœ°å€master_host,ä»¥åŠä¸»æœåŠ¡åŒºçš„ç«¯å£å·master_port ä¸»ä»æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€master_link_status ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§slave_priority ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡slave_repl_offeset(è¿™ä¸ªåœ¨ä¸»æœåŠ¡å™¨æŒ‚äº†,é‡æ–°é€‰ä¸»çš„æ—¶å€™æœ‰ç”¨) å‘ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä¿¡æ¯ é»˜è®¤æƒ…å†µä¸‹,sentinelä¼šä»¥æ¯ä¸¤ç§’ä¸€æ¬¡çš„é¢‘ç‡,é€šè¿‡å‘½ä»¤è¿æ¥å‘æ‰€æœ‰è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä»¥ä¸‹æ ¼å¼çš„å‘½ä»¤: PUBLISH _sentinel_:hello â€œ&lt;s_ip&gt;,&lt;s_port&gt;,&lt;s_runid&gt;,&lt;s_epoch&gt;,&lt;m_name&gt;,&lt;m_ip&gt;,&lt;m_port&gt;,&lt;m_epoch&gt;&quot; è¯¥å‘½ä»¤å‘æœåŠ¡å™¨çš„_sentinel_:helloé¢‘é“å‘é€äº†ä¸€æ¡ä¿¡æ¯,å‚æ•°ä¸­ä»¥s_å¼€å¤´çš„æ˜¯ sentinelæœ¬èº«çš„ä¿¡æ¯,m_å¼€å¤´çš„è®°å½•çš„æ˜¯ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯,å¦‚æœæ­¤æ—¶ç›‘æ§çš„æ˜¯ä¸»æœåŠ¡å™¨,å°±æ˜¯ä¸»æœåŠ¡å™¨è‡ªå·±çš„ä¿¡æ¯,å¦‚æœç›‘æ§çš„æ˜¯ä»æœåŠ¡å™¨,ä¹Ÿæ˜¯ä»æœåŠ¡å™¨å¯¹åº”ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯ æ¥æ”¶æ¥è‡ªä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨çš„é¢‘é“ä¿¡æ¯å½“sentinelä¸ä¸€ä¸ªä¸»æœåŠ¡å™¨æˆ–è€…ä»æœåŠ¡å™¨å»ºç«‹èµ·è¿æ¥ä¹‹å,sentinelå°±ä¼šé€šè¿‡è®¢é˜…è¿æ¥,å‘æœåŠ¡å™¨å‘é€ä»¥ä¸‹å‘½ä»¤: SUBSCRIBE _sentinel_:hello sentinelå¯¹ _sentinel_:helloé¢‘é“çš„è®¢é˜…ä¼šä¸€ç›´æŒç»­åˆ°sentinelä¸æœåŠ¡å™¨æ–­å¼€ä¸ºæ­¢,ä¹Ÿå°±æ˜¯è¯´å¯¹äºæ¯ä¸ªä¸sentinelè¿æ¥çš„æœåŠ¡å™¨,sentinelæ—¢é€šè¿‡å‘½ä»¤è¿æ¥å‘æœåŠ¡å™¨çš„_sentinel_:hello é¢‘é“å‘é€ä¿¡æ¯,åˆé€šè¿‡è®¢é˜…è¿æ¥ä»æœåŠ¡å™¨çš„è¯¥é¢‘é“æ¥æ”¶ä¿¡æ¯. ç”¨æˆ·åœ¨ä½¿ç”¨sentinelçš„æ—¶å€™ä¸éœ€è¦æä¾›å„ä¸ªsentinelçš„åœ°å€ä¿¡æ¯,ç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ªsentinelå¯ä»¥è‡ªåŠ¨å‘ç°å¯¹æ–¹. sentinelåœ¨è¿æ¥ä¸»æœåŠ¡å™¨æˆ–è€…ä»æœåŠ¡å™¨çš„æ—¶å€™ä¼šåŒæ—¶åˆ›å»ºå‘½ä»¤è¿æ¥å’Œè®¢é˜…è¿æ¥,ä½†æ˜¯åœ¨è¿æ¥å…¶ä»–sentinelçš„æ—¶å€™åªä¼šåˆ›å»ºå‘½ä»¤è¿æ¥è€Œä¸åˆ›å»ºè®¢é˜…è¿æ¥. ä¸»è§‚ä¸‹çº¿ æ‰€è°“ä¸»è§‚ä¸‹çº¿ï¼ˆSubjectively Downï¼Œ ç®€ç§° SDOWNï¼‰æŒ‡çš„æ˜¯å•ä¸ªSentinelå®ä¾‹å¯¹æœåŠ¡å™¨åšå‡ºçš„ä¸‹çº¿åˆ¤æ–­ï¼Œå³å•ä¸ªsentinelè®¤ä¸ºæŸä¸ªæœåŠ¡ä¸‹çº¿ï¼ˆæœ‰å¯èƒ½æ˜¯æ¥æ”¶ä¸åˆ°è®¢é˜…ï¼Œä¹‹é—´çš„ç½‘ç»œä¸é€šç­‰ç­‰åŸå› ï¼‰ã€‚ ä¸»è§‚ä¸‹çº¿å°±æ˜¯è¯´å¦‚æœæœåŠ¡å™¨åœ¨down-after-millisecondsç»™å®šçš„æ¯«ç§’æ•°ä¹‹å†…ï¼Œ æ²¡æœ‰è¿”å› Sentinel å‘é€çš„ PING å‘½ä»¤çš„å›å¤ï¼Œ æˆ–è€…è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œ é‚£ä¹ˆ Sentinel å°†è¿™ä¸ªæœåŠ¡å™¨æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼ˆSDOWN ï¼‰ã€‚ sentinelä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å…¶å»ºç«‹äº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆmasterï¼Œä»æœåŠ¡ï¼Œå…¶ä»–sentinelï¼‰å‘pingå‘½ä»¤ï¼Œé€šè¿‡åˆ¤æ–­pingå›å¤æ˜¯æœ‰æ•ˆå›å¤ï¼Œè¿˜æ˜¯æ— æ•ˆå›å¤æ¥åˆ¤æ–­å®ä¾‹æ—¶å€™åœ¨çº¿ï¼ˆå¯¹è¯¥sentinelæ¥è¯´æ˜¯â€œä¸»è§‚åœ¨çº¿â€ï¼‰ã€‚sentinelé…ç½®æ–‡ä»¶ä¸­çš„down-after-millisecondsè®¾ç½®äº†åˆ¤æ–­ä¸»è§‚ä¸‹çº¿çš„æ—¶é—´é•¿åº¦ï¼Œå¦‚æœå®ä¾‹åœ¨down-after-millisecondsæ¯«ç§’å†…ï¼Œè¿”å›çš„éƒ½æ˜¯æ— æ•ˆå›å¤ï¼Œé‚£ä¹ˆsentinelå›è®¤ä¸ºè¯¥å®ä¾‹å·²ï¼ˆä¸»è§‚ï¼‰ä¸‹çº¿ï¼Œä¿®æ”¹å…¶flagsçŠ¶æ€ä¸ºSRI_S_DOWNã€‚å¦‚æœå¤šä¸ªsentinelç›‘è§†ä¸€ä¸ªæœåŠ¡ï¼Œæœ‰å¯èƒ½å­˜åœ¨å¤šä¸ªsentinelçš„down-after-millisecondsé…ç½®ä¸åŒï¼Œè¿™ä¸ªåœ¨å®é™…ç”Ÿäº§ä¸­è¦æ³¨æ„ã€‚ å®¢è§‚ä¸‹çº¿å®¢è§‚ä¸‹çº¿ï¼ˆObjectively Downï¼Œ ç®€ç§° ODOWNï¼‰æŒ‡çš„æ˜¯å¤šä¸ª Sentinel å®ä¾‹åœ¨å¯¹åŒä¸€ä¸ªæœåŠ¡å™¨åšå‡º SDOWN åˆ¤æ–­ï¼Œ å¹¶ä¸”é€šè¿‡ SENTINEL is-master-down-by-addr å‘½ä»¤äº’ç›¸äº¤æµä¹‹åï¼Œ å¾—å‡ºçš„æœåŠ¡å™¨ä¸‹çº¿åˆ¤æ–­ï¼Œç„¶åå¼€å¯failoverã€‚ å®¢è§‚ä¸‹çº¿å°±æ˜¯è¯´åªæœ‰åœ¨è¶³å¤Ÿæ•°é‡çš„ Sentinel éƒ½å°†ä¸€ä¸ªæœåŠ¡å™¨æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ä¹‹åï¼Œ æœåŠ¡å™¨æ‰ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿ï¼ˆODOWNï¼‰ã€‚ åªæœ‰å½“masterè¢«è®¤å®šä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿæ•…éšœè¿ç§»ã€‚ å½“sentinelç›‘è§†çš„æŸä¸ªæœåŠ¡ä¸»è§‚ä¸‹çº¿åï¼Œsentinelä¼šè¯¢é—®å…¶å®ƒç›‘è§†è¯¥æœåŠ¡çš„sentinelï¼Œçœ‹å®ƒä»¬æ˜¯å¦ä¹Ÿè®¤ä¸ºè¯¥æœåŠ¡ä¸»è§‚ä¸‹çº¿ï¼Œæ¥æ”¶åˆ°è¶³å¤Ÿæ•°é‡ï¼ˆè¿™ä¸ªå€¼å¯ä»¥é…ç½®ï¼‰çš„sentinelåˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œæ—¢è®¤ä¸ºè¯¥æœåŠ¡å®¢è§‚ä¸‹çº¿ï¼Œå¹¶å¯¹å…¶åšæ•…éšœè½¬ç§»æ“ä½œã€‚ sentinelé€šè¿‡å‘é€ SENTINEL is-master-down-by-addr ip port current_epoch runidï¼Œï¼ˆipï¼šä¸»è§‚ä¸‹çº¿çš„æœåŠ¡ipï¼Œportï¼šä¸»è§‚ä¸‹çº¿çš„æœåŠ¡ç«¯å£ï¼Œcurrent_epochï¼šsentinelçš„çºªå…ƒï¼Œrunidï¼š*è¡¨ç¤ºæ£€æµ‹æœåŠ¡ä¸‹çº¿çŠ¶æ€ï¼Œå¦‚æœæ˜¯sentinel è¿è¡Œidï¼Œè¡¨ç¤ºç”¨æ¥é€‰ä¸¾é¢†å¤´sentinelï¼‰æ¥è¯¢é—®å…¶å®ƒsentinelæ˜¯å¦åŒæ„æœåŠ¡ä¸‹çº¿ã€‚ ä¸€ä¸ªsentinelæ¥æ”¶å¦ä¸€ä¸ªsentinelå‘æ¥çš„is-master-down-by-addråï¼Œæå–å‚æ•°ï¼Œæ ¹æ®ipå’Œç«¯å£ï¼Œæ£€æµ‹è¯¥æœåŠ¡æ˜¯å¦åœ¨è¯¥sentinelä¸»è§‚ä¸‹çº¿ï¼Œå¹¶ä¸”å›å¤is-master-down-by-addrï¼Œå›å¤åŒ…å«ä¸‰ä¸ªå‚æ•°ï¼šdown_stateï¼ˆ1è¡¨ç¤ºå·²ä¸‹çº¿ï¼Œ0è¡¨ç¤ºæœªä¸‹çº¿ï¼‰ï¼Œleader_runidï¼ˆé¢†å¤´sentinal idï¼‰ï¼Œleader_epochï¼ˆé¢†å¤´sentinelçºªå…ƒï¼‰ã€‚ sentinelæ¥æ”¶åˆ°å›å¤åï¼Œæ ¹æ®é…ç½®è®¾ç½®çš„ä¸‹çº¿æœ€å°æ•°é‡ï¼Œè¾¾åˆ°è¿™ä¸ªå€¼ï¼Œæ—¢è®¤ä¸ºè¯¥æœåŠ¡å®¢è§‚ä¸‹çº¿ã€‚ å®¢è§‚ä¸‹çº¿æ¡ä»¶åªé€‚ç”¨äºä¸»æœåŠ¡å™¨ï¼š å¯¹äºä»»ä½•å…¶ä»–ç±»å‹çš„ Redis å®ä¾‹ï¼Œ Sentinel åœ¨å°†å®ƒä»¬åˆ¤æ–­ä¸ºä¸‹çº¿å‰ä¸éœ€è¦è¿›è¡Œåå•†ï¼Œ æ‰€ä»¥ä»æœåŠ¡å™¨æˆ–è€…å…¶ä»– Sentinel æ°¸è¿œä¸ä¼šè¾¾åˆ°å®¢è§‚ä¸‹çº¿æ¡ä»¶ã€‚åªè¦ä¸€ä¸ª Sentinel å‘ç°æŸä¸ªä¸»æœåŠ¡å™¨è¿›å…¥äº†å®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼Œ è¿™ä¸ª Sentinel å°±å¯èƒ½ä¼šè¢«å…¶ä»– Sentinel æ¨é€‰å‡ºï¼Œ å¹¶å¯¹å¤±æ•ˆçš„ä¸»æœåŠ¡å™¨æ‰§è¡Œè‡ªåŠ¨æ•…éšœè¿ç§»æ“ä½œã€‚ åœ¨redis-sentinelçš„confæ–‡ä»¶é‡Œæœ‰è¿™ä¹ˆä¸¤ä¸ªé…ç½®ï¼š1ï¼‰sentinel monitor &lt;masterName&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt; å››ä¸ªå‚æ•°å«ä¹‰ï¼šmasterNameè¿™ä¸ªæ˜¯å¯¹æŸä¸ªmaster+slaveç»„åˆçš„ä¸€ä¸ªåŒºåˆ†æ ‡è¯†ï¼ˆä¸€å¥—sentinelæ˜¯å¯ä»¥ç›‘å¬å¤šå¥—master+slaveè¿™æ ·çš„ç»„åˆçš„ï¼‰ã€‚ip å’Œ port å°±æ˜¯masterèŠ‚ç‚¹çš„ ip å’Œ ç«¯å£å·ã€‚quorumè¿™ä¸ªå‚æ•°æ˜¯è¿›è¡Œå®¢è§‚ä¸‹çº¿çš„ä¸€ä¸ªä¾æ®ï¼Œæ„æ€æ˜¯è‡³å°‘æœ‰ quorum ä¸ªsentinelä¸»è§‚çš„è®¤ä¸ºè¿™ä¸ªmasteræœ‰æ•…éšœï¼Œæ‰ä¼šå¯¹è¿™ä¸ªmasterè¿›è¡Œä¸‹çº¿ä»¥åŠæ•…éšœè½¬ç§»ã€‚å› ä¸ºæœ‰çš„æ—¶å€™ï¼ŒæŸä¸ªsentinelèŠ‚ç‚¹å¯èƒ½å› ä¸ºè‡ªèº«ç½‘ç»œåŸå› ï¼Œå¯¼è‡´æ— æ³•è¿æ¥masterï¼Œè€Œæ­¤æ—¶masterå¹¶æ²¡æœ‰å‡ºç°æ•…éšœï¼Œæ‰€ä»¥è¿™å°±éœ€è¦å¤šä¸ªsentineléƒ½ä¸€è‡´è®¤ä¸ºè¯¥masteræœ‰é—®é¢˜ï¼Œæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè¿™å°±ä¿è¯äº†å…¬å¹³æ€§å’Œé«˜å¯ç”¨ã€‚ 2ï¼‰sentinel down-after-milliseconds ** &lt; **masterName &gt; &lt;timeout&gt;è¿™ä¸ªé…ç½®å…¶å®å°±æ˜¯è¿›è¡Œä¸»è§‚ä¸‹çº¿çš„ä¸€ä¸ªä¾æ®ï¼ŒmasterNameè¿™ä¸ªå‚æ•°ä¸ç”¨è¯´äº†ï¼Œtimeoutæ˜¯ä¸€ä¸ªæ¯«ç§’å€¼ï¼Œè¡¨ç¤ºï¼šå¦‚æœè¿™å°sentinelè¶…è¿‡timeoutè¿™ä¸ªæ—¶é—´éƒ½æ— æ³•è¿é€šmasteråŒ…æ‹¬slaveï¼ˆslaveä¸éœ€è¦å®¢è§‚ä¸‹çº¿ï¼Œå› ä¸ºä¸éœ€è¦æ•…éšœè½¬ç§»ï¼‰çš„è¯ï¼Œå°±ä¼šä¸»è§‚è®¤ä¸ºè¯¥masterå·²ç»ä¸‹çº¿ï¼ˆå®é™…ä¸‹çº¿éœ€è¦å®¢è§‚ä¸‹çº¿çš„åˆ¤æ–­é€šè¿‡æ‰ä¼šä¸‹çº¿ï¼‰ é‚£ä¹ˆï¼Œå¤šä¸ªsentinelä¹‹é—´æ˜¯å¦‚ä½•è¾¾åˆ°å…±è¯†çš„å‘¢ï¼ŸæŸä¸ªsentinelå…ˆå°†masterèŠ‚ç‚¹è¿›è¡Œä¸»è§‚ä¸‹çº¿ï¼Œç„¶åä¼šå°†è¿™ä¸ªåˆ¤å®šé€šè¿‡sentinel is-master-down-by-addrè¿™ä¸ªå‘½ä»¤é—®å¯¹åº”çš„èŠ‚ç‚¹æ˜¯å¦ä¹ŸåŒæ ·è®¤ä¸ºè¯¥addrçš„masterèŠ‚ç‚¹è¦åšå®¢è§‚ä¸‹çº¿ã€‚æœ€åå½“è¾¾æˆè¿™ä¸€å…±è¯†çš„sentinelä¸ªæ•°è¾¾åˆ°å‰é¢è¯´çš„quorumè®¾ç½®çš„è¿™ä¸ªå€¼æ—¶ï¼Œå°±ä¼šå¯¹è¯¥masterèŠ‚ç‚¹ä¸‹çº¿è¿›è¡Œæ•…éšœè½¬ç§»ã€‚quorumçš„å€¼ä¸€èˆ¬è®¾ç½®ä¸ºsentinelä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ 1ï¼Œä¾‹å¦‚3ä¸ªsentinelå°±è®¾ç½®2ã€‚ é€‰ä¸¾é¢†å¤´sentinel ä¸€ä¸ªredisæœåŠ¡è¢«åˆ¤æ–­ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼Œå¤šä¸ªç›‘è§†è¯¥æœåŠ¡çš„sentinelåå•†ï¼Œé€‰ä¸¾ä¸€ä¸ªé¢†å¤´sentinelï¼Œå¯¹è¯¥redisæœåŠ¡è¿›è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚é€‰ä¸¾é¢†å¤´sentineléµå¾ªä»¥ä¸‹è§„åˆ™ï¼š 1ï¼‰æ‰€æœ‰çš„sentineléƒ½æœ‰å…¬å¹³è¢«é€‰ä¸¾æˆé¢†å¤´çš„èµ„æ ¼ã€‚2ï¼‰æ‰€æœ‰çš„sentineléƒ½æœ‰ä¸”åªæœ‰ä¸€æ¬¡å°†æŸä¸ªsentinelé€‰ä¸¾æˆé¢†å¤´çš„æœºä¼šï¼ˆåœ¨ä¸€è½®é€‰ä¸¾ä¸­ï¼‰ï¼Œä¸€æ—¦é€‰ä¸¾æŸä¸ªsentinelä¸ºé¢†å¤´ï¼Œä¸èƒ½æ›´æ”¹ã€‚3ï¼‰sentinelè®¾ç½®é¢†å¤´sentinelæ˜¯å…ˆåˆ°å…ˆå¾—ï¼Œä¸€æ—¦å½“å‰sentinelè®¾ç½®äº†é¢†å¤´sentinelï¼Œä»¥åè¦æ±‚è®¾ç½®å…¶ä»–sentinelä¸ºé¢†å¤´è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ã€‚4ï¼‰æ¯ä¸ªå‘ç°æœåŠ¡å®¢è§‚ä¸‹çº¿çš„sentinelï¼Œéƒ½ä¼šè¦æ±‚å…¶ä»–sentinelå°†è‡ªå·±è®¾ç½®æˆé¢†å¤´ã€‚5ï¼‰å½“ä¸€ä¸ªsentinelï¼ˆæºsentinelï¼‰å‘å¦ä¸€ä¸ªsentinelï¼ˆç›®æ ‡sentinelï¼‰å‘é€is-master-down-by-addr ip port current_epoch runidå‘½ä»¤çš„æ—¶å€™ï¼Œrunidå‚æ•°ä¸æ˜¯*ï¼Œè€Œæ˜¯sentinelè¿è¡Œidï¼Œå°±è¡¨ç¤ºæºsentinelè¦æ±‚ç›®æ ‡sentinelé€‰ä¸¾å…¶ä¸ºé¢†å¤´ã€‚6ï¼‰æºsentinelä¼šæ£€æŸ¥ç›®æ ‡sentinelå¯¹å…¶è¦æ±‚è®¾ç½®æˆé¢†å¤´çš„å›å¤ï¼Œå¦‚æœå›å¤çš„leader_runidå’Œleader_epochä¸ºæºsentinelï¼Œè¡¨ç¤ºç›®æ ‡sentinelåŒæ„å°†æºsentinelè®¾ç½®æˆé¢†å¤´ã€‚7ï¼‰å¦‚æœæŸä¸ªsentinelè¢«åŠæ•°ä»¥ä¸Šçš„sentinelè®¾ç½®æˆé¢†å¤´ï¼Œé‚£ä¹ˆè¯¥sentinelæ—¢ä¸ºé¢†å¤´ã€‚8ï¼‰å¦‚æœåœ¨é™å®šæ—¶é—´å†…ï¼Œæ²¡æœ‰é€‰ä¸¾å‡ºé¢†å¤´sentinelï¼Œæš‚å®šä¸€æ®µæ—¶é—´ï¼Œå†é€‰ä¸¾ã€‚ æ•…éšœè½¬ç§»æ‰€è°“æ•…éšœè½¬ç§»å°±æ˜¯å½“masterå®•æœºï¼Œé€‰ä¸€ä¸ªåˆé€‚çš„slaveæ¥æ™‹å‡ä¸ºmasterçš„æ“ä½œï¼Œredis-sentinelä¼šè‡ªåŠ¨å®Œæˆè¿™ä¸ªï¼Œä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥å®ç°ã€‚ ä¸€æ¬¡æ•…éšœè½¬ç§»æ“ä½œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹æµç¨‹ï¼šå‘ç°ä¸»æœåŠ¡å™¨å·²ç»è¿›å…¥å®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚å¯¹æˆ‘ä»¬çš„å½“å‰é›†ç¾¤è¿›è¡Œè‡ªå¢ï¼Œ å¹¶å°è¯•åœ¨è¿™ä¸ªé›†ç¾¤ä¸­å½“é€‰ã€‚å¦‚æœå½“é€‰å¤±è´¥ï¼Œ é‚£ä¹ˆåœ¨è®¾å®šçš„æ•…éšœè¿ç§»è¶…æ—¶æ—¶é—´çš„ä¸¤å€ä¹‹åï¼Œ é‡æ–°å°è¯•å½“é€‰ã€‚ å¦‚æœå½“é€‰æˆåŠŸï¼Œ é‚£ä¹ˆæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š é€‰å‡ºä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œå¹¶å°†å®ƒå‡çº§ä¸ºä¸»æœåŠ¡å™¨ã€‚å‘è¢«é€‰ä¸­çš„ä»æœåŠ¡å™¨å‘é€ SLAVEOF NO ONE å‘½ä»¤ï¼Œè®©å®ƒè½¬å˜ä¸ºä¸»æœåŠ¡å™¨ã€‚é€šè¿‡å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ï¼Œ å°†æ›´æ–°åçš„é…ç½®ä¼ æ’­ç»™æ‰€æœ‰å…¶ä»– Sentinel ï¼Œ å…¶ä»– Sentinel å¯¹å®ƒä»¬è‡ªå·±çš„é…ç½®è¿›è¡Œæ›´æ–°ã€‚å‘å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤ï¼Œ è®©å®ƒä»¬å»å¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ã€‚å½“æ‰€æœ‰ä»æœåŠ¡å™¨éƒ½å·²ç»å¼€å§‹å¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨æ—¶ï¼Œ é¢†å¤´ Sentinel ç»ˆæ­¢è¿™æ¬¡æ•…éšœè¿ç§»æ“ä½œã€‚æ¯å½“ä¸€ä¸ª Redis å®ä¾‹è¢«é‡æ–°é…ç½®ï¼ˆreconfiguredï¼‰ â€”â€” æ— è®ºæ˜¯è¢«è®¾ç½®æˆä¸»æœåŠ¡å™¨ã€ä»æœåŠ¡å™¨ã€åˆæˆ–è€…è¢«è®¾ç½®æˆå…¶ä»–ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ â€”â€” Sentinel éƒ½ä¼šå‘è¢«é‡æ–°é…ç½®çš„å®ä¾‹å‘é€ä¸€ä¸ª CONFIG REWRITE å‘½ä»¤ï¼Œ ä»è€Œç¡®ä¿è¿™äº›é…ç½®ä¼šæŒä¹…åŒ–åœ¨ç¡¬ç›˜é‡Œã€‚ Sentinel ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥é€‰æ‹©æ–°çš„ä¸»æœåŠ¡å™¨ï¼š åœ¨å¤±æ•ˆä¸»æœåŠ¡å™¨å±ä¸‹çš„ä»æœåŠ¡å™¨å½“ä¸­ï¼Œ é‚£äº›è¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€å·²æ–­çº¿ã€æˆ–è€…æœ€åä¸€æ¬¡å›å¤ PING å‘½ä»¤çš„æ—¶é—´å¤§äºäº”ç§’é’Ÿçš„ä»æœåŠ¡å™¨éƒ½ä¼šè¢«æ·˜æ±°ã€‚ åœ¨å¤±æ•ˆä¸»æœåŠ¡å™¨å±ä¸‹çš„ä»æœåŠ¡å™¨å½“ä¸­ï¼Œ é‚£äº›ä¸å¤±æ•ˆä¸»æœåŠ¡å™¨è¿æ¥æ–­å¼€çš„æ—¶é•¿è¶…è¿‡ down-after é€‰é¡¹æŒ‡å®šçš„æ—¶é•¿åå€çš„ä»æœåŠ¡å™¨éƒ½ä¼šè¢«æ·˜æ±°ã€‚ åœ¨ç»å†äº†ä»¥ä¸Šä¸¤è½®æ·˜æ±°ä¹‹åå‰©ä¸‹æ¥çš„ä»æœåŠ¡å™¨ä¸­ï¼Œ æˆ‘ä»¬é€‰å‡ºå¤åˆ¶åç§»é‡ï¼ˆreplication offsetï¼‰æœ€å¤§çš„é‚£ä¸ªä»æœåŠ¡å™¨ä½œä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼› å¦‚æœå¤åˆ¶åç§»é‡ä¸å¯ç”¨ï¼Œ æˆ–è€…ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ç›¸åŒï¼Œ é‚£ä¹ˆå¸¦æœ‰æœ€å°è¿è¡Œ ID çš„é‚£ä¸ªä»æœåŠ¡å™¨æˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚ Sentinel è‡ªåŠ¨æ•…éšœè¿ç§»çš„ä¸€è‡´æ€§ç‰¹è´¨ Sentinel è‡ªåŠ¨æ•…éšœè¿ç§»ä½¿ç”¨ Raft ç®—æ³•æ¥é€‰ä¸¾é¢†å¤´ï¼ˆleaderï¼‰ Sentinel ï¼Œ ä»è€Œç¡®ä¿åœ¨ä¸€ä¸ªç»™å®šçš„çºªå…ƒï¼ˆepochï¼‰é‡Œï¼Œ åªæœ‰ä¸€ä¸ªé¢†å¤´äº§ç”Ÿã€‚ è¿™è¡¨ç¤ºåœ¨åŒä¸€ä¸ªçºªå…ƒä¸­ï¼Œ ä¸ä¼šæœ‰ä¸¤ä¸ª Sentinel åŒæ—¶è¢«é€‰ä¸­ä¸ºé¢†å¤´ï¼Œ å¹¶ä¸”å„ä¸ª Sentinel åœ¨åŒä¸€ä¸ªçºªå…ƒä¸­åªä¼šå¯¹ä¸€ä¸ªé¢†å¤´è¿›è¡ŒæŠ•ç¥¨ã€‚ æ›´é«˜çš„é…ç½®çºªå…ƒæ€»æ˜¯ä¼˜äºè¾ƒä½çš„çºªå…ƒï¼Œ å› æ­¤æ¯ä¸ª Sentinel éƒ½ä¼šä¸»åŠ¨ä½¿ç”¨æ›´æ–°çš„çºªå…ƒæ¥ä»£æ›¿è‡ªå·±çš„é…ç½®ã€‚ ç®€å•æ¥è¯´ï¼Œ å¯ä»¥å°† Sentinel é…ç½®çœ‹ä½œæ˜¯ä¸€ä¸ªå¸¦æœ‰ç‰ˆæœ¬å·çš„çŠ¶æ€ã€‚ ä¸€ä¸ªçŠ¶æ€ä¼šä»¥æœ€åå†™å…¥è€…èƒœå‡ºï¼ˆlast-write-winsï¼‰çš„æ–¹å¼ï¼ˆä¹Ÿå³æ˜¯ï¼Œæœ€æ–°çš„é…ç½®æ€»æ˜¯èƒœå‡ºï¼‰ä¼ æ’­è‡³æ‰€æœ‰å…¶ä»– Sentinel ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œ å½“å‡ºç°ç½‘ç»œåˆ†å‰²ï¼ˆnetwork partitionsï¼‰æ—¶ï¼Œ ä¸€ä¸ª Sentinel å¯èƒ½ä¼šåŒ…å«äº†è¾ƒæ—§çš„é…ç½®ï¼Œ è€Œå½“è¿™ä¸ª Sentinel æ¥åˆ°å…¶ä»– Sentinel å‘æ¥çš„ç‰ˆæœ¬æ›´æ–°çš„é…ç½®æ—¶ï¼Œ Sentinel å°±ä¼šå¯¹è‡ªå·±çš„é…ç½®è¿›è¡Œæ›´æ–°ã€‚ å¦‚æœè¦åœ¨ç½‘ç»œåˆ†å‰²å‡ºç°çš„æƒ…å†µä¸‹ä»ç„¶ä¿æŒä¸€è‡´æ€§ï¼Œ é‚£ä¹ˆåº”è¯¥ä½¿ç”¨ min-slaves-to-write é€‰é¡¹ï¼Œ è®©ä¸»æœåŠ¡å™¨åœ¨è¿æ¥çš„ä»å®ä¾‹å°‘äºç»™å®šæ•°é‡æ—¶åœæ­¢æ‰§è¡Œå†™æ“ä½œï¼Œ ä¸æ­¤åŒæ—¶ï¼Œ åº”è¯¥åœ¨æ¯ä¸ªè¿è¡Œ Redis ä¸»æœåŠ¡å™¨æˆ–ä»æœåŠ¡å™¨çš„æœºå™¨ä¸Šè¿è¡Œ Redis Sentinel è¿›ç¨‹ã€‚ Sentinel çŠ¶æ€çš„æŒä¹…åŒ– Sentinel çš„çŠ¶æ€ä¼šè¢«æŒä¹…åŒ–åœ¨ Sentinel é…ç½®æ–‡ä»¶é‡Œé¢ã€‚æ¯å½“ Sentinel æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„é…ç½®ï¼Œ æˆ–è€…å½“é¢†å¤´ Sentinel ä¸ºä¸»æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®æ—¶ï¼Œ è¿™ä¸ªé…ç½®ä¼šä¸é…ç½®çºªå…ƒä¸€èµ·è¢«ä¿å­˜åˆ°ç£ç›˜é‡Œé¢ã€‚è¿™æ„å‘³ç€åœæ­¢å’Œé‡å¯ Sentinel è¿›ç¨‹éƒ½æ˜¯å®‰å…¨çš„ã€‚ Sentinel åœ¨éæ•…éšœè¿ç§»çš„æƒ…å†µä¸‹å¯¹å®ä¾‹è¿›è¡Œé‡æ–°é…ç½®å³ä½¿æ²¡æœ‰è‡ªåŠ¨æ•…éšœè¿ç§»æ“ä½œåœ¨è¿›è¡Œï¼Œ Sentinel æ€»ä¼šå°è¯•å°†å½“å‰çš„é…ç½®è®¾ç½®åˆ°è¢«ç›‘è§†çš„å®ä¾‹ä¸Šé¢ã€‚ ç‰¹åˆ«æ˜¯ï¼š æ ¹æ®å½“å‰çš„é…ç½®ï¼Œ å¦‚æœä¸€ä¸ªä»æœåŠ¡å™¨è¢«å®£å‘Šä¸ºä¸»æœåŠ¡å™¨ï¼Œ é‚£ä¹ˆå®ƒä¼šä»£æ›¿åŸæœ‰çš„ä¸»æœåŠ¡å™¨ï¼Œ æˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼Œ å¹¶ä¸”æˆä¸ºåŸæœ‰ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨çš„å¤åˆ¶å¯¹è±¡ã€‚é‚£äº›è¿æ¥äº†é”™è¯¯ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ä¼šè¢«é‡æ–°é…ç½®ï¼Œ ä½¿å¾—è¿™äº›ä»æœåŠ¡å™¨ä¼šå»å¤åˆ¶æ­£ç¡®çš„ä¸»æœåŠ¡å™¨ã€‚ ä¸è¿‡ï¼Œ åœ¨ä»¥ä¸Šè¿™äº›æ¡ä»¶æ»¡è¶³ä¹‹åï¼Œ Sentinel åœ¨å¯¹å®ä¾‹è¿›è¡Œé‡æ–°é…ç½®ä¹‹å‰ä»ç„¶ä¼šç­‰å¾…ä¸€æ®µè¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œ ç¡®ä¿å¯ä»¥æ¥æ”¶åˆ°å…¶ä»– Sentinel å‘æ¥çš„é…ç½®æ›´æ–°ï¼Œ ä»è€Œé¿å…è‡ªèº«å› ä¸ºä¿å­˜äº†è¿‡æœŸçš„é…ç½®è€Œå¯¹å®ä¾‹è¿›è¡Œäº†ä¸å¿…è¦çš„é‡æ–°é…ç½®ã€‚ æ€»ç»“æ¥è¯´ï¼Œæ•…éšœè½¬ç§»åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š 1ï¼‰ä»ä¸‹çº¿çš„ä¸»æœåŠ¡çš„æ‰€æœ‰ä»æœåŠ¡é‡Œé¢æŒ‘é€‰ä¸€ä¸ªä»æœåŠ¡ï¼Œå°†å…¶è½¬æˆä¸»æœåŠ¡sentinelçŠ¶æ€æ•°æ®ç»“æ„ä¸­ä¿å­˜äº†ä¸»æœåŠ¡çš„æ‰€æœ‰ä»æœåŠ¡ä¿¡æ¯ï¼Œé¢†å¤´sentinelæŒ‰ç…§å¦‚ä¸‹çš„è§„åˆ™ä»ä»æœåŠ¡åˆ—è¡¨ä¸­æŒ‘é€‰å‡ºæ–°çš„ä¸»æœåŠ¡ï¼›åˆ é™¤åˆ—è¡¨ä¸­å¤„äºä¸‹çº¿çŠ¶æ€çš„ä»æœåŠ¡ï¼›åˆ é™¤æœ€è¿‘5ç§’æ²¡æœ‰å›å¤è¿‡é¢†å¤´sentinel infoä¿¡æ¯çš„ä»æœåŠ¡ï¼›åˆ é™¤ä¸å·²ä¸‹çº¿çš„ä¸»æœåŠ¡æ–­å¼€è¿æ¥æ—¶é—´è¶…è¿‡ down-after-milliseconds*10æ¯«ç§’çš„ä»æœåŠ¡ï¼Œè¿™æ ·å°±èƒ½ä¿ç•™ä»çš„æ•°æ®æ¯”è¾ƒæ–°ï¼ˆæ²¡æœ‰è¿‡æ—©çš„ä¸ä¸»æ–­å¼€è¿æ¥ï¼‰ï¼›é¢†å¤´sentinelä»å‰©ä¸‹çš„ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¼˜å…ˆçº§é«˜çš„ï¼Œå¦‚æœä¼˜å…ˆçº§ä¸€æ ·ï¼Œé€‰æ‹©åç§»é‡æœ€å¤§çš„ï¼ˆåç§»é‡å¤§è¯´æ˜å¤åˆ¶çš„æ•°æ®æ¯”è¾ƒæ–°ï¼‰ï¼Œå¦‚æœåç§»é‡ä¸€æ ·ï¼Œé€‰æ‹©è¿è¡Œidæœ€å°çš„ä»æœåŠ¡ã€‚ 2ï¼‰å·²ä¸‹çº¿ä¸»æœåŠ¡çš„æ‰€æœ‰ä»æœåŠ¡æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡æŒ‘é€‰å‡ºæ–°çš„ä¸»æœåŠ¡ä¹‹åï¼Œé¢†å¤´sentinel å‘åŸä¸»æœåŠ¡çš„ä»æœåŠ¡å‘é€ slaveof æ–°ä¸»æœåŠ¡ çš„å‘½ä»¤ï¼Œå¤åˆ¶æ–°masterã€‚ 3ï¼‰å°†å·²ä¸‹çº¿çš„ä¸»æœåŠ¡è®¾ç½®æˆæ–°çš„ä¸»æœåŠ¡çš„ä»æœåŠ¡ï¼Œå½“å…¶å›å¤æ­£å¸¸æ—¶ï¼Œå¤åˆ¶æ–°çš„ä¸»æœåŠ¡ï¼Œå˜æˆæ–°çš„ä¸»æœåŠ¡çš„ä»æœåŠ¡åŒç†ï¼Œå½“å·²ä¸‹çº¿çš„æœåŠ¡é‡æ–°ä¸Šçº¿æ—¶ï¼Œsentinelä¼šå‘å…¶å‘é€slaveofå‘½ä»¤ï¼Œè®©å…¶æˆä¸ºæ–°ä¸»çš„ä»ã€‚ æ¸©é¦¨æç¤ºï¼šè¿˜å¯ä»¥å‘ä»»æ„sentinelå‘ç”Ÿsentinel failover è¿›è¡Œæ‰‹åŠ¨æ•…éšœè½¬ç§»ï¼Œè¿™æ ·å°±ä¸éœ€è¦ç»è¿‡ä¸Šè¿°ä¸»å®¢è§‚å’Œé€‰ä¸¾çš„è¿‡ç¨‹ã€‚ é›†ç¾¤æ¨¡å¼ Redis Clusterå®ç°åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œæ•°æ®å…±äº«ï¼Œå³ä½¿éƒ¨åˆ†èŠ‚ç‚¹å¤±æ•ˆæˆ–è€…æ— æ³•è¿›è¡Œé€šè®¯æ—¶ï¼ŒClusterä»ç„¶å¯ä»¥ç»§ç»­å¤„ç†è¯·æ±‚ã€‚è‹¥æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹æ”¯æŒï¼Œåœ¨ä¸»èŠ‚ç‚¹ä¸‹çº¿æˆ–è€…æ— æ³•ä¸é›†ç¾¤çš„å¤§å¤šæ•°èŠ‚ç‚¹è¿›è¡Œé€šè®¯çš„æƒ…å†µä¸‹ï¼Œ ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶æä¾›æœåŠ¡ï¼Œä¿è¯Clusteræ­£å¸¸è¿è¡Œï¼ŒRedis Clusterçš„èŠ‚ç‚¹åˆ†ç‰‡æ˜¯é€šè¿‡å“ˆå¸Œæ§½ï¼ˆhash slotï¼‰å®ç°çš„ï¼Œæ¯ä¸ªé”®éƒ½å±äºè¿™ 16384ï¼ˆ0ï½16383ï¼‰ ä¸ªå“ˆå¸Œæ§½çš„å…¶ä¸­ä¸€ä¸ªï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å¤„ç†ä¸€éƒ¨åˆ†å“ˆå¸Œæ§½ã€‚ æ•°æ®shardingRedis é›†ç¾¤ä½¿ç”¨æ•°æ®åˆ†ç‰‡ï¼ˆshardingï¼‰è€Œéä¸€è‡´æ€§å“ˆå¸Œï¼ˆconsistency hashingï¼‰æ¥å®ç°ï¼š ä¸€ä¸ª Redis é›†ç¾¤åŒ…å« 16384 ä¸ªå“ˆå¸Œæ§½ï¼ˆhash slotï¼‰ï¼Œ æ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½å±äºè¿™ 16384 ä¸ªå“ˆå¸Œæ§½çš„å…¶ä¸­ä¸€ä¸ªï¼Œ é›†ç¾¤ä½¿ç”¨å…¬å¼ CRC16(key) % 16384 æ¥è®¡ç®—é”® key å±äºå“ªä¸ªæ§½ï¼Œ å…¶ä¸­ CRC16(key) è¯­å¥ç”¨äºè®¡ç®—é”® key çš„ CRC16 æ ¡éªŒå’Œ ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å¤„ç†ä¸€éƒ¨åˆ†å“ˆå¸Œæ§½ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œ ä¸€ä¸ªé›†ç¾¤å¯ä»¥æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œ å…¶ä¸­ï¼š èŠ‚ç‚¹ A è´Ÿè´£å¤„ç† 0 å·è‡³ 5500 å·å“ˆå¸Œæ§½ã€‚ èŠ‚ç‚¹ B è´Ÿè´£å¤„ç† 5501 å·è‡³ 11000 å·å“ˆå¸Œæ§½ã€‚ èŠ‚ç‚¹ C è´Ÿè´£å¤„ç† 11001 å·è‡³ 16384 å·å“ˆå¸Œæ§½ã€‚ è¿™ç§å°†å“ˆå¸Œæ§½åˆ†å¸ƒåˆ°ä¸åŒèŠ‚ç‚¹çš„åšæ³•ä½¿å¾—ç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“åœ°å‘é›†ç¾¤ä¸­æ·»åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹ã€‚ æ¯”å¦‚è¯´ï¼š å¦‚æœç”¨æˆ·å°†æ–°èŠ‚ç‚¹ D æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œ é‚£ä¹ˆé›†ç¾¤åªéœ€è¦å°†èŠ‚ç‚¹ A ã€B ã€ C ä¸­çš„æŸäº›æ§½ç§»åŠ¨åˆ°èŠ‚ç‚¹ D å°±å¯ä»¥äº†ã€‚ å¦‚æœç”¨æˆ·è¦ä»é›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹ A ï¼Œ é‚£ä¹ˆé›†ç¾¤åªéœ€è¦å°†èŠ‚ç‚¹ A ä¸­çš„æ‰€æœ‰å“ˆå¸Œæ§½ç§»åŠ¨åˆ°èŠ‚ç‚¹ B å’ŒèŠ‚ç‚¹ C ï¼Œ ç„¶åå†ç§»é™¤ç©ºç™½ï¼ˆä¸åŒ…å«ä»»ä½•å“ˆå¸Œæ§½ï¼‰çš„èŠ‚ç‚¹ A å°±å¯ä»¥äº†ã€‚ å› ä¸ºå°†ä¸€ä¸ªå“ˆå¸Œæ§½ä»ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¼šé€ æˆèŠ‚ç‚¹é˜»å¡ï¼Œ æ‰€ä»¥æ— è®ºæ˜¯æ·»åŠ æ–°èŠ‚ç‚¹è¿˜æ˜¯ç§»é™¤å·²å­˜åœ¨èŠ‚ç‚¹ï¼Œ åˆæˆ–è€…æ”¹å˜æŸä¸ªèŠ‚ç‚¹åŒ…å«çš„å“ˆå¸Œæ§½æ•°é‡ï¼Œ éƒ½ä¸ä¼šé€ æˆé›†ç¾¤ä¸‹çº¿ é›†ç¾¤å†…éƒ¨æ•°æ®ç»“æ„Redis ClusteråŠŸèƒ½æ¶‰åŠä¸‰ä¸ªæ ¸å¿ƒçš„æ•°æ®ç»“æ„clusterStateã€clusterNodeã€clusterLinkéƒ½åœ¨cluster.hä¸­å®šä¹‰ã€‚è¿™ä¸‰ä¸ªæ•°æ®ç»“æ„ä¸­æœ€é‡è¦çš„å±æ€§å°±æ˜¯ï¼šclusterState.slotsã€clusterState.slots_to_keyså’ŒclusterNode.slotsäº†ï¼Œå®ƒä»¬ä¿å­˜äº†ä¸‰ç§æ˜ å°„å…³ç³»ï¼š clusterStateï¼šé›†ç¾¤çŠ¶æ€ nodesï¼šæ‰€æœ‰ç»“ç‚¹ migrating_slots_toï¼šè¿å‡ºä¸­çš„æ§½ importing_slots_fromï¼šå¯¼å…¥ä¸­çš„æ§½ slots_to_keysï¼šæ§½ä¸­åŒ…å«çš„æ‰€æœ‰Keyï¼Œç”¨äºè¿ç§»Slotæ—¶è·å¾—å…¶åŒ…å«çš„Key slotsï¼šSlotæ‰€å±çš„ç»“ç‚¹ï¼Œç”¨äºå¤„ç†è¯·æ±‚æ—¶åˆ¤æ–­Keyæ‰€åœ¨Slotæ˜¯å¦è‡ªå·±è´Ÿè´£ clusterNodeï¼šç»“ç‚¹ä¿¡æ¯ slotsï¼šç»“ç‚¹è´Ÿè´£çš„æ‰€æœ‰Slotï¼Œç”¨äºå‘é€Gossipæ¶ˆæ¯é€šçŸ¥å…¶ä»–ç»“ç‚¹è‡ªå·±è´Ÿè´£çš„Slotã€‚é€šè¿‡ä½å›¾æ–¹å¼ä¿å­˜èŠ‚çœç©ºé—´ï¼Œ16384/8æ°å¥½æ˜¯2048å­—èŠ‚ï¼Œæ‰€ä»¥æ§½æ€»æ•°16384ä¸èƒ½éšæ„å®šï¼ clusterLinkï¼šä¸å…¶ä»–ç»“ç‚¹é€šä¿¡çš„è¿æ¥ é›†ç¾¤çŠ¶æ€ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ªè¿™æ ·çš„çŠ¶æ€ï¼Œè®°å½•äº†å®ƒä»¬çœ¼ä¸­çš„é›†ç¾¤çš„æ ·å­ã€‚å¦å¤–ï¼Œè™½ç„¶è¿™ä¸ªç»“æ„ä¸»è¦ç”¨äºè®°å½•é›†ç¾¤çš„å±æ€§ï¼Œä½†æ˜¯ä¸ºäº†èŠ‚çº¦èµ„æºï¼Œæœ‰äº›ä¸èŠ‚ç‚¹æœ‰å…³çš„å±æ€§ï¼Œæ¯”å¦‚ slots_to_keys ã€ failover_auth_count ä¹Ÿè¢«æ”¾åˆ°äº†è¿™ä¸ªç»“æ„é‡Œé¢ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687typedef struct clusterState &#123; ... //æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„æŒ‡é’ˆ clusterNode *myself; /* This node */ //é›†ç¾¤å½“å‰çš„çŠ¶æ€ï¼šæ˜¯åœ¨çº¿è¿˜æ˜¯ä¸‹çº¿ int state; /* REDIS_CLUSTER_OK, REDIS_CLUSTER_FAIL, ... */ //é›†ç¾¤å½“å‰çš„é…ç½®çºªå…ƒ,ç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t currentEpoch; //é›†ç¾¤ä¸­è‡³å°‘å¤„ç†ç€ä¸€ä¸ªæ§½çš„èŠ‚ç‚¹çš„æ•°é‡ int size; //é›†ç¾¤èŠ‚ç‚¹åå•ï¼ˆåŒ…æ‹¬ myself èŠ‚ç‚¹ï¼‰ //å­—å…¸çš„é”®ä¸ºèŠ‚ç‚¹çš„åå­—ï¼Œå­—å…¸çš„å€¼ä¸º clusterNode ç»“æ„ dict *nodes; /* Hash table of name -&gt; clusterNode structures */ //è®°å½•è¦ä»å½“å‰èŠ‚ç‚¹è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹çš„æ§½ï¼Œä»¥åŠè¿ç§»çš„ç›®æ ‡èŠ‚ç‚¹ //migrating_slots_to[i] = NULL è¡¨ç¤ºæ§½ i æœªè¢«è¿ç§» //migrating_slots_to[i] = clusterNode_A è¡¨ç¤ºæ§½ i è¦ä»æœ¬èŠ‚ç‚¹è¿ç§»è‡³èŠ‚ç‚¹ A clusterNode *migrating_slots_to[REDIS_CLUSTER_SLOTS]; //è®°å½•è¦ä»æºèŠ‚ç‚¹è¿ç§»åˆ°æœ¬èŠ‚ç‚¹çš„æ§½ï¼Œä»¥åŠè¿›è¡Œè¿ç§»çš„æºèŠ‚ç‚¹ //importing_slots_from[i] = NULL è¡¨ç¤ºæ§½ i æœªè¿›è¡Œå¯¼å…¥ //importing_slots_from[i] = clusterNode_A è¡¨ç¤ºæ­£ä»èŠ‚ç‚¹ A ä¸­å¯¼å…¥æ§½ i clusterNode *importing_slots_from[REDIS_CLUSTER_SLOTS]; //è´Ÿè´£å¤„ç†å„ä¸ªæ§½çš„èŠ‚ç‚¹ //ä¾‹å¦‚ slots[i] = clusterNode_A è¡¨ç¤ºæ§½ i ç”±èŠ‚ç‚¹ A å¤„ç† clusterNode *slots[REDIS_CLUSTER_SLOTS]; //è·³è·ƒè¡¨ï¼Œè¡¨ä¸­ä»¥æ§½ä½œä¸ºåˆ†å€¼ï¼Œé”®ä½œä¸ºæˆå‘˜ï¼Œå¯¹æ§½è¿›è¡Œæœ‰åºæ’åº //å½“éœ€è¦å¯¹æŸäº›æ§½è¿›è¡ŒåŒºé—´ï¼ˆrangeï¼‰æ“ä½œæ—¶ï¼Œè¿™ä¸ªè·³è·ƒè¡¨å¯ä»¥æä¾›æ–¹ä¾¿ //å…·ä½“æ“ä½œå®šä¹‰åœ¨ db.c é‡Œé¢ zskiplist *slots_to_keys; ...&#125; clusterState; //èŠ‚ç‚¹çŠ¶æ€struct clusterNode &#123; ... //åˆ›å»ºèŠ‚ç‚¹çš„æ—¶é—´ mstime_t ctime; //ä»èŠ‚ç‚¹çš„åå­—,ç”±40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ç»„æˆ char name[REDIS_CLUSTER_NAMELEN]; //èŠ‚ç‚¹æ ‡è¯† //ä½¿ç”¨å„ç§ä¸åŒçš„æ ‡è¯†å€¼è®°å½•èŠ‚ç‚¹çš„è§’è‰²ï¼ˆæ¯”å¦‚ä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹ï¼‰ï¼Œ //ä»¥åŠèŠ‚ç‚¹ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼ˆæ¯”å¦‚åœ¨çº¿æˆ–è€…ä¸‹çº¿ï¼‰ã€‚ int flags; /* REDIS_NODE_... */ //èŠ‚ç‚¹å½“å‰çš„é…ç½®çºªå…ƒ,ç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t configEpoch; //èŠ‚ç‚¹çš„ipåœ°å€ char ip[REDIS_IP_STR_LEN] //èŠ‚ç‚¹çš„ç«¯å£å· int port; //ç”±è¿™ä¸ªèŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½ //ä¸€å…±æœ‰ REDIS_CLUSTER_SLOTS / 8 ä¸ªå­—èŠ‚é•¿ //æ¯ä¸ªå­—èŠ‚çš„æ¯ä¸ªä½è®°å½•äº†ä¸€ä¸ªæ§½çš„ä¿å­˜çŠ¶æ€ //ä½çš„å€¼ä¸º 1 è¡¨ç¤ºæ§½æ­£ç”±æœ¬èŠ‚ç‚¹å¤„ç†ï¼Œå€¼ä¸º 0 åˆ™è¡¨ç¤ºæ§½å¹¶éæœ¬èŠ‚ç‚¹å¤„ç† //æ¯”å¦‚ slots[0] çš„ç¬¬ä¸€ä¸ªä½ä¿å­˜äº†æ§½ 0 çš„ä¿å­˜æƒ…å†µ //slots[0] çš„ç¬¬äºŒä¸ªä½ä¿å­˜äº†æ§½ 1 çš„ä¿å­˜æƒ…å†µï¼Œä»¥æ­¤ç±»æ¨ unsigned char slots[REDIS_CLUSTER_SLOTS/8]; /* slots handled by this node */ //æŒ‡é’ˆæ•°ç»„ï¼ŒæŒ‡å‘å„ä¸ªä»èŠ‚ç‚¹ struct clusterNode **slaves; /* pointers to slave nodes */ //å¦‚æœè¿™æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæŒ‡å‘ä¸»èŠ‚ç‚¹ struct clusterNode *slaveof; /* pointer to the master node */ ... //ä¿å­˜è¿æ¥ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯ clusterLink *link;&#125;; /* clusterLink encapsulates everything needed to talk with a remote node. *///clusterLink åŒ…å«äº†ä¸å…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€šè®¯æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯typedef struct clusterLink &#123; ... //TCP å¥—æ¥å­—æè¿°ç¬¦ int fd; /* TCP socket file descriptor */ //è¾“å‡ºç¼“å†²åŒº,ä¿å­˜ç€ç­‰å¾…å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯(message) sds sndbuf; //è¾“å…¥ç¼“å†²åŒº,ä¿å­˜ç€ä»å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°çš„æ¶ˆæ¯ sds rcvbuf; //ä¸è¿™ä¸ªè¿æ¥ç›¸å…³è”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¸º NULL struct clusterNode *node; /* Node related to this link if any, or NULL */ ...&#125; clusterLink; Redis Clusteré›†ç¾¤çš„å¤„ç†æµç¨‹åœ¨å•æœºæ¨¡å¼ä¸‹ï¼ŒRediså¯¹è¯·æ±‚çš„å¤„ç†å¾ˆç®€å•ã€‚Keyå­˜åœ¨çš„è¯ï¼Œå°±æ‰§è¡Œè¯·æ±‚ä¸­çš„æ“ä½œï¼›Keyä¸å­˜åœ¨çš„è¯ï¼Œå°±å‘Šè¯‰å®¢æˆ·ç«¯Keyä¸å­˜åœ¨ã€‚ç„¶è€Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå› ä¸ºæ¶‰åŠåˆ°è¯·æ±‚é‡å®šå‘å’ŒSlotè¿ç§»ï¼Œæ‰€ä»¥å¯¹è¯·æ±‚çš„å¤„ç†å˜å¾—å¾ˆå¤æ‚ï¼Œæµç¨‹å¦‚ä¸‹ï¼š æ£€æŸ¥Keyæ‰€åœ¨Slotæ˜¯å¦å±äºå½“å‰Nodeï¼Ÿ è®¡ç®—crc16(key) % 16384å¾—åˆ°Slot æŸ¥è¯¢clusterState.slotsè´Ÿè´£Slotçš„ç»“ç‚¹æŒ‡é’ˆ ä¸myselfæŒ‡é’ˆæ¯”è¾ƒ è‹¥ä¸å±äºï¼Œåˆ™å“åº”MOVEDé”™è¯¯é‡å®šå‘å®¢æˆ·ç«¯ è‹¥å±äºä¸”Keyå­˜åœ¨ï¼Œåˆ™ç›´æ¥æ“ä½œï¼Œè¿”å›ç»“æœç»™å®¢æˆ·ç«¯ è‹¥Keyä¸å­˜åœ¨ï¼Œæ£€æŸ¥è¯¥Slotæ˜¯å¦è¿å‡ºä¸­ï¼Ÿ(clusterState.migrating_slots_to) è‹¥Slotè¿å‡ºä¸­ï¼Œè¿”å›ASKé”™è¯¯é‡å®šå‘å®¢æˆ·ç«¯åˆ°è¿ç§»çš„ç›®çš„æœåŠ¡å™¨ä¸Š è‹¥Slotæœªè¿å‡ºï¼Œæ£€æŸ¥Slotæ˜¯å¦å¯¼å…¥ä¸­ï¼Ÿ(clusterState.importing_slots_from) è‹¥Slotå¯¼å…¥ä¸­ä¸”æœ‰ASKINGæ ‡è®°ï¼Œåˆ™ç›´æ¥æ“ä½œ å¦åˆ™å“åº”MOVEDé”™è¯¯é‡å®šå‘å®¢æˆ·ç«¯ Redis Clusterå®¹é”™æœºåˆ¶failoveræ˜¯redis clusterçš„å®¹é”™æœºåˆ¶ï¼Œæ˜¯redis clusteræœ€æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼›å®ƒå…è®¸åœ¨æŸäº›èŠ‚ç‚¹å¤±æ•ˆæƒ…å†µä¸‹ï¼Œé›†ç¾¤è¿˜èƒ½æ­£å¸¸æä¾›æœåŠ¡ã€‚ redis clusteré‡‡ç”¨ä¸»ä»æ¶æ„ï¼Œä»»ä½•æ—¶å€™åªæœ‰ä¸»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œä»èŠ‚ç‚¹è¿›è¡Œçƒ­å¤‡ä»½ï¼Œæ•…å…¶å®¹é”™æœºåˆ¶æ˜¯ä¸»ä»åˆ‡æ¢æœºåˆ¶ï¼Œå³ä¸»èŠ‚ç‚¹å¤±æ•ˆåï¼Œé€‰å–ä¸€ä¸ªä»èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚åœ¨å®ç°ä¸Šä¹Ÿå¤ç”¨äº†æ—§ç‰ˆæœ¬çš„ä¸»ä»åŒæ­¥æœºåˆ¶ã€‚ ä»çºµå‘çœ‹ï¼Œredis clusteræ˜¯ä¸€å±‚æ¶æ„ï¼ŒèŠ‚ç‚¹åˆ†ä¸ºä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹æŒ‚æ‰æˆ–å¤±æ•ˆï¼Œä¸éœ€è¦è¿›è¡Œfailoverï¼Œredis clusterèƒ½æ­£å¸¸æä¾›æœåŠ¡ï¼›ä¸»èŠ‚ç‚¹æŒ‚æ‰æˆ–å¤±æ•ˆéœ€è¦è¿›è¡Œfailoverã€‚å¦å¤–ï¼Œredis clusterè¿˜æ”¯æŒmanual failoverï¼Œå³äººå·¥è¿›è¡Œfailoverï¼Œå°†ä»èŠ‚ç‚¹å˜ä¸ºä¸»èŠ‚ç‚¹ï¼Œå³ä½¿ä¸»èŠ‚ç‚¹è¿˜æ´»ç€ã€‚ä¸‹é¢å°†ä»‹ç»è¿™ä¸¤ç§ç±»å‹çš„failoverã€‚ 1ï¼‰ä¸»èŠ‚ç‚¹å¤±æ•ˆäº§ç”Ÿçš„failover ï¼ˆä¸»ï¼‰èŠ‚ç‚¹å¤±æ•ˆæ£€æµ‹ä¸€èˆ¬åœ°ï¼Œé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¼šå‘å…¶ä»–èŠ‚ç‚¹å‘é€PINGæ•°æ®åŒ…ï¼ŒåŒæ—¶ä¹Ÿæ€»æ˜¯åº”ç­”ï¼ˆacceptï¼‰æ¥è‡ªé›†ç¾¤è¿æ¥ç«¯å£çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å¯¹æ¥æ”¶åˆ°çš„PINGæ•°æ®åŒ…è¿›è¡Œå›å¤ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹å‘å¦ä¸€ä¸ªèŠ‚ç‚¹å‘PINGå‘½ä»¤ï¼Œä½†æ˜¯ç›®æ ‡èŠ‚ç‚¹æœªèƒ½åœ¨ç»™å®šçš„æ—¶é™ï¼ˆnode timeoutï¼‰å†…å›å¤æ—¶ï¼Œé‚£ä¹ˆå‘é€å‘½ä»¤çš„èŠ‚ç‚¹ä¼šå°†ç›®æ ‡èŠ‚ç‚¹æ ‡è®°ä¸ºPFAILï¼ˆpossible failureï¼‰ã€‚ ç”±äºèŠ‚ç‚¹é—´çš„äº¤äº’æ€»æ˜¯ä¼´éšç€ä¿¡æ¯ä¼ æ’­çš„åŠŸèƒ½ï¼Œæ­¤æ—¶æ¯æ¬¡å½“èŠ‚ç‚¹å¯¹å…¶ä»–èŠ‚ç‚¹å‘é€ PING å‘½ä»¤çš„æ—¶å€™ï¼Œå°±ä¼šå‘ŠçŸ¥ç›®æ ‡èŠ‚ç‚¹æ­¤æ—¶é›†ç¾¤ä¸­å·²ç»è¢«æ ‡è®°ä¸ºPFAILæˆ–è€…FAILæ ‡è®°çš„èŠ‚ç‚¹ã€‚ç›¸åº”çš„ï¼Œå½“èŠ‚ç‚¹æ¥æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„ä¿¡æ¯æ—¶ï¼Œ å®ƒä¼šè®°ä¸‹é‚£äº›è¢«å…¶ä»–èŠ‚ç‚¹æ ‡è®°ä¸ºå¤±æ•ˆçš„èŠ‚ç‚¹ã€‚ è¿™ç§°ä¸ºå¤±æ•ˆæŠ¥å‘Šï¼ˆfailure reportï¼‰ã€‚ å¦‚æœèŠ‚ç‚¹å·²ç»å°†æŸä¸ªèŠ‚ç‚¹æ ‡è®°ä¸ºPFAILï¼Œå¹¶ä¸”æ ¹æ®èŠ‚ç‚¹æ‰€æ”¶åˆ°çš„å¤±æ•ˆæŠ¥å‘Šæ˜¾å¼ï¼Œé›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†å…¶ä»–ä¸»èŠ‚ç‚¹ï¼ˆn/2+1ï¼‰ä¹Ÿè®¤ä¸ºé‚£ä¸ªèŠ‚ç‚¹è¿›å…¥äº†å¤±æ•ˆçŠ¶æ€ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šå°†é‚£ä¸ªPFAILèŠ‚ç‚¹çš„çŠ¶æ€æ ‡è®°ä¸ºFAILã€‚ ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹è¢«æ ‡è®°ä¸ºFAILï¼Œå…³äºè¿™ä¸ªèŠ‚ç‚¹å·²å¤±æ•ˆçš„ä¿¡æ¯å°±ä¼šè¢«å¹¿æ’­åˆ°æ•´ä¸ªé›†ç¾¤ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡ä¿¡æ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°†å¤±æ•ˆèŠ‚ç‚¹æ ‡è®°ä¸ºFAILã€‚ é€‰ä¸¾ä¸»èŠ‚ç‚¹ä¸€æ—¦æŸä¸ªä¸»èŠ‚ç‚¹è¿›å…¥ FAIL çŠ¶æ€ï¼Œ é›†ç¾¤å˜ä¸ºFAILçŠ¶æ€ï¼ŒåŒæ—¶ä¼šè§¦å‘failoverã€‚failoverçš„ç›®çš„æ˜¯ä»ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œä½¿å¾—é›†ç¾¤æ¢å¤æ­£å¸¸ç»§ç»­æä¾›æœåŠ¡ã€‚æ•´ä¸ªä¸»èŠ‚ç‚¹é€‰ä¸¾çš„è¿‡ç¨‹å¯åˆ†ä¸ºç”³è¯·ã€æˆæƒã€å‡çº§ã€åŒæ­¥å››ä¸ªé˜¶æ®µï¼š ç”³è¯·æ–°çš„ä¸»èŠ‚ç‚¹ç”±åŸå·²å¤±æ•ˆçš„ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ä»èŠ‚ç‚¹ä¸­è‡ªè¡Œé€‰ä¸¾äº§ç”Ÿï¼Œä»èŠ‚ç‚¹çš„é€‰ä¸¾éµå¾ªä»¥ä¸‹æ¡ä»¶ï¼šaã€è¿™ä¸ªèŠ‚ç‚¹æ˜¯å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼›bã€å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„å“ˆå¸Œæ§½æ•°é‡éç©ºï¼›cã€ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„å¤åˆ¶è¿æ¥çš„æ–­çº¿æ—¶é•¿æœ‰é™ï¼Œä¸è¶…è¿‡ ( (node-timeout * slave-validity-factor) + repl-ping-slave-period ï¼‰ã€‚ å¦‚æœä¸€ä¸ªä»èŠ‚ç‚¹æ»¡è¶³äº†ä»¥ä¸Šçš„æ‰€æœ‰æ¡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªä»èŠ‚ç‚¹å°†å‘é›†ç¾¤ä¸­çš„å…¶ä»–ä¸»èŠ‚ç‚¹å‘é€æˆæƒè¯·æ±‚ï¼Œè¯¢é—®å®ƒä»¬æ˜¯å¦å…è®¸è‡ªå·±å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹å‘é€æˆæƒè¯·æ±‚çš„æ—¶æœºä¼šæ ¹æ®å„ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹çš„æ•°æ®åå·®æ¥è¿›è¡Œæ’åºï¼Œè®©åå·®å°çš„ä»èŠ‚ç‚¹ä¼˜å…ˆå‘èµ·æˆæƒè¯·æ±‚ã€‚ æˆæƒå…¶ä»–ä¸»èŠ‚ç‚¹ä¼šéµä¿¡ä»¥ä¸‹ä¸‰ç‚¹æ ‡å‡†æ¥è¿›è¡Œåˆ¤æ–­ï¼šaã€ å‘é€æˆæƒè¯·æ±‚çš„æ˜¯ä»èŠ‚ç‚¹ï¼Œè€Œä¸”å®ƒæ‰€å±çš„ä¸»èŠ‚ç‚¹å¤„äºFAILçŠ¶æ€ ï¼›bã€ ä»èŠ‚ç‚¹çš„currentEpochã€‰è‡ªèº«çš„currentEpochï¼Œä»èŠ‚ç‚¹çš„configEpoch&gt;=è‡ªèº«ä¿å­˜çš„è¯¥ä»èŠ‚ç‚¹çš„configEpochï¼›cã€ è¿™ä¸ªä»èŠ‚ç‚¹å¤„äºæ­£å¸¸çš„è¿è¡ŒçŠ¶æ€ï¼Œæ²¡æœ‰è¢«æ ‡è®°ä¸ºFAILæˆ–PFAILçŠ¶æ€ï¼› â€‹ å¦‚æœå‘é€æˆæƒè¯·æ±‚çš„ä»èŠ‚ç‚¹æ»¡è¶³ä»¥ä¸Šæ ‡å‡†ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å°†åŒæ„ä»èŠ‚ç‚¹çš„å‡çº§è¦æ±‚ï¼Œå‘ä»èŠ‚ç‚¹è¿”å› CLUSTERMSG_TYPE_FAILOVER_AUTH_ACKæˆæƒã€‚ å‡çº§ä¸€æ—¦æŸä¸ªä»èŠ‚ç‚¹åœ¨ç»™å®šçš„æ—¶é™å†…å¾—åˆ°å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹ï¼ˆn/2+1ï¼‰çš„æˆæƒï¼Œå®ƒå°±ä¼šæ¥ç®¡æ‰€æœ‰ç”±å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„å“ˆå¸Œæ§½ï¼Œå¹¶ä¸»åŠ¨å‘å…¶ä»–èŠ‚ç‚¹å‘é€ä¸€ä¸ªPONGæ•°æ®åŒ…ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼šaã€ å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹è‡ªå·±ç°åœ¨æ˜¯ä¸»èŠ‚ç‚¹äº†bã€ å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹è‡ªå·±æ˜¯ä¸€ä¸ªROMOTED SLAVEï¼Œå³å·²å‡çº§çš„ä»èŠ‚ç‚¹ï¼›cã€å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹éƒ½æ ¹æ®è‡ªå·±æ–°çš„èŠ‚ç‚¹å±æ€§ä¿¡æ¯å¯¹é…ç½®è¿›è¡Œç›¸åº”çš„æ›´æ–° åŒæ­¥å…¶ä»–èŠ‚ç‚¹åœ¨æ¥æ”¶åˆ°ROMOTED SLAVEçš„å‘ŠçŸ¥åï¼Œä¼šæ ¹æ®æ–°çš„ä¸»èŠ‚ç‚¹å¯¹é…ç½®è¿›è¡Œç›¸åº”çš„æ›´æ–°ã€‚ç‰¹åˆ«åœ°ï¼Œå…¶ä»–ä»èŠ‚ç‚¹ä¼šå°†æ–°çš„ä¸»èŠ‚ç‚¹è®¾ä¸ºè‡ªå·±çš„ä¸»èŠ‚ç‚¹ï¼Œä»è€Œä¸æ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œæ•°æ®åŒæ­¥ã€‚è‡³æ­¤ï¼Œfailoverç»“æŸï¼Œé›†ç¾¤æ¢å¤æ­£å¸¸çŠ¶æ€ã€‚ æ­¤æ—¶ï¼Œå¦‚æœåŸä¸»èŠ‚ç‚¹æ¢å¤æ­£å¸¸ï¼Œä½†ç”±äºå…¶çš„configEpochå°äºå…¶ä»–èŠ‚ç‚¹ä¿å­˜çš„configEpochï¼ˆfailoveräº†äº§ç”Ÿè¾ƒå¤§çš„configEpochï¼‰ï¼Œæ•…å…¶é…ç½®ä¼šè¢«æ›´æ–°ä¸ºæœ€æ–°é…ç½®ï¼Œå¹¶å°†è‡ªå·±è®¾æ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚ å¦å¤–ï¼Œåœ¨failoverè¿‡ç¨‹ä¸­ï¼Œå¦‚æœåŸä¸»èŠ‚ç‚¹æ¢å¤æ­£å¸¸ï¼Œfailoverä¸­æ­¢ï¼Œä¸ä¼šäº§ç”Ÿæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ 2ï¼‰Manual FailoverManual Failoveræ˜¯ä¸€ç§è¿ç»´åŠŸèƒ½ï¼Œå…è®¸æ‰‹åŠ¨è®¾ç½®ä»èŠ‚ç‚¹ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå³ä½¿ä¸»èŠ‚ç‚¹è¿˜æ´»ç€ã€‚Manual Failoverä¸ä¸Šé¢ä»‹ç»çš„Failoveræµç¨‹å¤§éƒ½ç›¸åŒï¼Œé™¤äº†ä¸‹é¢ä¸¤ç‚¹ä¸åŒï¼šaï¼‰è§¦å‘æœºåˆ¶ä¸åŒï¼ŒManual Failoveræ˜¯é€šè¿‡å®¢æˆ·ç«¯å‘é€cluster failoverè§¦å‘ï¼Œè€Œä¸”å‘é€å¯¹è±¡åªèƒ½æ˜¯ä»èŠ‚ç‚¹ï¼›bï¼‰ç”³è¯·æ¡ä»¶ä¸åŒï¼ŒManual Failoverä¸éœ€è¦ä¸»èŠ‚ç‚¹å¤±æ•ˆï¼Œfailoveræœ‰æ•ˆæ—¶é•¿å›ºå®šä¸º5ç§’ï¼Œè€Œä¸”åªæœ‰æ”¶åˆ°å‘½ä»¤çš„ä»èŠ‚ç‚¹æ‰ä¼šå‘èµ·ç”³è¯·ã€‚ å¦å¤–ï¼ŒManual Failoveråˆ†forceå’Œéforceï¼ŒåŒºåˆ«åœ¨äºï¼šéforceéœ€è¦ç­‰ä»èŠ‚ç‚¹å®Œå…¨åŒæ­¥å®Œä¸»èŠ‚ç‚¹çš„æ•°æ®åæ‰è¿›è¡Œfailoverï¼Œä¿è¯ä¸ä¸¢å¤±æ•°æ®ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­ï¼ŒåŸä¸»èŠ‚ç‚¹åœæ­¢å†™æ“ä½œï¼›è€Œforceä¸è¿›è¡Œè¿›è¡Œæ•°æ®å®Œæ•´åŒæ­¥ï¼Œç›´æ¥è¿›è¡Œfailoverã€‚ 3ï¼‰é›†ç¾¤çŠ¶æ€æ£€æµ‹é›†ç¾¤æœ‰OKå’ŒFAILä¸¤ç§çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡CLUSTER INFOå‘½ä»¤æŸ¥çœ‹ã€‚å½“é›†ç¾¤å‘ç”Ÿé…ç½®å˜åŒ–æ—¶ï¼Œ é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¯¹å®ƒæ‰€çŸ¥é“çš„èŠ‚ç‚¹è¿›è¡Œæ‰«æï¼Œåªè¦é›†ç¾¤ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå“ˆå¸Œæ§½ä¸å¯ç”¨ï¼ˆå³è´Ÿè´£è¯¥å“ˆå¸Œæ§½çš„ä¸»èŠ‚ç‚¹å¤±æ•ˆï¼‰ï¼Œé›†ç¾¤å°±ä¼šè¿›å…¥FAILçŠ¶æ€ï¼Œåœæ­¢å¤„ç†ä»»ä½•å‘½ä»¤ã€‚å¦å¤–ï¼Œå½“å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹éƒ½è¿›å…¥PFAILçŠ¶æ€æ—¶ï¼Œé›†ç¾¤ä¹Ÿä¼šè¿›å…¥FAILçŠ¶æ€ã€‚è¿™æ˜¯å› ä¸ºè¦å°†ä¸€ä¸ªèŠ‚ç‚¹ä»PFAILçŠ¶æ€æ”¹å˜ä¸ºFAILçŠ¶æ€ï¼Œå¿…é¡»è¦æœ‰å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹ï¼ˆn/2+1ï¼‰è®¤å¯ï¼Œå½“é›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹éƒ½è¿›å…¥PFAILæ—¶ï¼Œå•å‡­å°‘æ•°èŠ‚ç‚¹æ˜¯æ²¡æœ‰åŠæ³•å°†ä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸ºFAILçŠ¶æ€çš„ã€‚ ç„¶è€Œé›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹(n/2+1)è¿›å…¥äº†ä¸‹çº¿çŠ¶æ€ï¼Œè®©é›†ç¾¤å˜ä¸ºFAILï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å°‘æ•°å­˜ç€ä¸»èŠ‚ç‚¹ç»§ç»­å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œè¿™è§£å†³äº†å‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œä¸€ä¸ªå¯èƒ½è¢«ä¸¤ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£çš„å“ˆå¸Œæ§½ï¼ŒåŒæ—¶è¢«ç”¨æˆ·è¿›è¡Œè¯»å†™æ“ä½œï¼ˆé€šè¿‡ç¦æ‰å…¶ä¸­å°‘æ•°æ´¾è¯»å†™æ“ä½œï¼Œè¯ä¿åªæœ‰ä¸€ä¸ªè¯»å†™æ“ä½œï¼‰ï¼Œé€ æˆæ•°æ®ä¸¢å¤±æ•°æ®é—®é¢˜ã€‚è¯´æ˜ï¼šä¸Šé¢n/2+1çš„næ˜¯æŒ‡é›†ç¾¤é‡Œæœ‰è´Ÿè´£å“ˆå¸Œæ§½çš„ä¸»èŠ‚ç‚¹ä¸ªæ•°ã€‚ å‚è€ƒæ–‡çŒ®Redis Clusteré›†ç¾¤çŸ¥è¯†å­¦ä¹ æ€»ç»“ redisç³»åˆ—ï¼šé›†ç¾¤ é«˜å¯ç”¨Redisï¼šRedis Cluster redis clusterä»‹ç» Rediså“¨å…µæ¨¡å¼ï¼ˆsentinelï¼‰å­¦ä¹ æ€»ç»“åŠéƒ¨ç½²è®°å½•ï¼ˆä¸»ä»å¤åˆ¶ã€è¯»å†™åˆ†ç¦»ã€ä¸»ä»åˆ‡æ¢)","categories":[{"name":"è¯»ä¹¦ç¬”è®°","slug":"è¯»ä¹¦ç¬”è®°","permalink":"https://www.enjoyican.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"https://www.enjoyican.com/tags/Redis/"}]},{"title":"redisè®¾è®¡ä¸å®ç°è¯»ä¹¦ç¬”è®°-å•æœºæ•°æ®åº“çš„å®ç°","date":"2020-03-18T14:52:30.000Z","path":"posts/redis-two/","text":"1. æ•°æ®åº“redisæ•°æ®åº“çš„å¾ˆå¤šæ“ä½œéƒ½æ˜¯é€šè¿‡å¯¹é”®ç©ºé—´è¿›è¡Œæ“ä½œæ¥å®ç°çš„,æ¯”å¦‚æ·»åŠ ,åˆ é™¤,æ›´æ–°,å–å€¼æ“ä½œ,æ¯”å¦‚ç”¨äºæ¸…ç©ºæ•´ä¸ªæ•°æ®åº“çš„FLUSHDBå‘½ä»¤,ç”¨äºè¿”å›æ•°æ®åº“ä¸­éšæœºé”®çš„RANDOMKEY,ç±»ä¼¼çš„å‘½ä»¤è¿˜æœ‰EXISTS,RENAME,KEYSç­‰. å½“ä½¿ç”¨rediså‘½ä»¤å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ—¶,æœåŠ¡å™¨ä¸ä»…å¯¹é”®ç©ºé—´æ‰§è¡ŒæŒ‡å®šçš„è¯»å†™æ“ä½œ,è¿˜ä¼šæ‰§è¡Œä¸€äº›é¢å¤–çš„ç»´æŠ¤æ“ä½œ,åŒ…æ‹¬: è¯»å–ä¸€ä¸ªé”®å(åŒ…æ‹¬è¯»æ“ä½œå’Œå†™æ“ä½œ)æ›´æ–°é”®çš„å‘½ä¸­(hit)æˆ–ä¸å‘½ä¸­(miss)çš„æ¬¡æ•°,è¿™ä¸¤ä¸ªå€¼å¯ä»¥åœ¨INFO statså‘½ä»¤çš„keyspace_hitså±æ€§å’Œkeyspace_misseså±æ€§ä¸­æŸ¥çœ‹. æ›´æ–°é”®çš„LRU(æœ€åä¸€æ¬¡ä½¿ç”¨)æ—¶é—´,è¿™ä¸ªå€¼å¯ä»¥ç”¨æ¥è®¡ç®—é”®çš„é—²ç½®æ—¶é—´(ä¸ºå°†æ¥é”®åˆ é™¤ç®—æ³•åšå‡†å¤‡) è¯»å–æ—¶å¦‚æœå‘ç°é”®å·²ç»è¿‡æœŸ,å°±åˆ é™¤è¯¥é”®ä¹‹åå†æ‰§è¡Œå‰©ä¸‹çš„æ“ä½œ å¦‚æœæœ‰å®¢æˆ·ç«¯ä½¿ç”¨WATCHå‘½ä»¤ç›‘è§†äº†æŸä¸ªé”®,é‚£ä¹ˆæœåŠ¡å™¨åœ¨å¯¹è¢«ç›‘è§†çš„é”®è¿›è¡Œä¿®æ”¹ä¹‹å,ä¼šå°†è¿™ä¸ªé”®æ ‡è®°ä¸ºè„(dirty) æœåŠ¡å™¨æ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªé”®ä¹‹å,éƒ½ä¼šå¯¹è„(dirty)é”®è®¡æ•°å™¨çš„å€¼å¢1,è¿™ä¸ªè®¡æ•°å™¨ä¼šè§¦å‘æœåŠ¡å™¨çš„æŒä¹…åŒ–å’Œå¤åˆ¶æ“ä½œ è®¾ç½®è¿‡æœŸæ—¶é—´redisæœ‰å››ä¸ªå‘½ä»¤ç”¨æ¥è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´: EXPIRE &lt;key&gt; &lt;ttl&gt; å°†é”®çš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºttlç§’ PEXPIRE &lt;key&gt; &lt;ttl&gt;å°†é”®çš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºttlæ¯«ç§’ EXPIRE &lt;key&gt; &lt;timestamp&gt; å°†é”®çš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºtimestampæ‰€æŒ‡å®šçš„ç§’æ•°æ—¶é—´æˆ³ PEXPIRE &lt;key&gt; &lt;timestamp&gt;å°†é”®çš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºtimestampæ‰€æŒ‡å®šçš„æ¯«ç§’æ•°æ—¶é—´æˆ³ ä»¥ä¸Šå››ä¸ªå‘½ä»¤,æœ€ç»ˆæ‰§è¡Œéƒ½æ˜¯è½¬æ¢ä¸ºç¬¬å››ä¸ªå‘½ä»¤çš„æ‰§è¡Œæ–¹å¼æ‰§è¡Œçš„. ä¿å­˜è¿‡æœŸæ—¶é—´redisDbç»“æ„çš„expireså­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´,è¿™ä¸ªå­—å…¸å«åšè¿‡æœŸå­—å…¸:è¿‡æœŸå­—å…¸æ˜¯ä¸€ä¸ªlong longç±»å‹çš„æ•´æ•°,è¿™ä¸ªæ•´æ•°ä¿å­˜äº†é”®æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´(æ¯«ç§’ç²¾åº¦çš„UNIXæ—¶é—´æˆ³) ç§»é™¤è¿‡æœŸæ—¶é—´PERSISTå‘½ä»¤å¯ä»¥ç§»é™¤ä¸€ä¸ªé”®çš„è¿‡æœŸæ—¶é—´,ç”¨æ³• PERSIST key è®¡ç®—å¹¶è¿”å›å‰©ä½™ç”Ÿå­˜æ—¶é—´TTLå‘½ä»¤ä»¥ç§’ä¸ºå•ä½è¿”å›é”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´,è€ŒPTTLå‘½ä»¤åˆ™ä»¥æ¯«ç§’ä¸ºå•ä½è¿”å›é”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´,è¿™ä¸¤ä¸ªå‘½ä»¤éƒ½æ˜¯é€šè¿‡è®¡ç®—é”®çš„è¿‡æœŸæ—¶é—´å’Œå½“å‰æ—¶é—´ä¹‹é—´çš„å·®æ¥å®ç°çš„ è¿‡æœŸé”®åˆ é™¤ç­–ç•¥ å®šæ—¶åˆ é™¤: åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶,åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨(timer),è®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶,ç«‹å³æ‰§è¡Œé”®åˆ é™¤æ“ä½œ ä¼˜ç‚¹: å¯¹å†…å­˜å‹å¥½,é€šè¿‡ä½¿ç”¨å®šæ—¶å™¨ä¿è¯è¿‡æœŸé”®ä¼šå°½å¿«åˆ é™¤,å¹¶é‡Šæ”¾æ‰å ç”¨çš„å†…å­˜ ç¼ºç‚¹: å¯¹CPUæ—¶é—´ä¸å‹å¥½,æ¯”å¦‚æŸä¸€æ—¶åˆ»è¿‡æœŸé”®æ¯”è¾ƒå¤š,é‚£å°±ä¼šå ç”¨æ¯”è¾ƒå¤šçš„CPUæ—¶é—´æ¥åˆ é™¤ æƒ°æ€§åˆ é™¤: å¹³æ—¶ä¸å¯¹é”®è¿›è¡Œæ“ä½œ,å½“ä»é”®ç©ºé—´è·å–é”®çš„æ—¶å€™,æ£€æŸ¥é”®æ˜¯å¦è¿‡æœŸ,è¿‡æœŸçš„è¯å°±åˆ é™¤è¯¥é”®,æ²¡è¿‡æœŸå°±è¿”å› ä¼˜ç‚¹: å¯¹CPUæ—¶é—´å‹å¥½ ç¼ºç‚¹: å¯¹å†…å­˜ä¸å‹å¥½,æ¯”å¦‚ä¸€ä¸ªé”®å·²ç»è¿‡æœŸ,ä½†æ˜¯æ²¡æœ‰åŠæ—¶åˆ é™¤,å°±ä¼šä¸€ç›´å ç”¨å†…å­˜ å®šæœŸåˆ é™¤: æ¯ä¸ªä¸€æ®µæ—¶é—´å¯¹æ•°æ®åº“è¿›è¡Œæ£€æŸ¥,åˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®,è‡³äºåˆ é™¤å¤šå°‘,æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“,ç”±å…·ä½“ç®—æ³•ç¡®å®š å®šæœŸåˆ é™¤æ˜¯ä»¥ä¸Šä¸¤ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹çš„æŠ˜ä¸­,ä½†æ˜¯éœ€è¦åˆç†è®¾å®šåˆ é™¤æ“ä½œçš„æ‰§è¡Œæ—¶é•¿å’Œé¢‘ç‡ rediså®é™…é‡‡å–çš„æ˜¯æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ä¸¤ç§ç­–ç•¥ æƒ°æ€§åˆ é™¤ç­–ç•¥ç”±db.c/expireIfNeededå‡½æ•°å®ç°,æ‰€æœ‰è¯»å†™æ•°æ®åº“çš„å‘½ä»¤(å¦‚SET LRANGE SADD HGET KEYSç­‰)åœ¨æ‰§è¡Œä¹‹å‰éƒ½ä¼šè°ƒç”¨è¯¥å‡½æ•°å¯¹é”®è¿›è¡Œæ£€æŸ¥:å¦‚æœå·²ç»è¿‡æœŸè¯¥å‡½æ•°ä¼šå°†è¯¥é”®åˆ é™¤,å¦åˆ™ä¸åšæ“ä½œ. å®šæœŸåˆ é™¤ç­–ç•¥ç”±redis.c/activeExpireCycleå‡½æ•°å®ç°,æ¯å½“redisçš„æœåŠ¡å™¨å‘¨æœŸæ€§æ“ä½œredis.c/serverCronå‡½æ•°æ‰§è¡Œæ—¶,activeExpireCycleå‡½æ•°å°±ä¼šè¢«è°ƒç”¨. AOF/RDBå’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†ç”ŸæˆRDBæ–‡ä»¶: å½“æ‰§è¡ŒSAVEæˆ–è€…BGSAVEå‘½ä»¤åˆ›å»ºæ–°çš„RDBæ–‡ä»¶æ—¶,å·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°å»ºçš„RDBæ–‡ä»¶ä¸­ è½½å…¥RDBæ–‡ä»¶: å¯åŠ¨redisæœåŠ¡å™¨æ—¶,å¦‚æœæœåŠ¡å™¨å¼€å¯äº†RDBåŠŸèƒ½,é‚£ä¹ˆæœåŠ¡å™¨å°†å¯¹RDBæ–‡ä»¶è¿›è¡Œè½½å…¥.å¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œ,è½½å…¥RDBæ–‡ä»¶æ—¶,ä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥,è¿‡æœŸçš„é”®ä¸ä¼šè¢«è½½å…¥;å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨çš„æ¨¡å¼è¿è¡Œ,ä¸è®ºé”®æ˜¯å¦è¿‡æœŸ,éƒ½ä¼šè½½å…¥åˆ°æ•°æ®åº“,ä½†æ˜¯ç”±äºä¸»ä»æœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥çš„æ—¶å€™ä»æœåŠ¡å™¨çš„æ•°æ®åº“å°±ä¼šæ¸…ç©º,æ‰€ä»¥ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“. AOFæ–‡ä»¶å†™å…¥: å½“è¿‡æœŸé”®è¢«æƒ°æ€§åˆ é™¤æˆ–è€…å®šæœŸåˆ é™¤ä¹‹å,ç¨‹åºä¼šå‘AOFæ–‡ä»¶è¿½åŠ ä¸€æ¡DELå‘½ä»¤,æ¥æ˜¾å¼çš„è®°å½•è¯¥é”®å·²è¢«åˆ é™¤ AOFé‡å†™: åœ¨æ‰§è¡ŒAOFé‡å†™çš„è¿‡ç¨‹ä¸­ä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥,å¦‚æœå·²ç»è¿‡æœŸäº†çš„ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„AOFæ–‡ä»¶ å¤åˆ¶: å½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼ä¸‹æ—¶,ä»æœåŠ¡å™¨çš„è¿‡æœŸé”®åˆ é™¤åŠ¨ä½œç”±ä¸»æœåŠ¡å™¨æ§åˆ¶: ä¸»æœåŠ¡å™¨åˆ é™¤ä¸€ä¸ªé”®ä¹‹åä¼šæ˜¾å¼çš„å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ä¸€ä¸ªDELå‘½ä»¤,å‘ŠçŸ¥ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªè¿‡æœŸé”® ä»æœåŠ¡å™¨åªæœ‰åœ¨æ¥åˆ°ä¸»æœåŠ¡å™¨å‘æ¥çš„DELå‘½ä»¤ä¹‹å,æ‰ä¼šåˆ é™¤è¿‡æœŸé”® ä»æœåŠ¡å™¨æ¥åˆ°å®¢æˆ·ç«¯å‘é€çš„è¯»å‘½ä»¤æ—¶,å³ä½¿ç¢°åˆ°è¿‡æœŸé”®ä¹Ÿä¸ä¼šå¤„ç†,è¿˜æ˜¯ä¼šæŒ‰ç…§æ­£å¸¸æƒ…å†µè¿”å›å€¼ æ•°æ®åº“é€šçŸ¥æ•°æ®åº“é€šçŸ¥åŠŸèƒ½å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…ç»™å®šçš„é¢‘é“æˆ–æ¨¡å¼,æ¥è·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–,ä»¥åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µ,è¿™ç±»é€šçŸ¥å¯ä»¥åˆ†ä¸ºä¸¤ç±»: é”®ç©ºé—´é€šçŸ¥(key-space notification): å…³æ³¨æŸä¸ªé”®æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤,æ¯”å¦‚é’ˆå¯¹æŸä¸ªkeyæ‰§è¡Œäº†expire,set,delç­‰ é”®äº‹ä»¶é€šçŸ¥(key-event notification): å…³æ³¨æŸä¸ªå‘½ä»¤è¢«ä»€ä¹ˆé”®æ‰§è¡Œäº†,æ¯”å¦‚delå‘½ä»¤æ‰§è¡Œåœ¨å“ªäº›é”®ä¸Šäº† æœåŠ¡å™¨é…ç½®çš„notify-keyspace-eventsé€‰é¡¹å†³å®šäº†æœåŠ¡å™¨æ‰€å‘é€é€šçŸ¥çš„ç±»å‹: AKE : å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´å’Œé”®äº‹ä»¶é€šçŸ¥ AK : å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥ AE : å‘é€æ‰€ä»¥ç±»å‹çš„é”®äº‹ä»¶é€šçŸ¥ K$ : åªå‘é€å’Œå­—ç¬¦ä¸²é”®æœ‰å…³çš„é”®ç©ºé—´é€šçŸ¥ El : åªå‘é€å’Œlisté”®æœ‰å…³çš„é”®äº‹ä»¶é€šçŸ¥ 2. RDBæŒä¹…åŒ–RDBæŒä¹…åŒ–åŠŸèƒ½æ‰€ç”Ÿæˆçš„RDBæ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶,é€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”ŸæˆRDBæ–‡ä»¶æ—¶çš„æ•°æ®åº“çŠ¶æ€. RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥æœ‰ä¸¤ä¸ªRediså‘½ä»¤å¯ä»¥ç”¨äºç”ŸæˆRDBæ–‡ä»¶,ä¸€ä¸ªæ˜¯SAVE,å¦ä¸€ä¸ªæ˜¯BGSAVE,SAVE å‘½ä»¤ä¼šé˜»å¡æœåŠ¡å™¨è¿›ç¨‹,BGSAVEå‘½ä»¤ä¼šæ´¾ç”Ÿå‡ºä¸€ä¸ªå­è¿›ç¨‹,ç„¶åç”±å­è¿›ç¨‹è´Ÿè´£åˆ›å»ºRDBæ–‡ä»¶. Rediså¹¶æ²¡æœ‰ä¸“é—¨ç”¨äºè½½å…¥RDBæ–‡ä»¶çš„å‘½ä»¤,åªè¦æœåŠ¡å™¨å¯åŠ¨ä¹‹åæ£€æµ‹åˆ°RDBæ–‡ä»¶å°±ä¼šè‡ªåŠ¨è½½å…¥,ç”±äºAOFæ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯”RDBæ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é«˜,æ‰€ä»¥: å¦‚æœæœåŠ¡å™¨å¼€å¯äº†AOFæŒä¹…åŒ–åŠŸèƒ½,åˆ™ä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ AOFæŒä¹…åŒ–åŠŸèƒ½å…³é—­æ—¶,ä¼šé‡‡ç”¨RDBæ–‡ä»¶æ¥è¿˜åŸæ•°æ® æœåŠ¡å™¨åœ¨è½½å…¥RDBæ–‡ä»¶æœŸé—´,ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€,ç›´åˆ°è½½å…¥å·¥ä½œå®Œæˆä¸ºæ­¢,BGSAVEå‘½ä»¤å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®æ¯ä¸ªä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œ,è¯¦è§save 900 1...è¿™ä¸€ç»„é…ç½® å…·ä½“RDBæ–‡ä»¶ä¿å­˜çš„æ ¼å¼å’Œå†…å®¹å»ºè®®ç›´æ¥çœ‹åŸä¹¦ç¬¬10ç« å†…å®¹ 3.AOFæŒä¹…åŒ–ä¸RDBæŒä¹…åŒ–é€šè¿‡ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ä¸åŒ,AOFæŒä¹…åŒ–æ˜¯é€šè¿‡ä¿å­˜RedisæœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çš„çŠ¶æ€çš„,AOFæŒä¹…åŒ–åŠŸèƒ½çš„å®ç°åˆ†ä¸ºå‘½ä»¤è¿½åŠ (append),æ–‡ä»¶å†™å…¥,æ–‡ä»¶åŒæ­¥(sync)ä¸‰ä¸ªæ­¥éª¤ å‘½ä»¤è¿½åŠ å½“AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶,æœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹å,ä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„aof_bufç¼“å†²åŒºçš„æœ«å°¾: 1234567struct redisServer&#123; // ... //AOFç¼“å†²åŒº sds aof_buf; //...&#125; ä¾‹å¦‚:å½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å¦‚ä¸‹å‘½ä»¤: redis &gt; SET KEY VALUE OK æœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹å,ä¼šå°†ä»¥ä¸‹åè®®å†…å®¹è¿½åŠ åˆ°aof_bufç¼“å†²åŒºçš„æœ«å°¾: *3\\r\\n$3\\r\\nSET\\r\\nKEY\\r\\n$5\\r\\nVALUE\\r\\n æ–‡ä»¶çš„å†™å…¥ä¸åŒæ­¥ reidsæœåŠ¡å™¨è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯(loop).è¿™ä¸ªå¾ªç¯ä¸­çš„æ–‡ä»¶äº‹ä»¶è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚,ä»¥åŠå‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤,è€Œæ—¶é—´äº‹ä»¶åˆ™è´Ÿè´£æ‰§è¡ŒåƒserverCronå‡½æ•°è¿™æ ·éœ€è¦å®šæ—¶è¿è¡Œçš„å‡½æ•°. ç”±äºæœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶å¯èƒ½ä¼šæ‰§è¡Œå†™å‘½ä»¤.åœ¨æ­¤æœŸé—´ä¸€äº›å†…å®¹è¢«è¿½åŠ åˆ°aof_bufç¼“å†²åŒºä¸­,æ‰€ä»¥åœ¨æœåŠ¡å™¨æ¯æ¬¡ç»“æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰,éƒ½ä¼šè°ƒç”¨ä¸€ä¸ªflushAppendOnlyFileå‡½æ•°,è€ƒè™‘æ˜¯å¦å°†aof_bufç¼“å†²åŒºä¸­å†…å®¹å†™å…¥å’Œä¿å­˜è¿›AOFæ–‡ä»¶ä¸­,è¯¥å‡½æ•°çš„è¡Œä¸ºæœ‰æœåŠ¡å™¨é…ç½®æ–‡ä»¶ä¸­çš„appendfsyncé€‰é¡¹ä¸­çš„å€¼æ¥å†³å®š,å„ä¸ªå€¼çš„å«ä¹‰å¦‚ä¸‹: appendfsyncé€‰é¡¹çš„å€¼ flushAppendOnlyFileå‡½æ•°çš„è¡Œä¸º always å°†ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥å¹¶åŒæ­¥åˆ°AOFæ–‡ä»¶ everysec (é»˜è®¤) å°†ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°AOFæ–‡ä»¶,å¦‚æœä¸Šæ¬¡åŒæ­¥è·ç¦»ç°åœ¨æ—¶é—´è¶…è¿‡1ç§’,é‚£ä¹ˆå†æ¬¡å¯¹AOFæ–‡ä»¶è¿›è¡ŒåŒæ­¥,è¯¥åŒæ­¥è¡Œä¸ºæœ‰ä¸€ä¸ªä¸“é—¨è´Ÿè´£çš„çº¿ç¨‹ no å°†ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°AOFæ–‡ä»¶,ä½†å¹¶ä¸è¿›è¡ŒåŒæ­¥,ä½•æ—¶åŒæ­¥ç”±æ“ä½œç³»ç»Ÿå†³å®š AOFæ–‡ä»¶è½½å…¥ä¸æ•°æ®è¿˜åŸå› ä¸ºAOFæ–‡ä»¶ä¸­è®°å½•äº†é‡å»ºæ•°æ®åº“æ‰€éœ€è¦çš„æ‰€æœ‰å†™å‘½ä»¤,æ‰€ä»¥æœåŠ¡å™¨åªè¦è¯»å…¥å¹¶é‡æ–°æ‰§è¡Œä¸€éAOFæ–‡ä»¶ä¸­ä¿å­˜çš„å†™å‘½ä»¤,å°±å¯ä»¥è¿˜åŸæœåŠ¡å™¨å…³é—­ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€. AOFé‡å†™éšç€AOFæ–‡ä»¶ä¸­ä¿å­˜çš„æŒ‡ä»¤è¶Šæ¥è¶Šå¤š,æ–‡ä»¶ä½“ç§¯è¶Šæ¥è¶Šå¤§,è¿™ä¸ªæ—¶å€™éœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œé‡å†™æ¥ç¼©å°æ–‡ä»¶æ‰€å å­˜å‚¨ç©ºé—´. AOFæ–‡ä»¶é‡å†™å¹¶ä¸éœ€è¦å¯¹ç°æœ‰AOFæ–‡ä»¶è¿›è¡Œè¯»å–æˆ–è€…åˆ†æ,æ˜¯ç›´æ¥é€šè¿‡è¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€å®ç°çš„,æ¯”å¦‚å½“å‰æ•°æ®åº“å­˜åœ¨ä¸€ä¸ªé”®å€¼å¯¹,è€çš„AOFæ–‡ä»¶ä¸­å¯èƒ½å­˜å‚¨äº†å¯¹è¿™ä¸ªé”®å€¼å¯¹çš„å„ç§å†å²æ“ä½œå‘½ä»¤,é‡å†™çš„æ—¶å€™åªè¦è¯»å–è¯¥é”®å€¼å¯¹æœ€æ–°çš„çŠ¶æ€å°†ä¹‹å‰çš„å¤šä¸ªæŒ‡ä»¤åˆå¹¶æˆæœ€åçš„ä¸€æ¡æŒ‡ä»¤ä¿å­˜å³å¯,è¿™å°±æ˜¯AOFé‡å†™çš„åŸç† æœ‰ä¸ªç‰¹æ®Šçš„ç‚¹æ˜¯å¯¹äºé™¤äº†å­—ç¬¦ä¸²ä¹‹å¤–çš„å¦å¤–å››ç§æ•°æ®ç±»å‹,å¦‚æœä¸€ä¸ªé”®å¯¹åº”çš„å…ƒç´ ä¸ªæ•°å¾ˆå¤š,è¶…è¿‡æŸä¸ªé…ç½®çš„å€¼,ä¼šä½¿ç”¨å¤šæ¡è®°å½•ä¿å­˜å‘½ä»¤,è€Œä¸åªæ˜¯ä¸€æ¡. AOFæ–‡ä»¶çš„é‡å†™æ˜¯é€šè¿‡ä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œçš„,ä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹,ä¸»è¦æ˜¯ä¸ºäº†åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹è¿˜èƒ½ä¿è¯æ•°æ®å®‰å…¨æ€§.ç”±äºåœ¨å­è¿›ç¨‹æ‰§è¡Œé‡å†™ä»»åŠ¡çš„è¿‡ç¨‹ä¸­,å¯èƒ½ä¸»è¿›ç¨‹ä¾ç„¶ä¼šæ‰§è¡Œæ–°çš„å‘½ä»¤.Redisè®¾ç½®äº†ä¸€ä¸ªAOFé‡å†™ç¼“å†²åŒºæ¥å­˜å‚¨åœ¨è¿™æ®µæ—¶é—´ä¸­ä¸»è¿›ç¨‹æ‰§è¡Œçš„æ–°çš„æŒ‡ä»¤.è¯¥ç¼“å†²åŒºå½“å­è¿›ç¨‹å»ºç«‹çš„æ—¶å€™å¼€å§‹ä½¿ç”¨ å› æ­¤åœ¨å­è¿›ç¨‹è¿›è¡Œé‡å†™çš„è¿‡ç¨‹ä¸­,å¦‚æœä¸»çº¿ç¨‹æ¥æ”¶åˆ°æ–°çš„å‘½ä»¤,ä¼šå°†å…¶åŒæ—¶ä¿å­˜åœ¨aof_bufç¼“å†²åŒºåŠAOFé‡å†™ç¼“å†²åŒºä¸­;è€Œå­è¿›ç¨‹åœ¨å®ŒæˆAOFé‡å†™å·¥ä½œåä¼šç»™ä¸»è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·,ä¹‹åä¸»è¿›ç¨‹æ”¶åˆ°ä¿¡å·å¹¶è°ƒç”¨ä¸€ä¸ªå‡½æ•°,æ‰§è¡Œä»¥ä¸‹å·¥ä½œ: å°†AOFé‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–°çš„AOFæ–‡ä»¶ä¸­,è¿™æ—¶æ–°çš„AOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å°†å’Œå½“å‰æœåŠ¡å™¨çš„çŠ¶æ€ä¸€è‡´. å¯¹æ–°çš„AOFæ–‡ä»¶è¿›è¡Œæ”¹å,åŸå­åœ°è¦†ç›–ç°æœ‰çš„AOFæ–‡ä»¶,å®Œæˆæ–°æ—§æ–‡ä»¶çš„æ›¿æ¢ è¿™ä¸¤ä¸ªåŠ¨ä½œå®Œæˆä¹‹å,ä¸»çº¿ç¨‹å°±å¯ä»¥ç»§ç»­æ¥å—æ–°çš„æŒ‡ä»¤äº†. åœ¨æ•´ä¸ªAOFåå°é‡å†™çš„è¿‡ç¨‹ä¸­,åªæœ‰è¯¥è¿‡ç¨‹ä¼šå¯¹ä¸»è¿›ç¨‹é€ æˆé˜»å¡,å…¶ä»–æ—¶é—´éƒ½æ˜¯åœ¨åå°è¿›è¡Œ,ä¸å½±å“ä¸»è¿›ç¨‹æ‰§è¡Œä»»åŠ¡.","categories":[{"name":"è¯»ä¹¦ç¬”è®°","slug":"è¯»ä¹¦ç¬”è®°","permalink":"https://www.enjoyican.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"https://www.enjoyican.com/tags/Redis/"}]},{"title":"redisè®¾è®¡ä¸å®ç°è¯»ä¹¦ç¬”è®°-æ•°æ®ç»“æ„ä¸å®ç°","date":"2020-03-17T13:19:30.000Z","path":"posts/redis-one/","text":"1. ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ç®€å•åŠ¨æ€å­—ç¬¦ä¸²(simple dynamic string,SDS)æ˜¯redisçš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤º,é™¤æ­¤ä¹‹å¤–,SDSè¿˜è¢«ç”¨åšç¼“å†²åŒº(AOFæ¨¡å—ä¸­çš„AOFç¼“å†²åŒºå’Œå®¢æˆ·ç«¯çŠ¶æ€ä¸­çš„è¾“å…¥ç¼“å†²åŒº),AOFæ¨¡å—ç¼“å†²åŒºæŒ‡çš„æ˜¯åœ¨åšAOFå¤‡ä»½çš„æ—¶å€™æ–°å¢åŠ çš„æŒ‡ä»¤ä¼šç¼“å†²åˆ°ç¼“å†²åŒº,ä¹‹åå†å‘èµ·éƒ¨åˆ†åŒæ­¥åˆ°ç£ç›˜;å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºæ˜¯æŒ‡åœ¨æœåŠ¡ç«¯ä¿å­˜ç€å®¢æˆ·ç«¯è¾“å…¥æŒ‡ä»¤çš„ä¸€ä¸ªç¼“å†²åŒº. SDSçš„è¡¨ç¤ºç»“æ„å¦‚ä¸‹: 12345678struct sdshdr&#123; //è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨çš„å­—èŠ‚çš„æ•°é‡,ç­‰äºSDSæ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦ int len; //ä¿å­˜bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡ int free; //å­—èŠ‚æ•°ç»„,ç”¨äºä¿å­˜å­—ç¬¦ä¸² char buf[]&#125; ä»¥ä¸Šä¸¤å›¾ä¸ºSDSå­˜å‚¨ç¤ºä¾‹.å›¾1ä¸­freeä¸º0,è¡¨ç¤ºè¯¥SDSæ²¡æœ‰åˆ†é…ä»»ä½•æœªä½¿ç”¨ç©ºé—´,len=5è¡¨ç¤ºå­˜å‚¨çš„å­—ç¬¦ä¸²å­—èŠ‚é•¿åº¦,bufæŒ‡å‘ä¿å­˜æ•°æ®çš„æ•°ç»„,ç»“å°¾ä¿å­˜ç©ºå­—ç¬¦ä¸²â€™\\0â€™,è¿™æ˜¯ä¸ºäº†éµå¾ªCçš„ä¿å­˜ä¹ æƒ¯,ä»¥ä¾¿å¯ä»¥ä½¿ç”¨éƒ¨åˆ†Cçš„å‡½æ•°,ä½†ä¸è®¡å…¥lençš„ç»Ÿè®¡ä¸­.å›¾äºŒä¸­free=5è¡¨ç¤ºé™¤äº†ä¿å­˜çš„rediså­—ç¬¦ä¸²ä¹‹å¤–,è¿˜åˆ†é…äº†5å­—èŠ‚æœªä½¿ç”¨çš„ç©ºé—´. å› ä¸ºä¿å­˜äº†å­—ç¬¦ä¸²çš„é•¿åº¦,æ‰€ä»¥redisè·å–å­—ç¬¦ä¸²çš„é•¿åº¦æ—¶é—´å¤æ‚åº¦ä¸ºO(1),åŒæ—¶å¯ä»¥æœç»ç¼“å†²åŒºæº¢å‡º,å½“éœ€è¦ä¿®æ”¹SDSæ—¶,ä¼šå…ˆæ£€æŸ¥ç©ºé—´æ˜¯å¦è¶³å¤Ÿ,ä¸å¤Ÿçš„è¯ä¼šå…ˆæ‰©å±•ç©ºé—´å†ä¿å­˜æ–°çš„æ•°æ®. é€šè¿‡bufä¸­çš„freeè¡¨ç¤ºçš„æœªä½¿ç”¨ç©ºé—´,SDSå®ç°äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ä¸¤ç§ä¼˜åŒ–ç­–ç•¥. 1.1 ç©ºé—´é¢„åˆ†é…å½“è¿›è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œ,éœ€è¦å¯¹SDSè¿›è¡Œç©ºé—´æ‰©å±•æ—¶,ç¨‹åºä¼šåœ¨åˆ†é…ä¿®æ”¹æ‰€éœ€çš„å¿…è¦ç©ºé—´ä¹‹å¤–,å†åˆ†é…é¢å¤–çš„æœªä½¿ç”¨ç©ºé—´,åˆ†é…ç­–ç•¥å¦‚ä¸‹: å¦‚æœä¿®æ”¹ä¹‹åSDSçš„é•¿åº¦å°äº1MB,é‚£ä¹ˆç¨‹åºå°†åˆ†é…å’Œä¿®æ”¹ä¹‹ålené•¿åº¦åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´;å¦‚æœä¿®æ”¹ä¹‹åçš„SDSé•¿åº¦å¤§äº1MB,é‚£ä¹ˆç¨‹åºå°†åˆ†é…1MBçš„æœªä½¿ç”¨ç©ºé—´. 1.2 æƒ°æ€§ç©ºé—´é‡Šæ”¾å½“è¿›è¡Œå­—ç¬¦ä¸²ç¼©çŸ­æ“ä½œæ—¶,ä¿®æ”¹åç©ºä½™å‡ºæ¥çš„ç©ºé—´å¹¶ä¸ä¼šè¢«ç«‹å³é‡Šæ”¾,è€Œæ˜¯è®°å½•åœ¨freeä¸­,å½“ä¸‹æ¬¡è¿›è¡Œå­—ç¬¦ä¸²çš„æ‰©å±•æ—¶,å¦‚æœå­—ç¬¦ä¸²é•¿åº¦å°äºfreeçš„å€¼,å°±ä¸éœ€è¦è¿›è¡Œç©ºé—´æ‰©å±•æ“ä½œ,é€šè¿‡è¿™ä¸ªç­–ç•¥é¿å…äº†æ—¢é¿å…äº†ç¼©çŸ­å­—ç¬¦ä¸²ä¹‹åçš„å†…å­˜é‡åˆ†é…æ“ä½œ,åˆä¸ºå°†æ¥çš„æ‹“å±•ç•™å‡ºç©ºé—´,åŒæ—¶SDSæä¾›äº†ä¸“é—¨é‡Šæ”¾ç©ºé—´çš„api,ä¸éœ€è¦æ‹…å¿ƒfreeç©ºé—´å¤ªå¤§é€ æˆçš„å†…å­˜æµªè´¹. ä»¥ä¸‹æ˜¯SDSå­—ç¬¦ä¸²ä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«: 2. é“¾è¡¨é“¾è¡¨åœ¨redisä¸­çš„åº”ç”¨æ¯”è¾ƒå¹¿æ³›,listç±»å‹çš„å€¼å¯¹è±¡åº•å±‚å®ç°ä¹‹ä¸€å°±æ˜¯é“¾è¡¨,å½“åˆ—è¡¨é”®ä¸­åŒ…å«äº†æ•°é‡æ¯”è¾ƒå¤šçš„å…ƒç´ ,æˆ–è€…åŒ…å«çš„å…ƒç´ éƒ½æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶,å°±ä¼šä½¿ç”¨é“¾è¡¨(åé¢ç¬”è®°ä¸­è®°å½•),é™¤æ­¤ä¹‹å¤–å‘å¸ƒä¸è®¢é˜…,æ…¢æŸ¥è¯¢,ç›‘è§†å™¨ç­‰åŠŸèƒ½ä¹Ÿç”¨åˆ°äº†é“¾è¡¨,RedisæœåŠ¡å™¨æœ¬èº«è¿˜ç”¨é“¾è¡¨æ¥ä¿å­˜å¤šä¸ªå®¢æˆ·ç«¯çš„çŠ¶æ€ä¿¡æ¯ä»¥åŠæ„å»ºå®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒº. redisçš„é“¾è¡¨å®ç°æ˜¯åŒç«¯æ— ç¯é“¾è¡¨,å…¶ç»“æ„ä¸ç¤ºæ„å›¾å¦‚ä¸‹: æ­¤å¤–è¿˜é€šè¿‡listç»“æ„å¯¹é“¾è¡¨è¿›è¡ŒæŒæœ‰,ç¤ºæ„å›¾åŠç»“æ„å¦‚ä¸‹: 1234567891011121314typedef struct list&#123; //è¡¨å¤´èŠ‚ç‚¹ listNode *head; //è¡¨å°¾èŠ‚ç‚¹ listNode *tail; //é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ unsigned long len; //èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•° void *(*dup)(void *ptr); //èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•° void (*free) (void *ptr); //èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•° int (*match)(void *ptr,void *key);&#125;list; 3. å­—å…¸å­—å…¸ä¸­ä¸€ä¸ªkeyå¯¹åº”ä¸€ä¸ªvalue,æ¯ä¸ªkeyæ˜¯å”¯ä¸€çš„,redisæ•°æ®åº“åº•å±‚å°±æ˜¯ä½¿ç”¨å­—å…¸å®ç°,å¢åˆ æ”¹æŸ¥æ“ä½œä¹Ÿæ˜¯å»ºç«‹åœ¨å¯¹å­—å…¸çš„æ“ä½œä¹‹ä¸Š.é™¤æ­¤ä¹‹å¤–,å­—å…¸è¿˜æ˜¯å€¼å¯¹è±¡ç±»å‹ä¸ºhashæ—¶çš„åº•å±‚å®ç°,å½“ä¸€ä¸ªhashå€¼å¯¹è±¡åŒ…å«çš„æ•°æ®æ¯”è¾ƒå¤šæˆ–è€…åŒ…å«çš„æ•°æ®çš„é•¿åº¦éƒ½æ¯”è¾ƒé•¿çš„æ—¶å€™,redisä¼šä½¿ç”¨å­—å…¸ä½œä¸ºå…¶åº•å±‚å®ç°,è€Œå­—å…¸çš„åº•å±‚åˆæ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨å®ç°,æ¯ä¸ªå“ˆå¸Œè¡¨åŒ…å«å¤šä¸ªå“ˆå¸ŒèŠ‚ç‚¹æ¯ä¸ªå“ˆå¸ŒèŠ‚ç‚¹ä¿å­˜äº†å­—å…¸ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹rediså“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çª,å¤šä¸ªå†²çªçš„èŠ‚ç‚¹é€šè¿‡nextæŒ‡é’ˆç›¸é“¾æ¥,å½“æœ‰å†²çªæ—¶,æ–°çš„èŠ‚ç‚¹æ”¾åœ¨å…¶ä»–èŠ‚ç‚¹çš„å‰é¢.å½“hashè¡¨ä¸­æ•°æ®è¿‡å¤šæˆ–è€…è¿‡å°‘æ—¶,ä¼šé€šè¿‡rehashæ¥é‡æ–°åˆ†é…ç©ºé—´(å°†åŸæ¥å°ç©ºé—´å“ˆå¸Œè¡¨ä¸Šçš„èŠ‚ç‚¹rehashä¿å­˜åˆ°å¦å¤–ä¸€ä¸ªå¤§ç©ºé—´å“ˆå¸Œè¡¨ä¸Šçš„,ä¹‹åå°†åŸæ¥çš„å°è¡¨ç½®ç©º). 3.1 å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©å½“ä»¥ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªæ»¡è¶³æ—¶,ç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹å¯¹hashè¡¨è¿›è¡Œæ‰©å±•æ“ä½œ: 1)æœåŠ¡å™¨ç›®å‰æ²¡æœ‰æ‰§è¡ŒBGSAVEæˆ–è€…BGREWRITEAOFå‘½ä»¤,ä¸”éŸ©ç³»è¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº1(è´Ÿè½½å› å­=å·²ä¿å­˜çš„èŠ‚ç‚¹æ•°é‡/å“ˆå¸Œè¡¨å¤§å°) 2)æœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œä»¥ä¸Šä¸¤ä¸ªå‘½ä»¤ä¸­çš„ä¸€ä¸ª,ä½†æ˜¯è´Ÿè½½å› å­å¤§äºç­‰äº5 å½“å“ˆå¸Œè¡¨è´Ÿè½½å› å­å°äº0.1,ç¨‹åºè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©æ“ä½œ. 3.2 æ¸è¿›å¼rehashå½“æ‰©å±•æˆ–æ”¶ç¼©å“ˆå¸Œè¡¨çš„æ—¶å€™,éœ€è¦å¯¹å…¶ä¸­ä¿å­˜çš„é”®å€¼å¯¹è¿›è¡Œrehash,ä½†æ˜¯ä¸ºäº†è¡¨é¢å¯¹æœåŠ¡å™¨æ€§èƒ½é€ æˆå½±å“,å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§rehashå…¨éƒ¨é”®å€¼å¯¹è€Œæ˜¯åˆ†å¤šæ¬¡æ¸è¿›å¼åˆ†é….æ¸è¿›å¼rehashæœŸé—´æ–°å¢çš„é”®å€¼å¯¹ä¸ä¼šä¿å­˜åˆ°è€çš„å“ˆå¸Œè¡¨ä¸­,ä¼šç›´æ¥è¿›å…¥æ–°hashè¡¨. 4. è·³è¡¨redisä½¿ç”¨è·³è¡¨(skiplist)ä½œä¸ºzsetå¯¹è±¡ç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€:å½“ä¸€ä¸ªzsetåŒ…å«çš„å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šæˆ–è€…åŒ…å«çš„æˆå‘˜éƒ½æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶redisä¸­åªåœ¨ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨äº†è·³è¡¨,ä¸€ä¸ªæ˜¯å®ç°zsetæ•°æ®ç±»å‹,å¦å¤–ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„.åŒä¸€ä¸ªè·³è·ƒè¡¨ä¸­,å„ä¸ªèŠ‚ç‚¹ä¿å­˜çš„æˆå‘˜å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„,ä½†æ˜¯åˆ†å€¼å¯ä»¥ç›¸åŒ,åˆ†å€¼ç›¸åŒæ—¶æŒ‰ç…§å­—å…¸æ’åºå°çš„åœ¨å‰å¤§çš„åœ¨å. 5. æ•´æ•°é›†åˆæ•´æ•°é›†åˆ(intset)å€¼å¯¹è±¡ä¸ºsetæ•°æ®ç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€,å½“ä¸€ä¸ªé›†åˆè´¨åŒ…å«æ•´æ•°å€¼å…ƒç´ ,å¹¶ä¸”é›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶. intsetæ˜¯redisç”¨æ¥ä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„,å¯ä»¥ä¿å­˜ç±»å‹ä¸ºint16_t,int32_tæˆ–è€…int64_tçš„æ•´æ•°å€¼,å¹¶ä¸”ä¿è¯ ä¸ä¼šå‡ºç°é‡å¤: æ•´æ•°é›†åˆæ•°æ®ç»“æ„å¦‚ä¸‹: 12345678typedef struct intset&#123; //ç¼–ç æ–¹å¼ uint32_t encoding; //é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡ uint32_t length; //ä¿å­˜å…ƒç´ çš„æ•°ç»„ int8_t contents[];&#125;intset contents[]ç”¨äºä¿å­˜é›†åˆä¸­çš„å…ƒç´ (æŒ‰ç…§å€¼çš„å¤§å°ä»å°åˆ°å¤§,ä¸é‡å¤) encodingä¸­ä¿å­˜çš„ç¼–ç æ–¹å¼å†³å®šäº†contents[]ä¸­ä¿å­˜çš„å€¼ç±»å‹,æœ‰ä¸‰ç§å¯¹åº”å…³ç³»,encoding(content)-&gt;INTSET_ENC_INT16(int16_t):å¯ä¿å­˜-32768~32767;INTSET_ENC_INT32(int32_t)å¯ä¿å­˜-2147483648~2147283647,INTSET_ENC_INT64(int64_t)å¯ä¿å­˜-9223372036854775808~9223372036854775807 å‡çº§å½“è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œæ—¶,å¦‚æœæ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰çš„æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½é•¿,æ•´æ•°é›†åˆä¼šå…ˆè¿›è¡Œå‡çº§,ç„¶åæ‰å°†æ–°å…ƒç´ æ·»åŠ è¿›å»,æ¯”å¦‚ç°æœ‰ä¸‰ä¸ªæ˜¯int16_t,ç°åœ¨è¦æ·»åŠ ä¸€ä¸ªint32_tä¼šå…ˆå°†ä¹‹å‰çš„ä¸‰ä¸ªè½¬æ¢ä¸ºint32_t,ç„¶åå†åŠ å…¥æ–°å…ƒç´ .å‡çº§çš„å¥½å¤„ä¸€æ˜¯æå‡æ•´æ•°é›†åˆçš„çµæ´»æ€§,å¦å¤–èƒ½å¤ŸèŠ‚çº¦å†…å­˜ç©ºé—´,ç›®å‰æš‚ä¸æ”¯æŒé™çº§ 6. å‹ç¼©åˆ—è¡¨å‹ç¼©åˆ—è¡¨(ziplist)æ˜¯listå’Œhashå€¼å¯¹è±¡çš„åº•å±‚å®ç°ä¹‹ä¸€,å½“ä¸€ä¸ªliståªåŒ…å«å°‘æ•°å…ƒç´ ,å¹¶ä¸”æ¯ä¸ªå…ƒç´ è¦ä¹ˆæ˜¯å°æ•´æ•°å€¼è¦ä¹ˆæ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²,æˆ–è€…ä¸€ä¸ªhashé”®çš„å€¼åŒ…å«å°‘é‡çš„é”®å€¼å¯¹,å¹¶ä¸”æ¯ä¸ªé”®å€¼å¯¹è¦ä¹ˆè¦ä¹ˆæ˜¯å°æ•´æ•°å€¼è¦ä¹ˆæ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸². å‹ç¼©åˆ—è¡¨æ˜¯redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„,æ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹æ•°æ®ç»“æ„,ä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹(entry),æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼. 7. å¯¹è±¡7.1 å¯¹è±¡ç±»å‹ä¸ç¼–ç Redisä½¿ç”¨å¯¹è±¡æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å’Œå€¼,åˆ†åˆ«ä¸ºé”®å¯¹è±¡å’Œå€¼å¯¹è±¡.æ¯ä¸ªå¯¹è±¡ç”±ä¸€ä¸ªredisObjectç»“æ„è¡¨ç¤º,è¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯type,encodingå’Œptr: 123456789typedef struct redisObject&#123; //ç±»å‹ unsigned type:4; //ç¼–ç  unsigned encoding:4; //æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ void *ptr; //...&#125; å¯¹äºredisæ•°æ®åº“ä¿å­˜çš„é”®å€¼å¯¹æ¥è¯´,é”®æ€»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡,å€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²å¯¹è±¡,listå¯¹è±¡,hashå¯¹è±¡,setå¯¹è±¡å’Œzsetå¯¹è±¡.å¯ä»¥ä½¿ç”¨typeå‘½ä»¤æŸ¥çœ‹å€¼å¯¹è±¡çš„ç±»å‹,å‘½ä»¤æ ¼å¼ä¸ºtype key. å¯¹è±¡çš„ptræŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°æ•°æ®ç»“æ„,ç”±å¯¹è±¡çš„encodingå±æ€§å†³å®š,encodingå±æ€§è®°å½•äº†å¯¹è±¡çš„åº•å±‚å®ç°,è¿™ä¸ªå±æ€§çš„å€¼å¯ä»¥æ˜¯ä¸‹è¡¨ä¸­åˆ—å‡ºçš„å¸¸é‡ä¸­çš„ä¸€ä¸ª: ç¼–ç å¸¸é‡ ç¼–ç æ‰€å¯¹åº”çš„åº•å±‚æ•°æ®ç»“æ„ REDIS_ENCODING_INT longç±»å‹çš„æ•´æ•° REDIS_ENCODING_EMBSTR embstrç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸² REDIS_ENCODING_RAW ç®€å•åŠ¨æ€å­—ç¬¦ä¸² REDIS_ENCODING_HT å­—å…¸ REDIS_ENCODING_LINKEDLIST åŒç«¯é“¾è¡¨ REDIS_ENCODING_ZIPLIST å‹ç¼©åˆ—è¡¨ REDIS_ENCODING_INTSET æ•´æ•°é›†åˆ REDIS_ENCODING_SKIPLIST è·³è·ƒè¡¨å’Œå­—å…¸ æ¯ç§ç±»å‹çš„å¯¹è±¡éƒ½è‡³å°‘ä½¿ç”¨äº†ä¸¤ç§ç±»å‹çš„ç¼–ç ,å¦‚ä¸‹è¡¨æ‰€ç¤º: ç±»å‹ ç¼–ç  å¯¹è±¡ REDIS_STRING REDIS_ENCODING_INT ä½¿ç”¨æ•´æ•°å€¼å®ç°çš„å­—ç¬¦å¯¹è±¡ REDIS_STRING REDIS_ENCODING_EMBSTR ä½¿ç”¨embstrç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²å®ç°çš„å­—ç¬¦ä¸²å¯¹è±¡ REDIS_STRING REDIS_ENCODING_RAW ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²å®ç°çš„å­—ç¬¦ä¸²å¯¹è±¡ REDIS_LIST REDIS_ENCODING_ZIPLIST ä½¿ç”¨å‹ç¼©åˆ—è¡¨å®ç°çš„listå¯¹è±¡ REDIS_LIST REDIS_ENCODING_LINKEDLIST ä½¿ç”¨åŒç«¯é“¾è¡¨å®ç°çš„listå¯¹è±¡ REDIS_HASH REDIS_ENCODING_ZIPLIST ä½¿ç”¨å‹ç¼©åˆ—è¡¨å®ç°çš„hashå¯¹è±¡ REDIS_HASH REDIS_ENCODING_HT ä½¿ç”¨å­—å…¸å®ç°çš„hashå¯¹è±¡ REDIS_SET REDIS_ENCODING_INTSET ä½¿ç”¨æ•´æ•°é›†åˆå®ç°çš„setå¯¹è±¡ REDIS_SET REDIS_ENCODING_HT ä½¿ç”¨å­—å…¸å®ç°çš„setå¯¹è±¡ REDIS_ZET REDIS_ENCODING_ZIPLIST ä½¿ç”¨å‹ç¼©åˆ—è¡¨å®ç°çš„zsetå¯¹è±¡ REDIS_ZET REDIS_ENCODING_SKIPLIST ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸å®ç°çš„zsetå¯¹è±¡ ä½¿ç”¨object encoding keyå‘½ä»¤å¯ä»¥æŸ¥çœ‹å¯¹åº”é”®çš„å€¼å¯¹è±¡çš„ç¼–ç ,æ¯ç§å€¼å¯¹è±¡è‡³å°‘ä½¿ç”¨ä¸¤ç§ç¼–ç å¯ä»¥æ–¹ä¾¿redisåœ¨ä¸åŒçš„åœºæ™¯ä¸‹é€‰æ‹©åˆé€‚çš„æ•°æ®å®ç°,æé«˜æ•ˆç‡. 7.2 å­—ç¬¦ä¸²å¯¹è±¡å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯int,rawæˆ–è€…embstr,å„è‡ªä½¿ç”¨åœºæ™¯å¦‚ä¸‹: int: å½“å­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯æ•´æ•°å€¼,å¹¶ä¸”è¯¥æ•´æ•°å€¼å¯ä»¥ç”¨longç±»å‹è¡¨ç¤º raw: å½“ä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²å¹¶ä¸”è¯¥å­—ç¬¦ä¸²é•¿åº¦å¤§äº39å­—èŠ‚,ä½¿ç”¨ä¸€ä¸ªSDSæ¥ä¿å­˜å€¼,å¹¶å°†ç¼–ç è®¾ç½®ä¸ºraw embstr: å½“ä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²å¹¶ä¸”è¯¥å­—ç¬¦ä¸²é•¿åº¦å°äº39å­—èŠ‚,å°†ç¼–ç è®¾ç½®ä¸ºembstr embstrç¼–ç æ˜¯ä¸“é—¨ç”¨äºä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ä¼˜åŒ–ç¼–ç æ”¾æ˜¯,å…¶å’Œrawç¼–ç ä¸€æ ·,éƒ½æ˜¯ç”¨redisObjectç»“æ„å’Œsdshdrç»“æ„æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å¯¹è±¡,ä½†rawç¼–ç éœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ›å»ºredisObjectç»“æ„å’Œsdshdrç»“æ„,è€Œembstré€šè¿‡è°ƒç”¨ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†é…ä¸€å—è¿ç»­çš„ç©ºé—´,ç©ºé—´ä¸­ä¾æ¬¡åŒ…å«redisObjectç»“æ„å’Œsdshdrç»“æ„: ä½¿ç”¨embstrç¼–ç å¥½å¤„æ˜¯:1.é™ä½å†…å­˜åˆ†é…æ¬¡æ•°(ä»ä¸¤æ¬¡é™ä½ä¸ºä¸€æ¬¡)2.é‡Šæ”¾å­—ç¬¦ä¸²å¯¹è±¡æ—¶,rawéœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜é‡Šæ”¾å‡½æ•°,embstråªéœ€è¦ä¸€æ¬¡3.å› ä¸ºembstrç¼–ç å¯¹è±¡ä¿å­˜åœ¨è¿ç»­ç©ºé—´ä¸­,èƒ½æ›´å¥½åˆ©ç”¨ç¼“å­˜å¸¦æ¥çš„ä¼˜åŠ¿ å¯ä»¥ç”¨long doubleç±»å‹è¡¨ç¤ºçš„æµ®ç‚¹æ•°åœ¨redisä¸­ä¹Ÿæ˜¯ä½œä¸ºå­—ç¬¦ä¸²ä¿å­˜çš„.ç¼–ç å¯¹è±¡å¯ä»¥ç›¸äº’è½¬æ¢,å…¶ä¸­embstrç¼–ç æ²¡æœ‰ä»»ä½•ä¿®æ”¹ç¨‹åº,å› æ­¤æ˜¯åªè¯»çš„.ä¸‹è¡¨æ˜¯å¸¸è§å­—ç¬¦ä¸²å‘½ä»¤çš„å®ç°: 7.3 listå¯¹è±¡listå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…linkedlist,å½“listå¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶,ä½¿ç”¨ziplistç¼–ç ,å¦åˆ™ä½¿ç”¨linkedlist 1.listå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº64å­—èŠ‚; 2.å…ƒç´ æ•°é‡å°äº512ä¸ª ä»¥ä¸Šä¸¤ä¸ªæ•°å€¼åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä¿®æ”¹,å¯¹åº”çš„æ˜¯list-max-ziplist-valueé€‰é¡¹å’Œlist-max-ziplist-entries 7.4 hashå¯¹è±¡hashå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…hashtable,å½“ä½¿ç”¨ziplistå‹ç¼©åˆ—è¡¨ç¼–ç æ—¶,ä¸€ä¸ªé”®å€¼å¯¹åˆ†åˆ«ä¿å­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Š,ä¸€å‰ä¸€åç´§æŒ¨åœ¨ä¸€èµ·.å…ˆæ·»åŠ çš„é”®å€¼å¯¹åœ¨è¡¨å¤´æ–¹å‘,åæ·»åŠ çš„åœ¨è¡¨å°¾æ–¹å‘;å½“ä½¿ç”¨hashtableç¼–ç æ—¶,åº•å±‚ä½¿ç”¨å­—å…¸ä½œä¸ºå®ç°,é”®å€¼å¯¹éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡. hashå¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ä½¿ç”¨ziplistç¼–ç ,å¦åˆ™ä½¿ç”¨hashtableç¼–ç : 1.é”®å€¼å¯¹çš„é”®å’Œå€¼å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº64å­—èŠ‚; 2.é”®å€¼å¯¹ä¸ªæ•°å°äº512ä¸ª ä»¥ä¸Šä¸¤ä¸ªæ•°å€¼åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä¿®æ”¹,å¯¹åº”çš„æ˜¯hash-max-ziplist-valueé€‰é¡¹å’Œhash-max-ziplist-entries 7.5 setå¯¹è±¡setå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯intsetæˆ–è€…hashtable,å½“å¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ˜¯,ä½¿ç”¨intsetç¼–ç ,å¦åˆ™ä½¿ç”¨hashtableç¼–ç : 1.ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ 2.å…ƒç´ çš„æ•°é‡ä¸è¶…è¿‡512ä¸ª ç¬¬äºŒä¸ªæ•°å€¼åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä¿®æ”¹,å¯¹åº”çš„æ˜¯set-max-intset-entries 7.6 zsetå¯¹è±¡zsetå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…skiplist.å½“ä½¿ç”¨ziplistç¼–ç æ—¶,æ¯ä¸ªå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜,ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜(member),ç¬¬äºŒä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„åˆ†å€¼(score),åˆ—è¡¨å†…æŒ‰ç…§åˆ†å€¼ä»å°åˆ°å¤§æ’åº,åˆ†å€¼å°çš„åœ¨è¡¨å¤´æ–¹å‘,åˆ†å€¼å¤§çš„åœ¨è¡¨å°¾æ–¹å‘,skiplistç¼–ç çœ‹p78. å½“åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶,ä½¿ç”¨ziplistç¼–ç ,å¦åˆ™ä½¿ç”¨ziplistç¼–ç : 1.å…ƒç´ æ•°é‡ä¸ªæ•°å°‘äº128ä¸ª 2.æ‰€æœ‰å…ƒç´ æˆå‘˜çš„é•¿åº¦éƒ½å°äº64å­—èŠ‚ ä»¥ä¸Šä¸¤ä¸ªæ•°å€¼åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä¿®æ”¹,å¯¹åº”çš„æ˜¯zset-max-ziplist-entriesé€‰é¡¹å’Œzset-max-ziplist-value","categories":[{"name":"è¯»ä¹¦ç¬”è®°","slug":"è¯»ä¹¦ç¬”è®°","permalink":"https://www.enjoyican.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"https://www.enjoyican.com/tags/Redis/"}]},{"title":"è½¬è½½-AspectJ ä½¿ç”¨ä»‹ç»","date":"2020-03-16T15:39:25.000Z","path":"posts/spring-aop-aspectj/","text":"[TOC] ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä»‹ç»äº† Spring AOP çš„å„ç§ç”¨æ³•ï¼ŒåŒ…æ‹¬éšç€ Spring çš„æ¼”è¿›è€Œå‘å±•å‡ºæ¥çš„å‡ ç§é…ç½®æ–¹å¼ã€‚ ä½†æ˜¯æˆ‘ä»¬å§‹ç»ˆæ²¡æœ‰ä½¿ç”¨åˆ° AspectJï¼Œå³ä½¿æ˜¯åœ¨åŸºäºæ³¨è§£çš„ @AspectJ çš„é…ç½®æ–¹å¼ä¸­ï¼ŒSpring ä¹Ÿä»…ä»…æ˜¯ä½¿ç”¨äº† AspectJ åŒ…ä¸­çš„ä¸€äº›æ³¨è§£è€Œå·²ï¼Œå¹¶æ²¡æœ‰ä¾èµ–äº AspectJ å®ç°å…·ä½“çš„åŠŸèƒ½ã€‚ æœ¬æ–‡å°†ä»‹ç»ä½¿ç”¨ AspectJï¼Œä»‹ç»å®ƒçš„ 3 ç§ç»‡å…¥æ–¹å¼ã€‚ æœ¬æ–‡ä½¿ç”¨çš„æµ‹è¯•æºç å·²ä¸Šä¼ åˆ° Github: hongjiev/aspectj-learningï¼Œå¦‚æœä½ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ç¢°åˆ°éº»çƒ¦ï¼Œè¯·åœ¨è¯„è®ºåŒºç•™è¨€ã€‚ ç›®å½•ï¼š AspectJ ä½¿ç”¨ä»‹ç»AspectJ ä½œä¸º AOP ç¼–ç¨‹çš„å®Œå…¨è§£å†³æ–¹æ¡ˆï¼Œæä¾›äº†ä¸‰ç§ç»‡å…¥æ—¶æœºï¼Œåˆ†åˆ«ä¸º compile-timeï¼šç¼–è¯‘æœŸç»‡å…¥ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ä¸€æ­¥åˆ°ä½ï¼Œç›´æ¥ç¼–è¯‘å‡ºåŒ…å«ç»‡å…¥ä»£ç çš„ .class æ–‡ä»¶ post-compileï¼šç¼–è¯‘åç»‡å…¥ï¼Œå¢å¼ºå·²ç»ç¼–è¯‘å‡ºæ¥çš„ç±»ï¼Œå¦‚æˆ‘ä»¬è¦å¢å¼ºä¾èµ–çš„ jar åŒ…ä¸­çš„æŸä¸ªç±»çš„æŸä¸ªæ–¹æ³• load-timeï¼šåœ¨ JVM è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™è¿›è¡Œç»‡å…¥ æœ¬èŠ‚ä¸­çš„å†…å®¹å‚è€ƒäº†ã€ŠIntro to AspectJã€‹ï¼ŒBaeldung çœŸçš„æ˜¯æŒºä¸é”™çš„ä¸€ä¸ª Java åšå®¢ã€‚ é¦–å…ˆï¼Œå…ˆæŠŠä¸‹é¢ä¸¤ä¸ªä¾èµ–åŠ è¿›æ¥ï¼š 1234567891011&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt; &lt;version&gt;1.8.13&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;version&gt;1.8.13&lt;/version&gt;&lt;/dependency&gt; æˆ‘ä»¬åé¢éœ€è¦ç”¨åˆ°ä¸‹é¢è¿™ä¸ªç±»ï¼Œå‡è®¾è´¦æˆ·åˆå§‹æœ‰ 20 å—é’±ï¼Œä¹‹åä¼šè°ƒ account.pay(amount) è¿›è¡Œä»˜æ¬¾ï¼š 123456789101112public class Account &#123; int balance = 20; public boolean pay(int amount) &#123; if (balance &lt; amount) &#123; return false; &#125; balance -= amount; return true; &#125;&#125; ä¸‹é¢ï¼Œæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ª Aspect æ¥è¿›è¡Œæ¼”ç¤ºï¼š AccountAspectï¼šç”¨ AspectJ çš„è¯­æ³•æ¥å†™ï¼Œå¯¹äº¤æ˜“è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æ­¤æ¬¡äº¤æ˜“è¶…è¿‡ä½™é¢ï¼Œç›´æ¥æ‹’ç»ã€‚ ProfilingAspectï¼šç”¨ Java æ¥å†™ï¼Œç”¨äºè®°å½•æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ AccountAspect éœ€è¦ä»¥ .aj ç»“å°¾ï¼Œå¦‚æˆ‘ä»¬åœ¨ com.javadoop.aspectjlearning.aspectj çš„ package ä¸‹æ–°å»ºæ–‡ä»¶ AccountAspect.ajï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627package com.javadoop.aspectjlearning.aspect;import com.javadoop.aspectjlearning.model.Account;public aspect AccountAspect &#123; pointcut callPay(int amount, Account account): call(boolean com.javadoop.aspectjlearning.model.Account.pay(int)) &amp;&amp; args(amount) &amp;&amp; target(account); before(int amount, Account account): callPay(amount, account) &#123; System.out.println(\"[AccountAspect]ä»˜æ¬¾å‰æ€»é‡‘é¢: \" + account.balance); System.out.println(\"[AccountAspect]éœ€è¦ä»˜æ¬¾: \" + amount); &#125; boolean around(int amount, Account account): callPay(amount, account) &#123; if (account.balance &lt; amount) &#123; System.out.println(\"[AccountAspect]æ‹’ç»ä»˜æ¬¾!\"); return false; &#125; return proceed(amount, account); &#125; after(int amount, Account balance): callPay(amount, balance) &#123; System.out.println(\"[AccountAspect]ä»˜æ¬¾åï¼Œå‰©ä½™ï¼š\" + balance.balance); &#125;&#125; ä¸Šé¢ .aj çš„è¯­æ³•æˆ‘ä»¬å¯èƒ½ä¸ç†Ÿæ‚‰ï¼Œä½†æ˜¯çœ‹ä¸Šå»è¿˜æ˜¯ç®€å•çš„ï¼Œåˆ†åˆ«å¤„ç†äº† beforeã€around å’Œ after çš„åœºæ™¯ã€‚ æˆ‘ä»¬å†æ¥çœ‹ç”¨ Java å†™çš„ ProfilingAspect.java: 1234567891011121314151617181920212223package com.javadoop.aspectjlearning.aspect;import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.Around;import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Pointcut;@Aspectpublic class ProfilingAspect &#123; @Pointcut(\"execution(* com.javadoop.aspectjlearning.model.*.*(..))\") public void modelLayer() &#123; &#125; @Around(\"modelLayer()\") public Object logProfile(ProceedingJoinPoint joinPoint) throws Throwable &#123; long start = System.currentTimeMillis(); Object result = joinPoint.proceed(); System.out.println(\"[ProfilingAspect]æ–¹æ³•: ã€\" + joinPoint.getSignature() + \"ã€‘ç»“æŸï¼Œç”¨æ—¶: \" + (System.currentTimeMillis() - start)); return result; &#125;&#125; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¨è®ºæ€ä¹ˆæ ·å°†å®šä¹‰å¥½çš„ä¸¤ä¸ª Aspects ç»‡å…¥åˆ°æˆ‘ä»¬çš„ Account çš„ä»˜æ¬¾æ–¹æ³• pay(amount) ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸‰ç§ç»‡å…¥æ—¶æœºåˆ†åˆ«æ˜¯æ€ä¹ˆå®ç°çš„ã€‚ Compile-Time Weavingè¿™æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨ç¼–è¯‘æœŸçš„æ—¶å€™è¿›è¡Œç»‡å…¥ï¼Œè¿™æ ·ç¼–è¯‘å‡ºæ¥çš„ .class æ–‡ä»¶å·²ç»ç»‡å…¥äº†æˆ‘ä»¬çš„ä»£ç ï¼Œåœ¨ JVM è¿è¡Œçš„æ—¶å€™å…¶å®å°±æ˜¯åŠ è½½äº†ä¸€ä¸ªæ™®é€šçš„è¢«ç»‡å…¥äº†ä»£ç çš„ç±»ã€‚ å¦‚æœä½ æ˜¯é‡‡ç”¨ maven è¿›è¡Œç®¡ç†ï¼Œå¯ä»¥åœ¨ &lt;build&gt; ä¸­åŠ å…¥ä»¥ä¸‹çš„æ’ä»¶ï¼š 1234567891011121314151617181920212223&lt;!-- ç¼–è¯‘æœŸç»‡å…¥ --&gt;&lt;plugin&gt; &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt; &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.7&lt;/version&gt; &lt;configuration&gt; &lt;complianceLevel&gt;1.8&lt;/complianceLevel&gt; &lt;source&gt;1.8&lt;/source&gt; &lt;target&gt;1.8&lt;/target&gt; &lt;showWeaveInfo&gt;true&lt;/showWeaveInfo&gt; &lt;verbose&gt;true&lt;/verbose&gt; &lt;Xlint&gt;ignore&lt;/Xlint&gt; &lt;encoding&gt;UTF-8&lt;/encoding&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;goals&gt; &lt;goal&gt;compile&lt;/goal&gt; &lt;goal&gt;test-compile&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt;&lt;/plugin&gt; AccountAspect.aj æ–‡ä»¶ javac æ˜¯æ²¡æ³•ç¼–è¯‘çš„ï¼Œæ‰€ä»¥ä¸Šé¢è¿™ä¸ªæ’ä»¶å…¶å®å……å½“äº†ç¼–è¯‘çš„åŠŸèƒ½ã€‚ ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œäº†ï¼š 12345678910111213public class Application &#123; public static void main(String[] args) &#123; testCompileTime(); &#125; public static void testCompileTime() &#123; Account account = new Account(); System.out.println(\"==================\"); account.pay(10); account.pay(50); System.out.println(\"==================\"); &#125;&#125; è¾“å‡ºï¼š 12345678910&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;[AccountAspect]ä»˜æ¬¾å‰æ€»é‡‘é¢: 20[AccountAspect]éœ€è¦ä»˜æ¬¾: 10[ProfilingAspect]æ–¹æ³•: ã€boolean com.javadoop.aspectjlearning.model.Account.pay(int)ã€‘ç»“æŸï¼Œç”¨æ—¶: 1[AccountAspect]ä»˜æ¬¾åï¼Œå‰©ä½™ï¼š10[AccountAspect]ä»˜æ¬¾å‰æ€»é‡‘é¢: 10[AccountAspect]éœ€è¦ä»˜æ¬¾: 50[AccountAspect]æ‹’ç»ä»˜æ¬¾![AccountAspect]ä»˜æ¬¾åï¼Œå‰©ä½™ï¼š10&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ç»“æœçœ‹ä¸Šå»å°±å¾ˆç¥å¥‡ï¼ˆæˆ‘ä»¬çŸ¥é“æ˜¯ aop æçš„é¬¼å½“ç„¶ä¼šè§‰å¾—ä¸ç¥å¥‡ï¼‰ï¼Œå…¶å®å¥¥ç§˜å°±åœ¨äº main å‡½æ•°ä¸­çš„ä»£ç è¢«æ”¹å˜äº†ï¼Œä¸å†æ˜¯ä¸Šé¢å‡ è¡Œç®€å•çš„ä»£ç äº†ï¼Œè€Œæ˜¯è¿›è¡Œäº†ç»‡å…¥ï¼š 1 æˆ‘ä»¬çš„ Account ç±»ä¹Ÿä¸å†åƒåŸæ¥å®šä¹‰çš„é‚£æ ·äº†ï¼š 1 ç¼–è¯‘æœŸç»‡å…¥ç†è§£èµ·æ¥åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™å…ˆä¿®æ”¹äº†ä»£ç å†è¿›è¡Œç¼–è¯‘ã€‚ Post-Compile WeavingPost-Compile Weaving å’Œ Compile-Time Weaving éå¸¸ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç›´æ¥ç”¨åœºæ™¯æ¥è¯´ã€‚ æˆ‘ä»¬å‡è®¾ä¸Šé¢çš„ Account ç±»åœ¨ aspectj-learning-share.jar åŒ…ä¸­ï¼Œæˆ‘ä»¬çš„å·¥ç¨‹ aspectj-learning ä¾èµ–äº†è¿™ä¸ª jar åŒ…ã€‚ ç”±äº Account è¿™ä¸ªç±»å·²ç»è¢«ç¼–è¯‘å‡ºæ¥äº†ï¼Œæˆ‘ä»¬è¦å¯¹å®ƒçš„æ–¹æ³•è¿›è¡Œç»‡å…¥ï¼Œå°±éœ€è¦ç”¨åˆ°ç¼–è¯‘åç»‡å…¥ã€‚ ä¸ºäº†æ–¹ä¾¿å¤§å®¶æµ‹è¯•ï¼Œå°½é‡è®©å‰é¢çš„ç”¨ä¾‹ä¹Ÿèƒ½è·‘èµ·æ¥ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„ç±» Userï¼Œä»£ç å’Œ Account ä¸€æ ·ï¼Œä½†æ˜¯åœ¨ aspectj-learning-share.jar åŒ…ä¸­ï¼Œè¿™ä¸ªåŒ…å°±è¿™ä¸€ä¸ªç±»ã€‚ åŒæ—¶ä¹Ÿå¤åˆ¶ AccountAspect ä¸€ä»½å‡ºæ¥ï¼Œå‘½åä¸º UserAspectï¼Œç¨å¾®ä¿®æ”¹ä¿®æ”¹å°±å¯ä»¥ç”¨æ¥å¤„ç† User ç±»äº†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ³¨é‡Šæ‰ä¹‹å‰ç¼–è¯‘æœŸç»‡å…¥ä½¿ç”¨çš„æ’ä»¶é…ç½®ï¼Œå¢åŠ ä»¥ä¸‹æ’ä»¶é…ç½®ï¼ˆå…¶å®è¿˜æ˜¯åŒä¸€ä¸ªæ’ä»¶ï¼‰ï¼š 12345678910111213141516171819202122&lt;!--ç¼–è¯‘åç»‡å…¥--&gt;&lt;plugin&gt; &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt; &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.11&lt;/version&gt; &lt;configuration&gt; &lt;complianceLevel&gt;1.8&lt;/complianceLevel&gt; &lt;weaveDependencies&gt; &lt;weaveDependency&gt; &lt;groupId&gt;com.javadoop&lt;/groupId&gt; &lt;artifactId&gt;aspectj-learning-share&lt;/artifactId&gt; &lt;/weaveDependency&gt; &lt;/weaveDependencies&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;goals&gt; &lt;goal&gt;compile&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt;&lt;/plugin&gt; æ³¨æ„é…ç½®ä¸­çš„ &lt;weaveDependency&gt;ï¼Œæˆ‘ä»¬åœ¨ &lt;dependencies&gt; ä¸­è¦é…ç½®å¥½ä¾èµ–ï¼Œç„¶ååœ¨è¿™é‡Œè¿›è¡Œé…ç½®ã€‚è¿™æ ·å°±å¯ä»¥å¯¹å…¶è¿›è¡Œç»‡å…¥äº†ã€‚ æ¥ä¸‹æ¥ï¼Œå¤§å®¶å¯ä»¥æ‰‹åŠ¨ç”¨ mvn clean package ç¼–è¯‘ä¸€ä¸‹ï¼Œç„¶åå°±ä¼šçœ‹åˆ°ä»¥ä¸‹ç»“æœï¼š 3 ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„é…ç½®ä¼šæŠŠç›¸åº”çš„ jar åŒ…ä¸­çš„ç±»åŠ åˆ°å½“å‰å·¥ç¨‹çš„ç¼–è¯‘ç»“æœä¸­ï¼ˆUser ç±»åŸæœ¬æ˜¯åœ¨ aspectj-learning-share.jar ä¸­çš„ï¼‰ã€‚ è¿è¡Œä¸€ä¸‹ï¼š 1java -jar target/aspectj-learning-1.0-jar-with-dependencies.jar è¿è¡Œç»“æœä¹Ÿä¼šå¦‚é¢„æœŸçš„ä¸€æ ·ï¼ŒUserAspect å¯¹ User è¿›è¡Œäº†ç»‡å…¥ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚æ„Ÿå…´è¶£çš„è¯»è€…è‡ªå·±å»è·‘ä¸€ä¸‹ï¼Œæ³¨æ„ä¸€å®šè¦ç”¨ mvn å‘½ä»¤ï¼Œä¸è¦ç”¨ IDEï¼Œä¸ç„¶å¾ˆå¤šæ—¶å€™å‘ç°ä¸äº†é—®é¢˜ã€‚ Intellij åœ¨ build çš„æ—¶å€™ä¼šè‡ªå·±å¤„ç† AspectJï¼Œè€Œä¸æ˜¯ç”¨æˆ‘ä»¬é…ç½®çš„ maven æ’ä»¶ã€‚ Load-Time Weavingæœ€åï¼Œæˆ‘ä»¬è¦ä»‹ç»çš„æ˜¯ LTW ç»‡å…¥ï¼Œæ­£å¦‚ Load-Time çš„åå­—æ‰€ç¤ºï¼Œå®ƒæ˜¯åœ¨ JVM åŠ è½½ç±»çš„æ—¶å€™åšçš„ç»‡å…¥ã€‚AspectJ å…è®¸æˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š agent æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ³¨é‡Šæ‰ä¹‹å‰åœ¨ pom.xml ä¸­ç”¨äºç¼–è¯‘æœŸå’Œç¼–è¯‘åç»‡å…¥ä½¿ç”¨çš„æ’ä»¶ï¼Œå…å¾—å½±å“æˆ‘ä»¬çš„æµ‹è¯•ã€‚ æˆ‘ä»¬è¦çŸ¥é“ï¼Œä¸€æ—¦æˆ‘ä»¬å»æ‰äº† aspectj çš„ç¼–è¯‘æ’ä»¶ï¼Œé‚£ä¹ˆ .aj çš„æ–‡ä»¶æ˜¯ä¸ä¼šè¢«ç¼–è¯‘çš„ã€‚ ç„¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ JVM çš„å¯åŠ¨å‚æ•°ä¸­åŠ ä¸Šä»¥ä¸‹ agentï¼ˆæˆ–åœ¨ IDE ä¸­é…ç½® VM optionsï¼‰ï¼Œå¦‚ï¼š 1-javaagent:/Users/hongjie/.m2/repository/org/aspectj/aspectjweaver/1.8.13/aspectjweaver-1.8.13.jar ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ resources ä¸­é…ç½® aop.xml æ–‡ä»¶ï¼Œæ”¾ç½®åœ¨ META-INF ç›®å½•ä¸­ï¼ˆresource/META-INF/aop.xmlï¼‰ï¼š 123456789&lt;!DOCTYPE aspectj PUBLIC \"-//AspectJ//DTD//EN\" \"http://www.eclipse.org/aspectj/dtd/aspectj.dtd\"&gt;&lt;aspectj&gt; &lt;aspects&gt; &lt;aspect name=\"com.javadoop.aspectjlearning.aspect.ProfilingAspect\"/&gt; &lt;weaver options=\"-verbose -showWeaveInfo\"&gt; &lt;include within=\"com.javadoop.aspectjlearning..*\"/&gt; &lt;/weaver&gt; &lt;/aspects&gt;&lt;/aspectj&gt; aop.xml æ–‡ä»¶ä¸­çš„é…ç½®éå¸¸å®¹æ˜“ç†è§£ï¼Œåªéœ€è¦é…ç½® Aspects å’Œéœ€è¦è¢«ç»‡å…¥çš„ç±»å³å¯ã€‚ æˆ‘ä»¬ç”¨ä»¥ä¸‹ç¨‹åºè¿›è¡Œæµ‹è¯•ï¼š 123456789101112public class Application &#123; public static void main(String[] args) &#123; testLoadTime(); &#125; public static void testLoadTime() &#123; Account account = new Account(); System.out.println(\"==================\"); account.pay(10); account.pay(50); System.out.println(\"==================\"); &#125;&#125; ä¸‡äº‹å…·å¤‡äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹è·‘èµ·æ¥äº†ã€‚ ç¬¬ä¸€æ­¥ï¼Œç¼–è¯‘ 1mvn clean package ç¬¬äºŒæ­¥ï¼Œæ£€æŸ¥ç¼–è¯‘ç»“æœ æˆ‘ä»¬é€šè¿‡ IDE æŸ¥çœ‹ç¼–è¯‘å‡ºæ¥çš„ä»£ç ï¼ˆIDEåç¼–è¯‘ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒApplication ç±»å¹¶æœªè¿›è¡Œç»‡å…¥ï¼ŒAccount ç±»ä¹Ÿå¹¶æœªè¿›è¡Œç»‡å…¥ã€‚ ç¬¬ä¸‰æ­¥ï¼Œè¿è¡Œ ä»ç¬¬äºŒæ­¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿è¡Œä¹‹å‰ï¼ŒAspectJ æ²¡æœ‰åšä»»ä½•çš„äº‹æƒ…ã€‚ é‚£ä¹ˆå¯ä»¥è‚¯å®šçš„å°±æ˜¯ï¼ŒAspectJ ä¼šåœ¨è¿è¡ŒæœŸåˆ©ç”¨ aop.xml ä¸­çš„é…ç½®è¿›è¡Œç»‡å…¥å¤„ç†ã€‚ åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š 1java -jar target/aspectj-learning-1.0-jar-with-dependencies.jar è¾“å‡ºä¸ºï¼š 12&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•ç»‡å…¥å¤„ç†ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹è¯­å¥å†è¯•è¯•ï¼š 1java -javaagent:/Users/hongjie/.m2/repository/org/aspectj/aspectjweaver/1.8.13/aspectjweaver-1.8.13.jar -jar target/aspectj-learning-1.0-jar-with-dependencies.jar å¯åŠ¨çš„æ—¶å€™æŒ‡å®šäº† -javaagent:/.../aspectjweaver-1.8.13.jarï¼Œç„¶åå†çœ‹è¾“å‡ºç»“æœï¼š 1234&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;[ProfilingAspect]æ–¹æ³•: ã€boolean com.javadoop.aspectjlearning.model.Account.pay(int)ã€‘ç»“æŸï¼Œç”¨æ—¶: 1[ProfilingAspect]æ–¹æ³•: ã€boolean com.javadoop.aspectjlearning.model.Account.pay(int)ã€‘ç»“æŸï¼Œç”¨æ—¶: 0&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ProfilingAspect å·²ç»è¿›è¡Œäº†ç»‡å…¥å¤„ç†ï¼Œè¿™å°±æ˜¯ Load-time Weavingã€‚ åˆ°è¿™é‡Œï¼Œå°±è¦ç»“æŸè¿™ä¸€å°èŠ‚äº†ï¼Œè¿™é‡Œé¡ºä¾¿å†ä»‹ç»ä¸‹å¦‚æœç”¨ maven è·‘æµ‹è¯•çš„è¯æ€ä¹ˆæã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å¾€ surefire æ’ä»¶ä¸­åŠ ä¸Š javaagentï¼š 123456789101112&lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt; &lt;version&gt;2.10&lt;/version&gt; &lt;configuration&gt; &lt;argLine&gt; -javaagent:/xxx/aspectjweaver-1.8.13.jar &lt;/argLine&gt; &lt;useSystemClassLoader&gt;true&lt;/useSystemClassLoader&gt; &lt;forkMode&gt;always&lt;/forkMode&gt; &lt;/configuration&gt;&lt;/plugin&gt; ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ mvn test çœ‹åˆ°ç»‡å…¥æ•ˆæœäº†ã€‚è¿˜æ˜¯é‚£å¥è¯ï¼Œä¸è¦ç”¨ IDE è¿›è¡Œæµ‹è¯•ï¼Œå› ä¸º IDE å¤ªâ€œæ™ºèƒ½â€äº†ã€‚ å°ç»“AspectJ çš„ä¸‰ç§ç»‡å…¥æ–¹å¼ä¸­ï¼Œä¸ªäººè§‰å¾—å‰é¢çš„ä¸¤ç§ä¼šæ¯”è¾ƒå®ç”¨ä¸€äº›ï¼Œå› ä¸ºç¬¬ä¸‰ç§éœ€è¦ä¿®æ”¹å¯åŠ¨è„šæœ¬ï¼Œå¯¹äºå¤§å‹å…¬å¸æ¥è¯´ä¼šæ¯”è¾ƒä¸å‹å¥½ï¼Œéœ€è¦ä¸“é—¨æ‰¾è¿ç»´äººå‘˜é…ç½®ã€‚ åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬ç”¨å¾—æœ€å¤šçš„è¿˜æ˜¯çº¯ Spring AOPï¼Œé€šè¿‡æœ¬æ–‡çš„ä»‹ç»ï¼Œç›¸ä¿¡å¤§å®¶å¯¹äº AspectJ çš„ä½¿ç”¨åº”è¯¥ä¹Ÿæ²¡ä»€ä¹ˆå‹åŠ›äº†ã€‚ å¤§å®¶å¦‚æœå¯¹äºæœ¬æ–‡ä»‹ç»çš„å†…å®¹æœ‰ä»€ä¹ˆä¸æ¸…æ¥šçš„ï¼Œè¯·ç›´æ¥åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œå¦‚æœå¯¹äº Spring + AspectJ æ„Ÿå…´è¶£çš„è¯»è€…ï¼Œç¢°åˆ°é—®é¢˜ä¹Ÿå¯ä»¥åœ¨è¯„è®ºåŒºå’Œå¤§å®¶äº’åŠ¨è®¨è®ºã€‚ ï¼ˆå…¨æ–‡å®Œï¼‰ éƒ‘é‡å£°æ˜ : æœ¬æ–‡è½¬è½½è‡ªæˆ‘å…³æ³¨çš„ä¸€ä½å¤§ä½¬çš„åšå®¢,åŸæ–‡é“¾æ¥ ,å¦‚æœ‰ä¾µæƒè¿˜è¯·è”ç³»æœ¬äººåˆ é™¤,ä»…åšçŸ¥è¯†ä¼ æ’­ä¸è®°å½•,æ— å‰½çªƒå†’çŠ¯ä¹‹æ„.","categories":[{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.enjoyican.com/categories/%E6%A1%86%E6%9E%B6/"}],"tags":[{"name":"aop","slug":"aop","permalink":"https://www.enjoyican.com/tags/aop/"},{"name":"aspectj","slug":"aspectj","permalink":"https://www.enjoyican.com/tags/aspectj/"}]},{"title":"è½¬è½½-Spring-AOPä½¿ç”¨ä»‹ç»ï¼Œä»å‰ä¸–åˆ°ä»Šç”Ÿ","date":"2020-03-16T15:21:00.000Z","path":"posts/Spring-aop/","text":"å‰é¢å†™è¿‡ Spring IOC çš„æºç åˆ†æï¼Œå¾ˆå¤šè¯»è€…å¸Œæœ›å¯ä»¥å‡ºä¸€ä¸ª Spring AOP çš„æºç åˆ†æï¼Œä¸è¿‡ Spring AOP çš„æºç è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå†™å‡ºæ¥ä¸å…ç¯‡å¹…ä¼šå¤§äº›ã€‚ æœ¬æ–‡ä¸ä»‹ç»æºç åˆ†æï¼Œè€Œæ˜¯ä»‹ç» Spring AOP ä¸­çš„ä¸€äº›æ¦‚å¿µï¼Œä»¥åŠå®ƒçš„å„ç§é…ç½®æ–¹æ³•ï¼Œæ¶µç›–äº† Spring AOP å‘å±•åˆ°ç°åœ¨å‡ºç°çš„å…¨éƒ¨ 3 ç§é…ç½®æ–¹å¼ã€‚ ç”±äº Spring å¼ºå¤§çš„å‘åå…¼å®¹æ€§ï¼Œå®é™…ä»£ç ä¸­å¾€å¾€ä¼šå‡ºç°å¾ˆå¤šé…ç½®æ··æ‚çš„æƒ…å†µï¼Œè€Œä¸”å±…ç„¶è¿˜èƒ½å·¥ä½œï¼Œæœ¬æ–‡å¸Œæœ›å¸®åŠ©å¤§å®¶ç†æ¸…æ¥šè¿™äº›çŸ¥è¯†ã€‚ æœ¬æ–‡ä½¿ç”¨çš„æµ‹è¯•æºç å·²ä¸Šä¼ åˆ° Github: hongjiev/spring-aop-learningã€‚ ç›®å½•ï¼š AOP, AspectJ, Spring AOPæˆ‘ä»¬å…ˆæ¥æŠŠå®ƒä»¬çš„æ¦‚å¿µå’Œå…³ç³»è¯´è¯´æ¸…æ¥šã€‚ AOP è¦å®ç°çš„æ˜¯åœ¨æˆ‘ä»¬åŸæ¥å†™çš„ä»£ç çš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šçš„åŒ…è£…ï¼Œå¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ã€æ–¹æ³•è¿”å›åã€æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åç­‰åœ°æ–¹è¿›è¡Œä¸€å®šçš„æ‹¦æˆªå¤„ç†æˆ–è€…å«å¢å¼ºå¤„ç†ã€‚ AOP çš„å®ç°å¹¶ä¸æ˜¯å› ä¸º Java æä¾›äº†ä»€ä¹ˆç¥å¥‡çš„é’©å­ï¼Œå¯ä»¥æŠŠæ–¹æ³•çš„å‡ ä¸ªç”Ÿå‘½å‘¨æœŸå‘Šè¯‰æˆ‘ä»¬ï¼Œè€Œæ˜¯æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªä»£ç†ï¼Œå®é™…è¿è¡Œçš„å®ä¾‹å…¶å®æ˜¯ç”Ÿæˆçš„ä»£ç†ç±»çš„å®ä¾‹ã€‚ ä½œä¸º Java å¼€å‘è€…ï¼Œæˆ‘ä»¬éƒ½å¾ˆç†Ÿæ‚‰ AspectJ è¿™ä¸ªè¯ï¼Œç”šè‡³äºæˆ‘ä»¬æåˆ° AOP çš„æ—¶å€™ï¼Œæƒ³åˆ°çš„å¾€å¾€å°±æ˜¯ AspectJï¼Œå³ä½¿ä½ å¯èƒ½ä¸å¤ªæ‡‚å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠ AspectJ å’Œ Spring AOP åšä¸ªç®€å•çš„å¯¹æ¯”ï¼š Spring AOPï¼š å®ƒåŸºäºåŠ¨æ€ä»£ç†æ¥å®ç°ã€‚é»˜è®¤åœ°ï¼Œå¦‚æœä½¿ç”¨æ¥å£çš„ï¼Œç”¨ JDK æä¾›çš„åŠ¨æ€ä»£ç†å®ç°ï¼Œå¦‚æœæ²¡æœ‰æ¥å£ï¼Œä½¿ç”¨ CGLIB å®ç°ã€‚å¤§å®¶ä¸€å®šè¦æ˜ç™½èƒŒåçš„æ„æ€ï¼ŒåŒ…æ‹¬ä»€ä¹ˆæ—¶å€™ä¼šä¸ç”¨ JDK æä¾›çš„åŠ¨æ€ä»£ç†ï¼Œè€Œç”¨ CGLIB å®ç°ã€‚ Spring 3.2 ä»¥åï¼Œspring-core ç›´æ¥å°±æŠŠ CGLIB å’Œ ASM çš„æºç åŒ…æ‹¬è¿›æ¥äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼å¼•å…¥è¿™ä¸¤ä¸ªä¾èµ– Spring çš„ IOC å®¹å™¨å’Œ AOP éƒ½å¾ˆé‡è¦ï¼ŒSpring AOP éœ€è¦ä¾èµ–äº IOC å®¹å™¨æ¥ç®¡ç†ã€‚ å¦‚æœä½ æ˜¯ web å¼€å‘è€…ï¼Œæœ‰äº›æ—¶å€™ï¼Œä½ å¯èƒ½éœ€è¦çš„æ˜¯ä¸€ä¸ª Filter æˆ–ä¸€ä¸ª Interceptorï¼Œè€Œä¸ä¸€å®šæ˜¯ AOPã€‚ Spring AOP åªèƒ½ä½œç”¨äº Spring å®¹å™¨ä¸­çš„ Beanï¼Œå®ƒæ˜¯ä½¿ç”¨çº¯ç²¹çš„ Java ä»£ç å®ç°çš„ï¼Œåªèƒ½ä½œç”¨äº bean çš„æ–¹æ³•ã€‚ Spring æä¾›äº† AspectJ çš„æ”¯æŒï¼Œåé¢æˆ‘ä»¬ä¼šå•ç‹¬ä»‹ç»æ€ä¹ˆä½¿ç”¨ï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬ç”¨çº¯çš„ Spring AOP å°±å¤Ÿäº†ã€‚ å¾ˆå¤šäººä¼šå¯¹æ¯” Spring AOP å’Œ AspectJ çš„æ€§èƒ½ï¼ŒSpring AOP æ˜¯åŸºäºä»£ç†å®ç°çš„ï¼Œåœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™éœ€è¦ç”Ÿæˆä»£ç†å®ä¾‹ï¼Œåœ¨æ–¹æ³•è°ƒç”¨ä¸Šä¹Ÿä¼šå¢åŠ æ ˆçš„æ·±åº¦ï¼Œä½¿å¾— Spring AOP çš„æ€§èƒ½ä¸å¦‚ AspectJ é‚£ä¹ˆå¥½ã€‚ AspectJï¼š AspectJ å‡ºèº«ä¹Ÿæ˜¯åé—¨ï¼Œæ¥è‡ªäº Eclipse åŸºé‡‘ä¼šï¼Œlinkï¼šhttps://www.eclipse.org/aspectj å±äºé™æ€ç»‡å…¥ï¼Œå®ƒæ˜¯é€šè¿‡ä¿®æ”¹ä»£ç æ¥å®ç°çš„ï¼Œå®ƒçš„ç»‡å…¥æ—¶æœºå¯ä»¥æ˜¯ï¼š Compile-time weavingï¼šç¼–è¯‘æœŸç»‡å…¥ï¼Œå¦‚ç±» A ä½¿ç”¨ AspectJ æ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œç±» B å¼•ç”¨äº†å®ƒï¼Œè¿™ä¸ªåœºæ™¯å°±éœ€è¦ç¼–è¯‘æœŸçš„æ—¶å€™å°±è¿›è¡Œç»‡å…¥ï¼Œå¦åˆ™æ²¡æ³•ç¼–è¯‘ç±» Bã€‚ Post-compile weavingï¼šä¹Ÿå°±æ˜¯å·²ç»ç”Ÿæˆäº† .class æ–‡ä»¶ï¼Œæˆ–å·²ç»æ‰“æˆ jar åŒ…äº†ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬éœ€è¦å¢å¼ºå¤„ç†çš„è¯ï¼Œå°±è¦ç”¨åˆ°ç¼–è¯‘åç»‡å…¥ã€‚ Load-time weavingï¼šæŒ‡çš„æ˜¯åœ¨åŠ è½½ç±»çš„æ—¶å€™è¿›è¡Œç»‡å…¥ï¼Œè¦å®ç°è¿™ä¸ªæ—¶æœŸçš„ç»‡å…¥ï¼Œæœ‰å‡ ç§å¸¸è§çš„æ–¹æ³•ã€‚1ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å¹²è¿™ä¸ªï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„åŠæ³•ï¼Œåœ¨è¢«ç»‡å…¥ç±»åŠ è½½åˆ° JVM å‰å»å¯¹å®ƒè¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åŠ è½½çš„æ—¶å€™å®šä¹‰è¡Œä¸ºäº†ã€‚2ã€åœ¨ JVM å¯åŠ¨çš„æ—¶å€™æŒ‡å®š AspectJ æä¾›çš„ agentï¼š-javaagent:xxx/xxx/aspectjweaver.jarã€‚ AspectJ èƒ½å¹²å¾ˆå¤š Spring AOP å¹²ä¸äº†çš„äº‹æƒ…ï¼Œå®ƒæ˜¯ AOP ç¼–ç¨‹çš„å®Œå…¨è§£å†³æ–¹æ¡ˆã€‚Spring AOP è‡´åŠ›äºè§£å†³çš„æ˜¯ä¼ä¸šçº§å¼€å‘ä¸­æœ€æ™®éçš„ AOP éœ€æ±‚ï¼ˆæ–¹æ³•ç»‡å…¥ï¼‰ï¼Œè€Œä¸æ˜¯åŠ›æ±‚æˆä¸ºä¸€ä¸ªåƒ AspectJ ä¸€æ ·çš„ AOP ç¼–ç¨‹å®Œå…¨è§£å†³æ–¹æ¡ˆã€‚ å› ä¸º AspectJ åœ¨å®é™…ä»£ç è¿è¡Œå‰å®Œæˆäº†ç»‡å…¥ï¼Œæ‰€ä»¥å¤§å®¶ä¼šè¯´å®ƒç”Ÿæˆçš„ç±»æ˜¯æ²¡æœ‰é¢å¤–è¿è¡Œæ—¶å¼€é”€çš„ã€‚ å¾ˆå¿«æˆ‘ä¼šä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« ä»‹ç» AspectJ çš„ä½¿ç”¨ï¼Œä»¥åŠæ€ä¹ˆåœ¨ Spring åº”ç”¨ä¸­ä½¿ç”¨ AspectJã€‚ å·²æˆæ–‡ï¼š https://www.enjoyican.com/posts/spring-aop-aspectj/ AOP æœ¯è¯­è§£é‡Šåœ¨è¿™é‡Œï¼Œä¸å‡†å¤‡è§£é‡Šé‚£ä¹ˆå¤š AOP ç¼–ç¨‹ä¸­çš„æœ¯è¯­äº†ï¼Œæˆ‘ä»¬ç¢°åˆ°ä¸€ä¸ªè¯´ä¸€ä¸ªå§ã€‚ Adviceã€Advisorã€Pointcutã€Aspectã€Joinpoint ç­‰ç­‰ã€‚ Spring AOPé¦–å…ˆè¦è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œä»‹ç»çš„ Spring AOP æ˜¯çº¯çš„ Spring ä»£ç ï¼Œå’Œ AspectJ æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä½†æ˜¯ Spring å»¶ç”¨äº† AspectJ ä¸­çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä½¿ç”¨äº† AspectJ æä¾›çš„ jar åŒ…ä¸­çš„æ³¨è§£ï¼Œä½†æ˜¯ä¸ä¾èµ–äºå…¶å®ç°åŠŸèƒ½ã€‚ åé¢ä»‹ç»çš„å¦‚ @Aspectã€@Pointcutã€@Beforeã€@After ç­‰æ³¨è§£éƒ½æ˜¯æ¥è‡ªäº AspectJï¼Œä½†æ˜¯åŠŸèƒ½çš„å®ç°æ˜¯çº¯ Spring AOP è‡ªå·±å®ç°çš„ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç» Spring AOP çš„ä½¿ç”¨æ–¹æ³•ï¼Œå…ˆä»æœ€ç®€å•çš„é…ç½®æ–¹å¼å¼€å§‹è¯´èµ·ï¼Œè¿™æ ·è¯»è€…æƒ³çœ‹æºç ä¹Ÿä¼šæ¯”è¾ƒå®¹æ˜“ã€‚ ç›®å‰ Spring AOP ä¸€å…±æœ‰ä¸‰ç§é…ç½®æ–¹å¼ï¼ŒSpring åšåˆ°äº†å¾ˆå¥½åœ°å‘ä¸‹å…¼å®¹ï¼Œæ‰€ä»¥å¤§å®¶å¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚ Spring 1.2 åŸºäºæ¥å£çš„é…ç½®ï¼šæœ€æ—©çš„ Spring AOP æ˜¯å®Œå…¨åŸºäºå‡ ä¸ªæ¥å£çš„ï¼Œæƒ³çœ‹æºç çš„åŒå­¦å¯ä»¥ä»è¿™é‡Œèµ·æ­¥ã€‚ Spring 2.0 schema-based é…ç½®ï¼šSpring 2.0 ä»¥åä½¿ç”¨ XML çš„æ–¹å¼æ¥é…ç½®ï¼Œä½¿ç”¨ å‘½åç©ºé—´ &lt;aop /&gt; Spring 2.0 @AspectJ é…ç½®ï¼šä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®ï¼Œè¿™ç§æ–¹å¼æ„Ÿè§‰æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œè¿˜æœ‰ï¼Œè¿™é‡Œè™½ç„¶å«åš @AspectJï¼Œä½†æ˜¯è¿™ä¸ªå’Œ AspectJ å…¶å®æ²¡å•¥å…³ç³»ã€‚ Spring 1.2 ä¸­çš„é…ç½®è¿™èŠ‚æˆ‘ä»¬å°†ä»‹ç» Spring 1.2 ä¸­çš„é…ç½®ï¼Œè¿™æ˜¯æœ€å¤è€çš„é…ç½®ï¼Œä½†æ˜¯ç”±äº Spring æä¾›äº†å¾ˆå¥½çš„å‘åå…¼å®¹ï¼Œä»¥åŠå¾ˆå¤šäººæ ¹æœ¬ä¸çŸ¥é“ä»€ä¹ˆé…ç½®æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„ï¼Œä»¥åŠæ˜¯å¦æœ‰æ›´æ–°æ›´å¥½çš„é…ç½®æ–¹æ³•æ›¿ä»£ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤šä»£ç æ˜¯é‡‡ç”¨è¿™ç§å¤è€çš„é…ç½®æ–¹å¼çš„ï¼Œè¿™é‡Œè¯´çš„å¤è€å¹¶æ²¡æœ‰è´¬ä¹‰çš„æ„æ€ã€‚ ä¸‹é¢ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥æ¼”ç¤ºæ€ä¹ˆä½¿ç”¨ Spring 1.2 çš„é…ç½®æ–¹å¼ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸¤ä¸ªæ¥å£ UserService å’Œ OrderServiceï¼Œä»¥åŠå®ƒä»¬çš„å®ç°ç±» UserServiceImpl å’Œ OrderServiceImplï¼š ç¤ºä¾‹ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ª adviceï¼Œåˆ†åˆ«ç”¨äºæ‹¦æˆªæ–¹æ³•æ‰§è¡Œå‰å’Œæ–¹æ³•è¿”å›åï¼š advice æ˜¯æˆ‘ä»¬æ¥è§¦çš„ç¬¬ä¸€ä¸ªæ¦‚å¿µï¼Œè®°ä½å®ƒæ˜¯å¹²ä»€ä¹ˆç”¨çš„ã€‚ advice ä¸Šé¢çš„ä¸¤ä¸ª Advice åˆ†åˆ«ç”¨äºæ–¹æ³•è°ƒç”¨å‰è¾“å‡ºå‚æ•°å’Œæ–¹æ³•è°ƒç”¨åè¾“å‡ºç»“æœã€‚ ç°åœ¨å¯ä»¥å¼€å§‹é…ç½®äº†ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸ªåä¸º spring_1_2.xml çš„æ–‡ä»¶ï¼š é…ç½® æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è·‘èµ·æ¥çœ‹çœ‹ï¼š 6 æŸ¥çœ‹è¾“å‡ºç»“æœï¼š 1234å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createUser, å‚æ•°åˆ—è¡¨ï¼š[Tom, Cruise, 55]æ–¹æ³•è¿”å›ï¼šUser&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125;å‡†å¤‡æ‰§è¡Œæ–¹æ³•: queryUser, å‚æ•°åˆ—è¡¨ï¼š[]æ–¹æ³•è¿”å›ï¼šUser&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125; ä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå¯¹ UserService ä¸­çš„ä¸¤ä¸ªæ–¹æ³•éƒ½åšäº†å‰ã€åæ‹¦æˆªã€‚è¿™ä¸ªä¾‹å­ç†è§£èµ·æ¥åº”è¯¥éå¸¸ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªä»£ç†å®ç°ã€‚ ä»£ç†æ¨¡å¼éœ€è¦ä¸€ä¸ªæ¥å£ã€ä¸€ä¸ªå…·ä½“å®ç°ç±»ï¼Œç„¶åå°±æ˜¯å®šä¹‰ä¸€ä¸ªä»£ç†ç±»ï¼Œç”¨æ¥åŒ…è£…å®ç°ç±»ï¼Œæ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ç”¨ä»£ç†ç±»æ¥ç”Ÿæˆå®ä¾‹ã€‚ æ­¤ä¸­æ–¹æ³•æœ‰ä¸ªè‡´å‘½çš„é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æ‹¦æˆª OrderService ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª OrderService çš„ä»£ç†ã€‚å¦‚æœè¿˜è¦æ‹¦æˆª PostServiceï¼Œå¾—å®šä¹‰ä¸€ä¸ª PostService çš„ä»£ç†â€¦â€¦ è€Œä¸”ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„æ‹¦æˆªå™¨çš„ç²’åº¦åªæ§åˆ¶åˆ°äº†ç±»çº§åˆ«ï¼Œç±»ä¸­æ‰€æœ‰çš„æ–¹æ³•éƒ½è¿›è¡Œäº†æ‹¦æˆªã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ ·åªæ‹¦æˆªç‰¹å®šçš„æ–¹æ³•ã€‚ åœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼Œé…ç½®æ‹¦æˆªå™¨çš„æ—¶å€™ï¼ŒinterceptorNames é™¤äº†æŒ‡å®šä¸º Adviceï¼Œæ˜¯è¿˜å¯ä»¥æŒ‡å®šä¸º Interceptor å’Œ Advisor çš„ã€‚ è¿™é‡Œæˆ‘ä»¬æ¥ç†è§£ Advisor çš„æ¦‚å¿µï¼Œå®ƒä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå®ƒå†…éƒ¨éœ€è¦æŒ‡å®šä¸€ä¸ª Adviceï¼ŒAdvisor å†³å®šè¯¥æ‹¦æˆªå“ªäº›æ–¹æ³•ï¼Œæ‹¦æˆªåéœ€è¦å®Œæˆçš„å·¥ä½œè¿˜æ˜¯å†…éƒ¨çš„ Advice æ¥åšã€‚ å®ƒæœ‰å¥½å‡ ä¸ªå®ç°ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å®ç°ç±» NameMatchMethodPointcutAdvisor æ¥æ¼”ç¤ºï¼Œä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒéœ€è¦æˆ‘ä»¬ç»™å®ƒæä¾›æ–¹æ³•åå­—ï¼Œè¿™æ ·ç¬¦åˆè¯¥é…ç½®çš„æ–¹æ³•æ‰ä¼šåšæ‹¦æˆªã€‚ é…ç½® æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒuserServiceProxy è¿™ä¸ª bean é…ç½®äº†ä¸€ä¸ª advisorï¼Œadvisor å†…éƒ¨æœ‰ä¸€ä¸ª adviceã€‚advisor è´Ÿè´£åŒ¹é…æ–¹æ³•ï¼Œå†…éƒ¨çš„ advice è´Ÿè´£å®ç°æ–¹æ³•åŒ…è£…ã€‚ æ³¨æ„ï¼Œè¿™é‡Œçš„ mappedNames é…ç½®æ˜¯å¯ä»¥æŒ‡å®šå¤šä¸ªçš„ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¯ä»¥æ˜¯ä¸åŒç±»ä¸­çš„æ–¹æ³•ã€‚ç›¸æ¯”ç›´æ¥æŒ‡å®š adviceï¼Œadvisor å®ç°äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå› ä¸ºåœ¨è¿™é‡Œé…ç½® advice çš„è¯ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«æ‹¦æˆªã€‚ æµ‹è¯• è¾“å‡ºç»“æœå¦‚ä¸‹ï¼Œåªæœ‰ createUser æ–¹æ³•è¢«æ‹¦æˆªï¼š 1å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createUser, å‚æ•°åˆ—è¡¨ï¼š[Tom, Cruise, 55] åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† Advice å’Œ Advisor äº†ï¼Œå‰é¢ä¹Ÿè¯´äº†è¿˜å¯ä»¥é…ç½® Interceptorã€‚ å¯¹äº Java å¼€å‘è€…æ¥è¯´ï¼Œå¯¹ Interceptor è¿™ä¸ªæ¦‚å¿µè‚¯å®šéƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œå°±ä¸åšæ¼”ç¤ºäº†ï¼Œè´´ä¸€ä¸‹å®ç°ä»£ç ï¼š 12345678910public class DebugInterceptor implements MethodInterceptor &#123; public Object invoke(MethodInvocation invocation) throws Throwable &#123; System.out.println(\"Before: invocation=[\" + invocation + \"]\"); // æ‰§è¡Œ çœŸå®å®ç°ç±» çš„æ–¹æ³• Object rval = invocation.proceed(); System.out.println(\"Invocation returned\"); return rval; &#125;&#125; ä¸Šé¢ï¼Œæˆ‘ä»¬ä»‹ç»å®Œäº† Adviceã€Advisorã€Interceptor ä¸‰ä¸ªæ¦‚å¿µï¼Œç›¸ä¿¡å¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“å°±çœ‹æ‡‚å®ƒä»¬äº†ã€‚ å®ƒä»¬æœ‰ä¸ªå…±åŒçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬å¾—ä¸ºæ¯ä¸ª bean éƒ½é…ç½®ä¸€ä¸ªä»£ç†ï¼Œä¹‹åè·å– bean çš„æ—¶å€™éœ€è¦è·å–è¿™ä¸ªä»£ç†ç±»çš„ bean å®ä¾‹ï¼ˆå¦‚ (UserService) context.getBean(&quot;userServiceProxy&quot;)ï¼‰ï¼Œè¿™æ˜¾ç„¶éå¸¸ä¸æ–¹ä¾¿ï¼Œä¸åˆ©äºæˆ‘ä»¬ä¹‹åè¦ä½¿ç”¨çš„è‡ªåŠ¨æ ¹æ®ç±»å‹æ³¨å…¥ã€‚ä¸‹é¢ä»‹ç» autoproxy çš„è§£å†³æ–¹æ¡ˆã€‚ autoproxyï¼šä»åå­—æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯å®ç°è‡ªåŠ¨ä»£ç†ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ Spring å‘ç°ä¸€ä¸ª bean éœ€è¦è¢«åˆ‡é¢ç»‡å…¥çš„æ—¶å€™ï¼ŒSpring ä¼šè‡ªåŠ¨ç”Ÿæˆè¿™ä¸ª bean çš„ä¸€ä¸ªä»£ç†æ¥æ‹¦æˆªæ–¹æ³•çš„æ‰§è¡Œï¼Œç¡®ä¿å®šä¹‰çš„åˆ‡é¢èƒ½è¢«æ‰§è¡Œã€‚ è¿™é‡Œå¼ºè°ƒè‡ªåŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ Spring ä¼šè‡ªåŠ¨åšè¿™ä»¶äº‹ï¼Œè€Œä¸ç”¨åƒå‰é¢ä»‹ç»çš„ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°æŒ‡å®šä»£ç†ç±»çš„ beanã€‚ æˆ‘ä»¬å»æ‰åŸæ¥çš„ ProxyFactoryBean çš„é…ç½®ï¼Œæ”¹ä¸ºä½¿ç”¨ BeanNameAutoProxyCreator æ¥é…ç½®ï¼š BeanNameAutoProxyCreator é…ç½®å¾ˆç®€å•ï¼ŒbeanNames ä¸­å¯ä»¥ä½¿ç”¨æ­£åˆ™æ¥åŒ¹é… bean çš„åå­—ã€‚è¿™æ ·é…ç½®å‡ºæ¥ä»¥åï¼ŒuserServiceBeforeAdvice å’Œ userServiceAfterAdvice è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨å°±ä¸ä»…ä»…å¯ä»¥ä½œç”¨äº UserServiceImpl äº†ï¼Œä¹Ÿå¯ä»¥ä½œç”¨äº OrderServiceImplã€PostServiceImplã€ArticleServiceImplâ€¦â€¦ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å†æ˜¯é…ç½®æŸä¸ª bean çš„ä»£ç†äº†ã€‚ æ³¨æ„ï¼Œè¿™é‡Œçš„ InterceptorNames å’Œå‰é¢ä¸€æ ·ï¼Œä¹Ÿæ˜¯å¯ä»¥é…ç½®æˆ Advisor å’Œ Interceptor çš„ã€‚ ç„¶åæˆ‘ä»¬ä¿®æ”¹ä¸‹ä½¿ç”¨çš„åœ°æ–¹ï¼š æµ‹è¯• å‘ç°æ²¡æœ‰ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå®Œå…¨ä¸éœ€è¦å…³å¿ƒä»£ç†äº†ï¼Œç›´æ¥ä½¿ç”¨åŸæ¥çš„ç±»å‹å°±å¯ä»¥äº†ï¼Œè¿™æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚ è¾“å‡ºç»“æœå°±æ˜¯ OrderService å’Œ UserService ä¸­çš„æ¯ä¸ªæ–¹æ³•éƒ½å¾—åˆ°äº†æ‹¦æˆªï¼š 12345678å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createUser, å‚æ•°åˆ—è¡¨ï¼š[Tom, Cruise, 55]æ–¹æ³•è¿”å›ï¼šUser&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125;å‡†å¤‡æ‰§è¡Œæ–¹æ³•: queryUser, å‚æ•°åˆ—è¡¨ï¼š[]æ–¹æ³•è¿”å›ï¼šUser&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125;å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder, å‚æ•°åˆ—è¡¨ï¼š[Leo, éšä¾¿ä¹°ç‚¹ä»€ä¹ˆ]æ–¹æ³•è¿”å›ï¼šOrder&#123;username&#x3D;&#39;Leo&#39;, product&#x3D;&#39;éšä¾¿ä¹°ç‚¹ä»€ä¹ˆ&#39;&#125;å‡†å¤‡æ‰§è¡Œæ–¹æ³•: queryOrder, å‚æ•°åˆ—è¡¨ï¼š[Leo]æ–¹æ³•è¿”å›ï¼šOrder&#123;username&#x3D;&#39;Leo&#39;, product&#x3D;&#39;éšä¾¿ä¹°ç‚¹ä»€ä¹ˆ&#39;&#125; åˆ°è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯å‘ç° BeanNameAutoProxyCreator éå¸¸å¥½ç”¨ï¼Œå®ƒéœ€è¦æŒ‡å®šè¢«æ‹¦æˆªç±»åçš„æ¨¡å¼(å¦‚ *ServiceImpl)ï¼Œå®ƒå¯ä»¥é…ç½®å¤šæ¬¡ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨æ¥åŒ¹é…ä¸åŒæ¨¡å¼çš„ç±»äº†ã€‚ å¦å¤–ï¼Œåœ¨ BeanNameAutoProxyCreator åŒä¸€ä¸ªåŒ…ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç±» DefaultAdvisorAutoProxyCreatorï¼Œæ¯”ä¸Šé¢çš„ BeanNameAutoProxyCreator è¿˜è¦æ–¹ä¾¿ã€‚ ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œadvisor å†…éƒ¨åŒ…è£…äº† adviceï¼Œadvisor è´Ÿè´£å†³å®šæ‹¦æˆªå“ªäº›æ–¹æ³•ï¼Œå†…éƒ¨ advice å®šä¹‰æ‹¦æˆªåçš„é€»è¾‘ã€‚æ‰€ä»¥ï¼Œä»”ç»†æƒ³æƒ³å…¶å®å°±æ˜¯åªè¦è®©æˆ‘ä»¬çš„ advisor å…¨å±€ç”Ÿæ•ˆå°±èƒ½å®ç°æˆ‘ä»¬éœ€è¦çš„è‡ªå®šä¹‰æ‹¦æˆªåŠŸèƒ½ã€æ‹¦æˆªåçš„é€»è¾‘å¤„ç†ã€‚ BeanNameAutoProxyCreator æ˜¯è‡ªå·±åŒ¹é…æ–¹æ³•ï¼Œç„¶åäº¤ç”±å†…éƒ¨é…ç½® advice æ¥æ‹¦æˆªå¤„ç†ï¼› è€Œ DefaultAdvisorAutoProxyCreator æ˜¯è®© ioc å®¹å™¨ä¸­çš„æ‰€æœ‰ advisor æ¥åŒ¹é…æ–¹æ³•ï¼Œadvisor å†…éƒ¨éƒ½æ˜¯æœ‰ advice çš„ï¼Œè®©å®ƒä»¬å†…éƒ¨çš„ advice æ¥æ‰§è¡Œæ‹¦æˆªå¤„ç†ã€‚ 1ã€æˆ‘ä»¬éœ€è¦å†å›å¤´çœ‹ä¸‹ Advisor çš„é…ç½®ï¼Œä¸Šé¢æˆ‘ä»¬ç”¨äº† NameMatchMethodPointcutAdvisor è¿™ä¸ªç±»ï¼š 1234&lt;bean id=\"logCreateAdvisor\" class=\"org.springframework.aop.support.NameMatchMethodPointcutAdvisor\"&gt; &lt;property name=\"advice\" ref=\"logArgsAdvice\" /&gt; &lt;property name=\"mappedNames\" value=\"createUser,createOrder\" /&gt;&lt;/bean&gt; å…¶å® Advisor è¿˜æœ‰ä¸€ä¸ªæ›´åŠ çµæ´»çš„å®ç°ç±» RegexpMethodPointcutAdvisorï¼Œå®ƒèƒ½å®ç°æ­£åˆ™åŒ¹é…ï¼Œå¦‚ï¼š 1234&lt;bean id=\"logArgsAdvisor\" class=\"org.springframework.aop.support.RegexpMethodPointcutAdvisor\"&gt; &lt;property name=\"advice\" ref=\"logArgsAdvice\" /&gt; &lt;property name=\"pattern\" value=\"com.javadoop.*.service.*.create.*\" /&gt;&lt;/bean&gt; ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡é…ç½® Advisorï¼Œç²¾ç¡®å®šä½åˆ°éœ€è¦è¢«æ‹¦æˆªçš„æ–¹æ³•ï¼Œç„¶åä½¿ç”¨å†…éƒ¨çš„ Advice æ‰§è¡Œé€»è¾‘å¤„ç†ã€‚ 2ã€ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦é…ç½® DefaultAdvisorAutoProxyCreatorï¼Œå®ƒçš„é…ç½®éå¸¸ç®€å•ï¼Œç›´æ¥ä½¿ç”¨ä¸‹é¢è¿™æ®µé…ç½®å°±å¯ä»¥äº†ï¼Œå®ƒå°±ä¼šä½¿å¾—æ‰€æœ‰çš„ Advisor è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— é¡»å…¶ä»–é…ç½®ã€‚ 1&lt;bean class=\"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator\" /&gt; DefaultAdvisorAutoProxyCreator ç„¶åæˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼š æµ‹è¯• è¾“å‡ºï¼š 1234å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createUser, å‚æ•°åˆ—è¡¨ï¼š[Tom, Cruise, 55]æ–¹æ³•è¿”å›ï¼šUser&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125;å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder, å‚æ•°åˆ—è¡¨ï¼š[Leo, éšä¾¿ä¹°ç‚¹ä»€ä¹ˆ]æ–¹æ³•è¿”å›ï¼šOrder&#123;username&#x3D;&#39;Leo&#39;, product&#x3D;&#39;éšä¾¿ä¹°ç‚¹ä»€ä¹ˆ&#39;&#125; ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œcreate* æ–¹æ³•ä½¿ç”¨äº† logArgsAdvisor è¿›è¡Œä¼ å‚è¾“å‡ºï¼Œquery* æ–¹æ³•ä½¿ç”¨äº† logResultAdvisor è¿›è¡Œäº†è¿”å›ç»“æœè¾“å‡ºã€‚ åˆ°è¿™é‡Œï¼ŒSpring 1.2 çš„é…ç½®å°±è¦ä»‹ç»å®Œäº†ã€‚æœ¬æ–‡ä¸ä¼šä»‹ç»å¾—é¢é¢ä¿±åˆ°ï¼Œä¸»è¦æ˜¯å…³æ³¨æœ€æ ¸å¿ƒçš„é…ç½®ï¼Œå¦‚æœè¯»è€…æ„Ÿå…´è¶£ï¼Œè¦å­¦ä¼šè‡ªå·±å»æ‘¸ç´¢ï¼Œæ¯”å¦‚è¿™é‡Œçš„ Advisor å°±ä¸åªæœ‰æˆ‘è¿™é‡Œä»‹ç»çš„ NameMatchMethodPointcutAdvisor å’Œ RegexpMethodPointcutAdvisorï¼ŒAutoProxyCreator ä¹Ÿä¸ä»…ä»…æ˜¯ BeanNameAutoProxyCreator å’Œ DefaultAdvisorAutoProxyCreatorã€‚ è¯»åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³å¯¹äºå¾ˆå¤šäººæ¥è¯´ï¼Œå°±çŸ¥é“æ€ä¹ˆå»é˜…è¯» Spring AOP æºç äº†ã€‚ Spring 2.0 @AspectJ é…ç½®Spring 2.0 ä»¥åï¼Œå¼•å…¥äº† @AspectJ å’Œ Schema-based çš„ä¸¤ç§é…ç½®æ–¹å¼ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç» @AspectJ çš„é…ç½®æ–¹å¼ï¼Œä¹‹åæˆ‘ä»¬å†æ¥çœ‹ä½¿ç”¨ xml çš„é…ç½®æ–¹å¼ã€‚ æ³¨æ„äº†ï¼Œ@AspectJ å’Œ AspectJ æ²¡å¤šå¤§å…³ç³»ï¼Œå¹¶ä¸æ˜¯è¯´åŸºäº AspectJ å®ç°çš„ï¼Œè€Œä»…ä»…æ˜¯ä½¿ç”¨äº† AspectJ ä¸­çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æ³¨è§£ä¹Ÿæ˜¯ç›´æ¥æ¥è‡ªäº AspectJ çš„åŒ…ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¾èµ– aspectjweaver.jar è¿™ä¸ªåŒ…ï¼Œè¿™ä¸ªåŒ…æ¥è‡ªäº AspectJï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;version&gt;1.8.11&lt;/version&gt;&lt;/dependency&gt; å¦‚æœæ˜¯ä½¿ç”¨ Spring Boot çš„è¯ï¼Œæ·»åŠ ä»¥ä¸‹ä¾èµ–å³å¯ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;&lt;/dependency&gt; åœ¨ @AspectJ çš„é…ç½®æ–¹å¼ä¸­ï¼Œä¹‹æ‰€ä»¥è¦å¼•å…¥ aspectjweaver å¹¶ä¸æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ä½¿ç”¨ AspectJ çš„å¤„ç†åŠŸèƒ½ï¼Œè€Œæ˜¯å› ä¸º Spring ä½¿ç”¨äº† AspectJ æä¾›çš„ä¸€äº›æ³¨è§£ï¼Œå®é™…ä¸Šè¿˜æ˜¯çº¯çš„ Spring AOP ä»£ç ã€‚ è¯´äº†è¿™ä¹ˆå¤šï¼Œæ˜ç¡®ä¸€ç‚¹ï¼Œ@AspectJ é‡‡ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®ä½¿ç”¨ Spring AOPã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯ @AspectJ çš„æ³¨è§£é…ç½®æ–¹å¼ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š 1ã€åœ¨ xml ä¸­é…ç½®ï¼š 1&lt;aop:aspectj-autoproxy/&gt; ä½¿ç”¨ @EnableAspectJAutoProxy 12345@Configuration@EnableAspectJAutoProxypublic class AppConfig &#123;&#125; ä¸€æ—¦å¼€å¯äº†ä¸Šé¢çš„é…ç½®ï¼Œé‚£ä¹ˆæ‰€æœ‰ä½¿ç”¨ @Aspect æ³¨è§£çš„ bean éƒ½ä¼šè¢« Spring å½“åšç”¨æ¥å®ç° AOP çš„é…ç½®ç±»ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€ä¸ª Aspectã€‚ æ³¨æ„äº†ï¼Œ@Aspect æ³¨è§£è¦ä½œç”¨åœ¨ bean ä¸Šé¢ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨ @Component ç­‰æ³¨è§£æ–¹å¼ï¼Œè¿˜æ˜¯åœ¨ xml ä¸­é…ç½® beanï¼Œé¦–å…ˆå®ƒéœ€è¦æ˜¯ä¸€ä¸ª beanã€‚ æ¯”å¦‚ä¸‹é¢è¿™ä¸ª beanï¼Œå®ƒçš„ç±»åä¸Šä½¿ç”¨äº† @Aspectï¼Œå®ƒå°±ä¼šè¢«å½“åš Spring AOP çš„é…ç½®ã€‚ 123&lt;bean id=\"myAspect\" class=\"org.xyz.NotVeryUsefulAspect\"&gt; &lt;!-- configure properties of aspect here as normal --&gt;&lt;/bean&gt; 1234567package org.xyz;import org.aspectj.lang.annotation.Aspect;@Aspectpublic class NotVeryUsefulAspect &#123;&#125; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å…³å¿ƒçš„æ˜¯ @Aspect æ³¨è§£çš„ bean ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®å“ªäº›å†…å®¹ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Pointcutï¼ŒPointcut åœ¨å¤§éƒ¨åˆ†åœ°æ–¹è¢«ç¿»è¯‘æˆåˆ‡ç‚¹ï¼Œç”¨äºå®šä¹‰å“ªäº›æ–¹æ³•éœ€è¦è¢«å¢å¼ºæˆ–è€…è¯´éœ€è¦è¢«æ‹¦æˆªï¼Œæœ‰ç‚¹ç±»ä¼¼äºä¹‹å‰ä»‹ç»çš„ Advisor çš„æ–¹æ³•åŒ¹é…ã€‚ Spring AOP åªæ”¯æŒ bean ä¸­çš„æ–¹æ³•ï¼ˆä¸åƒ AspectJ é‚£ä¹ˆå¼ºå¤§ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸º Pointcut å°±æ˜¯ç”¨æ¥åŒ¹é… Spring å®¹å™¨ä¸­çš„æ‰€æœ‰ bean çš„æ–¹æ³•çš„ã€‚ 12@Pointcut(\"execution(* transfer(..))\")// the pointcut expressionprivate void anyOldTransfer() &#123;&#125;// the pointcut signature æˆ‘ä»¬çœ‹åˆ°ï¼Œ@Pointcut ä¸­ä½¿ç”¨äº† execution æ¥æ­£åˆ™åŒ¹é…æ–¹æ³•ç­¾åï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ï¼Œé™¤äº† executionï¼Œæˆ‘ä»¬å†çœ‹çœ‹å…¶ä»–çš„å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„åŒ¹é…æ–¹å¼ï¼š withinï¼šæŒ‡å®šæ‰€åœ¨ç±»æˆ–æ‰€åœ¨åŒ…ä¸‹é¢çš„æ–¹æ³•ï¼ˆSpring AOP ç‹¬æœ‰ï¼‰ å¦‚ @Pointcut(â€œwithin(com.javadoop.springaoplearning.service..*)â€) @annotationï¼šæ–¹æ³•ä¸Šå…·æœ‰ç‰¹å®šçš„æ³¨è§£ï¼Œå¦‚ @Subscribe ç”¨äºè®¢é˜…ç‰¹å®šçš„äº‹ä»¶ã€‚ å¦‚ @Pointcut(â€œexecution(* .(..)) &amp;&amp; @annotation(com.javadoop.annotation.Subscribe)â€) bean(idOrNameOfBean)ï¼šåŒ¹é… bean çš„åå­—ï¼ˆSpring AOP ç‹¬æœ‰ï¼‰ å¦‚ @Pointcut(â€œbean(*Service)â€) Tipsï¼šä¸Šé¢åŒ¹é…ä¸­ï¼Œé€šå¸¸ â€œ.â€ ä»£è¡¨ä¸€ä¸ªåŒ…åï¼Œâ€..â€ ä»£è¡¨åŒ…åŠå…¶å­åŒ…ï¼Œæ–¹æ³•å‚æ•°ä»»æ„åŒ¹é…ä½¿ç”¨ä¸¤ä¸ªç‚¹ â€œ..â€ã€‚ å¯¹äº web å¼€å‘è€…ï¼ŒSpring æœ‰ä¸ªå¾ˆå¥½çš„å»ºè®®ï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ª SystemArchitectureï¼š 1234567891011121314151617181920212223@Aspectpublic class SystemArchitecture &#123; // web å±‚ @Pointcut(\"within(com.javadoop.web..*)\") public void inWebLayer() &#123;&#125; // service å±‚ @Pointcut(\"within(com.javadoop.service..*)\") public void inServiceLayer() &#123;&#125; // dao å±‚ @Pointcut(\"within(com.javadoop.dao..*)\") public void inDataAccessLayer() &#123;&#125; // service å®ç°ï¼Œæ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯æ–¹æ³•å®ç°ï¼Œå…¶å®é€šå¸¸ä¹Ÿå¯ä»¥ä½¿ç”¨ bean(*ServiceImpl) @Pointcut(\"execution(* com.javadoop..service.*.*(..))\") public void businessService() &#123;&#125; // dao å®ç° @Pointcut(\"execution(* com.javadoop.dao.*.*(..))\") public void dataAccessOperation() &#123;&#125;&#125; ä¸Šé¢è¿™ä¸ª SystemArchitecture å¾ˆå¥½ç†è§£ï¼Œè¯¥ Aspect å®šä¹‰äº†ä¸€å †çš„ Pointcutï¼Œéšååœ¨ä»»ä½•éœ€è¦ Pointcut çš„åœ°æ–¹éƒ½å¯ä»¥ç›´æ¥å¼•ç”¨ï¼ˆå¦‚ xml ä¸­çš„ pointcut-ref=â€â€ï¼‰ã€‚ é…ç½® pointcut å°±æ˜¯é…ç½®æˆ‘ä»¬éœ€è¦æ‹¦æˆªå“ªäº›æ–¹æ³•ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦é…ç½®éœ€è¦å¯¹è¿™äº›è¢«æ‹¦æˆªçš„æ–¹æ³•åšä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯å‰é¢ä»‹ç»çš„ Adviceã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦é…ç½® Adviceã€‚ ä¸‹é¢è¿™å—ä»£ç ç¤ºä¾‹äº†å„ç§å¸¸ç”¨çš„æƒ…å†µï¼š æ³¨æ„ï¼Œå®é™…å†™ä»£ç çš„æ—¶å€™ï¼Œä¸è¦æŠŠæ‰€æœ‰çš„åˆ‡é¢éƒ½æ‰åœ¨ä¸€ä¸ª class ä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960@Aspectpublic class AdviceExample &#123; // è¿™é‡Œä¼šç”¨åˆ°æˆ‘ä»¬å‰é¢è¯´çš„ SystemArchitecture // ä¸‹é¢æ–¹æ³•å°±æ˜¯å†™æ‹¦æˆª \"daoå±‚å®ç°\" @Before(\"com.javadoop.aop.SystemArchitecture.dataAccessOperation()\") public void doAccessCheck() &#123; // ... å®ç°ä»£ç  &#125; // å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥\"å†…è”\"Pointcutï¼Œç›´æ¥åœ¨è¿™é‡Œå®šä¹‰ Pointcut // æŠŠ Advice å’Œ Pointcut åˆåœ¨ä¸€èµ·äº†ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ¦‚å¿µæˆ‘ä»¬è¿˜æ˜¯è¦åŒºåˆ†æ¸…æ¥šçš„ @Before(\"execution(* com.javadoop.dao.*.*(..))\") public void doAccessCheck() &#123; // ... å®ç°ä»£ç  &#125; @AfterReturning(\"com.javadoop.aop.SystemArchitecture.dataAccessOperation()\") public void doAccessCheck() &#123; // ... &#125; @AfterReturning( pointcut=\"com.javadoop.aop.SystemArchitecture.dataAccessOperation()\", returning=\"retVal\") public void doAccessCheck(Object retVal) &#123; // è¿™æ ·ï¼Œè¿›æ¥è¿™ä¸ªæ–¹æ³•çš„å¤„ç†æ—¶å€™ï¼ŒretVal å°±æ˜¯ç›¸åº”æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿ // ... å®ç°ä»£ç  &#125; // å¼‚å¸¸è¿”å› @AfterThrowing(\"com.javadoop.aop.SystemArchitecture.dataAccessOperation()\") public void doRecoveryActions() &#123; // ... å®ç°ä»£ç  &#125; @AfterThrowing( pointcut=\"com.javadoop.aop.SystemArchitecture.dataAccessOperation()\", throwing=\"ex\") public void doRecoveryActions(DataAccessException ex) &#123; // ... å®ç°ä»£ç  &#125; // æ³¨æ„ç†è§£å®ƒå’Œ @AfterReturning ä¹‹é—´çš„åŒºåˆ«ï¼Œè¿™é‡Œä¼šæ‹¦æˆªæ­£å¸¸è¿”å›å’Œå¼‚å¸¸çš„æƒ…å†µ @After(\"com.javadoop.aop.SystemArchitecture.dataAccessOperation()\") public void doReleaseLock() &#123; // é€šå¸¸å°±åƒ finally å—ä¸€æ ·ä½¿ç”¨ï¼Œç”¨æ¥é‡Šæ”¾èµ„æºã€‚ // æ— è®ºæ­£å¸¸è¿”å›è¿˜æ˜¯å¼‚å¸¸é€€å‡ºï¼Œéƒ½ä¼šè¢«æ‹¦æˆªåˆ° &#125; // æ„Ÿè§‰è¿™ä¸ªå¾ˆæœ‰ç”¨å§ï¼Œæ—¢èƒ½åš @Before çš„äº‹æƒ…ï¼Œä¹Ÿå¯ä»¥åš @AfterReturning çš„äº‹æƒ… @Around(\"com.javadoop.aop.SystemArchitecture.businessService()\") public Object doBasicProfiling(ProceedingJoinPoint pjp) throws Throwable &#123; // start stopwatch Object retVal = pjp.proceed(); // stop stopwatch return retVal; &#125;&#125; ç»†å¿ƒçš„è¯»è€…å¯èƒ½å‘ç°äº†æœ‰äº› Advice ç¼ºå°‘æ–¹æ³•ä¼ å‚ï¼Œå¦‚åœ¨ @Before åœºæ™¯ä¸­å‚æ•°å¾€å¾€æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦ç”¨æ—¥å¿—è®°å½•ä¸‹æ¥è¢«æ‹¦æˆªæ–¹æ³•çš„å…¥å‚æƒ…å†µã€‚ Spring æä¾›äº†éå¸¸ç®€å•çš„è·å–å…¥å‚çš„æ–¹æ³•ï¼Œä½¿ç”¨ org.aspectj.lang.JoinPoint ä½œä¸º Advice çš„ç¬¬ä¸€ä¸ªå‚æ•°å³å¯ï¼Œå¦‚ï¼š 1234@Before(\"com.javadoop.springaoplearning.aop_spring_2_aspectj.SystemArchitecture.businessService()\")public void logArgs(JoinPoint joinPoint) &#123; System.out.println(\"æ–¹æ³•æ‰§è¡Œå‰ï¼Œæ‰“å°å…¥å‚ï¼š\" + Arrays.toString(joinPoint.getArgs()));&#125; æ³¨æ„ï¼šç¬¬ä¸€ï¼Œå¿…é¡»æ”¾ç½®åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸Šï¼›ç¬¬äºŒï¼Œå¦‚æœæ˜¯ @Aroundï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨å…¶å­ç±» ProceedingJoinPointï¼Œå› ä¸ºå®ƒæœ‰ procceed()/procceed(args[]) æ–¹æ³•ã€‚ åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä»‹ç»å®Œäº† @AspectJ é…ç½®æ–¹å¼ä¸­çš„ Pointcut å’Œ Advice çš„é…ç½®ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œå…¶å®æœ€é‡è¦çš„å°±æ˜¯è¿™ä¸¤ä¸ªäº†ï¼Œå®šä¹‰ Pointcut å’Œä½¿ç”¨åˆé€‚çš„ Advice åœ¨å„ä¸ª Pointcut ä¸Šã€‚ ä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸€èŠ‚ä»‹ç»çš„ @AspectJ æ¥å®ç°ä¸Šä¸€èŠ‚å®ç°çš„è®°å½•æ–¹æ³•ä¼ å‚å’Œè®°å½•æ–¹æ³•è¿”å›å€¼ã€‚ ç¤ºä¾‹ xml çš„é…ç½®éå¸¸ç®€å•ï¼š é…ç½® è¿™é‡Œæ˜¯ç¤ºä¾‹ï¼Œæ‰€ä»¥ bean çš„é…ç½®è¿˜æ˜¯ä½¿ç”¨äº† xml çš„é…ç½®æ–¹å¼ã€‚ æµ‹è¯•ä¸€ä¸‹ï¼š æµ‹è¯• è¾“å‡ºç»“æœï¼š 1234æ–¹æ³•æ‰§è¡Œå‰ï¼Œæ‰“å°å…¥å‚ï¼š[Tom, Cruise, 55]User&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125;æ–¹æ³•æ‰§è¡Œå‰ï¼Œæ‰“å°å…¥å‚ï¼š[]User&#123;firstName&#x3D;&#39;Tom&#39;, lastName&#x3D;&#39;Cruise&#39;, age&#x3D;55, address&#x3D;&#39;null&#39;&#125; JoinPoint é™¤äº† getArgs() å¤–è¿˜æœ‰ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ï¼Œå¤§å®¶å¯ä»¥è¿›å»ç¨å¾®çœ‹ä¸€çœ¼ã€‚ æœ€åæä¸€ç‚¹ï¼Œ@Aspect ä¸­çš„é…ç½®ä¸ä¼šä½œç”¨äºä½¿ç”¨ @Aspect æ³¨è§£çš„ beanã€‚ Spring 2.0 schema-based é…ç½®æœ¬èŠ‚å°†ä»‹ç»çš„æ˜¯ Spring 2.0 ä»¥åæä¾›çš„åŸºäº &lt;aop /&gt; å‘½åç©ºé—´çš„ XML é…ç½®ã€‚è¿™é‡Œè¯´çš„ schema-based å°±æ˜¯æŒ‡åŸºäº aop è¿™ä¸ª schemaã€‚ ä»‹ç» IOC çš„æ—¶å€™ä¹Ÿä»‹ç»è¿‡ Spring æ˜¯æ€ä¹ˆè§£æå„ä¸ªå‘½åç©ºé—´çš„ï¼ˆå„ç§ *NamespaceHandlerï¼‰ï¼Œè§£æ &lt;aop /&gt; çš„æºç åœ¨ org.springframework.aop.config.AopNamespaceHandler ä¸­ã€‚ æœ‰äº†å‰é¢çš„ @AspectJ çš„é…ç½®æ–¹å¼çš„çŸ¥è¯†ï¼Œç†è§£ xml æ–¹å¼çš„é…ç½®éå¸¸ç®€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åºŸè¯å°‘ä¸€ç‚¹äº†ã€‚ è¿™é‡Œå…ˆä»‹ç»é…ç½® Aspectï¼Œä¾¿äºåç»­ç†è§£ï¼š 123456789&lt;aop:config&gt; &lt;aop:aspect id=\"myAspect\" ref=\"aBean\"&gt; ... &lt;/aop:aspect&gt;&lt;/aop:config&gt;&lt;bean id=\"aBean\" class=\"...\"&gt; ...&lt;/bean&gt; æ‰€æœ‰çš„é…ç½®éƒ½åœ¨ &lt;aop:config&gt; ä¸‹é¢ã€‚ &lt;aop:aspect &gt; ä¸­éœ€è¦æŒ‡å®šä¸€ä¸ª beanï¼Œå’Œå‰é¢ä»‹ç»çš„ LogArgsAspect å’Œ LogResultAspect ä¸€æ ·ï¼Œæˆ‘ä»¬çŸ¥é“è¯¥ bean ä¸­æˆ‘ä»¬éœ€è¦å†™å¤„ç†ä»£ç ã€‚ ç„¶åï¼Œæˆ‘ä»¬å†™å¥½ Aspect ä»£ç åï¼Œå°†å…¶â€œç»‡å…¥â€åˆ°åˆé€‚çš„ Pointcut ä¸­ï¼Œè¿™å°±æ˜¯é¢å‘åˆ‡é¢ã€‚ ç„¶åï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Pointcutï¼Œéå¸¸ç®€å•ï¼Œå¦‚ä¸‹ï¼š 12345678910&lt;aop:config&gt; &lt;aop:pointcut id=\"businessService\" expression=\"execution(* com.javadoop.springaoplearning.service.*.*(..))\"/&gt; &lt;!--ä¹Ÿå¯ä»¥åƒä¸‹é¢è¿™æ ·--&gt; &lt;aop:pointcut id=\"businessService2\" expression=\"com.javadoop.SystemArchitecture.businessService()\"/&gt;&lt;/aop:config&gt; å°† &lt;aop:pointcut&gt; ä½œä¸º &lt;aop:config&gt; çš„ç›´æ¥å­å…ƒç´ ï¼Œå°†ä½œä¸ºå…¨å±€ Pointcutã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ &lt;aop:aspect /&gt;å†…éƒ¨é…ç½® Pointcutï¼Œè¿™æ ·è¯¥ Pointcut ä»…ç”¨äºè¯¥ Aspectï¼š 123456&lt;aop:config&gt; &lt;aop:aspect ref=\"logArgsAspect\"&gt; &lt;aop:pointcut id=\"internalPointcut\" expression=\"com.javadoop.SystemArchitecture.businessService()\" /&gt; &lt;/aop:aspect&gt;&lt;/aop:config&gt; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åº”è¯¥é…ç½® Advice äº†ï¼Œä¸ºäº†é¿å…åºŸè¯è¿‡å¤šï¼Œæˆ‘ä»¬ç›´æ¥ä¸Šå®ä¾‹å§ï¼Œéå¸¸å¥½ç†è§£ï¼Œå°†ä¸Šä¸€èŠ‚ç”¨ @AspectJ æ–¹å¼é…ç½®çš„æ¬è¿‡æ¥ï¼š 16 ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é…ç½®äº†ä¸¤ä¸ª LogArgsAspect å’Œä¸€ä¸ª LogResultAspectã€‚ å…¶å®åŸºäº XML çš„é…ç½®ä¹Ÿæ˜¯éå¸¸çµæ´»çš„ï¼Œè¿™é‡Œæ²¡åŠæ³•ç»™å¤§å®¶æ¼”ç¤ºå„ç§æ­é…ï¼Œå¤§å®¶æŠ“ä½åŸºæœ¬çš„ Pointcutã€Advice å’Œ Aspect è¿™å‡ ä¸ªæ¦‚å¿µï¼Œå°±å¾ˆå®¹æ˜“é…ç½®äº†ã€‚ å°ç»“åˆ°è¿™é‡Œï¼Œæœ¬æ–‡ä»‹ç»äº† Spring AOP çš„ä¸‰ç§é…ç½®æ–¹å¼ï¼Œæˆ‘ä»¬è¦çŸ¥é“çš„æ˜¯ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ Spring AOPï¼Œå’Œ AspectJ æ²¡ä»€ä¹ˆå…³ç³»ã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œå°†ä¼šä»‹ç» AspectJ çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠæ€æ ·åœ¨ Spring åº”ç”¨ä¸­ä½¿ç”¨ AspectJã€‚ä¹‹åå·®ä¸å¤šå°±å¯ä»¥å‡º Spring AOP æºç åˆ†æäº†ã€‚ ã€ŠAspectJ ä½¿ç”¨ä»‹ç»ã€‹ä»‹ç»äº† AspectJ çš„ 3 ç§ç”¨æ³•ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»çœ‹ä¸€çœ‹ï¼Œé‚£ç¯‡æ–‡ç« ç¨å¾®çŸ­ä¸€äº›ã€‚ é™„å½•æœ¬æ–‡ä½¿ç”¨çš„æµ‹è¯•æºç å·²ä¸Šä¼ åˆ° Github: hongjiev/spring-aop-learningã€‚ å»ºè®®è¯»è€… clone ä¸‹æ¥ä»¥åï¼Œé€šè¿‡å‘½ä»¤è¡Œè¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸æ˜¯ä¾èµ–äº IDEï¼Œå› ä¸º IDE å¤ªâ€æ™ºèƒ½â€äº†ï¼š mvn clean package java -jar target/spring-aop-learning-1.0-jar-with-dependencies.jar pom.xml ä¸­é…ç½®äº† assembly æ’ä»¶ï¼Œæ‰“åŒ…çš„æ—¶å€™ä¼šå°†æ‰€æœ‰ jar åŒ…ä¾èµ–æ‰“åˆ°ä¸€èµ·ã€‚ ä¿®æ”¹ Application.java ä¸­çš„ä»£ç ï¼Œæˆ–è€…å…¶ä»–ä»£ç ï¼Œç„¶åé‡å¤ 1 å’Œ 2 ï¼ˆå…¨æ–‡å®Œï¼‰ éƒ‘é‡å£°æ˜ : æœ¬æ–‡è½¬è½½è‡ªæˆ‘å…³æ³¨çš„ä¸€ä½å¤§ä½¬çš„åšå®¢,åŸæ–‡é“¾æ¥ ,å¦‚æœ‰ä¾µæƒè¿˜è¯·è”ç³»æœ¬äººåˆ é™¤,ä»…åšçŸ¥è¯†ä¼ æ’­ä¸è®°å½•,æ— å‰½çªƒå†’çŠ¯ä¹‹æ„.","categories":[{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.enjoyican.com/categories/%E6%A1%86%E6%9E%B6/"}],"tags":[{"name":"spring","slug":"spring","permalink":"https://www.enjoyican.com/tags/spring/"}]},{"title":"åŸºäºhexoåšå®¢æ­å»ºtips","date":"2020-03-12T02:08:30.000Z","path":"posts/blog-byhexo-tips/","text":"æ­å»ºåŸºäºhexoæ­å»ºåšå®¢çš„æ•™ç¨‹,ç½‘ä¸Šå¾ˆå¤š,è¿™é‡Œä¸å†èµ˜è¿°,ä¸åŒä¸»é¢˜é€‚é…æœ‰ä¸åŒçš„å‘éœ€è¦è¸©,å› äººè€Œå¼‚,ä¸‹é¢ç»™å‡ºä¸€äº›æ•™ç¨‹é“¾æ¥: hexoå®˜æ–¹ä¸»é¡µä¸­æ–‡ç‰ˆ ä½¿ç”¨Hexoæ­å»ºGitHubåšå®¢ ä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢ç½‘ç«™æœ€å®Œæ•´è¯¦ç»†æ•™ç¨‹ æŒ‰ç…§ä¸Šè¿°æ•™ç¨‹æ­å»ºè¿‡ç¨‹ä¸­å¦‚é‡åˆ°æŠ¥é”™å¼‚å¸¸,ä¸€èˆ¬ç½‘ä¸Šæœç´¢éƒ½æ˜¯èƒ½æœç´¢åˆ°åŸå› çš„,é’ˆå¯¹ä¿®æ”¹å³å¯.åšå®¢æ­å»ºå®Œæˆå,ä½ æœ‰ä¸¤ç§æ–¹å¼è®¿é—®è‡ªå·±çš„åšå®¢: è‡ªå·±æœ‰æœåŠ¡å™¨,ä½†æ˜¯æ²¡æœ‰åŸŸå: é¦–å…ˆä¸Šä¼ æ–°å†™å¥½çš„ä¸€ç¯‡æ–‡æ¡£ä¹‹åæ‰§è¡Œhexo g,hexo så‘å¸ƒæ–‡ç« å¯åŠ¨åšå®¢ä¹‹å,å°±å¯ä»¥åœ¨æµè§ˆå™¨é€šè¿‡IP:4000(hexoé»˜è®¤ç«¯å£)è®¿é—®åˆ°è‡ªå·±çš„åšå®¢,ä½†æ˜¯è¿™ç§è®¿é—®æ–¹å¼ä¸€æ–¹é¢æµè§ˆå™¨åœ°å€çœ‹ç€ä¸èˆ’æœ,å¦ä¸€æ–¹é¢é€šè¿‡hexo såœ¨æœåŠ¡å™¨å¯åŠ¨ä¹‹å,æ²¡åŠæ³•é€€å‡ºå½“å‰å‘½ä»¤è¡Œ,ctrl+Cä¹‹åå°±è‡ªåŠ¨é€€å‡ºäº†,è®¿é—®ä¸äº†äº†,é€šè¿‡hexo s&amp;å¯åŠ¨,å¯ä»¥è®©åšå®¢åå°è¿è¡Œ,çŸ­æš‚è§£æ”¾ä½ çš„å‘½ä»¤è¡Œ,å¯ä»¥è®©ä½ å»æ‰§è¡Œåˆ«çš„å‘½ä»¤,ä½†æ˜¯è¿™ä¸ªçº¿ç¨‹è¿‡ä¸€ä¼šå„¿å°±æ­»äº¡äº†,åˆè®¿é—®ä¸äº†äº†. è‡ªå·±æ²¡æœ‰æœåŠ¡å™¨,åŸºäºgithubæ­å»º: åŸºäºgithubæ­å»ºçš„,å½“ä½ æ‰§è¡Œhexo g hexo då‘å¸ƒåˆ°è¿œç¨‹ä»“åº“ä¹‹åä½ å¯ä»¥é€šè¿‡https: yourgithubusername.github.ioè®¿é—®ä½ çš„åšå®¢,ä½†æ˜¯githubè®¿é—®æœ‰å¯èƒ½æ¯”è¾ƒæ…¢,æ­¤å¤–githubå±è”½äº†ç™¾åº¦æœç´¢,è¿™ä¸ªåšå®¢å†…å®¹åªèƒ½å­¤èŠ³è‡ªèµäº†.æ‰€ä»¥æ¥ä¸‹æ¥å°±æƒ³åˆ°ç”³è¯·åŸŸå,é€šè¿‡è‡ªå·±æœåŠ¡å™¨æ­å»ºåšå®¢. ç”³è¯·åŸŸåå¤‡æ¡ˆå› ä¸ºæˆ‘è‡ªå·±å¹³æ—¶æœ‰è‡ªç”¨çš„é˜¿é‡Œäº‘æœåŠ¡å™¨,æ²¡æœ‰åŸŸå,æ‰€ä»¥è¿™ä¸€æ­¥æˆ‘åªéœ€è¦åœ¨é˜¿é‡Œäº‘ä¸Šç”³è¯·åŸŸåå¹¶å¤‡æ¡ˆå³å¯,åŸŸåçš„ç”³è¯·å›½å†…å¤–ç½‘ç«™éƒ½å¯ä»¥,æˆ‘ä¸æƒ³åœ¨åé¢ä¸é˜¿é‡Œäº‘æœåŠ¡å™¨åŒ¹é…çš„æ—¶å€™é‡åˆ°å„ç§å‘æ‰€ä»¥ç›´æ¥åœ¨é˜¿é‡Œäº‘ä¸Šæ³¨å†Œäº†ä¸€ä¸ªåŸŸå,ä¸‰å¹´193RMB,æ³¨å†ŒæˆåŠŸåæäº¤é˜¿é‡Œäº‘åˆå®¡,è‡ª2019å¹´7æœˆ29æ—¥èµ·ï¼Œæ ¹æ®ç®¡å±€å¯¹å¤‡æ¡ˆçœŸå®æ€§çš„è¦æ±‚ï¼Œé˜¿é‡Œäº‘å¤‡æ¡ˆæµç¨‹ä¸­ä½¿ç”¨ç§»åŠ¨ç«¯è¿›è¡Œæ´»ä½“æ£€æµ‹ä¿éšœçœŸå®æ€§ï¼Œå¹•å¸ƒæ‹ç…§æ–¹å¼ä¸å†ä½¿ç”¨,ç›´æ¥åœ¨appä¸Šäººè„¸è¯†åˆ«åä¸Šä¼ ç…§ç‰‡å³å¯ä¸è¿‡äººè„¸è¯†åˆ«çš„æ—¶å€™è¯·ç¨å¾®æ”¶æ‹¾ä¸‹,æˆ‘å½“æ—¶äººè„¸è¯†åˆ«çš„æ—¶å€™æ²¡æƒ³åˆ°åé¢ä¼šç”¨è¿™å¼ ç…§ç‰‡ç”³è¯·å¤‡æ¡ˆæ‰€ä»¥å¤§åŠå¤œ12ç‚¹ç©¿ç€ç¡è¡£,ç¡çœ¼æƒºå¿ªæ‹äº†å¼ ç…§,åé¢ä¹Ÿæ‡’å¾—æ›¿æ¢äº†,æ‰€ä»¥å°±ç”¨ä¸€å¼ æŒ«ç…§æäº¤å¤‡æ¡ˆç”³è¯·äº†. å¤‡æ¡ˆæ—¶é˜¿é‡Œäº‘ä¼šè¿›è¡Œåˆå®¡,æ³¨æ„ç½‘ç«™åç§°ä¸è¦å‡ºç°åšå®¢,ç©ºé—´ç­‰å­—æ ·,è¿™äº›å­—æ ·ä¸åœ¨å·¥ä¿¡éƒ¨å¤‡æ¡ˆæ”¯æŒå†…å®¹é‡Œ,å…·ä½“å¯ä»¥ä¸Šé˜¿é‡Œäº‘æŸ¥è¯¢,ä¸è¿‡å°±ç®—å¡«é”™,é˜¿é‡Œäº‘åˆå®¡åŒå­¦ä¼šæé†’ä½ ä¿®æ”¹ åˆå®¡ç”¨äº†1ä¸ªå·¥ä½œæ—¥,ä¹‹åå°±æ˜¯é˜¿é‡Œäº‘æäº¤å·¥ä¿¡éƒ¨å®¡æ ¸,æˆ‘çš„ä¸ªäººç½‘ç«™å®¡æ ¸ç‰¹åˆ«å¿«,ä¸€å¤©å°±é€šè¿‡äº†,ä¹‹å‰ä¸€ç›´ä»¥ä¸ºè¦15-20å¤©,å¿…é¡»ç»™æµ™æ±Ÿå·¥ä¿¡éƒ¨ç‚¹ä¸ªèµ. å¤‡æ¡ˆå®Œæˆå,æŒ‰ç…§ç›¸å…³æŒ‡ç¤ºä¿®æ”¹ä½ çš„åšå®¢jsæ–‡ä»¶,å°†è¦æ±‚çš„å¤‡æ¡ˆå·æ”¾åœ¨ä½ ç½‘ç«™çš„åº•éƒ¨å¹¶é“¾æ¥åˆ°å¯¹åº”ç½‘å€. ç”¨nginxåšé™æ€èµ„æºæœåŠ¡å™¨åŸŸåæœ‰äº†,åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°æŒ‡å‘ä½ çš„æœåŠ¡å™¨ipä¹‹å,å°±å¯ä»¥é€šè¿‡nginxè®¿é—®åšå®¢é™æ€èµ„æºäº†.å› ä¸ºå‰è¿°hexo gçš„æ‰§è¡Œå°±æ˜¯åœ¨å¯¹åº”çš„publicæ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆé™æ€htmlç­‰æ–‡ä»¶èµ„æº,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡nginxè®¿é—®,å°±ä¸å†éœ€è¦åå°å¯åŠ¨hexoäº†. å®‰è£…nginx,ç½‘ä¸Šæ•™ç¨‹å¾ˆå¤š,æœç´¢å³å¯,å®‰è£…å¾ˆå¿« é…ç½®nginxé…ç½®æ–‡ä»¶,å°†rootæ ¹ç›®å½•é…ç½®å¦‚ä¸‹ 12345678910server &#123; listen 80; server_name enjoyican.com www.enjoyican.com; location / &#123; # rootç›®å½•é…ç½®ä¸ºä½ çš„åšå®¢è·¯å¾„ä¸‹çš„publicæ–‡ä»¶å¤¹ root /usr/soft/hexo/public/; index index.html index.htm; &#125; &#125; è¿™æ ·é…ç½®å¹¶é‡å¯nginxä¹‹åå°±å¯ä»¥é€šè¿‡åŸŸåè®¿é—®ä½ çš„åšå®¢èµ„æºäº†,ä½†æ˜¯åœ¨æµè§ˆå™¨è®¿é—®çš„æ—¶å€™ä¼šæ˜¾ç¤ºä¸å®‰å…¨å­—æ ·,çœ‹ç€ä¸èˆ’æœ,æ‰€ä»¥æ¥ä¸‹æ¥å°±æ˜¯é…ç½®https,ä»¥åŠå°†httpçš„è¯·æ±‚è½¬å‘åˆ°httpsä¸Š,å…·ä½“çš„é…ç½®å¯ä»¥å‚è€ƒå¦‚ä¸‹é“¾æ¥: ä¸ªäººç½‘ç«™å‡çº§httpä¸ºhttps","categories":[{"name":"tips","slug":"tips","permalink":"https://www.enjoyican.com/categories/tips/"}],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://www.enjoyican.com/tags/hexo/"}]},{"title":"è½¬è½½-Spring IOC å®¹å™¨æºç åˆ†æ","date":"2020-03-08T15:15:46.000Z","path":"posts/Spring-IOC/","text":"Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚ æœ¬æ–‡é‡‡ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 4.3.11.RELEASEï¼Œç®—æ˜¯ 5.0.x å‰æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬äº†ã€‚ä¸ºäº†é™ä½éš¾åº¦ï¼Œæœ¬æ–‡æ‰€è¯´çš„æ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯åŸºäº xml çš„é…ç½®çš„æ–¹å¼ï¼Œå®é™…ä½¿ç”¨å·²ç»å¾ˆå°‘äººè¿™ä¹ˆåšäº†ï¼Œè‡³å°‘ä¸æ˜¯çº¯ xml é…ç½®ï¼Œä¸è¿‡ä»ç†è§£æºç çš„è§’åº¦æ¥çœ‹ç”¨è¿™ç§æ–¹å¼æ¥è¯´æ— ç–‘æ˜¯æœ€åˆé€‚çš„ã€‚ é˜…è¯»å»ºè®®ï¼šè¯»è€…è‡³å°‘éœ€è¦çŸ¥é“æ€ä¹ˆé…ç½® Springï¼Œäº†è§£ Spring ä¸­çš„å„ç§æ¦‚å¿µï¼Œå°‘éƒ¨åˆ†å†…å®¹æˆ‘è¿˜å‡è®¾è¯»è€…ä½¿ç”¨è¿‡ SpringMVCã€‚æœ¬æ–‡è¦è¯´çš„ IOC æ€»ä½“æ¥è¯´æœ‰ä¸¤å¤„åœ°æ–¹æœ€é‡è¦ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º Bean å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ– Beanï¼Œå¦‚æœè¯»è€…è§‰å¾—ä¸€æ¬¡æ€§çœ‹å®Œæœ¬æ–‡å‹åŠ›æœ‰ç‚¹å¤§ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰è¿™ä¸ªæ€è·¯åˆ†ä¸¤æ¬¡æ¶ˆåŒ–ã€‚è¯»è€…ä¸ä¸€å®šå¯¹ Spring å®¹å™¨çš„æºç æ„Ÿå…´è¶£ï¼Œä¹Ÿè®¸é™„å½•éƒ¨åˆ†ä»‹ç»çš„çŸ¥è¯†å¯¹è¯»è€…æœ‰äº›è®¸ä½œç”¨ã€‚ å¸Œæœ›é€šè¿‡æœ¬æ–‡å¯ä»¥è®©è¯»è€…ä¸æƒ§æ€•é˜…è¯» Spring æºç ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½åé¦ˆè¡¨è¿°é”™è¯¯æˆ–ä¸åˆç†çš„åœ°æ–¹ã€‚ å¼•è¨€å…ˆçœ‹ä¸‹æœ€åŸºæœ¬çš„å¯åŠ¨ Spring å®¹å™¨çš„ä¾‹å­ï¼š 123public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(\"classpath:applicationfile.xml\");&#125; ä»¥ä¸Šä»£ç å°±å¯ä»¥åˆ©ç”¨é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª Spring å®¹å™¨äº†ï¼Œè¯·ä½¿ç”¨ maven çš„å°ä¼™ä¼´ç›´æ¥åœ¨ dependencies ä¸­åŠ ä¸Šä»¥ä¸‹ä¾èµ–å³å¯ï¼Œä¸ªäººæ¯”è¾ƒåå¯¹é‚£äº›ä¸çŸ¥é“è¦æ·»åŠ ä»€ä¹ˆä¾èµ–ï¼Œç„¶åæŠŠ Spring çš„æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½åŠ è¿›æ¥çš„æ–¹å¼ã€‚ 12345&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;4.3.11.RELEASE&lt;/version&gt;&lt;/dependency&gt; spring-context ä¼šè‡ªåŠ¨å°† spring-coreã€spring-beansã€spring-aopã€spring-expression è¿™å‡ ä¸ªåŸºç¡€ jar åŒ…å¸¦è¿›æ¥ã€‚ å¤šè¯´ä¸€å¥ï¼Œå¾ˆå¤šå¼€å‘è€…å…¥é—¨å°±ç›´æ¥æ¥è§¦çš„ SpringMVCï¼Œå¯¹ Spring å…¶å®ä¸æ˜¯å¾ˆäº†è§£ï¼ŒSpring æ˜¯æ¸è¿›å¼çš„å·¥å…·ï¼Œå¹¶ä¸å…·æœ‰å¾ˆå¼ºçš„ä¾µå…¥æ€§ï¼Œå®ƒçš„æ¨¡å—ä¹Ÿåˆ’åˆ†å¾—å¾ˆåˆç†ï¼Œå³ä½¿ä½ çš„åº”ç”¨ä¸æ˜¯ web åº”ç”¨ï¼Œæˆ–è€…ä¹‹å‰å®Œå…¨æ²¡æœ‰ä½¿ç”¨åˆ° Springï¼Œè€Œä½ å°±æƒ³ç”¨ Spring çš„ä¾èµ–æ³¨å…¥è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®å®Œå…¨æ˜¯å¯ä»¥çš„ï¼Œå®ƒçš„å¼•å…¥ä¸ä¼šå¯¹å…¶ä»–çš„ç»„ä»¶äº§ç”Ÿå†²çªã€‚ åºŸè¯è¯´å®Œï¼Œæˆ‘ä»¬ç»§ç»­ã€‚ApplicationContext context = new ClassPathXmlApplicationContext(...) å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çŒœå‡ºä¸€äºŒï¼Œå°±æ˜¯åœ¨ ClassPath ä¸­å¯»æ‰¾ xml é…ç½®æ–‡ä»¶ï¼Œæ ¹æ® xml æ–‡ä»¶å†…å®¹æ¥æ„å»º ApplicationContextã€‚å½“ç„¶ï¼Œé™¤äº† ClassPathXmlApplicationContext ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜æœ‰å…¶ä»–æ„å»º ApplicationContext çš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤§ä½“çš„ç»§æ‰¿ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼š 1 è¯»è€…å¯ä»¥å¤§è‡´çœ‹ä¸€ä¸‹ç±»åï¼Œæºç åˆ†æçš„æ—¶å€™ä¸è‡³äºæ‰¾ä¸ç€çœ‹å“ªä¸ªç±»ï¼Œå› ä¸º Spring ä¸ºäº†é€‚åº”å„ç§ä½¿ç”¨åœºæ™¯ï¼Œæä¾›çš„å„ä¸ªæ¥å£éƒ½å¯èƒ½æœ‰å¾ˆå¤šçš„å®ç°ç±»ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå°±æ˜¯æªç€ä¸€ä¸ªå®Œæ•´çš„åˆ†æ”¯çœ‹å®Œã€‚ å½“ç„¶ï¼Œè¯»æœ¬æ–‡çš„æ—¶å€™è¯»è€…ä¹Ÿä¸å¿…å¤ªæ‹…å¿ƒï¼Œæ¯ä¸ªä»£ç å—åˆ†æçš„æ—¶å€™ï¼Œæˆ‘éƒ½ä¼šå‘Šè¯‰è¯»è€…æˆ‘ä»¬åœ¨è¯´å“ªä¸ªç±»ç¬¬å‡ è¡Œã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext å…œå…œè½¬è½¬äº†å¥½ä¹…æ‰åˆ° ApplicationContext æ¥å£ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç»¿é¢œè‰²çš„ FileSystemXmlApplicationContext å’Œ AnnotationConfigApplicationContext è¿™ä¸¤ä¸ªç±»ã€‚ 1ã€FileSystemXmlApplicationContext çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ª xml é…ç½®æ–‡ä»¶åœ¨ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œå…¶ä»–å’Œ ClassPathXmlApplicationContext åŸºæœ¬ä¸Šä¸€æ ·ã€‚ 2ã€AnnotationConfigApplicationContext æ˜¯åŸºäºæ³¨è§£æ¥ä½¿ç”¨çš„ï¼Œå®ƒä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œé‡‡ç”¨ java é…ç½®ç±»å’Œå„ç§æ³¨è§£æ¥é…ç½®ï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹å§ã€‚ ä¸è¿‡æœ¬æ–‡æ—¨åœ¨å¸®åŠ©å¤§å®¶ç†è§£æ•´ä¸ªæ„å»ºæµç¨‹ï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨ ClassPathXmlApplicationContext è¿›è¡Œåˆ†æã€‚ æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹æ€ä¹ˆå®ä¾‹åŒ– ApplicationContextã€‚ é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š 123public interface MessageService &#123; String getMessage();&#125; å®šä¹‰æ¥å£å®ç°ç±»ï¼š 123456public class MessageServiceImpl implements MessageService &#123; public String getMessage() &#123; return \"hello world\"; &#125;&#125; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ resources ç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åéšæ„ï¼Œé€šå¸¸å« application.xml æˆ– application-xxx.xml å°±å¯ä»¥äº†ï¼š 1234567&lt;?xml version=\"1.0\" encoding=\"UTF-8\" ?&gt;&lt;beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://www.springframework.org/schema/beans\" xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\" default-autowire=\"byName\"&gt; &lt;bean id=\"messageService\" class=\"com.javadoop.example.MessageServiceImpl\"/&gt;&lt;/beans&gt; è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·‘èµ·æ¥äº†ï¼š 12345678910111213public class App &#123; public static void main(String[] args) &#123; // ç”¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª ApplicationContext ApplicationContext context = new ClassPathXmlApplicationContext(\"classpath:application.xml\"); System.out.println(\"context å¯åŠ¨æˆåŠŸ\"); // ä» context ä¸­å–å‡ºæˆ‘ä»¬çš„ Beanï¼Œè€Œä¸æ˜¯ç”¨ new MessageServiceImpl() è¿™ç§æ–¹å¼ MessageService messageService = context.getBean(MessageService.class); // è¿™å¥å°†è¾“å‡º: hello world System.out.println(messageService.getMessage()); &#125;&#125; ä»¥ä¸Šä¾‹å­å¾ˆç®€å•ï¼Œä¸è¿‡ä¹Ÿå¤Ÿå¼•å‡ºæœ¬æ–‡çš„ä¸»é¢˜äº†ï¼Œå°±æ˜¯æ€ä¹ˆæ ·é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ Spring çš„ ApplicationContext ï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„ IOC çš„æ ¸å¿ƒäº†ã€‚ApplicationContext å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè´Ÿè´£åˆ›å»ºå®ä¾‹ Beanï¼Œå¾€å„ä¸ª Bean ä¸­æ³¨å…¥ä¾èµ–ç­‰ã€‚ BeanFactory ç®€ä»‹BeanFactoryï¼Œä»åå­—ä¸Šä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”Ÿäº§ bean çš„å·¥å‚ï¼Œå®ƒè´Ÿè´£ç”Ÿäº§å’Œç®¡ç†å„ä¸ª bean å®ä¾‹ã€‚ åˆå­¦è€…å¯åˆ«ä»¥ä¸ºæˆ‘ä¹‹å‰è¯´é‚£ä¹ˆå¤šå’Œ BeanFactory æ— å…³ï¼Œå‰é¢è¯´çš„ ApplicationContext å…¶å®å°±æ˜¯ä¸€ä¸ª BeanFactoryã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å’Œ BeanFactory æ¥å£ç›¸å…³çš„ä¸»è¦çš„ç»§æ‰¿ç»“æ„ï¼š 2 æˆ‘æƒ³ï¼Œå¤§å®¶çœ‹å®Œè¿™ä¸ªå›¾ä»¥åï¼Œå¯èƒ½å°±ä¸æ˜¯å¾ˆå¼€å¿ƒäº†ã€‚ApplicationContext å¾€ä¸‹çš„ç»§æ‰¿ç»“æ„å‰é¢ä¸€å¼ å›¾è¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚è¿™å¼ å›¾å‘¢ï¼ŒèƒŒä¸‹æ¥è‚¯å®šæ˜¯ä¸éœ€è¦çš„ï¼Œæœ‰å‡ ä¸ªé‡ç‚¹å’Œå¤§å®¶è¯´æ˜ä¸‹å°±å¥½ã€‚ ApplicationContext ç»§æ‰¿äº† ListableBeanFactoryï¼Œè¿™ä¸ª Listable çš„æ„æ€å°±æ˜¯ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¤šä¸ª Beanï¼Œå¤§å®¶çœ‹æºç ä¼šå‘ç°ï¼Œæœ€é¡¶å±‚ BeanFactory æ¥å£çš„æ–¹æ³•éƒ½æ˜¯è·å–å•ä¸ª Bean çš„ã€‚ ApplicationContext ç»§æ‰¿äº† HierarchicalBeanFactoryï¼ŒHierarchical å•è¯æœ¬èº«å·²ç»èƒ½è¯´æ˜é—®é¢˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ä¸­èµ·å¤šä¸ª BeanFactoryï¼Œç„¶åå¯ä»¥å°†å„ä¸ª BeanFactory è®¾ç½®ä¸ºçˆ¶å­å…³ç³»ã€‚ AutowireCapableBeanFactory è¿™ä¸ªåå­—ä¸­çš„ Autowire å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰ï¼Œå®ƒå°±æ˜¯ç”¨æ¥è‡ªåŠ¨è£…é… Bean ç”¨çš„ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸Šå›¾ï¼ŒApplicationContext å¹¶æ²¡æœ‰ç»§æ‰¿å®ƒï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸ä½¿ç”¨ç»§æ‰¿ï¼Œä¸ä»£è¡¨ä¸å¯ä»¥ä½¿ç”¨ç»„åˆï¼Œå¦‚æœä½ çœ‹åˆ° ApplicationContext æ¥å£å®šä¹‰ä¸­çš„æœ€åä¸€ä¸ªæ–¹æ³• getAutowireCapableBeanFactory() å°±çŸ¥é“äº†ã€‚ ConfigurableListableBeanFactory ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œçœ‹å›¾ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒç»§æ‰¿äº†ç¬¬äºŒå±‚æ‰€æœ‰çš„ä¸‰ä¸ªæ¥å£ï¼Œè€Œ ApplicationContext æ²¡æœ‰ã€‚è¿™ç‚¹ä¹‹åä¼šç”¨åˆ°ã€‚ è¯·å…ˆä¸ç”¨èŠ±æ—¶é—´åœ¨å…¶ä»–çš„æ¥å£å’Œç±»ä¸Šï¼Œå…ˆç†è§£æˆ‘è¯´çš„è¿™å‡ ç‚¹å°±å¯ä»¥äº†ã€‚ ç„¶åï¼Œè¯·è¯»è€…æ‰“å¼€ç¼–è¾‘å™¨ï¼Œç¿»ä¸€ä¸‹ BeanFactoryã€ListableBeanFactoryã€HierarchicalBeanFactoryã€AutowireCapableBeanFactoryã€ApplicationContext è¿™å‡ ä¸ªæ¥å£çš„ä»£ç ï¼Œå¤§æ¦‚çœ‹ä¸€ä¸‹å„ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¤§å®¶å¿ƒé‡Œè¦æœ‰åº•ï¼Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ä¸è´´ä»£ç ä»‹ç»äº†ã€‚ å¯åŠ¨è¿‡ç¨‹åˆ†æä¸‹é¢å°†ä¼šæ˜¯å†—é•¿çš„ä»£ç åˆ†æï¼Œè®°ä½ï¼Œä¸€å®šè¦è‡ªå·±æ‰“å¼€æºç æ¥çœ‹ï¼Œä¸ç„¶çº¯çœ‹æ˜¯å¾ˆç´¯çš„ã€‚ ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä» ClassPathXmlApplicationContext çš„æ„é€ æ–¹æ³•è¯´èµ·ã€‚ 1234567891011121314151617181920public class ClassPathXmlApplicationContext extends AbstractXmlApplicationContext &#123; private Resource[] configResources; // å¦‚æœå·²ç»æœ‰ ApplicationContext å¹¶éœ€è¦é…ç½®æˆçˆ¶å­å…³ç³»ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³• public ClassPathXmlApplicationContext(ApplicationContext parent) &#123; super(parent); &#125; ... public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent) throws BeansException &#123; super(parent); // æ ¹æ®æä¾›çš„è·¯å¾„ï¼Œå¤„ç†æˆé…ç½®æ–‡ä»¶æ•°ç»„(ä»¥åˆ†å·ã€é€—å·ã€ç©ºæ ¼ã€tabã€æ¢è¡Œç¬¦åˆ†å‰²) setConfigLocations(configLocations); if (refresh) &#123; refresh(); // æ ¸å¿ƒæ–¹æ³• &#125; &#125; ...&#125; æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ refresh()ï¼Œè¿™é‡Œç®€å•è¯´ä¸‹ä¸ºä»€ä¹ˆæ˜¯ refresh()ï¼Œè€Œä¸æ˜¯ init() è¿™ç§åå­—çš„æ–¹æ³•ã€‚å› ä¸º ApplicationContext å»ºç«‹èµ·æ¥ä»¥åï¼Œå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨ refresh() è¿™ä¸ªæ–¹æ³•é‡å»ºçš„ï¼Œrefresh() ä¼šå°†åŸæ¥çš„ ApplicationContext é”€æ¯ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–æ“ä½œã€‚ å¾€ä¸‹çœ‹ï¼Œrefresh() æ–¹æ³•é‡Œé¢è°ƒç”¨äº†é‚£ä¹ˆå¤šæ–¹æ³•ï¼Œå°±çŸ¥é“è‚¯å®šä¸ç®€å•äº†ï¼Œè¯·è¯»è€…å…ˆçœ‹ä¸ªå¤§æ¦‚ï¼Œç»†èŠ‚ä¹‹åä¼šè¯¦ç»†è¯´ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778@Overridepublic void refresh() throws BeansException, IllegalStateException &#123; // æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜› synchronized (this.startupShutdownMonitor) &#123; // å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦ prepareRefresh(); // è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ // å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ // æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map) ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean // è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´ prepareBeanFactory(beanFactory); try &#123; // ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ // é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘ // è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ– // å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹ postProcessBeanFactory(beanFactory); // è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) æ–¹æ³• invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ« // æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization // ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚æ³¨æ„ï¼Œåˆ°è¿™é‡Œ Bean è¿˜æ²¡åˆå§‹åŒ– registerBeanPostProcessors(beanFactory); // åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº† initMessageSource(); // åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº† initApplicationEventMulticaster(); // ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œ // å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰ onRefresh(); // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡ registerListeners(); // é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹ // åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans //ï¼ˆlazy-init çš„é™¤å¤–ï¼‰ finishBeanFactoryInitialization(beanFactory); // æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆ finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(\"Exception encountered during context initialization - \" + \"cancelling refresh attempt: \" + ex); &#125; // Destroy already created singletons to avoid dangling resources. // é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº destroyBeans(); // Reset 'active' flag. cancelRefresh(ex); // æŠŠå¼‚å¸¸å¾€å¤–æŠ› throw ex; &#125; finally &#123; // Reset common introspection caches in Spring's core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); &#125; &#125;&#125; ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹ä¸€æ­¥æ­¥æ¥è‚¢è§£è¿™ä¸ª refresh() æ–¹æ³•ã€‚ åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ä¸­çš„å‡ ä¸ªæ³¨é‡Šå³å¯ã€‚ 12345678910111213141516171819protected void prepareRefresh() &#123; // è®°å½•å¯åŠ¨æ—¶é—´ï¼Œ // å°† active å±æ€§è®¾ç½®ä¸º trueï¼Œclosed å±æ€§è®¾ç½®ä¸º falseï¼Œå®ƒä»¬éƒ½æ˜¯ AtomicBoolean ç±»å‹ this.startupDate = System.currentTimeMillis(); this.closed.set(false); this.active.set(true); if (logger.isInfoEnabled()) &#123; logger.info(\"Refreshing \" + this); &#125; // Initialize any placeholder property sources in the context environment initPropertySources(); // æ ¡éªŒ xml é…ç½®æ–‡ä»¶ getEnvironment().validateRequiredProperties(); this.earlyApplicationEvents = new LinkedHashSet&lt;ApplicationEvent&gt;();&#125; åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Beanæˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ä¸­çš„ä¸‹ä¸€è¡Œ obtainFreshBeanFactory()ã€‚ æ³¨æ„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å…¨æ–‡æœ€é‡è¦çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ– BeanFactoryã€åŠ è½½ Beanã€æ³¨å†Œ Bean ç­‰ç­‰ã€‚ å½“ç„¶ï¼Œè¿™æ­¥ç»“æŸåï¼ŒBean å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ Bean å®ä¾‹å¹¶æœªåœ¨è¿™ä¸€æ­¥ç”Ÿæˆã€‚ // AbstractApplicationContext.java 1234567891011protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123; // å…³é—­æ—§çš„ BeanFactory (å¦‚æœæœ‰)ï¼Œåˆ›å»ºæ–°çš„ BeanFactoryï¼ŒåŠ è½½ Bean å®šä¹‰ã€æ³¨å†Œ Bean ç­‰ç­‰ refreshBeanFactory(); // è¿”å›åˆšåˆšåˆ›å»ºçš„ BeanFactory ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (logger.isDebugEnabled()) &#123; logger.debug(\"Bean factory for \" + getDisplayName() + \": \" + beanFactory); &#125; return beanFactory;&#125; // AbstractRefreshableApplicationContext.java 120 1234567891011121314151617181920212223242526272829@Overrideprotected final void refreshBeanFactory() throws BeansException &#123; // å¦‚æœ ApplicationContext ä¸­å·²ç»åŠ è½½è¿‡ BeanFactory äº†ï¼Œé”€æ¯æ‰€æœ‰ Beanï¼Œå…³é—­ BeanFactory // æ³¨æ„ï¼Œåº”ç”¨ä¸­ BeanFactory æœ¬æ¥å°±æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿™é‡Œå¯ä¸æ˜¯è¯´åº”ç”¨å…¨å±€æ˜¯å¦æœ‰ BeanFactoryï¼Œè€Œæ˜¯å½“å‰ // ApplicationContext æ˜¯å¦æœ‰ BeanFactory if (hasBeanFactory()) &#123; destroyBeans(); closeBeanFactory(); &#125; try &#123; // åˆå§‹åŒ–ä¸€ä¸ª DefaultListableBeanFactoryï¼Œä¸ºä»€ä¹ˆç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬é©¬ä¸Šè¯´ã€‚ DefaultListableBeanFactory beanFactory = createBeanFactory(); // ç”¨äº BeanFactory çš„åºåˆ—åŒ–ï¼Œæˆ‘æƒ³ä¸éƒ¨åˆ†äººåº”è¯¥éƒ½ç”¨ä¸åˆ° beanFactory.setSerializationId(getId()); // ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œåˆ«è·Ÿä¸¢äº†ï¼Œå…·ä½“ç»†èŠ‚ä¹‹åè¯´ // è®¾ç½® BeanFactory çš„ä¸¤ä¸ªé…ç½®å±æ€§ï¼šæ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ customizeBeanFactory(beanFactory); // åŠ è½½ Bean åˆ° BeanFactory ä¸­ loadBeanDefinitions(beanFactory); synchronized (this.beanFactoryMonitor) &#123; this.beanFactory = beanFactory; &#125; &#125; catch (IOException ex) &#123; throw new ApplicationContextException(\"I/O error parsing bean definition source for \" + getDisplayName(), ex); &#125;&#125; çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—è¯»è€…å°±åº”è¯¥ç«™åœ¨é«˜å¤„çœ‹ ApplicationContext äº†ï¼ŒApplicationContext ç»§æ‰¿è‡ª BeanFactoryï¼Œä½†æ˜¯å®ƒä¸åº”è¯¥è¢«ç†è§£ä¸º BeanFactory çš„å®ç°ç±»ï¼Œè€Œæ˜¯è¯´å…¶å†…éƒ¨æŒæœ‰ä¸€ä¸ªå®ä¾‹åŒ–çš„ BeanFactoryï¼ˆDefaultListableBeanFactoryï¼‰ã€‚ä»¥åæ‰€æœ‰çš„ BeanFactory ç›¸å…³çš„æ“ä½œå…¶å®æ˜¯å§”æ‰˜ç»™è¿™ä¸ªå®ä¾‹æ¥å¤„ç†çš„ã€‚ æˆ‘ä»¬è¯´è¯´ä¸ºä»€ä¹ˆé€‰æ‹©å®ä¾‹åŒ– DefaultListableBeanFactory ï¼Ÿå‰é¢æˆ‘ä»¬è¯´äº†æœ‰ä¸ªå¾ˆé‡è¦çš„æ¥å£ ConfigurableListableBeanFactoryï¼Œå®ƒå®ç°äº† BeanFactory ä¸‹é¢ä¸€å±‚çš„æ‰€æœ‰ä¸‰ä¸ªæ¥å£ï¼Œæˆ‘æŠŠä¹‹å‰çš„ç»§æ‰¿å›¾å†æ‹¿è¿‡æ¥å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹ï¼š 3 æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ConfigurableListableBeanFactory åªæœ‰ä¸€ä¸ªå®ç°ç±» DefaultListableBeanFactoryï¼Œè€Œä¸”å®ç°ç±» DefaultListableBeanFactory è¿˜é€šè¿‡å®ç°å³è¾¹çš„ AbstractAutowireCapableBeanFactory é€šåƒäº†å³è·¯ã€‚æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œæœ€åº•ä¸‹è¿™ä¸ªå®¶ä¼™ DefaultListableBeanFactory åŸºæœ¬ä¸Šæ˜¯æœ€ç‰›çš„ BeanFactory äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™è¾¹ä¼šä½¿ç”¨è¿™ä¸ªç±»æ¥å®ä¾‹åŒ–çš„åŸå› ã€‚ å¦‚æœä½ æƒ³è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€å¾€ Spring IOC å®¹å™¨æ³¨å†Œæ–°çš„ beanï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆåœ¨è¿è¡Œæ—¶è·å¾—è¿™ä¸ªå®ä¾‹å‘¢ï¼Ÿ ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ ApplicationContext æ¥å£èƒ½è·å–åˆ° AutowireCapableBeanFactoryï¼Œå°±æ˜¯æœ€å³ä¸Šè§’é‚£ä¸ªï¼Œç„¶åå®ƒå‘ä¸‹è½¬å‹å°±èƒ½å¾—åˆ° DefaultListableBeanFactory äº†ã€‚ é‚£æ€ä¹ˆæ‹¿åˆ° ApplicationContext å®ä¾‹å‘¢ï¼Ÿå¦‚æœä½ ä¸ä¼šï¼Œè¯´æ˜ä½ æ²¡ç”¨è¿‡ Springã€‚ åœ¨ç»§ç»­å¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ BeanDefinitionã€‚æˆ‘ä»¬è¯´ BeanFactory æ˜¯ Bean å®¹å™¨ï¼Œé‚£ä¹ˆ Bean åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ è¿™é‡Œçš„ BeanDefinition å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Spring çš„ Beanï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å„ä¸ª Bean å…¶å®ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª BeanDefinition å­˜åœ¨äº Spring çš„ BeanFactory ä¸­ã€‚ æ‰€ä»¥ï¼Œå¦‚æœæœ‰äººé—®ä½  Bean æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ è¦çŸ¥é“ Bean åœ¨ä»£ç å±‚é¢ä¸Šå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ BeanDefinition çš„å®ä¾‹ã€‚ BeanDefinition ä¸­ä¿å­˜äº†æˆ‘ä»¬çš„ Bean ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™ä¸ª Bean æŒ‡å‘çš„æ˜¯å“ªä¸ªç±»ã€æ˜¯å¦æ˜¯å•ä¾‹çš„ã€æ˜¯å¦æ‡’åŠ è½½ã€è¿™ä¸ª Bean ä¾èµ–äº†å“ªäº› Bean ç­‰ç­‰ã€‚ BeanDefinition æ¥å£å®šä¹‰æˆ‘ä»¬æ¥çœ‹ä¸‹ BeanDefinition çš„æ¥å£å®šä¹‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788public interface BeanDefinition extends AttributeAccessor, BeanMetadataElement &#123; // æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤åªæä¾› sington å’Œ prototype ä¸¤ç§ï¼Œ // å¾ˆå¤šè¯»è€…å¯èƒ½çŸ¥é“è¿˜æœ‰ request, session, globalSession, application, websocket è¿™å‡ ç§ï¼Œ // ä¸è¿‡ï¼Œå®ƒä»¬å±äºåŸºäº web çš„æ‰©å±•ã€‚ String SCOPE_SINGLETON = ConfigurableBeanFactory.SCOPE_SINGLETON; String SCOPE_PROTOTYPE = ConfigurableBeanFactory.SCOPE_PROTOTYPE; // æ¯”è¾ƒä¸é‡è¦ï¼Œç›´æ¥è·³è¿‡å§ int ROLE_APPLICATION = 0; int ROLE_SUPPORT = 1; int ROLE_INFRASTRUCTURE = 2; // è®¾ç½®çˆ¶ Beanï¼Œè¿™é‡Œæ¶‰åŠåˆ° bean ç»§æ‰¿ï¼Œä¸æ˜¯ java ç»§æ‰¿ã€‚è¯·å‚è§é™„å½•çš„è¯¦ç»†ä»‹ç» // ä¸€å¥è¯å°±æ˜¯ï¼šç»§æ‰¿çˆ¶ Bean çš„é…ç½®ä¿¡æ¯è€Œå·² void setParentName(String parentName); // è·å–çˆ¶ Bean String getParentName(); // è®¾ç½® Bean çš„ç±»åç§°ï¼Œå°†æ¥æ˜¯è¦é€šè¿‡åå°„æ¥ç”Ÿæˆå®ä¾‹çš„ void setBeanClassName(String beanClassName); // è·å– Bean çš„ç±»åç§° String getBeanClassName(); // è®¾ç½® bean çš„ scope void setScope(String scope); String getScope(); // è®¾ç½®æ˜¯å¦æ‡’åŠ è½½ void setLazyInit(boolean lazyInit); boolean isLazyInit(); // è®¾ç½®è¯¥ Bean ä¾èµ–çš„æ‰€æœ‰çš„ Beanï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–ä¸æ˜¯æŒ‡å±æ€§ä¾èµ–(å¦‚ @Autowire æ ‡è®°çš„)ï¼Œ // æ˜¯ depends-on=\"\" å±æ€§è®¾ç½®çš„å€¼ã€‚ void setDependsOn(String... dependsOn); // è¿”å›è¯¥ Bean çš„æ‰€æœ‰ä¾èµ– String[] getDependsOn(); // è®¾ç½®è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ï¼Œåªå¯¹æ ¹æ®ç±»å‹æ³¨å…¥æœ‰æ•ˆï¼Œ // å¦‚æœæ ¹æ®åç§°æ³¨å…¥ï¼Œå³ä½¿è¿™è¾¹è®¾ç½®äº† falseï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ void setAutowireCandidate(boolean autowireCandidate); // è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ boolean isAutowireCandidate(); // ä¸»è¦çš„ã€‚åŒä¸€æ¥å£çš„å¤šä¸ªå®ç°ï¼Œå¦‚æœä¸æŒ‡å®šåå­—çš„è¯ï¼ŒSpring ä¼šä¼˜å…ˆé€‰æ‹©è®¾ç½® primary ä¸º true çš„ bean void setPrimary(boolean primary); // æ˜¯å¦æ˜¯ primary çš„ boolean isPrimary(); // å¦‚æœè¯¥ Bean é‡‡ç”¨å·¥å‚æ–¹æ³•ç”Ÿæˆï¼ŒæŒ‡å®šå·¥å‚åç§°ã€‚å¯¹å·¥å‚ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œè¯·å‚åŠ é™„å½• // ä¸€å¥è¯å°±æ˜¯ï¼šæœ‰äº›å®ä¾‹ä¸æ˜¯ç”¨åå°„ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ç”¨å·¥å‚æ¨¡å¼ç”Ÿæˆçš„ void setFactoryBeanName(String factoryBeanName); // è·å–å·¥å‚åç§° String getFactoryBeanName(); // æŒ‡å®šå·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§° void setFactoryMethodName(String factoryMethodName); // è·å–å·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§° String getFactoryMethodName(); // æ„é€ å™¨å‚æ•° ConstructorArgumentValues getConstructorArgumentValues(); // Bean ä¸­çš„å±æ€§å€¼ï¼Œåé¢ç»™ bean æ³¨å…¥å±æ€§å€¼çš„æ—¶å€™ä¼šè¯´åˆ° MutablePropertyValues getPropertyValues(); // æ˜¯å¦ singleton boolean isSingleton(); // æ˜¯å¦ prototype boolean isPrototype(); // å¦‚æœè¿™ä¸ª Bean æ˜¯è¢«è®¾ç½®ä¸º abstractï¼Œé‚£ä¹ˆä¸èƒ½å®ä¾‹åŒ–ï¼Œ // å¸¸ç”¨äºä½œä¸º çˆ¶bean ç”¨äºç»§æ‰¿ï¼Œå…¶å®ä¹Ÿå¾ˆå°‘ç”¨...... boolean isAbstract(); int getRole(); String getDescription(); String getResourceDescription(); BeanDefinition getOriginatingBeanDefinition();&#125; è¿™ä¸ª BeanDefinition å…¶å®å·²ç»åŒ…å«å¾ˆå¤šçš„ä¿¡æ¯äº†ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ‰€æœ‰çš„æ–¹æ³•å¯¹åº”ä»€ä¹ˆä¸œè¥¿æ²¡å…³ç³»ï¼Œå¸Œæœ›çœ‹å®Œæœ¬æ–‡åè¯»è€…å¯ä»¥å½»åº•ææ¸…æ¥šé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿ã€‚ è¿™é‡Œæ¥å£è™½ç„¶é‚£ä¹ˆå¤šï¼Œä½†æ˜¯æ²¡æœ‰ç±»ä¼¼ getInstance() è¿™ç§æ–¹æ³•æ¥è·å–æˆ‘ä»¬å®šä¹‰çš„ç±»çš„å®ä¾‹ï¼ŒçœŸæ­£çš„æˆ‘ä»¬å®šä¹‰çš„ç±»ç”Ÿæˆçš„å®ä¾‹åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œè¿™ä¸ªè¦å¾ˆåé¢æ‰èƒ½è®²åˆ°ã€‚ æœ‰äº† BeanDefinition çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ refreshBeanFactory() æ–¹æ³•ä¸­çš„å‰©ä½™éƒ¨åˆ†ï¼š 12customizeBeanFactory(beanFactory);loadBeanDefinitions(beanFactory); è™½ç„¶åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†è·¯è¿˜å¾ˆé•¿å•Šã€‚ã€‚ã€‚ customizeBeanFactorycustomizeBeanFactory(beanFactory) æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é…ç½®æ˜¯å¦å…è®¸ BeanDefinition è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ã€‚ 12345678910protected void customizeBeanFactory(DefaultListableBeanFactory beanFactory) &#123; if (this.allowBeanDefinitionOverriding != null) &#123; // æ˜¯å¦å…è®¸ Bean å®šä¹‰è¦†ç›– beanFactory.setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding); &#125; if (this.allowCircularReferences != null) &#123; // æ˜¯å¦å…è®¸ Bean é—´çš„å¾ªç¯ä¾èµ– beanFactory.setAllowCircularReferences(this.allowCircularReferences); &#125;&#125; BeanDefinition çš„è¦†ç›–é—®é¢˜å¯èƒ½ä¼šæœ‰å¼€å‘è€…ç¢°åˆ°è¿™ä¸ªå‘ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ bean æ—¶ä½¿ç”¨äº†ç›¸åŒçš„ id æˆ– nameï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullï¼Œå¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚ å¾ªç¯å¼•ç”¨ä¹Ÿå¾ˆå¥½ç†è§£ï¼šA ä¾èµ– Bï¼Œè€Œ B ä¾èµ– Aã€‚æˆ– A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C ä¾èµ– Aã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring å…è®¸å¾ªç¯ä¾èµ–ï¼Œå½“ç„¶å¦‚æœä½ åœ¨ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– Bï¼Œåœ¨ B çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– A æ˜¯ä¸è¡Œçš„ã€‚ è‡³äºè¿™ä¸¤ä¸ªå±æ€§æ€ä¹ˆé…ç½®ï¼Ÿæˆ‘åœ¨é™„å½•ä¸­è¿›è¡Œäº†ä»‹ç»ï¼Œå°¤å…¶å¯¹äºè¦†ç›–é—®é¢˜ï¼Œå¾ˆå¤šäººéƒ½å¸Œæœ›ç¦æ­¢å‡ºç° Bean è¦†ç›–ï¼Œå¯æ˜¯ Spring é»˜è®¤æ˜¯ä¸åŒæ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¦†ç›–çš„ã€‚ ä¹‹åçš„æºç ä¸­è¿˜ä¼šå‡ºç°è¿™ä¸¤ä¸ªå±æ€§ï¼Œè¯»è€…æœ‰ä¸ªå°è±¡å°±å¯ä»¥äº†ï¼Œå®ƒä»¬ä¸æ˜¯éå¸¸é‡è¦ã€‚ åŠ è½½ Bean: loadBeanDefinitionsæ¥ä¸‹æ¥æ˜¯æœ€é‡è¦çš„ loadBeanDefinitions(beanFactory) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ ¹æ®é…ç½®ï¼ŒåŠ è½½å„ä¸ª Beanï¼Œç„¶åæ”¾åˆ° BeanFactory ä¸­ã€‚ è¯»å–é…ç½®çš„æ“ä½œåœ¨ XmlBeanDefinitionReader ä¸­ï¼Œå…¶è´Ÿè´£åŠ è½½é…ç½®ã€è§£æã€‚ // AbstractXmlApplicationContext.java 80 123456789101112131415161718/** æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ–¹æ³•å°†é€šè¿‡ä¸€ä¸ª XmlBeanDefinitionReader å®ä¾‹æ¥åŠ è½½å„ä¸ª Beanã€‚*/@Overrideprotected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123; // ç»™è¿™ä¸ª BeanFactory å®ä¾‹åŒ–ä¸€ä¸ª XmlBeanDefinitionReader XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // Configure the bean definition reader with this context's // resource loading environment. beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // åˆå§‹åŒ– BeanDefinitionReaderï¼Œå…¶å®è¿™ä¸ªæ˜¯æä¾›ç»™å­ç±»è¦†å†™çš„ï¼Œ // æˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰ç±»è¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å§‘ä¸”å½“åšä¸é‡è¦å§ initBeanDefinitionReader(beanDefinitionReader); // é‡ç‚¹æ¥äº†ï¼Œç»§ç»­å¾€ä¸‹ loadBeanDefinitions(beanDefinitionReader);&#125; ç°åœ¨è¿˜åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨åˆšåˆšåˆå§‹åŒ–çš„ Reader å¼€å§‹æ¥åŠ è½½ xml é…ç½®ï¼Œè¿™å—ä»£ç è¯»è€…å¯ä»¥é€‰æ‹©æ€§è·³è¿‡ï¼Œä¸æ˜¯å¾ˆé‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢è¿™ä¸ªä»£ç å—ï¼Œè¯»è€…å¯ä»¥å¾ˆè½»æ¾åœ°ç•¥è¿‡ã€‚ // AbstractXmlApplicationContext.java 120 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException &#123; Resource[] configResources = getConfigResources(); if (configResources != null) &#123; // å¾€ä¸‹çœ‹ reader.loadBeanDefinitions(configResources); &#125; String[] configLocations = getConfigLocations(); if (configLocations != null) &#123; // 2 reader.loadBeanDefinitions(configLocations); &#125;&#125;// ä¸Šé¢è™½ç„¶æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸è¿‡ç¬¬äºŒä¸ªåˆ†æ”¯å¾ˆå¿«é€šè¿‡è§£æè·¯å¾„è½¬æ¢ä¸º Resource ä»¥åä¹Ÿä¼šè¿›åˆ°è¿™é‡Œ@Overridepublic int loadBeanDefinitions(Resource... resources) throws BeanDefinitionStoreException &#123; Assert.notNull(resources, \"Resource array must not be null\"); int counter = 0; // æ³¨æ„è¿™é‡Œæ˜¯ä¸ª for å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª resource for (Resource resource : resources) &#123; // ç»§ç»­å¾€ä¸‹çœ‹ counter += loadBeanDefinitions(resource); &#125; // æœ€åè¿”å› counterï¼Œè¡¨ç¤ºæ€»å…±åŠ è½½äº†å¤šå°‘çš„ BeanDefinition return counter;&#125;// XmlBeanDefinitionReader 303@Overridepublic int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException &#123; return loadBeanDefinitions(new EncodedResource(resource));&#125;// XmlBeanDefinitionReader 314public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123; Assert.notNull(encodedResource, \"EncodedResource must not be null\"); if (logger.isInfoEnabled()) &#123; logger.info(\"Loading XML bean definitions from \" + encodedResource.getResource()); &#125; // ç”¨ä¸€ä¸ª ThreadLocal æ¥å­˜æ”¾é…ç½®æ–‡ä»¶èµ„æº Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get(); if (currentResources == null) &#123; currentResources = new HashSet&lt;EncodedResource&gt;(4); this.resourcesCurrentlyBeingLoaded.set(currentResources); &#125; if (!currentResources.add(encodedResource)) &#123; throw new BeanDefinitionStoreException( \"Detected cyclic loading of \" + encodedResource + \" - check your import definitions!\"); &#125; try &#123; InputStream inputStream = encodedResource.getResource().getInputStream(); try &#123; InputSource inputSource = new InputSource(inputStream); if (encodedResource.getEncoding() != null) &#123; inputSource.setEncoding(encodedResource.getEncoding()); &#125; // æ ¸å¿ƒéƒ¨åˆ†æ˜¯è¿™é‡Œï¼Œå¾€ä¸‹é¢çœ‹ return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); &#125; finally &#123; inputStream.close(); &#125; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( \"IOException parsing XML document from \" + encodedResource.getResource(), ex); &#125; finally &#123; currentResources.remove(encodedResource); if (currentResources.isEmpty()) &#123; this.resourcesCurrentlyBeingLoaded.remove(); &#125; &#125;&#125;// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 388 è¡Œprotected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException &#123; try &#123; // è¿™é‡Œå°±ä¸çœ‹äº†ï¼Œå°† xml æ–‡ä»¶è½¬æ¢ä¸º Document å¯¹è±¡ Document doc = doLoadDocument(inputSource, resource); // ç»§ç»­ return registerBeanDefinitions(doc, resource); &#125; catch (...&#125;// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 505 è¡Œ// è¿”å›å€¼ï¼šè¿”å›ä»å½“å‰é…ç½®æ–‡ä»¶åŠ è½½äº†å¤šå°‘æ•°é‡çš„ Beanpublic int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123; BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); // è¿™é‡Œ documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore;&#125;// DefaultBeanDefinitionDocumentReader 90@Overridepublic void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123; this.readerContext = readerContext; logger.debug(\"Loading bean definitions\"); Element root = doc.getDocumentElement(); // ä» xml æ ¹èŠ‚ç‚¹å¼€å§‹è§£ææ–‡ä»¶ doRegisterBeanDefinitions(root);&#125; ç»è¿‡æ¼«é•¿çš„é“¾è·¯ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶ç»ˆäºè½¬æ¢ä¸ºä¸€é¢— DOM æ ‘äº†ï¼Œæ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å…¶ä¸­ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„ï¼Œè¯»è€…å¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰ä¸ª for å¾ªç¯çš„ã€‚ä¸‹é¢å¼€å§‹ä»æ ¹èŠ‚ç‚¹å¼€å§‹è§£æï¼š doRegisterBeanDefinitionsï¼š123456789101112131415161718192021222324252627282930313233// DefaultBeanDefinitionDocumentReader 116protected void doRegisterBeanDefinitions(Element root) &#123; // æˆ‘ä»¬çœ‹åå­—å°±çŸ¥é“ï¼ŒBeanDefinitionParserDelegate å¿…å®šæ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œå®ƒè´Ÿè´£è§£æ Bean å®šä¹‰ï¼Œ // è¿™é‡Œä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸€ä¸ª parent? çœ‹åˆ°åé¢å°±çŸ¥é“äº†ï¼Œæ˜¯é€’å½’é—®é¢˜ï¼Œ // å› ä¸º &lt;beans /&gt; å†…éƒ¨æ˜¯å¯ä»¥å®šä¹‰ &lt;beans /&gt; çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„ root å…¶å®ä¸ä¸€å®šå°±æ˜¯ xml çš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯åµŒå¥—åœ¨é‡Œé¢çš„ &lt;beans /&gt; èŠ‚ç‚¹ï¼Œä»æºç åˆ†æçš„è§’åº¦ï¼Œæˆ‘ä»¬å½“åšæ ¹èŠ‚ç‚¹å°±å¥½äº† BeanDefinitionParserDelegate parent = this.delegate; this.delegate = createDelegate(getReaderContext(), root, parent); if (this.delegate.isDefaultNamespace(root)) &#123; // è¿™å—è¯´çš„æ˜¯æ ¹èŠ‚ç‚¹ &lt;beans ... profile=\"dev\" /&gt; ä¸­çš„ profile æ˜¯å¦æ˜¯å½“å‰ç¯å¢ƒéœ€è¦çš„ï¼Œ // å¦‚æœå½“å‰ç¯å¢ƒé…ç½®çš„ profile ä¸åŒ…å«æ­¤ profileï¼Œé‚£å°±ç›´æ¥ return äº†ï¼Œä¸å¯¹æ­¤ &lt;beans /&gt; è§£æ // ä¸ç†Ÿæ‚‰ profile ä¸ºä½•ç‰©ï¼Œä¸ç†Ÿæ‚‰æ€ä¹ˆé…ç½® profile è¯»è€…çš„è¯·ç§»æ­¥é™„å½•åŒº String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE); if (StringUtils.hasText(profileSpec)) &#123; String[] specifiedProfiles = StringUtils.tokenizeToStringArray( profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS); if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Skipped XML bean definition file due to specified profiles [\" + profileSpec + \"] not matching: \" + getReaderContext().getResource()); &#125; return; &#125; &#125; &#125; preProcessXml(root); // é’©å­ // å¾€ä¸‹çœ‹ parseBeanDefinitions(root, this.delegate); postProcessXml(root); // é’©å­ this.delegate = parent;&#125; preProcessXml(root) å’Œ postProcessXml(root) æ˜¯ç»™å­ç±»ç”¨çš„é’©å­æ–¹æ³•ï¼Œé‰´äºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ã€‚ è¿™é‡Œæ¶‰åŠåˆ°äº† profile çš„é—®é¢˜ï¼Œå¯¹äºä¸äº†è§£çš„è¯»è€…ï¼Œæˆ‘åœ¨é™„å½•ä¸­å¯¹ profile åšäº†ç®€å•çš„è§£é‡Šï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚ æ¥ä¸‹æ¥ï¼Œçœ‹æ ¸å¿ƒè§£ææ–¹æ³• parseBeanDefinitions(root, this.delegate) : 123456789101112131415161718192021222324// default namespace æ¶‰åŠåˆ°çš„å°±å››ä¸ªæ ‡ç­¾ &lt;import /&gt;ã€&lt;alias /&gt;ã€&lt;bean /&gt; å’Œ &lt;beans /&gt;ï¼Œ// å…¶ä»–çš„å±äº custom çš„protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123; if (delegate.isDefaultNamespace(root)) &#123; NodeList nl = root.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (node instanceof Element) &#123; Element ele = (Element) node; if (delegate.isDefaultNamespace(ele)) &#123; // è§£æ default namespace ä¸‹é¢çš„å‡ ä¸ªå…ƒç´  parseDefaultElement(ele, delegate); &#125; else &#123; // è§£æå…¶ä»– namespace çš„å…ƒç´  delegate.parseCustomElement(ele); &#125; &#125; &#125; &#125; else &#123; delegate.parseCustomElement(root); &#125;&#125; ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ¯ä¸ªé…ç½®æ¥è¯´ï¼Œåˆ†åˆ«è¿›å…¥åˆ° parseDefaultElement(ele, delegate); å’Œ delegate.parseCustomElement(ele); è¿™ä¸¤ä¸ªåˆ†æ”¯äº†ã€‚ parseDefaultElement(ele, delegate) ä»£è¡¨è§£æçš„èŠ‚ç‚¹æ˜¯ &lt;import /&gt;ã€&lt;alias /&gt;ã€&lt;bean /&gt;ã€&lt;beans /&gt; è¿™å‡ ä¸ªã€‚ è¿™é‡Œçš„å››ä¸ªæ ‡ç­¾ä¹‹æ‰€ä»¥æ˜¯ default çš„ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ˜¯å¤„äºè¿™ä¸ª namespace ä¸‹å®šä¹‰çš„ï¼š 1http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans åˆåˆ°åˆå­¦è€…ç§‘æ™®æ—¶é—´ï¼Œä¸ç†Ÿæ‚‰ namespace çš„è¯»è€…è¯·çœ‹ä¸‹é¢è´´å‡ºæ¥çš„ xmlï¼Œè¿™é‡Œçš„ç¬¬äºŒè¡Œ xmlns å°±æ˜¯å’¯ã€‚ 123456&lt;beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://www.springframework.org/schema/beans\" xsi:schemaLocation=\" http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\" default-autowire=\"byName\"&gt; è€Œå¯¹äºå…¶ä»–çš„æ ‡ç­¾ï¼Œå°†è¿›å…¥åˆ° delegate.parseCustomElement(element) è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ &lt;mvc /&gt;ã€&lt;task /&gt;ã€&lt;context /&gt;ã€&lt;aop /&gt;ç­‰ã€‚ è¿™äº›å±äºæ‰©å±•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸Šé¢è¿™äº› â€é defaultâ€œ æ ‡ç­¾ï¼Œé‚£ä¹ˆä¸Šé¢çš„ xml å¤´éƒ¨çš„åœ°æ–¹ä¹Ÿè¦å¼•å…¥ç›¸åº”çš„ namespace å’Œ .xsd æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åŒæ—¶ä»£ç ä¸­éœ€è¦æä¾›ç›¸åº”çš„ parser æ¥è§£æï¼Œå¦‚ MvcNamespaceHandlerã€TaskNamespaceHandlerã€ContextNamespaceHandlerã€AopNamespaceHandler ç­‰ã€‚ å‡å¦‚è¯»è€…æƒ³åˆ†æ &lt;context:property-placeholder location=&quot;classpath:xx.properties&quot; /&gt; çš„å®ç°åŸç†ï¼Œå°±åº”è¯¥åˆ° ContextNamespaceHandler ä¸­æ‰¾ç­”æ¡ˆã€‚ 12345678910111213&lt;beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://www.springframework.org/schema/beans\" xmlns:context=\"http://www.springframework.org/schema/context\" xmlns:mvc=\"http://www.springframework.org/schema/mvc\" xsi:schemaLocation=\" http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd \" default-autowire=\"byName\"&gt; åŒç†ï¼Œä»¥åä½ è¦æ˜¯ç¢°åˆ° &lt;dubbo /&gt; è¿™ç§æ ‡ç­¾ï¼Œé‚£ä¹ˆå°±åº”è¯¥æœä¸€æœæ˜¯ä¸æ˜¯æœ‰ DubboNamespaceHandler è¿™ä¸ªå¤„ç†ç±»ã€‚ å›è¿‡ç¥æ¥ï¼Œçœ‹çœ‹å¤„ç† default æ ‡ç­¾çš„æ–¹æ³•ï¼š 12345678910111213141516171819private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123; if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123; // å¤„ç† &lt;import /&gt; æ ‡ç­¾ importBeanDefinitionResource(ele); &#125; else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123; // å¤„ç† &lt;alias /&gt; æ ‡ç­¾å®šä¹‰ // &lt;alias name=\"fromName\" alias=\"toName\"/&gt; processAliasRegistration(ele); &#125; else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123; // å¤„ç† &lt;bean /&gt; æ ‡ç­¾å®šä¹‰ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘ä»¬çš„é‡ç‚¹å§ processBeanDefinition(ele, delegate); &#125; else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123; // å¦‚æœç¢°åˆ°çš„æ˜¯åµŒå¥—çš„ &lt;beans /&gt; æ ‡ç­¾ï¼Œéœ€è¦é€’å½’ doRegisterBeanDefinitions(ele); &#125;&#125; å¦‚æœæ¯ä¸ªæ ‡ç­¾éƒ½è¯´ï¼Œé‚£æˆ‘ä¸åè¡€ï¼Œä½ ä»¬éƒ½è¦åè¡€äº†ã€‚æˆ‘ä»¬æŒ‘æˆ‘ä»¬çš„é‡ç‚¹ &lt;bean /&gt; æ ‡ç­¾å‡ºæ¥è¯´ã€‚ processBeanDefinition è§£æ bean æ ‡ç­¾ä¸‹é¢æ˜¯ processBeanDefinition è§£æ &lt;bean /&gt; æ ‡ç­¾ï¼š // DefaultBeanDefinitionDocumentReader 298 1234567891011121314151617181920protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; // å°† &lt;bean /&gt; èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯æå–å‡ºæ¥ï¼Œç„¶åå°è£…åˆ°ä¸€ä¸ª BeanDefinitionHolder ä¸­ï¼Œç»†èŠ‚å¾€ä¸‹çœ‹ BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); // ä¸‹é¢çš„å‡ è¡Œå…ˆä¸è¦çœ‹ï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œåé¢ä¼šç»§ç»­è¯´çš„ if (bdHolder != null) &#123; bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // Register the final decorated instance. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error(\"Failed to register bean definition with name '\" + bdHolder.getBeanName() + \"'\", ele, ex); &#125; // Send registration event. getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); &#125;&#125; ç»§ç»­å¾€ä¸‹çœ‹æ€ä¹ˆè§£æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ &lt;bean /&gt; æ ‡ç­¾ä¸­å¯ä»¥å®šä¹‰å“ªäº›å±æ€§ï¼š Property class ç±»çš„å…¨é™å®šå name å¯æŒ‡å®š idã€name(ç”¨é€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”) scope ä½œç”¨åŸŸ constructor arguments æŒ‡å®šæ„é€ å‚æ•° properties è®¾ç½®å±æ€§çš„å€¼ autowiring mode no(é»˜è®¤å€¼)ã€byNameã€byTypeã€ constructor lazy-initialization mode æ˜¯å¦æ‡’åŠ è½½(å¦‚æœè¢«éæ‡’åŠ è½½çš„beanä¾èµ–äº†é‚£ä¹ˆå…¶å®ä¹Ÿå°±ä¸èƒ½æ‡’åŠ è½½äº†) initialization method bean å±æ€§è®¾ç½®å®Œæˆåï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• destruction method bean é”€æ¯åçš„å›è°ƒæ–¹æ³• ä¸Šé¢è¡¨æ ¼ä¸­çš„å†…å®¹æˆ‘æƒ³å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰å§ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œé‚£å°±æ˜¯ä½ ä¸å¤Ÿäº†è§£ Spring çš„é…ç½®äº†ã€‚ ç®€å•åœ°è¯´å°±æ˜¯åƒä¸‹é¢è¿™æ ·å­ï¼š 123456789101112131415&lt;bean id=\"exampleBean\" name=\"name1, name2, name3\" class=\"com.javadoop.ExampleBean\" scope=\"singleton\" lazy-init=\"true\" init-method=\"init\" destroy-method=\"cleanup\"&gt; &lt;!-- å¯ä»¥ç”¨ä¸‹é¢ä¸‰ç§å½¢å¼æŒ‡å®šæ„é€ å‚æ•° --&gt; &lt;constructor-arg type=\"int\" value=\"7500000\"/&gt; &lt;constructor-arg name=\"years\" value=\"7500000\"/&gt; &lt;constructor-arg index=\"0\" value=\"7500000\"/&gt; &lt;!-- property çš„å‡ ç§æƒ…å†µ --&gt; &lt;property name=\"beanOne\"&gt; &lt;ref bean=\"anotherExampleBean\"/&gt; &lt;/property&gt; &lt;property name=\"beanTwo\" ref=\"yetAnotherBean\"/&gt; &lt;property name=\"integerProperty\" value=\"1\"/&gt;&lt;/bean&gt; å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢ä¸¾ä¾‹å‡ºæ¥çš„è¿™äº›ï¼Œè¿˜æœ‰ factory-beanã€factory-methodã€&lt;lockup-method /&gt;ã€&lt;replaced-method /&gt;ã€&lt;meta /&gt;ã€&lt;qualifier /&gt; è¿™å‡ ä¸ªï¼Œå¤§å®¶æ˜¯ä¸æ˜¯ç†Ÿæ‚‰å‘¢ï¼Ÿè‡ªå·±æ£€éªŒä¸€ä¸‹è‡ªå·±å¯¹ Spring ä¸­ bean çš„äº†è§£ç¨‹åº¦ã€‚ æœ‰äº†ä»¥ä¸Šè¿™äº›çŸ¥è¯†ä»¥åï¼Œæˆ‘ä»¬å†ç»§ç»­å¾€é‡Œçœ‹æ€ä¹ˆè§£æ bean å…ƒç´ ï¼Œæ˜¯æ€ä¹ˆè½¬æ¢åˆ° BeanDefinitionHolder çš„ã€‚ // BeanDefinitionParserDelegate 428 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public BeanDefinitionHolder parseBeanDefinitionElement(Element ele) &#123; return parseBeanDefinitionElement(ele, null);&#125;public BeanDefinitionHolder parseBeanDefinitionElement(Element ele, BeanDefinition containingBean) &#123; String id = ele.getAttribute(ID_ATTRIBUTE); String nameAttr = ele.getAttribute(NAME_ATTRIBUTE); List&lt;String&gt; aliases = new ArrayList&lt;String&gt;(); // å°† name å±æ€§çš„å®šä¹‰æŒ‰ç…§ â€œé€—å·ã€åˆ†å·ã€ç©ºæ ¼â€ åˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ª åˆ«ååˆ—è¡¨æ•°ç»„ï¼Œ // å½“ç„¶ï¼Œå¦‚æœä½ ä¸å®šä¹‰ name å±æ€§çš„è¯ï¼Œå°±æ˜¯ç©ºçš„äº† // æˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ id å’Œ name çš„é…ç½®ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€çœ¼ï¼Œæœ‰ä¸ª20ç§’å°±å¯ä»¥äº† if (StringUtils.hasLength(nameAttr)) &#123; String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS); aliases.addAll(Arrays.asList(nameArr)); &#125; String beanName = id; // å¦‚æœæ²¡æœ‰æŒ‡å®šid, é‚£ä¹ˆç”¨åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªåå­—ä½œä¸ºbeanName if (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123; beanName = aliases.remove(0); if (logger.isDebugEnabled()) &#123; logger.debug(\"No XML 'id' specified - using '\" + beanName + \"' as bean name and \" + aliases + \" as aliases\"); &#125; &#125; if (containingBean == null) &#123; checkNameUniqueness(beanName, aliases, ele); &#125; // æ ¹æ® &lt;bean ...&gt;...&lt;/bean&gt; ä¸­çš„é…ç½®åˆ›å»º BeanDefinitionï¼Œç„¶åæŠŠé…ç½®ä¸­çš„ä¿¡æ¯éƒ½è®¾ç½®åˆ°å®ä¾‹ä¸­, // ç»†èŠ‚åé¢ç»†è¯´ï¼Œå…ˆçŸ¥é“ä¸‹é¢è¿™è¡Œç»“æŸåï¼Œä¸€ä¸ª BeanDefinition å®ä¾‹å°±å‡ºæ¥äº†ã€‚ AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean); // åˆ°è¿™é‡Œï¼Œæ•´ä¸ª &lt;bean /&gt; æ ‡ç­¾å°±ç®—è§£æç»“æŸäº†ï¼Œä¸€ä¸ª BeanDefinition å°±å½¢æˆäº†ã€‚ if (beanDefinition != null) &#123; // å¦‚æœéƒ½æ²¡æœ‰è®¾ç½® id å’Œ nameï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ beanName å°±ä¼šä¸º nullï¼Œè¿›å…¥ä¸‹é¢è¿™å—ä»£ç äº§ç”Ÿ // å¦‚æœè¯»è€…ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸éœ€è¦å…³å¿ƒè¿™å—ä»£ç ï¼Œå¯¹æœ¬æ–‡æºç åˆ†ææ¥è¯´ï¼Œè¿™äº›ä¸œè¥¿ä¸é‡è¦ if (!StringUtils.hasText(beanName)) &#123; try &#123; if (containingBean != null) &#123;// æŒ‰ç…§æˆ‘ä»¬çš„æ€è·¯ï¼Œè¿™é‡Œ containingBean æ˜¯ null çš„ beanName = BeanDefinitionReaderUtils.generateBeanName( beanDefinition, this.readerContext.getRegistry(), true); &#125; else &#123; // å¦‚æœæˆ‘ä»¬ä¸å®šä¹‰ id å’Œ nameï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼•è¨€é‡Œçš„é‚£ä¸ªä¾‹å­ï¼š // 1. beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0 // 2. beanClassName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl beanName = this.readerContext.generateBeanName(beanDefinition); String beanClassName = beanDefinition.getBeanClassName(); if (beanClassName != null &amp;&amp; beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp; !this.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123; // æŠŠ beanClassName è®¾ç½®ä¸º Bean çš„åˆ«å aliases.add(beanClassName); &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(\"Neither XML 'id' nor 'name' specified - \" + \"using generated bean name [\" + beanName + \"]\"); &#125; &#125; catch (Exception ex) &#123; error(ex.getMessage(), ele); return null; &#125; &#125; String[] aliasesArray = StringUtils.toStringArray(aliases); // è¿”å› BeanDefinitionHolder return new BeanDefinitionHolder(beanDefinition, beanName, aliasesArray); &#125; return null;&#125; ç„¶åï¼Œæˆ‘ä»¬å†çœ‹çœ‹æ€ä¹ˆæ ¹æ®é…ç½®åˆ›å»º BeanDefinition å®ä¾‹çš„ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960public AbstractBeanDefinition parseBeanDefinitionElement( Element ele, String beanName, BeanDefinition containingBean) &#123; this.parseState.push(new BeanEntry(beanName)); String className = null; if (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123; className = ele.getAttribute(CLASS_ATTRIBUTE).trim(); &#125; try &#123; String parent = null; if (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123; parent = ele.getAttribute(PARENT_ATTRIBUTE); &#125; // åˆ›å»º BeanDefinitionï¼Œç„¶åè®¾ç½®ç±»ä¿¡æ¯è€Œå·²ï¼Œå¾ˆç®€å•ï¼Œå°±ä¸è´´ä»£ç äº† AbstractBeanDefinition bd = createBeanDefinition(className, parent); // è®¾ç½® BeanDefinition çš„ä¸€å †å±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰åœ¨ AbstractBeanDefinition ä¸­ parseBeanDefinitionAttributes(ele, beanName, containingBean, bd); bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT)); /** * ä¸‹é¢çš„ä¸€å †æ˜¯è§£æ &lt;bean&gt;......&lt;/bean&gt; å†…éƒ¨çš„å­å…ƒç´ ï¼Œ * è§£æå‡ºæ¥ä»¥åçš„ä¿¡æ¯éƒ½æ”¾åˆ° bd çš„å±æ€§ä¸­ */ // è§£æ &lt;meta /&gt; parseMetaElements(ele, bd); // è§£æ &lt;lookup-method /&gt; parseLookupOverrideSubElements(ele, bd.getMethodOverrides()); // è§£æ &lt;replaced-method /&gt; parseReplacedMethodSubElements(ele, bd.getMethodOverrides()); // è§£æ &lt;constructor-arg /&gt; parseConstructorArgElements(ele, bd); // è§£æ &lt;property /&gt; parsePropertyElements(ele, bd); // è§£æ &lt;qualifier /&gt; parseQualifierElements(ele, bd); bd.setResource(this.readerContext.getResource()); bd.setSource(extractSource(ele)); return bd; &#125; catch (ClassNotFoundException ex) &#123; error(\"Bean class [\" + className + \"] not found\", ele, ex); &#125; catch (NoClassDefFoundError err) &#123; error(\"Class that bean class [\" + className + \"] depends on not found\", ele, err); &#125; catch (Throwable ex) &#123; error(\"Unexpected failure during bean definition parsing\", ele, ex); &#125; finally &#123; this.parseState.pop(); &#125; return null;&#125; åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¹æ® &lt;bean /&gt; é…ç½®åˆ›å»ºäº†ä¸€ä¸ª BeanDefinitionHolder å®ä¾‹ã€‚æ³¨æ„ï¼Œæ˜¯ä¸€ä¸ªã€‚ æˆ‘ä»¬å›åˆ°è§£æ &lt;bean /&gt; çš„å…¥å£æ–¹æ³•: 123456789101112131415161718protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; // å°† &lt;bean /&gt; èŠ‚ç‚¹è½¬æ¢ä¸º BeanDefinitionHolderï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ä¸€å † BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) &#123; // å¦‚æœæœ‰è‡ªå®šä¹‰å±æ€§çš„è¯ï¼Œè¿›è¡Œç›¸åº”çš„è§£æï¼Œå…ˆå¿½ç•¥ bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // æˆ‘ä»¬æŠŠè¿™æ­¥å«åš æ³¨å†ŒBean å§ BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error(\"Failed to register bean definition with name '\" + bdHolder.getBeanName() + \"'\", ele, ex); &#125; // æ³¨å†Œå®Œæˆåï¼Œå‘é€äº‹ä»¶ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´è¿™ä¸ª getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); &#125;&#125; å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹è¿™å—å§ï¼Œæˆ‘ä»¬åé¢å°±ä¸å›æ¥è¯´è¿™ä¸ªäº†ã€‚è¿™é‡Œå·²ç»æ ¹æ®ä¸€ä¸ª &lt;bean /&gt; æ ‡ç­¾äº§ç”Ÿäº†ä¸€ä¸ª BeanDefinitionHolder çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹é‡Œé¢ä¹Ÿå°±æ˜¯ä¸€ä¸ª BeanDefinition çš„å®ä¾‹å’Œå®ƒçš„ beanNameã€aliases è¿™ä¸‰ä¸ªä¿¡æ¯ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹å§‹ç»ˆåœ¨ BeanDefinition ä¸Šï¼š 12345678public class BeanDefinitionHolder implements BeanMetadataElement &#123; private final BeanDefinition beanDefinition; private final String beanName; private final String[] aliases;... ç„¶åæˆ‘ä»¬å‡†å¤‡æ³¨å†Œè¿™ä¸ª BeanDefinitionï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ªæ³¨å†Œäº‹ä»¶å‘é€å‡ºå»ã€‚ ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹è¯´è¯´æ³¨å†Œ Bean å§ã€‚ æ³¨å†Œ Bean// BeanDefinitionReaderUtils 143 123456789101112131415161718public static void registerBeanDefinition( BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException &#123; String beanName = definitionHolder.getBeanName(); // æ³¨å†Œè¿™ä¸ª Bean registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); // å¦‚æœè¿˜æœ‰åˆ«åçš„è¯ï¼Œä¹Ÿè¦æ ¹æ®åˆ«åå…¨éƒ¨æ³¨å†Œä¸€éï¼Œä¸ç„¶æ ¹æ®åˆ«åå°±ä¼šæ‰¾ä¸åˆ° Bean äº† String[] aliases = definitionHolder.getAliases(); if (aliases != null) &#123; for (String alias : aliases) &#123; // alias -&gt; beanName ä¿å­˜å®ƒä»¬çš„åˆ«åä¿¡æ¯ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ª map ä¿å­˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œ // è·å–çš„æ—¶å€™ï¼Œä¼šå…ˆå°† alias è½¬æ¢ä¸º beanNameï¼Œç„¶åå†æŸ¥æ‰¾ registry.registerAlias(beanName, alias); &#125; &#125;&#125; åˆ«åæ³¨å†Œçš„æ”¾ä¸€è¾¹ï¼Œæ¯•ç«Ÿå®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ³¨å†Œ Beanã€‚ // DefaultListableBeanFactory 793 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182@Overridepublic void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException &#123; Assert.hasText(beanName, \"Bean name must not be empty\"); Assert.notNull(beanDefinition, \"BeanDefinition must not be null\"); if (beanDefinition instanceof AbstractBeanDefinition) &#123; try &#123; ((AbstractBeanDefinition) beanDefinition).validate(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException(...); &#125; &#125; // old? è¿˜è®°å¾— â€œå…è®¸ bean è¦†ç›–â€ è¿™ä¸ªé…ç½®å—ï¼ŸallowBeanDefinitionOverriding BeanDefinition oldBeanDefinition; // ä¹‹åä¼šçœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Bean æ³¨å†Œåä¼šæ”¾å…¥è¿™ä¸ª beanDefinitionMap ä¸­ oldBeanDefinition = this.beanDefinitionMap.get(beanName); // å¤„ç†é‡å¤åç§°çš„ Bean å®šä¹‰çš„æƒ…å†µ if (oldBeanDefinition != null) &#123; if (!isAllowBeanDefinitionOverriding()) &#123; // å¦‚æœä¸å…è®¸è¦†ç›–çš„è¯ï¼ŒæŠ›å¼‚å¸¸ throw new BeanDefinitionStoreException(beanDefinition.getResourceDescription()... &#125; else if (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123; // log...ç”¨æ¡†æ¶å®šä¹‰çš„ Bean è¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰çš„ Bean &#125; else if (!beanDefinition.equals(oldBeanDefinition)) &#123; // log...ç”¨æ–°çš„ Bean è¦†ç›–æ—§çš„ Bean &#125; else &#123; // log...ç”¨åŒç­‰çš„ Bean è¦†ç›–æ—§çš„ Beanï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ equals æ–¹æ³•è¿”å› true çš„ Bean &#125; // è¦†ç›– this.beanDefinitionMap.put(beanName, beanDefinition); &#125; else &#123; // åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰å…¶ä»–çš„ Bean å¼€å§‹åˆå§‹åŒ–äº†. // æ³¨æ„ï¼Œ\"æ³¨å†ŒBean\" è¿™ä¸ªåŠ¨ä½œç»“æŸï¼ŒBean ä¾ç„¶è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åé¢ä¼šæœ‰å¤§ç¯‡å¹…è¯´åˆå§‹åŒ–è¿‡ç¨‹ï¼Œ // åœ¨ Spring å®¹å™¨å¯åŠ¨çš„æœ€åï¼Œä¼š é¢„åˆå§‹åŒ– æ‰€æœ‰çš„ singleton beans if (hasBeanCreationStarted()) &#123; // Cannot modify startup-time collection elements anymore (for stable iteration) synchronized (this.beanDefinitionMap) &#123; this.beanDefinitionMap.put(beanName, beanDefinition); List&lt;String&gt; updatedDefinitions = new ArrayList&lt;String&gt;(this.beanDefinitionNames.size() + 1); updatedDefinitions.addAll(this.beanDefinitionNames); updatedDefinitions.add(beanName); this.beanDefinitionNames = updatedDefinitions; if (this.manualSingletonNames.contains(beanName)) &#123; Set&lt;String&gt; updatedSingletons = new LinkedHashSet&lt;String&gt;(this.manualSingletonNames); updatedSingletons.remove(beanName); this.manualSingletonNames = updatedSingletons; &#125; &#125; &#125; else &#123; // æœ€æ­£å¸¸çš„åº”è¯¥æ˜¯è¿›åˆ°è¿™ä¸ªåˆ†æ”¯ã€‚ // å°† BeanDefinition æ”¾åˆ°è¿™ä¸ª map ä¸­ï¼Œè¿™ä¸ª map ä¿å­˜äº†æ‰€æœ‰çš„ BeanDefinition this.beanDefinitionMap.put(beanName, beanDefinition); // è¿™æ˜¯ä¸ª ArrayListï¼Œæ‰€ä»¥ä¼šæŒ‰ç…§ bean é…ç½®çš„é¡ºåºä¿å­˜æ¯ä¸€ä¸ªæ³¨å†Œçš„ Bean çš„åå­— this.beanDefinitionNames.add(beanName); // è¿™æ˜¯ä¸ª LinkedHashSetï¼Œä»£è¡¨çš„æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ singleton beanï¼Œ // æ³¨æ„è¿™é‡Œæ˜¯ remove æ–¹æ³•ï¼Œåˆ°è¿™é‡Œçš„ Bean å½“ç„¶ä¸æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ // æ‰‹åŠ¨æŒ‡çš„æ˜¯é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ³¨å†Œçš„ bean ï¼š // registerSingleton(String beanName, Object singletonObject) // è¿™ä¸æ˜¯é‡ç‚¹ï¼Œè§£é‡Šåªæ˜¯ä¸ºäº†ä¸è®©å¤§å®¶ç–‘æƒ‘ã€‚Spring ä¼šåœ¨åé¢\"æ‰‹åŠ¨\"æ³¨å†Œä¸€äº› Beanï¼Œ // å¦‚ \"environment\"ã€\"systemProperties\" ç­‰ beanï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ³¨å†Œ Bean åˆ°å®¹å™¨ä¸­çš„ this.manualSingletonNames.remove(beanName); &#125; // è¿™ä¸ªä¸é‡è¦ï¼Œåœ¨é¢„åˆå§‹åŒ–çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸å¿…ç®¡å®ƒã€‚ this.frozenBeanDefinitionNames = null; &#125; if (oldBeanDefinition != null || containsSingleton(beanName)) &#123; resetBeanDefinition(beanName); &#125;&#125; æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°è¿™é‡Œå·²ç»åˆå§‹åŒ–äº† Bean å®¹å™¨ï¼Œ&lt;bean /&gt; é…ç½®ä¹Ÿç›¸åº”çš„è½¬æ¢ä¸ºäº†ä¸€ä¸ªä¸ª BeanDefinitionï¼Œç„¶åæ³¨å†Œäº†å„ä¸ª BeanDefinition åˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ä¸”å‘é€äº†æ³¨å†Œäº‹ä»¶ã€‚ â€”â€”â€” åˆ†å‰²çº¿ â€”â€”â€” åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œå‰é¢çš„å†…å®¹éƒ½è¿˜ç®—æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡åº”è¯¥ä¹Ÿæ¯”è¾ƒç¹çï¼Œå¤§å®¶è¦æ¸…æ¥šåœ°çŸ¥é“å‰é¢éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚ Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆåè¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ï¼Œæˆ‘é‡æ–°è´´äº†ä¸€éä»£ç ï¼Œçœ‹çœ‹æˆ‘ä»¬è¯´åˆ°å“ªäº†ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰è¯´å®Œ obtainFreshBeanFactory() æ–¹æ³•ã€‚ è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œå¼€å§‹å¤§å¹…ç¼©å‡æ‰æ²¡å¿…è¦è¯¦ç»†ä»‹ç»çš„éƒ¨åˆ†ï¼Œå¤§å®¶ç›´æ¥çœ‹ä¸‹é¢çš„ä»£ç ä¸­çš„æ³¨é‡Šå°±å¥½äº†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980@Overridepublic void refresh() throws BeansException, IllegalStateException &#123; // æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜› synchronized (this.startupShutdownMonitor) &#123; // å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦ prepareRefresh(); // è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ // å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ // æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map) ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean // è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´ prepareBeanFactory(beanFactory); try &#123; // ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ // é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘ // è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ– // å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹ postProcessBeanFactory(beanFactory); // è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) å›è°ƒæ–¹æ³• invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ« // æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization // ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œï¼Œä¹‹åä¼šçœ‹åˆ°å›è°ƒè¿™ä¸¤æ–¹æ³•çš„æ—¶æœº registerBeanPostProcessors(beanFactory); // åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº† initMessageSource(); // åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº† initApplicationEventMulticaster(); // ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œä¸å±•å¼€è¯´ // å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰ onRefresh(); // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡ registerListeners(); // é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹ // åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans //ï¼ˆlazy-init çš„é™¤å¤–ï¼‰ finishBeanFactoryInitialization(beanFactory); // æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆï¼Œä¸å±•å¼€ finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(\"Exception encountered during context initialization - \" + \"cancelling refresh attempt: \" + ex); &#125; // Destroy already created singletons to avoid dangling resources. // é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº destroyBeans(); // Reset 'active' flag. cancelRefresh(ex); // æŠŠå¼‚å¸¸å¾€å¤–æŠ› throw ex; &#125; finally &#123; // Reset common introspection caches in Spring's core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); &#125; &#125;&#125; å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactoryä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒSpring æŠŠæˆ‘ä»¬åœ¨ xml é…ç½®çš„ bean éƒ½æ³¨å†Œä»¥åï¼Œä¼šâ€æ‰‹åŠ¨â€æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„ beanã€‚ è¿™é‡Œç®€å•ä»‹ç»ä¸‹ prepareBeanFactory(factory) æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374/** * Configure the factory's standard context characteristics, * such as the context's ClassLoader and post-processors. * @param beanFactory the BeanFactory to configure */protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; // è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬çŸ¥é“ BeanFactory éœ€è¦åŠ è½½ç±»ï¼Œä¹Ÿå°±éœ€è¦ç±»åŠ è½½å™¨ï¼Œ // è¿™é‡Œè®¾ç½®ä¸ºåŠ è½½å½“å‰ ApplicationContext ç±»çš„ç±»åŠ è½½å™¨ beanFactory.setBeanClassLoader(getClassLoader()); // è®¾ç½® BeanExpressionResolver beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader())); // beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment())); // æ·»åŠ ä¸€ä¸ª BeanPostProcessorï¼Œè¿™ä¸ª processor æ¯”è¾ƒç®€å•ï¼š // å®ç°äº† Aware æ¥å£çš„ beans åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ª processor è´Ÿè´£å›è°ƒï¼Œ // è¿™ä¸ªæˆ‘ä»¬å¾ˆå¸¸ç”¨ï¼Œå¦‚æˆ‘ä»¬ä¼šä¸ºäº†è·å– ApplicationContext è€Œ implement ApplicationContextAware // æ³¨æ„ï¼šå®ƒä¸ä»…ä»…å›è°ƒ ApplicationContextAwareï¼Œ // è¿˜ä¼šè´Ÿè´£å›è°ƒ EnvironmentAwareã€ResourceLoaderAware ç­‰ï¼Œçœ‹ä¸‹æºç å°±æ¸…æ¥šäº† beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this)); // ä¸‹é¢å‡ è¡Œçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœæŸä¸ª bean ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œåœ¨è‡ªåŠ¨è£…é…çš„æ—¶å€™å¿½ç•¥å®ƒä»¬ï¼Œ // Spring ä¼šé€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†è¿™äº›ä¾èµ–ã€‚ beanFactory.ignoreDependencyInterface(EnvironmentAware.class); beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class); beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class); beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class); beanFactory.ignoreDependencyInterface(MessageSourceAware.class); beanFactory.ignoreDependencyInterface(ApplicationContextAware.class); /** * ä¸‹é¢å‡ è¡Œå°±æ˜¯ä¸ºç‰¹æ®Šçš„å‡ ä¸ª bean èµ‹å€¼ï¼Œå¦‚æœæœ‰ bean ä¾èµ–äº†ä»¥ä¸‹å‡ ä¸ªï¼Œä¼šæ³¨å…¥è¿™è¾¹ç›¸åº”çš„å€¼ï¼Œ * ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ\"å½“å‰ ApplicationContext æŒæœ‰ä¸€ä¸ª BeanFactory\"ï¼Œè¿™é‡Œè§£é‡Šäº†ç¬¬ä¸€è¡Œã€‚ * ApplicationContext è¿˜ç»§æ‰¿äº† ResourceLoaderã€ApplicationEventPublisherã€MessageSource * æ‰€ä»¥å¯¹äºè¿™å‡ ä¸ªä¾èµ–ï¼Œå¯ä»¥èµ‹å€¼ä¸º thisï¼Œæ³¨æ„ this æ˜¯ä¸€ä¸ª ApplicationContext * é‚£è¿™é‡Œæ€ä¹ˆæ²¡çœ‹åˆ°ä¸º MessageSource èµ‹å€¼å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º MessageSource è¢«æ³¨å†Œæˆä¸ºäº†ä¸€ä¸ªæ™®é€šçš„ bean */ beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory); beanFactory.registerResolvableDependency(ResourceLoader.class, this); beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this); beanFactory.registerResolvableDependency(ApplicationContext.class, this); // è¿™ä¸ª BeanPostProcessor ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ bean å®ä¾‹åŒ–åï¼Œå¦‚æœæ˜¯ ApplicationListener çš„å­ç±»ï¼Œ // é‚£ä¹ˆå°†å…¶æ·»åŠ åˆ° listener åˆ—è¡¨ä¸­ï¼Œå¯ä»¥ç†è§£æˆï¼šæ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this)); // è¿™é‡Œæ¶‰åŠåˆ°ç‰¹æ®Šçš„ beanï¼Œåä¸ºï¼šloadTimeWeaverï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œå¿½ç•¥å®ƒ // tips: ltw æ˜¯ AspectJ çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œç»‡å…¥ï¼Œè¿™ä¸ªå’Œ Spring AOP ä¸ä¸€æ ·ï¼Œ // æ„Ÿå…´è¶£çš„è¯»è€…è¯·å‚è€ƒæˆ‘å†™çš„å…³äº AspectJ çš„å¦ä¸€ç¯‡æ–‡ç«  https://www.javadoop.com/post/aspectj if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); // Set a temporary ClassLoader for type matching. beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125; /** * ä»ä¸‹é¢å‡ è¡Œä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒSpring å¾€å¾€å¾ˆ \"æ™ºèƒ½\" å°±æ˜¯å› ä¸ºå®ƒä¼šå¸®æˆ‘ä»¬é»˜è®¤æ³¨å†Œä¸€äº›æœ‰ç”¨çš„ beanï¼Œ * æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›– */ // å¦‚æœæ²¡æœ‰å®šä¹‰ \"environment\" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š \"æ‰‹åŠ¨\" æ³¨å†Œä¸€ä¸ª if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment()); &#125; // å¦‚æœæ²¡æœ‰å®šä¹‰ \"systemProperties\" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š \"æ‰‹åŠ¨\" æ³¨å†Œä¸€ä¸ª if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties()); &#125; // å¦‚æœæ²¡æœ‰å®šä¹‰ \"systemEnvironment\" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š \"æ‰‹åŠ¨\" æ³¨å†Œä¸€ä¸ª if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment()); &#125;&#125; åœ¨ä¸Šé¢è¿™å—ä»£ç ä¸­ï¼ŒSpring å¯¹ä¸€äº›ç‰¹æ®Šçš„ bean è¿›è¡Œäº†å¤„ç†ï¼Œè¯»è€…å¦‚æœæš‚æ—¶è¿˜ä¸èƒ½æ¶ˆåŒ–å®ƒä»¬ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ…¢æ…¢å¾€ä¸‹çœ‹ã€‚ åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansæˆ‘ä»¬çš„é‡ç‚¹å½“ç„¶æ˜¯ finishBeanFactoryInitialization(beanFactory); è¿™ä¸ªå·¨å¤´äº†ï¼Œè¿™é‡Œä¼šè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚ æ³¨æ„ï¼Œåé¢çš„æè¿°ä¸­ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨åˆå§‹åŒ–æˆ–é¢„åˆå§‹åŒ–æ¥ä»£è¡¨è¿™ä¸ªé˜¶æ®µï¼ŒSpring ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå®Œæˆæ‰€æœ‰çš„ singleton beans çš„å®ä¾‹åŒ–ã€‚ æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”è¯¥è¯´ BeanFactory å·²ç»åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ Bean éƒ½å·²ç»åˆå§‹åŒ–å¹¶ä¸”å…¶ä¸­çš„ postProcessBeanFactory(factory) æ–¹æ³•å·²ç»å¾—åˆ°å›è°ƒæ‰§è¡Œäº†ã€‚è€Œä¸” Spring å·²ç»â€œæ‰‹åŠ¨â€æ³¨å†Œäº†ä¸€äº›ç‰¹æ®Šçš„ Beanï¼Œå¦‚ environmentã€systemProperties ç­‰ã€‚ å‰©ä¸‹çš„å°±æ˜¯åˆå§‹åŒ– singleton beans äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒä»¬æ˜¯å•ä¾‹çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ‡’åŠ è½½ï¼Œé‚£ä¹ˆ Spring ä¼šåœ¨æ¥ä¸‹æ¥åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚ // AbstractApplicationContext.java 834 1234567891011121314151617181920212223242526272829303132333435363738394041// åˆå§‹åŒ–å‰©ä½™çš„ singleton beansprotected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123; // é¦–å…ˆï¼Œåˆå§‹åŒ–åå­—ä¸º conversionService çš„ Beanã€‚æœ¬ç€é€ä½›é€åˆ°è¥¿çš„ç²¾ç¥ï¼Œæˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ ConversionServiceï¼Œå› ä¸ºè¿™å®åœ¨å¤ªå®ç”¨äº† // ä»€ä¹ˆï¼Œçœ‹ä»£ç è¿™é‡Œæ²¡æœ‰åˆå§‹åŒ– Bean å•Šï¼ // æ³¨æ„äº†ï¼Œåˆå§‹åŒ–çš„åŠ¨ä½œåŒ…è£…åœ¨ beanFactory.getBean(...) ä¸­ï¼Œè¿™é‡Œå…ˆä¸è¯´ç»†èŠ‚ï¼Œå…ˆå¾€ä¸‹çœ‹å§ if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123; beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); &#125; // Register a default embedded value resolver if no bean post-processor // (such as a PropertyPlaceholderConfigurer bean) registered any before: // at this point, primarily for resolution in annotation attribute values. if (!beanFactory.hasEmbeddedValueResolver()) &#123; beanFactory.addEmbeddedValueResolver(new StringValueResolver() &#123; @Override public String resolveStringValue(String strVal) &#123; return getEnvironment().resolvePlaceholders(strVal); &#125; &#125;); &#125; // å…ˆåˆå§‹åŒ– LoadTimeWeaverAware ç±»å‹çš„ Bean // ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè¿™æ˜¯ AspectJ ç›¸å…³çš„å†…å®¹ï¼Œæ”¾å¿ƒè·³è¿‡å§ String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) &#123; getBean(weaverAwareName); &#125; // Stop using the temporary ClassLoader for type matching. beanFactory.setTempClassLoader(null); // æ²¡ä»€ä¹ˆåˆ«çš„ç›®çš„ï¼Œå› ä¸ºåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼ŒSpring å·²ç»å¼€å§‹é¢„åˆå§‹åŒ– singleton beans äº†ï¼Œ // è‚¯å®šä¸å¸Œæœ›è¿™ä¸ªæ—¶å€™è¿˜å‡ºç° bean å®šä¹‰è§£æã€åŠ è½½ã€æ³¨å†Œã€‚ beanFactory.freezeConfiguration(); // å¼€å§‹åˆå§‹åŒ– beanFactory.preInstantiateSingletons();&#125; ä»ä¸Šé¢æœ€åä¸€è¡Œå¾€é‡Œçœ‹ï¼Œæˆ‘ä»¬å°±åˆå›åˆ° DefaultListableBeanFactory è¿™ä¸ªç±»äº†ï¼Œè¿™ä¸ªç±»å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿäº†å§ã€‚ preInstantiateSingletons// DefaultListableBeanFactory 728 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768@Overridepublic void preInstantiateSingletons() throws BeansException &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug(\"Pre-instantiating singletons in \" + this); &#125; // this.beanDefinitionNames ä¿å­˜äº†æ‰€æœ‰çš„ beanNames List&lt;String&gt; beanNames = new ArrayList&lt;String&gt;(this.beanDefinitionNames); // ä¸‹é¢è¿™ä¸ªå¾ªç¯ï¼Œè§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans çš„åˆå§‹åŒ–æ“ä½œ for (String beanName : beanNames) &#123; // åˆå¹¶çˆ¶ Bean ä¸­çš„é…ç½®ï¼Œæ³¨æ„ &lt;bean id=\"\" class=\"\" parent=\"\" /&gt; ä¸­çš„ parentï¼Œç”¨çš„ä¸å¤šå§ï¼Œ // è€ƒè™‘åˆ°è¿™å¯èƒ½ä¼šå½±å“å¤§å®¶çš„ç†è§£ï¼Œæˆ‘åœ¨é™„å½•ä¸­è§£é‡Šäº†ä¸€ä¸‹ \"Bean ç»§æ‰¿\"ï¼Œä¸äº†è§£çš„è¯·åˆ°é™„å½•ä¸­çœ‹ä¸€ä¸‹ RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // éæŠ½è±¡ã€éæ‡’åŠ è½½çš„ singletonsã€‚å¦‚æœé…ç½®äº† 'abstract = true'ï¼Œé‚£æ˜¯ä¸éœ€è¦åˆå§‹åŒ–çš„ if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123; // å¤„ç† FactoryBean(è¯»è€…å¦‚æœä¸ç†Ÿæ‚‰ FactoryBeanï¼Œè¯·ç§»æ­¥é™„å½•åŒºäº†è§£) if (isFactoryBean(beanName)) &#123; // FactoryBean çš„è¯ï¼Œåœ¨ beanName å‰é¢åŠ ä¸Š â€˜&amp;â€™ ç¬¦å·ã€‚å†è°ƒç”¨ getBeanï¼ŒgetBean æ–¹æ³•åˆ«æ€¥ final FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName); // åˆ¤æ–­å½“å‰ FactoryBean æ˜¯å¦æ˜¯ SmartFactoryBean çš„å®ç°ï¼Œæ­¤å¤„å¿½ç•¥ï¼Œç›´æ¥è·³è¿‡ boolean isEagerInit; if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) &#123; isEagerInit = AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() &#123; @Override public Boolean run() &#123; return ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit(); &#125; &#125;, getAccessControlContext()); &#125; else &#123; isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp; ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit()); &#125; if (isEagerInit) &#123; getBean(beanName); &#125; &#125; else &#123; // å¯¹äºæ™®é€šçš„ Beanï¼Œåªè¦è°ƒç”¨ getBean(beanName) è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è¿›è¡Œåˆå§‹åŒ–äº† getBean(beanName); &#125; &#125; &#125; // åˆ°è¿™é‡Œè¯´æ˜æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans å·²ç»å®Œæˆäº†åˆå§‹åŒ– // å¦‚æœæˆ‘ä»¬å®šä¹‰çš„ bean æ˜¯å®ç°äº† SmartInitializingSingleton æ¥å£çš„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå¾—åˆ°å›è°ƒï¼Œå¿½ç•¥ for (String beanName : beanNames) &#123; Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) &#123; final SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123; @Override public Object run() &#123; smartSingleton.afterSingletonsInstantiated(); return null; &#125; &#125;, getAccessControlContext()); &#125; else &#123; smartSingleton.afterSingletonsInstantiated(); &#125; &#125; &#125;&#125; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ° getBean(beanName) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ç»å¸¸ç”¨æ¥ä» BeanFactory ä¸­è·å–ä¸€ä¸ª Beanï¼Œè€Œåˆå§‹åŒ–çš„è¿‡ç¨‹ä¹Ÿå°è£…åˆ°äº†è¿™ä¸ªæ–¹æ³•é‡Œã€‚ getBeanåœ¨ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè¯»è€…åº”è¯¥å…·å¤‡ FactoryBean çš„çŸ¥è¯†ï¼Œå¦‚æœè¯»è€…è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ç§»æ­¥é™„å½•éƒ¨åˆ†äº†è§£ FactoryBeanã€‚ // AbstractBeanFactory 196 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176@Overridepublic Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false);&#125;// æˆ‘ä»¬åœ¨å‰–æåˆå§‹åŒ– Bean çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ getBean æ–¹æ³•æˆ‘ä»¬ç»å¸¸æ˜¯ç”¨æ¥ä»å®¹å™¨ä¸­è·å– Bean ç”¨çš„ï¼Œæ³¨æ„åˆ‡æ¢æ€è·¯ï¼Œ// å·²ç»åˆå§‹åŒ–è¿‡äº†å°±ä»å®¹å™¨ä¸­ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±å…ˆåˆå§‹åŒ–å†è¿”å›@SuppressWarnings(\"unchecked\")protected &lt;T&gt; T doGetBean( final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException &#123; // è·å–ä¸€ä¸ª â€œæ­£ç»Ÿçš„â€ beanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean(å‰é¢å¸¦ â€˜&amp;â€™)ï¼Œ // ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„ final String beanName = transformedBeanName(name); // æ³¨æ„è·Ÿç€è¿™ä¸ªï¼Œè¿™ä¸ªæ˜¯è¿”å›å€¼ Object bean; // æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯å·²ç»åˆ›å»ºè¿‡äº† Object sharedInstance = getSingleton(beanName); // è¿™é‡Œè¯´ä¸‹ args å‘—ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸€ç‚¹ä¸é‡è¦ã€‚å‰é¢æˆ‘ä»¬ä¸€è·¯è¿›æ¥çš„æ—¶å€™éƒ½æ˜¯ getBean(beanName)ï¼Œ // æ‰€ä»¥ args ä¼ å‚å…¶å®æ˜¯ null çš„ï¼Œä½†æ˜¯å¦‚æœ args ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆæ„å‘³ç€è°ƒç”¨æ–¹ä¸æ˜¯å¸Œæœ›è·å– Beanï¼Œè€Œæ˜¯åˆ›å»º Bean if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isDebugEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.debug(\"...\"); &#125; else &#123; logger.debug(\"Returning cached instance of singleton bean '\" + beanName + \"'\"); &#125; &#125; // ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼šå¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼Œ // å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡ // (FactoryBean çŸ¥è¯†ï¼Œè¯»è€…è‹¥ä¸æ¸…æ¥šè¯·ç§»æ­¥é™„å½•) bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; else &#123; if (isPrototypeCurrentlyInCreation(beanName)) &#123; // åˆ›å»ºè¿‡äº†æ­¤ beanName çš„ prototype ç±»å‹çš„ beanï¼Œé‚£ä¹ˆæŠ›å¼‚å¸¸ï¼Œ // å¾€å¾€æ˜¯å› ä¸ºé™·å…¥äº†å¾ªç¯å¼•ç”¨ throw new BeanCurrentlyInCreationException(beanName); &#125; // æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨ BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // å¦‚æœå½“å‰å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª BeanDefinitionï¼Œè¯•è¯•çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰ String nameToLookup = originalBeanName(name); if (args != null) &#123; // è¿”å›çˆ¶å®¹å™¨çš„æŸ¥è¯¢ç»“æœ return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; &#125; if (!typeCheckOnly) &#123; // typeCheckOnly ä¸º falseï¼Œå°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚ markBeanAsCreated(beanName); &#125; /* * ç¨ç¨æ€»ç»“ä¸€ä¸‹ï¼š * åˆ°è¿™é‡Œçš„è¯ï¼Œè¦å‡†å¤‡åˆ›å»º Bean äº†ï¼Œå¯¹äº singleton çš„ Bean æ¥è¯´ï¼Œå®¹å™¨ä¸­è¿˜æ²¡åˆ›å»ºè¿‡æ­¤ Beanï¼› * å¯¹äº prototype çš„ Bean æ¥è¯´ï¼Œæœ¬æ¥å°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Beanã€‚ */ try &#123; final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // å…ˆåˆå§‹åŒ–ä¾èµ–çš„æ‰€æœ‰ Beanï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚ // æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–æŒ‡çš„æ˜¯ depends-on ä¸­å®šä¹‰çš„ä¾èµ– String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; // æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œçš„å¾ªç¯ä¾èµ–å’Œæˆ‘ä»¬å‰é¢è¯´çš„å¾ªç¯ä¾èµ–åˆä¸ä¸€æ ·ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¸å…è®¸å‡ºç°çš„ï¼Œä¸ç„¶è¦ä¹±å¥—äº†ï¼Œè¯»è€…æƒ³ä¸€ä¸‹å°±çŸ¥é“äº† if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Circular depends-on relationship between '\" + beanName + \"' and '\" + dep + \"'\"); &#125; // æ³¨å†Œä¸€ä¸‹ä¾èµ–å…³ç³» registerDependentBean(dep, beanName); // å…ˆåˆå§‹åŒ–è¢«ä¾èµ–é¡¹ getBean(dep); &#125; &#125; // å¦‚æœæ˜¯ singleton scope çš„ï¼Œåˆ›å»º singleton çš„å®ä¾‹ if (mbd.isSingleton()) &#123; sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; try &#123; // æ‰§è¡Œåˆ›å»º Beanï¼Œè¯¦æƒ…åé¢å†è¯´ return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; destroySingleton(beanName); throw ex; &#125; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; // å¦‚æœæ˜¯ prototype scope çš„ï¼Œåˆ›å»º prototype çš„å®ä¾‹ else if (mbd.isPrototype()) &#123; // It's a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); // æ‰§è¡Œåˆ›å»º Bean prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; // å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç† else &#123; String scopeName = mbd.getScope(); final Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException(\"No Scope registered for scope name '\" + scopeName + \"'\"); &#125; try &#123; Object scopedInstance = scope.get(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; beforePrototypeCreation(beanName); try &#123; // æ‰§è¡Œåˆ›å»º Bean return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new BeanCreationException(beanName, \"Scope '\" + scopeName + \"' is not active for the current thread; consider \" + \"defining a scoped proxy for this bean if you intend to refer to it from a singleton\", ex); &#125; &#125; &#125; catch (BeansException ex) &#123; cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; &#125; // æœ€åï¼Œæ£€æŸ¥ä¸€ä¸‹ç±»å‹å¯¹ä¸å¯¹ï¼Œä¸å¯¹çš„è¯å°±æŠ›å¼‚å¸¸ï¼Œå¯¹çš„è¯å°±è¿”å›äº† if (requiredType != null &amp;&amp; bean != null &amp;&amp; !requiredType.isInstance(bean)) &#123; try &#123; return getTypeConverter().convertIfNecessary(bean, requiredType); &#125; catch (TypeMismatchException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Failed to convert bean '\" + name + \"' to required type '\" + ClassUtils.getQualifiedName(requiredType) + \"'\", ex); &#125; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; &#125; return (T) bean;&#125; å¤§å®¶åº”è¯¥ä¹ŸçŒœåˆ°äº†ï¼Œæ¥ä¸‹æ¥å½“ç„¶æ˜¯åˆ†æ createBean æ–¹æ³•ï¼š 1protected abstract Object createBean(String beanName, RootBeanDefinition mbd, Object[] args) throws BeanCreationException; ç¬¬ä¸‰ä¸ªå‚æ•° args æ•°ç»„ä»£è¡¨åˆ›å»ºå®ä¾‹éœ€è¦çš„å‚æ•°ï¼Œä¸å°±æ˜¯ç»™æ„é€ æ–¹æ³•ç”¨çš„å‚æ•°ï¼Œæˆ–è€…æ˜¯å·¥å‚ Bean çš„å‚æ•°å˜›ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„åˆå§‹åŒ–é˜¶æ®µï¼Œargs æ˜¯ nullã€‚ è¿™å›æˆ‘ä»¬è¦åˆ°ä¸€ä¸ªæ–°çš„ç±»äº† AbstractAutowireCapableBeanFactoryï¼Œçœ‹ç±»åï¼ŒAutowireCapableï¼Ÿç±»åæ˜¯ä¸æ˜¯ä¹Ÿè¯´æ˜äº†ç‚¹é—®é¢˜äº†ã€‚ ä¸»è¦æ˜¯ä¸ºäº†ä»¥ä¸‹åœºæ™¯ï¼Œé‡‡ç”¨ @Autowired æ³¨è§£æ³¨å…¥å±æ€§å€¼ï¼š 12345678public class MessageServiceImpl implements MessageService &#123; @Autowired private UserService userService; public String getMessage() &#123; return userService.getMessage(); &#125;&#125; 1&lt;bean id=\"messageService\" class=\"com.javadoop.example.MessageServiceImpl\" /&gt; ä»¥ä¸Šè¿™ç§å±äºæ··ç”¨äº† xml å’Œ æ³¨è§£ ä¸¤ç§æ–¹å¼çš„é…ç½®æ–¹å¼ï¼ŒSpring ä¼šå¤„ç†è¿™ç§æƒ…å†µã€‚ å¥½äº†ï¼Œè¯»è€…è¦çŸ¥é“è¿™ä¹ˆå›äº‹å°±å¯ä»¥äº†ï¼Œç»§ç»­å‘å‰ã€‚ // AbstractAutowireCapableBeanFactory 447 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849/** * Central method of this class: creates a bean instance, * populates the bean instance, applies post-processors, etc. * @see #doCreateBean */@Overrideprotected Object createBean(String beanName, RootBeanDefinition mbd, Object[] args) throws BeanCreationException &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Creating instance of bean '\" + beanName + \"'\"); &#125; RootBeanDefinition mbdToUse = mbd; // ç¡®ä¿ BeanDefinition ä¸­çš„ Class è¢«åŠ è½½ Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName); if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123; mbdToUse = new RootBeanDefinition(mbd); mbdToUse.setBeanClass(resolvedClass); &#125; // å‡†å¤‡æ–¹æ³•è¦†å†™ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šMethodOverridesï¼Œå®ƒæ¥è‡ªäº bean å®šä¹‰ä¸­çš„ &lt;lookup-method /&gt; // å’Œ &lt;replaced-method /&gt;ï¼Œå¦‚æœè¯»è€…æ„Ÿå…´è¶£ï¼Œå›åˆ° bean è§£æçš„åœ°æ–¹çœ‹çœ‹å¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„è§£æã€‚ // æˆ‘åœ¨é™„å½•ä¸­ä¹Ÿå¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç›¸å…³çŸ¥è¯†ç‚¹è¿›è¡Œäº†ä»‹ç»ï¼Œè¯»è€…å¯ä»¥ç§»æ­¥å»çœ‹çœ‹ try &#123; mbdToUse.prepareMethodOverrides(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, \"Validation of method overrides failed\", ex); &#125; try &#123; // è®© InstantiationAwareBeanPostProcessor åœ¨è¿™ä¸€æ­¥æœ‰æœºä¼šè¿”å›ä»£ç†ï¼Œ // åœ¨ ã€ŠSpring AOP æºç åˆ†æã€‹é‚£ç¯‡æ–‡ç« ä¸­æœ‰è§£é‡Šï¼Œè¿™é‡Œå…ˆè·³è¿‡ Object bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) &#123; return bean; &#125; &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName, \"BeanPostProcessor before instantiation of bean failed\", ex); &#125; // é‡å¤´æˆï¼Œåˆ›å»º bean Object beanInstance = doCreateBean(beanName, mbdToUse, args); if (logger.isDebugEnabled()) &#123; logger.debug(\"Finished creating instance of bean '\" + beanName + \"'\"); &#125; return beanInstance;&#125; åˆ›å»º Beanæˆ‘ä»¬ç»§ç»­å¾€é‡Œçœ‹ doCreateBean è¿™ä¸ªæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125/** * Actually create the specified bean. Pre-creation processing has already happened * at this point, e.g. checking &#123;@code postProcessBeforeInstantiation&#125; callbacks. * &lt;p&gt;Differentiates between default bean instantiation, use of a * factory method, and autowiring a constructor. * @param beanName the name of the bean * @param mbd the merged bean definition for the bean * @param args explicit arguments to use for constructor or factory method invocation * @return a new instance of the bean * @throws BeanCreationException if the bean could not be created * @see #instantiateBean * @see #instantiateUsingFactoryMethod * @see #autowireConstructor */protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args) throws BeanCreationException &#123; // Instantiate the bean. BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) &#123; instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; if (instanceWrapper == null) &#123; // è¯´æ˜ä¸æ˜¯ FactoryBeanï¼Œè¿™é‡Œå®ä¾‹åŒ– Beanï¼Œè¿™é‡Œéå¸¸å…³é”®ï¼Œç»†èŠ‚ä¹‹åå†è¯´ instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; // è¿™ä¸ªå°±æ˜¯ Bean é‡Œé¢çš„ æˆ‘ä»¬å®šä¹‰çš„ç±» çš„å®ä¾‹ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘ç›´æ¥æè¿°æˆ \"bean å®ä¾‹\" final Object bean = (instanceWrapper != null ? instanceWrapper.getWrappedInstance() : null); // ç±»å‹ Class&lt;?&gt; beanType = (instanceWrapper != null ? instanceWrapper.getWrappedClass() : null); mbd.resolvedTargetType = beanType; // å»ºè®®è·³è¿‡å§ï¼Œæ¶‰åŠæ¥å£ï¼šMergedBeanDefinitionPostProcessor synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; // MergedBeanDefinitionPostProcessorï¼Œè¿™ä¸ªæˆ‘çœŸä¸å±•å¼€è¯´äº†ï¼Œç›´æ¥è·³è¿‡å§ï¼Œå¾ˆå°‘ç”¨çš„ applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Post-processing of merged bean definition failed\", ex); &#125; mbd.postProcessed = true; &#125; &#125; // Eagerly cache singletons to be able to resolve circular references // even when triggered by lifecycle interfaces like BeanFactoryAware. // ä¸‹é¢è¿™å—ä»£ç æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä»¥åæœ‰æ—¶é—´ï¼Œæˆ‘å†å¯¹å¾ªç¯ä¾èµ–è¿™ä¸ªé—®é¢˜è¿›è¡Œè§£æå§ boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Eagerly caching bean '\" + beanName + \"' to allow for resolving potential circular references\"); &#125; addSingletonFactory(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; return getEarlyBeanReference(beanName, mbd, bean); &#125; &#125;); &#125; // Initialize the bean instance. Object exposedObject = bean; try &#123; // è¿™ä¸€æ­¥ä¹Ÿæ˜¯éå¸¸å…³é”®çš„ï¼Œè¿™ä¸€æ­¥è´Ÿè´£å±æ€§è£…é…ï¼Œå› ä¸ºå‰é¢çš„å®ä¾‹åªæ˜¯å®ä¾‹åŒ–äº†ï¼Œå¹¶æ²¡æœ‰è®¾å€¼ï¼Œè¿™é‡Œå°±æ˜¯è®¾å€¼ populateBean(beanName, mbd, instanceWrapper); if (exposedObject != null) &#123; // è¿˜è®°å¾— init-method å—ï¼Ÿè¿˜æœ‰ InitializingBean æ¥å£ï¼Ÿè¿˜æœ‰ BeanPostProcessor æ¥å£ï¼Ÿ // è¿™é‡Œå°±æ˜¯å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒ exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Initialization of bean failed\", ex); &#125; &#125; if (earlySingletonExposure) &#123; // Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) &#123; if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;String&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException(beanName, \"Bean with name '\" + beanName + \"' has been injected into other beans [\" + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + \"] in its raw version as part of a circular reference, but has eventually been \" + \"wrapped. This means that said other beans do not use the final version of the \" + \"bean. This is often the result of over-eager type matching - consider using \" + \"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example.\"); &#125; &#125; &#125; &#125; // Register bean as disposable. try &#123; registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Invalid destruction signature\", ex); &#125; return exposedObject;&#125; åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº† doCreateBean æ–¹æ³•ï¼Œæ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»è¯´å®Œäº†æ•´ä¸ªåˆå§‹åŒ–æµç¨‹ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘ doCreateBean ä¸­çš„ä¸‰ä¸ªç»†èŠ‚å‡ºæ¥è¯´è¯´ã€‚ä¸€ä¸ªæ˜¯åˆ›å»º Bean å®ä¾‹çš„ createBeanInstance æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä¾èµ–æ³¨å…¥çš„ populateBean æ–¹æ³•ï¼Œè¿˜æœ‰å°±æ˜¯å›è°ƒæ–¹æ³• initializeBeanã€‚ æ³¨æ„äº†ï¼Œæ¥ä¸‹æ¥çš„è¿™ä¸‰ä¸ªæ–¹æ³•è¦è®¤çœŸè¯´é‚£ä¹Ÿæ˜¯æå…¶å¤æ‚çš„ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘å°±ç‚¹åˆ°ä¸ºæ­¢äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±å¾€é‡Œçœ‹ï¼Œæœ€å¥½å°±æ˜¯ç¢°åˆ°ä¸æ‡‚çš„ï¼Œè‡ªå·±å†™ä»£ç å»è°ƒè¯•å®ƒã€‚ åˆ›å»º Bean å®ä¾‹æˆ‘ä»¬å…ˆçœ‹çœ‹ createBeanInstance æ–¹æ³•ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¦‚æœæ¯ä¸ªåˆ†æ”¯éƒ½åˆ†æä¸‹å»ï¼Œå¿…ç„¶ä¹Ÿæ˜¯æå…¶å¤æ‚å†—é•¿çš„ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹è¯´ã€‚æ­¤æ–¹æ³•çš„ç›®çš„å°±æ˜¯å®ä¾‹åŒ–æˆ‘ä»¬æŒ‡å®šçš„ç±»ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, Object[] args) &#123; // ç¡®ä¿å·²ç»åŠ è½½äº†æ­¤ class Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName); // æ ¡éªŒä¸€ä¸‹è¿™ä¸ªç±»çš„è®¿é—®æƒé™ if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Bean class isn't public, and non-public access not allowed: \" + beanClass.getName()); &#125; if (mbd.getFactoryMethodName() != null) &#123; // é‡‡ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µçš„è¯»è€…è¯·çœ‹é™„å½•ï¼Œæ³¨æ„ï¼Œä¸æ˜¯ FactoryBean return instantiateUsingFactoryMethod(beanName, mbd, args); &#125; // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ¯”å¦‚ç¬¬äºŒæ¬¡åˆ›å»º prototype beanã€‚ // è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ç¬¬ä¸€æ¬¡åˆ›å»ºçŸ¥é“ï¼Œé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œè¿˜æ˜¯æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ æ¥å®Œæˆå®ä¾‹åŒ– boolean resolved = false; boolean autowireNecessary = false; if (args == null) &#123; synchronized (mbd.constructorArgumentLock) &#123; if (mbd.resolvedConstructorOrFactoryMethod != null) &#123; resolved = true; autowireNecessary = mbd.constructorArgumentsResolved; &#125; &#125; &#125; if (resolved) &#123; if (autowireNecessary) &#123; // æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ return autowireConstructor(beanName, mbd, null, null); &#125; else &#123; // æ— å‚æ„é€ å‡½æ•° return instantiateBean(beanName, mbd); &#125; &#125; // åˆ¤æ–­æ˜¯å¦é‡‡ç”¨æœ‰å‚æ„é€ å‡½æ•° Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName); if (ctors != null || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123; // æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ return autowireConstructor(beanName, mbd, ctors, args); &#125; // è°ƒç”¨æ— å‚æ„é€ å‡½æ•° return instantiateBean(beanName, mbd);&#125; æŒ‘ä¸ªç®€å•çš„æ— å‚æ„é€ å‡½æ•°æ„é€ å®ä¾‹æ¥çœ‹çœ‹ï¼š 123456789101112131415161718192021222324252627protected BeanWrapper instantiateBean(final String beanName, final RootBeanDefinition mbd) &#123; try &#123; Object beanInstance; final BeanFactory parent = this; if (System.getSecurityManager() != null) &#123; beanInstance = AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123; @Override public Object run() &#123; return getInstantiationStrategy().instantiate(mbd, beanName, parent); &#125; &#125;, getAccessControlContext()); &#125; else &#123; // å®ä¾‹åŒ– beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent); &#125; // åŒ…è£…ä¸€ä¸‹ï¼Œè¿”å› BeanWrapper bw = new BeanWrapperImpl(beanInstance); initBeanWrapper(bw); return bw; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Instantiation of bean failed\", ex); &#125;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®çš„åœ°æ–¹åœ¨äºï¼š 1beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent); è¿™é‡Œä¼šè¿›è¡Œå®é™…çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹: // SimpleInstantiationStrategy 59 123456789101112131415161718192021222324252627282930313233343536373839404142@Overridepublic Object instantiate(RootBeanDefinition bd, String beanName, BeanFactory owner) &#123; // å¦‚æœä¸å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œé‚£å°±ä½¿ç”¨ java åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¦åˆ™ä½¿ç”¨ CGLIB, // æ–¹æ³•è¦†å†™ è¯·å‚è§é™„å½•\"æ–¹æ³•æ³¨å…¥\"ä¸­å¯¹ lookup-method å’Œ replaced-method çš„ä»‹ç» if (bd.getMethodOverrides().isEmpty()) &#123; Constructor&lt;?&gt; constructorToUse; synchronized (bd.constructorArgumentLock) &#123; constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod; if (constructorToUse == null) &#123; final Class&lt;?&gt; clazz = bd.getBeanClass(); if (clazz.isInterface()) &#123; throw new BeanInstantiationException(clazz, \"Specified class is an interface\"); &#125; try &#123; if (System.getSecurityManager() != null) &#123; constructorToUse = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;() &#123; @Override public Constructor&lt;?&gt; run() throws Exception &#123; return clazz.getDeclaredConstructor((Class[]) null); &#125; &#125;); &#125; else &#123; constructorToUse = clazz.getDeclaredConstructor((Class[]) null); &#125; bd.resolvedConstructorOrFactoryMethod = constructorToUse; &#125; catch (Throwable ex) &#123; throw new BeanInstantiationException(clazz, \"No default constructor found\", ex); &#125; &#125; &#125; // åˆ©ç”¨æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ– return BeanUtils.instantiateClass(constructorToUse); &#125; else &#123; // å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œåˆ©ç”¨ CGLIB æ¥å®Œæˆå®ä¾‹åŒ–ï¼Œéœ€è¦ä¾èµ–äº CGLIB ç”Ÿæˆå­ç±»ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ // tips: å› ä¸ºå¦‚æœä¸ä½¿ç”¨ CGLIB çš„è¯ï¼Œå­˜åœ¨ override çš„æƒ…å†µ JDK å¹¶æ²¡æœ‰æä¾›ç›¸åº”çš„å®ä¾‹åŒ–æ”¯æŒ return instantiateWithMethodInjection(bd, beanName, owner); &#125;&#125; åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ç®—å®ä¾‹åŒ–å®Œæˆäº†ã€‚æˆ‘ä»¬å¼€å§‹è¯´æ€ä¹ˆè¿›è¡Œå±æ€§æ³¨å…¥ã€‚ bean å±æ€§æ³¨å…¥çœ‹å®Œäº† createBeanInstance(â€¦) æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ populateBean(â€¦) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£è¿›è¡Œå±æ€§è®¾å€¼ï¼Œå¤„ç†ä¾èµ–ã€‚ // AbstractAutowireCapableBeanFactory 1203 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) &#123; // bean å®ä¾‹çš„æ‰€æœ‰å±æ€§éƒ½åœ¨è¿™é‡Œäº† PropertyValues pvs = mbd.getPropertyValues(); if (bw == null) &#123; if (!pvs.isEmpty()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, \"Cannot apply property values to null instance\"); &#125; else &#123; // Skip property population phase for null instance. return; &#125; &#125; // åˆ°è¿™æ­¥çš„æ—¶å€™ï¼Œbean å®ä¾‹åŒ–å®Œæˆï¼ˆé€šè¿‡å·¥å‚æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡å¼€å§‹å±æ€§è®¾å€¼ï¼Œ // InstantiationAwareBeanPostProcessor çš„å®ç°ç±»å¯ä»¥åœ¨è¿™é‡Œå¯¹ bean è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œ // æˆ‘ä¹Ÿæ²¡æ‰¾åˆ°æœ‰å®é™…çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚ä¸”å¿½ç•¥è¿™å—å§ boolean continueWithPropertyPopulation = true; if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; // å¦‚æœè¿”å› falseï¼Œä»£è¡¨ä¸éœ€è¦è¿›è¡Œåç»­çš„å±æ€§è®¾å€¼ï¼Œä¹Ÿä¸éœ€è¦å†ç»è¿‡å…¶ä»–çš„ BeanPostProcessor çš„å¤„ç† if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123; continueWithPropertyPopulation = false; break; &#125; &#125; &#125; &#125; if (!continueWithPropertyPopulation) &#123; return; &#125; if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // é€šè¿‡åå­—æ‰¾åˆ°æ‰€æœ‰å±æ€§å€¼ï¼Œå¦‚æœæ˜¯ bean ä¾èµ–ï¼Œå…ˆåˆå§‹åŒ–ä¾èµ–çš„ beanã€‚è®°å½•ä¾èµ–å…³ç³» if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123; autowireByName(beanName, mbd, bw, newPvs); &#125; // é€šè¿‡ç±»å‹è£…é…ã€‚å¤æ‚ä¸€äº› if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; autowireByType(beanName, mbd, bw, newPvs); &#125; pvs = newPvs; &#125; boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); boolean needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE); if (hasInstAwareBpps || needsDepCheck) &#123; PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); if (hasInstAwareBpps) &#123; for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; // è¿™é‡Œæœ‰ä¸ªéå¸¸æœ‰ç”¨çš„ BeanPostProcessor è¿›åˆ°è¿™é‡Œ: AutowiredAnnotationBeanPostProcessor // å¯¹é‡‡ç”¨ @Autowiredã€@Value æ³¨è§£çš„ä¾èµ–è¿›è¡Œè®¾å€¼ï¼Œè¿™é‡Œçš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„ï¼Œä¸è¿‡æœ¬æ–‡ä¸ä¼šå±•å¼€è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…è¯·è‡ªè¡Œç ”ç©¶ pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvs == null) &#123; return; &#125; &#125; &#125; &#125; if (needsDepCheck) &#123; checkDependencies(beanName, mbd, filteredPds, pvs); &#125; &#125; // è®¾ç½® bean å®ä¾‹çš„å±æ€§å€¼ applyPropertyValues(beanName, mbd, bw, pvs);&#125; initializeBeanå±æ€§æ³¨å…¥å®Œæˆåï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯å¤„ç†å„ç§å›è°ƒäº†ï¼Œè¿™å—ä»£ç æ¯”è¾ƒç®€å•ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738protected Object initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd) &#123; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123; @Override public Object run() &#123; invokeAwareMethods(beanName, bean); return null; &#125; &#125;, getAccessControlContext()); &#125; else &#123; // å¦‚æœ bean å®ç°äº† BeanNameAwareã€BeanClassLoaderAware æˆ– BeanFactoryAware æ¥å£ï¼Œå›è°ƒ invokeAwareMethods(beanName, bean); &#125; Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) &#123; // BeanPostProcessor çš„ postProcessBeforeInitialization å›è°ƒ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); &#125; try &#123; // å¤„ç† bean ä¸­å®šä¹‰çš„ init-methodï¼Œ // æˆ–è€…å¦‚æœ bean å®ç°äº† InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet() æ–¹æ³• invokeInitMethods(beanName, wrappedBean, mbd); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, \"Invocation of init method failed\", ex); &#125; if (mbd == null || !mbd.isSynthetic()) &#123; // BeanPostProcessor çš„ postProcessAfterInitialization å›è°ƒ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; return wrappedBean;&#125; å¤§å®¶å‘ç°æ²¡æœ‰ï¼ŒBeanPostProcessor çš„ä¸¤ä¸ªå›è°ƒéƒ½å‘ç”Ÿåœ¨è¿™è¾¹ï¼Œåªä¸è¿‡ä¸­é—´å¤„ç†äº† init-methodï¼Œæ˜¯ä¸æ˜¯å’Œè¯»è€…åŸæ¥çš„è®¤çŸ¥æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Ÿ é™„å½•id å’Œ nameæ¯ä¸ª Bean åœ¨ Spring å®¹å™¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼ˆbeanNameï¼‰å’Œ 0 ä¸ªæˆ–å¤šä¸ªåˆ«åï¼ˆaliasesï¼‰ã€‚ æˆ‘ä»¬ä» Spring å®¹å™¨ä¸­è·å– Bean çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® beanNameï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ«åã€‚ 1beanFactory.getBean(\"beanName or alias\"); åœ¨é…ç½® &lt;bean /&gt; çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® id å’Œ nameï¼Œçœ‹å‡ ä¸ªä¾‹å­å°±çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚ 1&lt;bean id=\"messageService\" name=\"m1, m2, m3\" class=\"com.javadoop.example.MessageServiceImpl\"&gt; ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œåˆ«åæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«ä¸º m1ã€m2ã€m3ã€‚ 1&lt;bean name=\"m1, m2, m3\" class=\"com.javadoop.example.MessageServiceImpl\" /&gt; ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º m1ï¼Œåˆ«åæœ‰ 2 ä¸ªï¼Œåˆ†åˆ«ä¸º m2ã€m3ã€‚ 1&lt;bean class=\"com.javadoop.example.MessageServiceImpl\"&gt; beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0ï¼Œ åˆ«å 1 ä¸ªï¼Œä¸ºï¼š com.javadoop.example.MessageServiceImpl 1&lt;bean id=\"messageService\" class=\"com.javadoop.example.MessageServiceImpl\"&gt; ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œæ²¡æœ‰åˆ«åã€‚ é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–æˆ‘ä»¬è¯´è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullã€‚å¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­ Bean id æˆ– name é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚ å¯æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å°±ä¸¥æ ¼æœç»å‘ç”Ÿ Bean è¦†ç›–ï¼Œå› ä¸ºä¸‡ä¸€å‡ºç°è¿™ç§æƒ…å†µï¼Œä¼šå¢åŠ æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æˆæœ¬ã€‚ å¾ªç¯ä¾èµ–è¯´çš„æ˜¯ A ä¾èµ– Bï¼Œè€Œ B åˆä¾èµ– Aã€‚æˆ–è€…æ˜¯ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C å´ä¾èµ– Aã€‚é»˜è®¤ allowCircularReferences ä¹Ÿæ˜¯ nullã€‚ å®ƒä»¬ä¸¤ä¸ªå±æ€§æ˜¯ä¸€èµ·å‡ºç°çš„ï¼Œå¿…ç„¶å¯ä»¥åœ¨åŒä¸€ä¸ªåœ°æ–¹ä¸€èµ·è¿›è¡Œé…ç½®ã€‚ æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§çš„ä½œè€… Juergen Hoeller åœ¨è¿™ä¸ª jira çš„è®¨è®ºä¸­è¯´æ˜äº†æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªå±æ€§ã€‚ 123456789public class NoBeanOverridingContextLoader extends ContextLoader &#123; @Override protected void customizeContext(ServletContext servletContext, ConfigurableWebApplicationContext applicationContext) &#123; super.customizeContext(servletContext, applicationContext); AbstractRefreshableApplicationContext arac = (AbstractRefreshableApplicationContext) applicationContext; arac.setAllowBeanDefinitionOverriding(false); &#125;&#125; 12345678public class MyContextLoaderListener extends org.springframework.web.context.ContextLoaderListener &#123; @Override protected ContextLoader createContextLoader() &#123; return new NoBeanOverridingContextLoader(); &#125; &#125; 123&lt;listener&gt; &lt;listener-class&gt;com.javadoop.MyContextLoaderListener&lt;/listener-class&gt; &lt;/listener&gt; å¦‚æœä»¥ä¸Šæ–¹å¼ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œè¯·å‚è€ƒè¿™ä¸ªé“¾æ¥ï¼šè§£å†³springä¸­ä¸åŒé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨nameæˆ–è€…idç›¸åŒçš„beanå¯èƒ½å¼•èµ·çš„é—®é¢˜ profileæˆ‘ä»¬å¯ä»¥æŠŠä¸åŒç¯å¢ƒçš„é…ç½®åˆ†åˆ«é…ç½®åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 1234567891011&lt;beans profile=\"development\" xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:jdbc=\"http://www.springframework.org/schema/jdbc\" xsi:schemaLocation=\"...\"&gt; &lt;jdbc:embedded-database id=\"dataSource\"&gt; &lt;jdbc:script location=\"classpath:com/bank/config/sql/schema.sql\"/&gt; &lt;jdbc:script location=\"classpath:com/bank/config/sql/test-data.sql\"/&gt; &lt;/jdbc:embedded-database&gt;&lt;/beans&gt; 12345678&lt;beans profile=\"production\" xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:jee=\"http://www.springframework.org/schema/jee\" xsi:schemaLocation=\"...\"&gt; &lt;jee:jndi-lookup id=\"dataSource\" jndi-name=\"java:comp/env/jdbc/datasource\"/&gt;&lt;/beans&gt; åº”è¯¥ä¸å¿…åšè¿‡å¤šè§£é‡Šäº†å§ï¼Œçœ‹æ¯ä¸ªæ–‡ä»¶ç¬¬ä¸€è¡Œçš„ profile=â€â€ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š 1234567891011121314151617&lt;beans xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:jdbc=\"http://www.springframework.org/schema/jdbc\" xmlns:jee=\"http://www.springframework.org/schema/jee\" xsi:schemaLocation=\"...\"&gt; &lt;beans profile=\"development\"&gt; &lt;jdbc:embedded-database id=\"dataSource\"&gt; &lt;jdbc:script location=\"classpath:com/bank/config/sql/schema.sql\"/&gt; &lt;jdbc:script location=\"classpath:com/bank/config/sql/test-data.sql\"/&gt; &lt;/jdbc:embedded-database&gt; &lt;/beans&gt; &lt;beans profile=\"production\"&gt; &lt;jee:jndi-lookup id=\"dataSource\" jndi-name=\"java:comp/env/jdbc/datasource\"/&gt; &lt;/beans&gt;&lt;/beans&gt; ç†è§£èµ·æ¥ä¹Ÿå¾ˆç®€å•å§ã€‚ æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆä½¿ç”¨ç‰¹å®šçš„ profile å‘¢ï¼ŸSpring åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå»å¯»æ‰¾ â€œspring.profiles.activeâ€ çš„å±æ€§å€¼ï¼Œæ ¹æ®è¿™ä¸ªå±æ€§å€¼æ¥çš„ã€‚é‚£æ€ä¹ˆé…ç½®è¿™ä¸ªå€¼å‘¢ï¼Ÿ Spring ä¼šåœ¨è¿™å‡ ä¸ªåœ°æ–¹å¯»æ‰¾ spring.profiles.active çš„å±æ€§å€¼ï¼šæ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡ã€JVM ç³»ç»Ÿå˜é‡ã€web.xml ä¸­å®šä¹‰çš„å‚æ•°ã€JNDIã€‚ æœ€ç®€å•çš„æ–¹å¼è«è¿‡äºåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æŒ‡å®šï¼š 1-Dspring.profiles.active=\"profile1,profile2\" profile å¯ä»¥æ¿€æ´»å¤šä¸ª å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„å½¢å¼ä» Environment ä¸­è®¾ç½® profileï¼š 1234AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();ctx.getEnvironment().setActiveProfiles(\"development\");ctx.register(SomeConfig.class, StandaloneDataConfig.class, JndiDataConfig.class);ctx.refresh(); // é‡å¯ å¦‚æœæ˜¯ Spring Boot çš„è¯æ›´ç®€å•ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ›å»º application.propertiesã€application-dev.propertiesã€application-prod.properties ç­‰æ–‡ä»¶ï¼Œå…¶ä¸­ application.properties é…ç½®å„ä¸ªç¯å¢ƒé€šç”¨çš„é…ç½®ï¼Œapplication-{profile}.properties ä¸­é…ç½®ç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š profileï¼š 1java -Dspring.profiles.active=prod -jar JavaDoop.jar å¦‚æœæ˜¯å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨çš„è¯ï¼Œåœ¨æµ‹è¯•ç±»ä¸­ä½¿ç”¨ @ActiveProfiles æŒ‡å®šï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ å·¥å‚æ¨¡å¼ç”Ÿæˆ Beanè¯·è¯»è€…æ³¨æ„ factory-bean å’Œ FactoryBean çš„åŒºåˆ«ã€‚è¿™èŠ‚è¯´çš„æ˜¯å‰è€…ï¼Œæ˜¯è¯´é™æ€å·¥å‚æˆ–å®ä¾‹å·¥å‚ï¼Œè€Œåè€…æ˜¯ Spring ä¸­çš„ç‰¹æ®Šæ¥å£ï¼Œä»£è¡¨ä¸€ç±»ç‰¹æ®Šçš„ Beanï¼Œé™„å½•çš„ä¸‹é¢ä¸€èŠ‚ä¼šä»‹ç» FactoryBeanã€‚ è®¾è®¡æ¨¡å¼é‡Œï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åˆ†é™æ€å·¥å‚å’Œå®ä¾‹å·¥å‚ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹ Spring ä¸­æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªï¼Œæ¥ä¸ªä»£ç ç¤ºä¾‹å°±ä»€ä¹ˆéƒ½æ¸…æ¥šäº†ã€‚ é™æ€å·¥å‚ï¼š 123&lt;bean id=\"clientService\" class=\"examples.ClientService\" factory-method=\"createInstance\"/&gt; 123456789public class ClientService &#123; private static ClientService clientService = new ClientService(); private ClientService() &#123;&#125; // é™æ€æ–¹æ³• public static ClientService createInstance() &#123; return clientService; &#125;&#125; å®ä¾‹å·¥å‚ï¼š 1234567891011&lt;bean id=\"serviceLocator\" class=\"examples.DefaultServiceLocator\"&gt; &lt;!-- inject any dependencies required by this locator bean --&gt;&lt;/bean&gt;&lt;bean id=\"clientService\" factory-bean=\"serviceLocator\" factory-method=\"createClientServiceInstance\"/&gt;&lt;bean id=\"accountService\" factory-bean=\"serviceLocator\" factory-method=\"createAccountServiceInstance\"/&gt; 1234567891011121314public class DefaultServiceLocator &#123; private static ClientService clientService = new ClientServiceImpl(); private static AccountService accountService = new AccountServiceImpl(); public ClientService createClientServiceInstance() &#123; return clientService; &#125; public AccountService createAccountServiceInstance() &#123; return accountService; &#125;&#125; FactoryBeanFactoryBean é€‚ç”¨äº Bean çš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± çš„åˆ›å»ºã€‚ 12345public interface FactoryBean&lt;T&gt; &#123; T getObject() throws Exception; Class&lt;T&gt; getObjectType(); boolean isSingleton();&#125; 1234public class Person &#123; private Car car ; private void setCar(Car car)&#123; this.car = car; &#125; &#125; æˆ‘ä»¬å‡è®¾ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ª Person çš„ Beanï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Car çš„å®ä¾‹ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾ Car çš„å®ä¾‹åˆ›å»ºå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠåˆ›å»º Car çš„å¤æ‚è¿‡ç¨‹åŒ…è£…èµ·æ¥ï¼š 123456789101112131415161718192021public class MyCarFactoryBean implements FactoryBean&lt;Car&gt;&#123; private String make; private int year ; public void setMake(String m)&#123; this.make =m ; &#125; public void setYear(int y)&#123; this.year = y; &#125; public Car getObject()&#123; // è¿™é‡Œæˆ‘ä»¬å‡è®¾ Car çš„å®ä¾‹åŒ–è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåæ­£å°±ä¸æ˜¯å‡ è¡Œä»£ç å¯ä»¥å†™å®Œçš„é‚£ç§ CarBuilder cb = CarBuilder.car(); if(year!=0) cb.setYear(this.year); if(StringUtils.hasText(this.make)) cb.setMake( this.make ); return cb.factory(); &#125; public Class&lt;Car&gt; getObjectType() &#123; return Car.class ; &#125; public boolean isSingleton() &#123; return false; &#125;&#125; æˆ‘ä»¬çœ‹çœ‹è£…é…çš„æ—¶å€™æ˜¯æ€ä¹ˆé…ç½®çš„ï¼š 1234567&lt;bean class = \"com.javadoop.MyCarFactoryBean\" id = \"car\"&gt; &lt;property name = \"make\" value =\"Honda\"/&gt; &lt;property name = \"year\" value =\"1984\"/&gt;&lt;/bean&gt;&lt;bean class = \"com.javadoop.Person\" id = \"josh\"&gt; &lt;property name = \"car\" ref = \"car\"/&gt;&lt;/bean&gt; çœ‹åˆ°ä¸ä¸€æ ·äº†å—ï¼Ÿid ä¸º â€œcarâ€ çš„ bean å…¶å®æŒ‡å®šçš„æ˜¯ä¸€ä¸ª FactoryBeanï¼Œä¸è¿‡é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥è®©é…ç½® Person çš„ Bean ç›´æ¥ä¾èµ–äºè¿™ä¸ª FactoryBean å°±å¯ä»¥äº†ã€‚ä¸­é—´çš„è¿‡ç¨‹ Spring å·²ç»å°è£…å¥½äº†ã€‚ è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥ç‚¹å¹²è´§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨è¿˜ç”¨ xml é…ç½® Bean ä¾èµ–çš„è¶Šæ¥è¶Šå°‘äº†ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡‡ç”¨ java config çš„æ–¹å¼æ¥é…ç½®ï¼Œè¿™é‡Œæœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ 12345678910111213141516171819@Configuration public class CarConfiguration &#123; @Bean public MyCarFactoryBean carFactoryBean()&#123; MyCarFactoryBean cfb = new MyCarFactoryBean(); cfb.setMake(\"Honda\"); cfb.setYear(1984); return cfb; &#125; @Bean public Person aPerson()&#123; Person person = new Person(); // æ³¨æ„è¿™é‡Œçš„ä¸åŒ person.setCar(carFactoryBean().getObject()); return person; &#125; &#125; è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æˆ‘ä»¬çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠ MyCarFactoryBean çœ‹æˆæ˜¯ä¸€ä¸ªç®€å•çš„ Bean å°±å¯ä»¥äº†ï¼Œä¸å¿…ç†ä¼šä»€ä¹ˆ FactoryBeanï¼Œå®ƒæ˜¯ä¸æ˜¯ FactoryBean å’Œæˆ‘ä»¬æ²¡å…³ç³»ã€‚ åˆå§‹åŒ– Bean çš„å›è°ƒæœ‰ä»¥ä¸‹å››ç§æ–¹æ¡ˆï¼š 1&lt;bean id=\"exampleInitBean\" class=\"examples.ExampleBean\" init-method=\"init\"/&gt; 123456public class AnotherExampleBean implements InitializingBean &#123; public void afterPropertiesSet() &#123; // do some initialization work &#125;&#125; 1234@Bean(initMethod = \"init\")public Foo foo() &#123; return new Foo();&#125; 1234@PostConstructpublic void init() &#123; &#125; é”€æ¯ Bean çš„å›è°ƒ1&lt;bean id=\"exampleInitBean\" class=\"examples.ExampleBean\" destroy-method=\"cleanup\"/&gt; 123456public class AnotherExampleBean implements DisposableBean &#123; public void destroy() &#123; // do some destruction work (like releasing pooled connections) &#125;&#125; 1234@Bean(destroyMethod = \"cleanup\")public Bar bar() &#123; return new Bar();&#125; 1234@PreDestroypublic void cleanup() &#123; &#125; ConversionServiceæ—¢ç„¶æ–‡ä¸­è¯´åˆ°äº†è¿™ä¸ªï¼Œé¡ºä¾¿æä¸€ä¸‹å¥½äº†ã€‚ æœ€æœ‰ç”¨çš„åœºæ™¯å°±æ˜¯ï¼Œå®ƒç”¨æ¥å°†å‰ç«¯ä¼ è¿‡æ¥çš„å‚æ•°å’Œåç«¯çš„ controller æ–¹æ³•ä¸Šçš„å‚æ•°è¿›è¡Œç»‘å®šçš„æ—¶å€™ç”¨ã€‚ åƒå‰ç«¯ä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²ã€æ•´æ•°è¦è½¬æ¢ä¸ºåç«¯çš„ Stringã€Integer å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœ controller æ–¹æ³•éœ€è¦çš„æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œæˆ–è€…æ˜¯ Date è¿™äº›éåŸºç¡€ç±»å‹ï¼ˆå«åŸºç¡€ç±»å‹åŒ…è£…ç±»ï¼‰å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘é‡‡ç”¨ ConversionService æ¥è¿›è¡Œè½¬æ¢ã€‚ 12345678&lt;bean id=\"conversionService\" class=\"org.springframework.context.support.ConversionServiceFactoryBean\"&gt; &lt;property name=\"converters\"&gt; &lt;list&gt; &lt;bean class=\"com.javadoop.learning.utils.StringToEnumConverterFactory\"/&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean&gt; ConversionService æ¥å£å¾ˆç®€å•ï¼Œæ‰€ä»¥è¦è‡ªå®šä¹‰ä¸€ä¸ª convert çš„è¯ä¹Ÿå¾ˆç®€å•ã€‚ ä¸‹é¢å†è¯´ä¸€ä¸ªå®ç°è¿™ç§è½¬æ¢å¾ˆç®€å•çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯å®ç° Converter æ¥å£ã€‚ æ¥çœ‹ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·æ¯”ä»€ä¹ˆéƒ½ç®¡ç”¨ã€‚ 1234567891011public class StringToDateConverter implements Converter&lt;String, Date&gt; &#123; @Override public Date convert(String source) &#123; try &#123; return DateUtils.parseDate(source, \"yyyy-MM-dd\", \"yyyy-MM-dd HH:mm:ss\", \"yyyy-MM-dd HH:mm\", \"HH:mm:ss\", \"HH:mm\"); &#125; catch (ParseException e) &#123; return null; &#125; &#125;&#125; åªè¦æ³¨å†Œè¿™ä¸ª Bean å°±å¯ä»¥äº†ã€‚è¿™æ ·ï¼Œå‰ç«¯å¾€åç«¯ä¼ çš„æ—¶é—´æè¿°å­—ç¬¦ä¸²å°±å¾ˆå®¹æ˜“ç»‘å®šæˆ Date ç±»å‹äº†ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•æ“ä½œã€‚ Bean ç»§æ‰¿åœ¨åˆå§‹åŒ– Bean çš„åœ°æ–¹ï¼Œæˆ‘ä»¬è¯´è¿‡äº†è¿™ä¸ªï¼š 1RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); è¿™é‡Œæ¶‰åŠåˆ°çš„å°±æ˜¯ &lt;bean parent=&quot;&quot; /&gt; ä¸­çš„ parent å±æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Spring ä¸­æ˜¯ç”¨è¿™ä¸ªæ¥å¹²ä»€ä¹ˆçš„ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œè¿™é‡Œçš„ç»§æ‰¿å’Œ java è¯­æ³•ä¸­çš„ç»§æ‰¿æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿‡æ€è·¯æ˜¯ç›¸é€šçš„ã€‚child bean ä¼šç»§æ‰¿ parent bean çš„æ‰€æœ‰é…ç½®ï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸€äº›é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ–°å¢é¢å¤–çš„é…ç½®ã€‚ Spring ä¸­æä¾›äº†ç»§æ‰¿è‡ª AbstractBeanDefinition çš„ ChildBeanDefinition æ¥è¡¨ç¤º child beanã€‚ çœ‹å¦‚ä¸‹ä¸€ä¸ªä¾‹å­: 12345678910&lt;bean id=\"inheritedTestBean\" abstract=\"true\" class=\"org.springframework.beans.TestBean\"&gt; &lt;property name=\"name\" value=\"parent\"/&gt; &lt;property name=\"age\" value=\"1\"/&gt;&lt;/bean&gt;&lt;bean id=\"inheritsWithDifferentClass\" class=\"org.springframework.beans.DerivedTestBean\" parent=\"inheritedTestBean\" init-method=\"initialize\"&gt; &lt;property name=\"name\" value=\"override\"/&gt;&lt;/bean&gt; parent bean è®¾ç½®äº† abstract=&quot;true&quot; æ‰€ä»¥å®ƒä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œchild bean ç»§æ‰¿äº† parent bean çš„ä¸¤ä¸ªå±æ€§ï¼Œä½†æ˜¯å¯¹ name å±æ€§è¿›è¡Œäº†è¦†å†™ã€‚ child bean ä¼šç»§æ‰¿ scopeã€æ„é€ å™¨å‚æ•°å€¼ã€å±æ€§å€¼ã€init-methodã€destroy-method ç­‰ç­‰ã€‚ å½“ç„¶ï¼Œæˆ‘ä¸æ˜¯è¯´ parent bean ä¸­çš„ abstract = true åœ¨è¿™é‡Œæ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯è¯´å¦‚æœåŠ ä¸Šäº†ä»¥å Spring åœ¨å®ä¾‹åŒ– singleton beans çš„æ—¶å€™ä¼šå¿½ç•¥è¿™ä¸ª beanã€‚ æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæç«¯ parent beanï¼Œå®ƒæ²¡æœ‰æŒ‡å®š classï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ª bean çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å……å½“æ¨¡æ¿ç”¨çš„ parent beanï¼Œæ­¤å¤„å°±å¿…é¡»åŠ ä¸Š abstract = trueã€‚ 1234&lt;bean id=\"inheritedTestBeanWithoutClass\" abstract=\"true\"&gt; &lt;property name=\"name\" value=\"parent\"/&gt; &lt;property name=\"age\" value=\"1\"/&gt;&lt;/bean&gt; æ–¹æ³•æ³¨å…¥ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä¸­å¤§å¤šæ•°çš„ Bean éƒ½æ˜¯ singleton çš„ã€‚singleton ä¾èµ– singletonï¼Œæˆ–è€… prototype ä¾èµ– prototype éƒ½å¾ˆå¥½è§£å†³ï¼Œç›´æ¥è®¾ç½®å±æ€§ä¾èµ–å°±å¯ä»¥äº†ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ singleton ä¾èµ– prototype å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ä¸èƒ½ç”¨å±æ€§ä¾èµ–ï¼Œå› ä¸ºå¦‚æœç”¨å±æ€§ä¾èµ–çš„è¯ï¼Œæˆ‘ä»¬æ¯æ¬¡å…¶å®æ‹¿åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶å€™çš„ beanã€‚ ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸è¦ç”¨å±æ€§ä¾èµ–ï¼Œæ¯æ¬¡è·å–ä¾èµ–çš„ bean çš„æ—¶å€™ä» BeanFactory ä¸­å–ã€‚è¿™ä¸ªä¹Ÿæ˜¯å¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼äº†å§ã€‚æ€ä¹ˆå–ï¼Œæˆ‘å°±ä¸ä»‹ç»äº†ï¼Œå¤§éƒ¨åˆ† Spring é¡¹ç›®å¤§å®¶éƒ½ä¼šå®šä¹‰é‚£ä¹ˆä¸ªå·¥å…·ç±»çš„ã€‚ å¦ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯è¿™é‡Œè¦ä»‹ç»çš„é€šè¿‡ä½¿ç”¨ Lookup methodã€‚ lookup-methodæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Spring Reference ä¸­æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š 1234567891011121314151617package fiona.apple;// no more Spring imports!public abstract class CommandManager &#123; public Object process(Object commandState) &#123; // grab a new instance of the appropriate Command interface Command command = createCommand(); // set the state on the (hopefully brand new) Command instance command.setState(commandState); return command.execute(); &#125; // okay... but where is the implementation of this method? protected abstract Command createCommand();&#125; xml é…ç½® &lt;lookup-method /&gt;ï¼š 123456789&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;&lt;bean id=\"myCommand\" class=\"fiona.apple.AsyncCommand\" scope=\"prototype\"&gt; &lt;!-- inject dependencies here as required --&gt;&lt;/bean&gt;&lt;!-- commandProcessor uses statefulCommandHelper --&gt;&lt;bean id=\"commandManager\" class=\"fiona.apple.CommandManager\"&gt; &lt;lookup-method name=\"createCommand\" bean=\"myCommand\"/&gt;&lt;/bean&gt; Spring é‡‡ç”¨ CGLIB ç”Ÿæˆå­—èŠ‚ç çš„æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬å®šä¹‰çš„ç±»ä¸èƒ½å®šä¹‰ä¸º final classï¼ŒæŠ½è±¡æ–¹æ³•ä¸Šä¹Ÿä¸èƒ½åŠ  finalã€‚ lookup-method ä¸Šçš„é…ç½®ä¹Ÿå¯ä»¥é‡‡ç”¨æ³¨è§£æ¥å®Œæˆï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨é…ç½® &lt;lookup-method /&gt; äº†ï¼Œå…¶ä»–ä¸å˜ï¼š 1234567891011public abstract class CommandManager &#123; public Object process(Object commandState) &#123; MyCommand command = createCommand(); command.setState(commandState); return command.execute(); &#125; @Lookup(\"myCommand\") protected abstract Command createCommand();&#125; æ³¨æ„ï¼Œæ—¢ç„¶ç”¨äº†æ³¨è§£ï¼Œè¦é…ç½®æ³¨è§£æ‰«æï¼š&lt;context:component-scan base-package=&quot;com.javadoop&quot; /&gt; ç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼š 1234567891011public abstract class CommandManager &#123; public Object process(Object commandState) &#123; MyCommand command = createCommand(); command.setState(commandState); return command.execute(); &#125; @Lookup protected abstract MyCommand createCommand();&#125; ä¸Šé¢çš„è¿”å›å€¼ç”¨äº† MyCommandï¼Œå½“ç„¶ï¼Œå¦‚æœ Command åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿”å›å€¼ä¹Ÿå¯ä»¥å†™ Commandã€‚ replaced-methodè®°ä½å®ƒçš„åŠŸèƒ½ï¼Œå°±æ˜¯æ›¿æ¢æ‰ bean ä¸­çš„ä¸€äº›æ–¹æ³•ã€‚ 12345678public class MyValueCalculator &#123; public String computeValue(String input) &#123; // some real code... &#125; // some other methods...&#125; æ–¹æ³•è¦†å†™ï¼Œæ³¨æ„è¦å®ç° MethodReplacer æ¥å£ï¼š 123456789public class ReplacementComputeValue implements org.springframework.beans.factory.support.MethodReplacer &#123; public Object reimplement(Object o, Method m, Object[] args) throws Throwable &#123; // get the input value, work with it, and return a computed result String input = (String) args[0]; ... return ...; &#125;&#125; é…ç½®ä¹Ÿå¾ˆç®€å•ï¼š 12345678&lt;bean id=\"myValueCalculator\" class=\"x.y.z.MyValueCalculator\"&gt; &lt;!-- å®šä¹‰ computeValue è¿™ä¸ªæ–¹æ³•è¦è¢«æ›¿æ¢æ‰ --&gt; &lt;replaced-method name=\"computeValue\" replacer=\"replacementComputeValue\"&gt; &lt;arg-type&gt;String&lt;/arg-type&gt; &lt;/replaced-method&gt;&lt;/bean&gt;&lt;bean id=\"replacementComputeValue\" class=\"a.b.c.ReplacementComputeValue\"/&gt; arg-type æ˜æ˜¾ä¸æ˜¯å¿…é¡»çš„ï¼Œé™¤éå­˜åœ¨æ–¹æ³•é‡è½½ï¼Œè¿™æ ·å¿…é¡»é€šè¿‡å‚æ•°ç±»å‹åˆ—è¡¨æ¥åˆ¤æ–­è¿™é‡Œè¦è¦†ç›–å“ªä¸ªæ–¹æ³•ã€‚ BeanPostProcessoråº”è¯¥è¯´ BeanPostProcessor æ¦‚å¿µåœ¨ Spring ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹æ¥å£å®šä¹‰ï¼š 1234567public interface BeanPostProcessor &#123; Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException; Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;&#125; çœ‹è¿™ä¸ªæ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•åå­—æˆ‘ä»¬å¤§ä½“ä¸Šå¯ä»¥çŒœæµ‹ bean åœ¨åˆå§‹åŒ–ä¹‹å‰ä¼šæ‰§è¡Œ postProcessBeforeInitialization è¿™ä¸ªæ–¹æ³•ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åä¼šæ‰§è¡Œ postProcessAfterInitialization è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆç†è§£æ˜¯éå¸¸ç‰‡é¢çš„ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ BeanPostProcessor å®ç°å¤–ï¼ŒSpring å®¹å™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç»™æˆ‘ä»¬ä¹ŸåŠ äº†å‡ ä¸ªã€‚å¦‚åœ¨è·å– BeanFactory çš„ obtainFactory() æ–¹æ³•ç»“æŸåçš„ prepareBeanFactory(factory)ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¼šå‘ç°ï¼ŒSpring å¾€å®¹å™¨ä¸­æ·»åŠ äº†è¿™ä¸¤ä¸ª BeanPostProcessorï¼šApplicationContextAwareProcessorã€ApplicationListenerDetectorã€‚ æˆ‘ä»¬å›åˆ°è¿™ä¸ªæ¥å£æœ¬èº«ï¼Œè¯»è€…è¯·çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ bean å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ bean çš„åå­—ï¼Œé‡ç‚¹åœ¨è¿”å›å€¼å°†ä¼šä½œä¸ºæ–°çš„ bean å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œæ²¡äº‹çš„è¯è¿™é‡Œä¸èƒ½éšä¾¿è¿”å›ä¸ª nullã€‚ é‚£æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å¯¹ä¸€äº›æˆ‘ä»¬æƒ³è¦ä¿®é¥°çš„ bean å®ä¾‹åšä¸€äº›äº‹æƒ…ã€‚ä½†æ˜¯å¯¹äº Spring æ¡†æ¶æ¥è¯´ï¼Œå®ƒä¼šå†³å®šæ˜¯ä¸æ˜¯è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿”å› bean å®ä¾‹çš„ä»£ç†ï¼Œè¿™æ ·å°±æœ‰æ›´å¤§çš„æƒ³è±¡ç©ºé—´äº†ã€‚ æœ€åï¼Œæˆ‘ä»¬è¯´è¯´å¦‚æœæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ª bean å®ç° BeanPostProcessor çš„è¯ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ å¦‚æœä»”ç»†çœ‹äº†ä»£ç åˆ†æçš„è¯ï¼Œå…¶å®å¾ˆå®¹æ˜“çŸ¥é“äº†ï¼Œåœ¨ bean å®ä¾‹åŒ–å®Œæˆã€å±æ€§æ³¨å…¥å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œå…·ä½“è¯·å‚è§ç±» AbstractAutowireCapableBeanFactory#initBean æ–¹æ³•ã€‚ é¦–å…ˆä¼šå›è°ƒå‡ ä¸ªå®ç°äº† Aware æ¥å£çš„ beanï¼Œç„¶åå°±å¼€å§‹å›è°ƒ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•ï¼Œä¹‹åæ˜¯å›è°ƒ init-methodï¼Œç„¶åå†å›è°ƒ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•ã€‚ æ€»ç»“æŒ‰ç†è¯´ï¼Œæ€»ç»“åº”è¯¥å†™åœ¨é™„å½•å‰é¢ï¼Œæˆ‘å°±ä¸è®²ç©¶äº†ã€‚ åœ¨èŠ±äº†é‚£ä¹ˆå¤šæ—¶é—´åï¼Œè¿™ç¯‡æ–‡ç« ç»ˆäºç®—æ˜¯åŸºæœ¬å†™å®Œäº†ï¼Œå¤§å®¶åœ¨æƒŠå¹ Spring ç»™æˆ‘ä»¬åšäº†é‚£ä¹ˆå¤šçš„äº‹çš„æ—¶å€™ï¼Œåº”è¯¥é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œå»ç†è§£ Spring å†™å¾—å¥½çš„åœ°æ–¹ï¼Œå»ç†è§£å®ƒçš„è®¾è®¡æ€æƒ³ã€‚ æœ¬æ–‡çš„ç¼ºé™·åœ¨äºå¯¹ Spring é¢„åˆå§‹åŒ– singleton beans çš„è¿‡ç¨‹åˆ†æä¸å¤Ÿï¼Œä¸»è¦æ˜¯ä»£ç é‡çœŸçš„æ¯”è¾ƒå¤§ï¼Œåˆ†æ”¯æ—è·¯ä¼—å¤šã€‚åŒæ—¶ï¼Œè™½ç„¶é™„å½•æ¡ç›®ä¸å°‘ï¼Œä½†æ˜¯åºå¤§çš„ Spring çœŸçš„å¼•å‡ºäº†å¾ˆå¤šçš„æ¦‚å¿µï¼Œå¸Œæœ›æ—¥åæœ‰ç²¾åŠ›å¯ä»¥æ…¢æ…¢è¡¥å……ä¸€äº›ã€‚ ï¼ˆå…¨æ–‡å®Œï¼‰ éƒ‘é‡å£°æ˜ : æœ¬æ–‡è½¬è½½è‡ªæˆ‘å…³æ³¨çš„ä¸€ä½å¤§ä½¬çš„åšå®¢,åŸæ–‡é“¾æ¥åŸæ–‡ å¦‚æœ‰ä¾µæƒè¿˜è¯·è”ç³»æœ¬äººåˆ é™¤,ä»…åšçŸ¥è¯†ä¼ æ’­ä¸è®°å½•,æ— å‰½çªƒå†’çŠ¯ä¹‹æ„. å¯åœ¨æœ¬äººä¸ªäººåšå®¢ blog-spring-iocä¸‹ç•™è¨€æˆ–è€…åœ¨csdn-spring-iocä¸­ç•™è¨€","categories":[{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.enjoyican.com/categories/%E6%A1%86%E6%9E%B6/"}],"tags":[{"name":"spring","slug":"spring","permalink":"https://www.enjoyican.com/tags/spring/"}]},{"title":"springäº‹ä»¶ç›‘å¬","date":"2019-09-06T12:29:30.000Z","path":"posts/spring-application-listener/","text":"ä¸šåŠ¡åœºæ™¯ï¼šåœ¨ä¸€ä¸ªåŠ äº†äº‹åŠ¡çš„serviceæ–¹æ³•ä¸­ï¼Œæœ‰æ•°æ®åº“æ“ä½œï¼Œæœ‰MQæ¶ˆæ¯çš„å‘é€ï¼ŒMQå‘é€åæ¶ˆæ¯æ¶ˆè´¹ç«¯éœ€è¦å›æŸ¥æ•°æ®åº“ï¼Œç›®å‰å­˜åœ¨çš„ä¸€ä¸ªæƒ…å†µæ˜¯åœ¨æ•°æ®åº“æ“ä½œäº‹åŠ¡å°šæœªæäº¤çš„æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯å°±å‘é€æˆåŠŸäº†ï¼Œæ­¤æ—¶æ¶ˆæ¯æ¶ˆè´¹è€…å›æŸ¥æ•°æ®åº“ï¼Œæ•°æ®ä¾ç„¶æ˜¯æœªæ›´æ”¹çš„çŠ¶æ€ï¼Œå¯¼è‡´æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ã€‚ éœ€æ±‚ï¼šæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ§åˆ¶åœ¨äº‹åŠ¡æäº¤æˆåŠŸä¹‹åæ¶ˆæ¯å†æ¶ˆè´¹ æ–¹æ¡ˆï¼šé‡‡ç”¨springäº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Œå½“ç›‘å¬åˆ°äº‹åŠ¡æˆåŠŸæäº¤åï¼Œå¼€å§‹å‘å¸ƒæ¶ˆæ¯ï¼š 1.äº‹ä»¶å‘å¸ƒè€…éœ€è¦å®ç°ApplicationEventPublisherAwareæ¥å£ï¼šç›¸å…³è¯¦ç»†è§£é‡Šå¯ä»¥å‚è€ƒä»¥ä¸‹åšå®¢ï¼šæ·±å…¥ç†è§£springå®¹å™¨å†…äº‹ä»¶å‘å¸ƒç›‘å¬æœºåˆ¶ ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930@Slf4j@Componentpublic class SendMqEventPublisher implements ApplicationEventPublisherAware &#123; private static ApplicationEventPublisher eventPublisher; @Override public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) &#123; if (eventPublisher == null) &#123; eventPublisher = applicationEventPublisher; &#125; &#125; /** * @description å‘å¸ƒäº‹ä»¶ */ public void publishEvent(BaseEvent event) &#123; log.info(\"===&gt; å‘å¸ƒsendMqäº‹ä»¶: &#123;&#125;\", event); eventPublisher.publishEvent(event); &#125; public void publishMqEvent(String topic, String tag, MessageObject messageObject) &#123; SendMqParam sendMqParam = new SendMqParam(); sendMqParam.setTopic(topic); sendMqParam.setTag(tag); sendMqParam.setMessageObject(messageObject); this.publishEvent(new BaseEvent(sendMqParam)); &#125;&#125; å…¶ä¸­è¦å‘å¸ƒçš„äº‹ä»¶ä½“BaseEventç»§æ‰¿è‡ªApplicationEventï¼š 123public class BaseEvent&lt;T&gt; extends ApplicationEvent &#123; //å…·ä½“æ¶ˆæ¯ä½“è‡ªå®šä¹‰&#125; 2.åœ¨äº‹åŠ¡æ–¹æ³•ä¸­è¿›è¡Œäº‹ä»¶å‘å¸ƒï¼š12345678910111213141516@Override @Transactional(rollbackFor = Exception.class, propagation = Propagation.REQUIRES_NEW) public void processOneAchieve(UpgradeStoreAchievementEntity storeAchievementEntity) &#123; //å…¶ä»–æ•°æ®åº“æ“ä½œç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ //äº‹ä»¶å‘å¸ƒ UpgradeOperateMqo upgradeOperateMqo = new UpgradeOperateMqo(); upgradeOperateMqo.setStarstoreId(currentStarstoreId); sendMqEventPublisher.publishMqEvent(MessageConstant.STARSTORE_RELATION_TOPIC, MessageConstant.STARSTORE_UPGRADE_OPERATE_TAG, MessageBuilder.overMessage(upgradeOperateMqo)); &#125; finally &#123; distLockSservice.unlock(lockResult); &#125; &#125; 3.äº‹ä»¶ç›‘å¬è€…é€šè¿‡æ³¨è§£ç›‘å¬å‘å¸ƒçš„äº‹ä»¶é€šè¿‡åœ¨æ–¹æ³•ä¸Šå¢åŠ æ³¨è§£@TransactionalEventListenerè¿›è¡Œäº‹ä»¶ç›‘å¬æ¶ˆè´¹ï¼ˆè¯¥æ³¨è§£åªç›‘å¬äº‹åŠ¡ç›¸å…³çš„äº‹ä»¶ï¼‰ï¼Œå…¶ä¸­å‚æ•°phaseå‚æ•°å¯ä»¥æ§åˆ¶ç›‘å¬åˆ°äº‹ä»¶åå¤„ç†äº‹ä»¶ä¸æäº¤äº‹åŠ¡çš„å‰åå…³ç³»ï¼š å‚æ•°å€¼æœ‰ä¸‹é¢å››ç§ï¼šBEFORE_COMMIT,AFTER_COMMIT,AFTER_ROLLBACK,AFTER_COMPLETION; 1234567891011121314151617@Component@Slf4jpublic class SendMqEventListener &#123; @Autowired private RocketMQTemplate rocketMQTemplate; @TransactionalEventListener(fallbackExecution = true, phase = TransactionPhase.AFTER_COMMIT) public void onApplicationEvent(BaseEvent&lt;SendMqParam&gt; event) &#123; SendMqParam sendMqParam = (SendMqParam) event.getSource(); String name = Thread.currentThread().getName(); log.info(\"===&gt; æ”¶åˆ°sendMqäº‹ä»¶: &#123;&#125;ï¼Œçº¿ç¨‹åä¸ºï¼š &#123;&#125;\", sendMqParam, name); rocketMQTemplate.sendNormal(sendMqParam.getTopic(), sendMqParam.getTag(), sendMqParam.getMessageObject()); &#125;&#125; æ³¨æ„springäº‹ä»¶å‘å¸ƒè€…å’Œç›‘å¬è€…éƒ½éœ€è¦åŠ å…¥springç®¡ç†ï¼Œ@Componentæ³¨è§£ä¸è¦å¿˜è®° æ°¸ä¸è¨€è´¥","categories":[{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.enjoyican.com/categories/%E6%A1%86%E6%9E%B6/"}],"tags":[{"name":"spring","slug":"spring","permalink":"https://www.enjoyican.com/tags/spring/"}]},{"title":"æ ‘å’Œå›¾ç¬”è®°","date":"2019-03-20T14:19:30.000Z","path":"posts/tree/","text":"æ ‘å’Œå›¾","categories":[{"name":"æ•°æ®ç»“æ„ä¸ç®—æ³•","slug":"æ•°æ®ç»“æ„ä¸ç®—æ³•","permalink":"https://www.enjoyican.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"datastructure","slug":"datastructure","permalink":"https://www.enjoyican.com/tags/datastructure/"}]}]